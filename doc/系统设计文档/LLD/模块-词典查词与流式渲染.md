# 模块：词典查询与流式渲染

## 1. 作用域

- 覆盖 `/lookup`、`/regenerate`、`/history` 读取链路在 BFF 内部的执行路径。
- 目标：在 **2.3 s** 超时窗口内完成首个内容模块渲染（第 16 章 16.4），命中缓存路径 P95 ≤1.2 s；未命中时提供流式回退。
- 依赖：API 网关（限流/trace）、Redis L1/L2、LLM 适配层、RDBMS（历史/配置）、可观测性 Agent。

## 2. 详细流程

### 2.1 时序图

- FigJam 链接：<https://www.figma.com/file/glancy-sdd-figjam?type=whiteboard&node-id=2-100#LLD-Lookup>
- Mermaid 源：`doc/系统设计文档/图/LLD-Lookup-Sequence.mmd`

### 2.2 步骤说明

| 步骤 | 说明                                                                                                                                                       | SLA/SLO 对齐                                    |
| ---- | ---------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------- |
| 1    | 网关注入 `trace_id`、`X-Quota-*`，完成 Token Bucket 校验，BFF 验证输入合法性（同语模式不展示译文，参照第 20 章 20.3）。                                      | 边缘 P95 ≤150 ms                                |
| 2    | BFF 组合缓存键（语言对 + 词形 + profile + 策略指纹），先查 L1（进程内/本地 Redis），miss 则查 L2（共享 Redis）。                                          | L1 命中率≥40%、L2≥20%（第 16 章 16.3）。        |
| 3    | Λ 若命中：封装 `X-Cache=HIT(L1|L2)`，将模块化内容写入 SSE Channel，第一个模块 ≤150 ms 推送。                                                                | 首屏平均 ≤1.2 s                                 |
| 4    | Λ 若未命中：验证配额（详见配额模块）、准备 Prompt、同步调用 LLM 适配层，设置 2.3 s BFF 超时与 5.0 s upstream 超时，超时即走降级内容。                      | 95% 请求 ≤2.3 s                                 |
| 5    | 流式渲染：BFF 解析 LLM 流事件，将 `definitions/example/collocation` 逐段推送到 SSE；若 1.8 s 未收到 `FIRST_CHUNK`，进入降级逻辑。                           | P95 ≤2.5 s（第 16 章）                           |
| 6    | 缓写：完成后异步写入历史记录、更新 Redis L1/L2、刷新统计指标；失败不会阻塞主链路，写入补偿队列。                                                           | 不影响 SLA（第 13 章）                          |

### 2.3 流式状态机

| 状态           | 触发条件                                 | 行为                                                                                                  |
| -------------- | ---------------------------------------- | ------------------------------------------------------------------------------------------------------- |
| INIT           | SSE 通道建立                             | 记录 `stream_id`、推送骨架屏指令                                                                       |
| CACHE_HIT      | 缓存命中                                 | 立即推送模块，状态切换为 `PLAYBACK_DONE`                                                                |
| LLM_STREAMING  | 收到 LLM `FIRST_CHUNK`                   | 每条 chunk 映射到 UI 模块并附 `chunk_id`；超过 5 s 未完成→触发 `FALLBACK`                              |
| DEGRADED       | LLM 失败/超时/熔断                       | 推送“基础释义 + 模板例句”，设置 `degraded=true`；记录降级指标并触发缓存刷新任务                        |
| PLAYBACK_DONE  | SSE `complete`                           | 发送 `stream.close` 事件，记录 `latency_ms`，写审计日志                                                 |

### 2.4 算法/伪代码

```pseudo
handleLookup(request):
    ctx = buildContext(request)
    cacheKey = hash(ctx.langPair, ctx.normalizedQuery, ctx.profileId, ctx.strategy)
    result = cacheGetL1(cacheKey) ?? cacheGetL2(cacheKey)
    if result:
        emitStream(result, cacheHitHeader(result.source))
        return
    quota = quotaCheck(ctx)
    if not quota.ok: return quota.error
    prompt = composePrompt(ctx)
    try:
        stream = llmAdapter.defaultStream(prompt, timeout=2.3s)
        emitStream(stream, cacheHitHeader("MISS"))
        asyncPersist(stream, ctx)
    except TimeoutError:
        emitDegraded(ctx)
        scheduleRefresh(ctx)
```

### 2.5 数据结构

| 对象          | 字段                                                                             | 说明                                             |
| ------------- | -------------------------------------------------------------------------------- | ------------------------------------------------ |
| CacheEntry    | `version`,`modules[]`,`generatedAt`,`ttl`,`origin`                               | `origin`=LLM/CACHE/DEGRADED；版本用于并行失效    |
| StreamChunk   | `chunkId`,`moduleType`,`payload`,`seq`,`isLast`,`latencyMs`                      | SSE frame，latency 用于 P95 统计                 |
| HistoryRecord | `lookupId`,`userId`,`langPair`,`payloadRef`,`cost`,`degraded`                    | `payloadRef` 指向对象存储/压缩内容               |

## 3. 错误与恢复

- **熔断/降级**：遵循第 13 章阈值，扇出到可观测性；降级内容带 `templateVersion` 便于静态验证。
- **缓存不一致**：命中但版本过旧时，标记 `stale-while-revalidate`，同步返回旧值 + 异步刷新（最大 30 s）。
- **重试策略**：BFF 不主动重试 LLM（避免等待 >2.3 s），由适配层半开探测；缓存写失败进入任务编排队列。

## 4. 指标与日志

| 指标                | 说明                                          | 验收引用                |
| ------------------- | --------------------------------------------- | ----------------------- |
| `lookup_first_chunk_latency_ms` | SSE 首 chunk 延迟                    | 第 16 章 16.3、20.3      |
| `lookup_cache_hit_ratio{tier}` | L1/L2 命中率                         | 第 16 章 16.3、20.3      |
| `lookup_degraded_total`        | 降级次数                              | 第 13 章 13.1.2、20.15   |
| `lookup_stream_abort_total`    | SSE 断开次数                          | 发布前演练（第 20 章）   |

