# 模块：导出任务流水线与签名下载 TTL

## 1. 作用域

- 覆盖 `/exports` 接口、导出任务编排、对象存储与一次性签名链接的全过程。
- 验收基线：回执≤5 s、链接 TTL 10 分钟、任务 RTO ≤15 min（第 13 章）、导出链路受限速/配额约束（第 20 章）。

## 2. 流水线概览

| 阶段        | 说明                                                                                                  | SLA/NFR 引用                     |
| ----------- | ----------------------------------------------------------------------------------------------------- | -------------------------------- |
| 入队        | BFF 校验参数/配额后写入 `exports_jobs` 表并推送消息队列，回执携带 `jobId` 与状态轮询入口。            | 回执 ≤5 s（第 20 章 20.15）      |
| 取数        | Job Worker 根据 `jobId` 查询 RDBMS/缓存，生成 CSV/JSON；对大结果集分页读取避免对主库施压。             | 不影响主链路，保障 RPO（第 13） |
| 落盘与签名  | Worker 将产物写入临时对象存储路径，生成 S3 V4 签名（TTL 10 分钟），写回 `exports_receipt`。            | 数据语义（第 20 章 20.3）        |
| 通知/回执   | 通过 Webhook/SSE/轮询返回进度；链接过期后需重新发起导出。                                               | TTL 过期一次性（第 20 章）       |

## 3. 时序与组件

- FigJam 链接：<https://www.figma.com/file/glancy-sdd-figjam?type=whiteboard&node-id=2-400#LLD-Export>
- Mermaid 源：`doc/系统设计文档/图/LLD-Export-Pipeline.mmd`

### 3.1 详细步骤

1. **请求校验**：BFF 校验词条范围、日期区间、格式（CSV/JSON），执行配额扣减（导出配额独立计数）。
2. **任务创建**：生成 `jobId`、写入 RDBMS (`exports_jobs`)，状态 INIT；将 Job 投递到消息队列（带重试上限）。
3. **快速响应**：在 5 s 内返回 `{jobId,status=pending,receiptUrl}`，receiptUrl 指向 `/exports/{jobId}`。
4. **任务消费**：
   - Worker 拉取 Job，切换状态为 RUNNING。
   - 分页读取 `lookups/results`，将数据标准化为 schema 版本化结构。
   - 在本地生成文件/流式上传到对象存储临时桶（带 AES-256 加密）。
5. **签名与一致性**：
   - 生成一次性签名 URL（10 分钟 TTL）。
   - 将 URL、过期时间、哈希写入 `exports_receipt`。
   - 通过通知通道（WebHook/SSE/轮询）告知用户。
6. **清理策略**：
   - TTL 到期后对象自动删除（Lifecycle Policy）。
   - Job 状态保留 7 天，以支持审计/重放。

## 4. 异常处理

| 场景                   | 策略                                                                                 |
| ---------------------- | ------------------------------------------------------------------------------------ |
| RDBMS 查询慢/失败      | Job 标记 `RETRYING`，退避重试（3 次）；超过阈值 → `FAILED` + 告警；不影响其他 Job。 |
| 对象存储上传失败       | 立即重试 1 次；仍失败则回滚状态并附错误码 `EXPORT_UPLOAD_FAILED`。                  |
| 签名过期               | 客户端收到 403；需重新发起导出；禁止重用旧链接。                                     |
| TTL 未清理             | Lifecycle 任务每小时扫描；超过 TTL 的对象强制删除并记录指标。                       |

## 5. 数据表/字段

| 表名           | 关键字段                                             | 说明                                                |
| -------------- | ---------------------------------------------------- | --------------------------------------------------- |
| `exports_jobs` | `job_id`,`user_id`,`filters`,`format`,`status`,`ttl` | Job 实体；`status` ∈ {INIT,RUNNING,SUCCESS,FAILED}  |
| `exports_receipt` | `job_id`,`signed_url`,`expires_at`,`checksum`,`degraded` | 回执；`degraded` 表示降级为缓存快照                 |

## 6. 指标

- `export_job_latency_ms`（INIT→SUCCESS）
- `export_receipt_ttl_violation_total`
- `export_job_status_total{status}`
- `export_signed_download_403_total`

## 7. 安全

- 签名使用最小权限 IAM，限制 `content-type`,`content-length`，并绑定 IP/UA 片段降低劫持风险。
- 日志不落正文，存储路径仅保留散列，符合第 20 章数据语义。

