# 模块：配额校验与订阅一致性

## 1. 作用域

- 为 `/lookup`、`/regenerate`、`/exports` 等接口提供统一的配额计数、订阅权益同步与成本护栏联动。
- 满足第 10 章限流、第 11 章权益同步要求，并与第 13/16/20 章的可用性与验收指标一致：日配额本地时区重置、429 回执含剩余额度及重置时间、权益 ≤5 s 生效。

## 2. 组件与数据

| 组件             | 说明                                                                                                    |
| ---------------- | ------------------------------------------------------------------------------------------------------- |
| Redis L2（配额） | 存储 `{subject}:{quotaType}` 计数与 TTL；使用 Lua 脚本保证原子性。                                       |
| RDBMS（权益）    | `subscriptions`,`entitlements`,`quota_policy` 表；写入来源：支付 Webhook、运营后台。                     |
| 订阅快照缓存     | 每个用户保留 `subscription_snapshot`（JSON）在 Redis L1，TTL 5 分钟，含权益版本与配额上限。              |
| 镜像任务         | 任务编排服务周期性校验（5 分钟）订阅状态，防止 Redis 快照过期导致不一致。                                  |

## 3. 时序流程

- FigJam 链接：<https://www.figma.com/file/glancy-sdd-figjam?type=whiteboard&node-id=2-300#LLD-Quota>
- Mermaid 源：`doc/系统设计文档/图/LLD-Quota-Flow.mmd`

### 3.1 步骤

1. **快照加载**：BFF 接收到请求后读取 `subscription_snapshot:{user}`。若不存在或版本过旧，查询 RDBMS 并写回 Redis（超时时走游客权益）。
2. **配额计算**：根据快照中档位（Free/Plus/Pro）选取 `quotaPolicy`（查词/再生成/导出分开计数），计算剩余额度。
3. **原子扣减**：执行 Lua 脚本 `decrWithReset(bucket, now, resetTimestamp)`，确保：
   - 基于本地时区的 reset（第 20 章 20.3）。
   - 当剩余 <0 时返回错误并附 `retry_after`.
4. **一致性校验**：若 Redis 计数与订阅快照不一致（例如快照为 Plus 但 Redis 仅有 Free 上限），触发 `syncSubscription`：
   - 读取 RDBMS 最新权益。
   - 更新 Redis 计数器上限与快照。
   - 记录 `quota_snapshot_drift` 指标。
5. **成本护栏联动**：若当日成本 ≥95% 预算，BFF 将 `再生成` 能力禁用并强制走缓存（第 13 章 13.1.2）。

## 4. 伪代码

```pseudo
checkQuota(ctx, quotaType):
    snapshot = cache.getSnapshot(ctx.user) ?? refreshSnapshot(ctx.user)
    limits = snapshot.quota[quotaType]
    ttl = computeLocalReset(snapshot.timezone)
    result = redis.luaDecr(bucket=ctx.user+quotaType, ttl, limits.max)
    if not result.ok:
        return {ok:false, code:429, remaining:0, reset:ttl.resetAt}
    return {ok:true, remaining: result.remaining, reset: ttl.resetAt}
```

## 5. 错误场景与恢复

- **快照缺失**：RDBMS 查询失败→返回 503 并标记 `Retry-After: 3s`，以免放行错误权益；SRE 告警。
- **配额键漂移**：检测 `quota_snapshot_drift` >1% 时，触发批量刷新任务。
- **WebHook 延迟**：支付成功≤5 s 写入 RDBMS；若延迟，BFF 允许“optimistic grant”——短暂放行并记录补偿任务，保障体验。

## 6. 指标

| 指标名                         | 说明                                           |
| ------------------------------ | ---------------------------------------------- |
| `quota_consumed_total{type}`   | 每种配额的消耗总数                              |
| `quota_reject_total{type}`     | 429 次数，作为容量规划输入                      |
| `subscription_snapshot_refresh`| 快照刷新次数/延迟                               |
| `quota_snapshot_drift`         | 快照版本与 RDBMS 版本差距                       |
