# Module – Text-To-Speech (TTS)

Entry point: `backend/src/main/java/com/glancy/backend/controller/TtsController.java`. Supporting components include `VolcengineTtsClient`, `TtsRequestValidator`, `TtsQuotaService`, and `TtsRateLimiter`. Tests: `TtsControllerTest` (MockMvc contract), `TtsControllerValidationIT` (integration validation), plus service-level guards (`TtsRateLimiterTest`).

## Request Schema (`TtsRequest`)
| Field | Type / Constraints | Purpose |
|-------|--------------------|---------|
| `text` | string, required, trimmed | Content to synthesize. |
| `lang` | string, required (e.g. `en-US`, `zh-CN`) | Determines voice group in `tts-config.yml`. |
| `voice` | string, optional | Voice id; defaults to language fallback. Membership is validated via `TtsRequestValidator`. |
| `format` | regex `mp3` only | Output encoding. |
| `speed` | decimal between 0.5 and 2.0 | Playback speed multiplier. |
| `shortcut` | boolean (default `true`) | When `true`, cache misses return `204` so the client can decide whether to trigger synthesis. |
| `operation` | `QUERY` (default) or `SUBMIT` | Propagated to Volcengine. `SUBMIT` enables asynchronous chunk streaming when feature-flagged. |

`GET` variants bind to `TtsQueryRequest`, which mirrors the schema via query parameters and forces `shortcut=false` to always return audio when available.

## Endpoints (`/api/tts`)
| Method & Path | Description | Request / Response | Auth & Limits | Code & Tests |
|---------------|-------------|--------------------|---------------|--------------|
| `POST /api/tts/word` | JSON-based word pronunciation synthesis. | **Body** `TtsRequest`. Returns `200 OK` with `TtsResponse` (Base64 audio, duration, format, `from_cache`). Responds `204 No Content` when `shortcut=true` and cache miss. | Requires `X-USER-TOKEN`. Rate limiter: 30 req/user/min, 120 req/IP/min, burst 20, cooldown 60 s. Daily quota defaults to 5 (free) / 100 (member). | `TtsController.synthesizeWord`<br>`TtsControllerTest.synthesizeWordReturnsAudio`<br>`TtsControllerTest.synthesizeWordCacheMissReturns204`<br>`TtsControllerValidationIT.synthesizeWordWithUnsupportedLanguageReturns422` |
| `GET /api/tts/word` | Query-parameter variant suited for limited clients. | Query parameters: `text`, `lang`, `voice?`, `format?`, `speed?`, `operation?`. Returns `TtsResponse` identical to POST; `shortcut` is forced to `false`. | Same auth/limits as POST. | `TtsController.streamWord`<br>`TtsControllerTest.streamWordReturnsPayload` |
| `POST /api/tts/sentence` | Generate longer utterances from JSON body. | Same payload as `/word`. Response semantics match word synthesis. | Same auth/limits. | `TtsController.synthesizeSentence`<br>`TtsControllerValidationIT.synthesizeSentenceWithProVoiceByFreeUserReturns403` |
| `GET /api/tts/sentence` | GET variant for sentences. | Same query params as `/word`. Returns `TtsResponse`. | Same auth/limits. | `TtsController.streamSentence`<br>`TtsControllerTest.streamSentenceReturnsPayload` |
| `GET /api/tts/voices?lang=en` | List voice options for a language. | Response `VoiceResponse` with `default` voice id and `options[]` (`VoiceOption` = id, label, plan). | Requires token; currently relies on downstream config for plan filtering. | `TtsController.listVoices`<br>`TtsControllerTest.listVoicesReturnsOptions` |

## Streaming / Chunk Format
As of the current build the controller always returns JSON—even when clients send `Accept: text/event-stream`—to preserve backwards compatibility (`GlobalExceptionHandlerJsonOnlyTest.GivenEventStreamAccept_WhenHandleError_ThenRespondJson`). When the `operation=SUBMIT` pipeline is enabled, the SSE adaptor will emit frames in the following format:

```text
event: audio
data: {"seq":1,"final":false,"payload":{"data":"<base64>","duration_ms":200,"format":"mp3","from_cache":false}}
```

| Field | Description | Source |
|-------|-------------|--------|
| `seq` | 1-based incremental sequence. Clients should assemble audio chunks in order. | Generated by SSE adaptor (chunk index). |
| `final` | Boolean flag indicating the last chunk. | Derived from upstream completion sentinel or cache hit. |
| `payload.data` | Base64-encoded audio bytes. | `TtsResponse#getData`. |
| `payload.duration_ms` | Clip duration in milliseconds. | `TtsResponse#getDurationMs`. |
| `payload.format` | Encoding (currently `mp3`). | `TtsResponse#getFormat`. |
| `payload.from_cache` | True if served from cache to signal instant delivery. | `TtsResponse#isFromCache`. |

Clients not opting into SSE should keep `Accept: application/json` and treat the response body as the final chunk.

## Voice Plans & Validation
- Voice availability is declared in `backend/src/main/resources/tts-config.yml`. Each option lists a `plan` (`all`, `plus`, `pro`, `premium`).
- `TtsRequestValidator` cross-checks the caller’s membership (`MembershipType`) and throws `ForbiddenException` when a voice requires a higher tier, exercised in `TtsControllerValidationIT.synthesizeSentenceWithProVoiceByFreeUserReturns403`.
- Unsupported languages raise `InvalidRequestException` with message `不支持的语言`.

## Quota Enforcement
- `TtsQuotaService.verifyQuota` runs before synthesis; exceeding the daily limit results in HTTP 403 with `今日配额已用完`.
- Usage is recorded only after a successful synthesis to avoid over-counting. Cached responses respect `tts-config.features.countCachedAsUsage` (currently `false`).

## Error Scenarios
| Scenario | Response | Tests |
|----------|----------|-------|
| Invalid parameters (empty text, unsupported language/format) | 422 `请求参数不合法`. | `TtsControllerValidationIT.synthesizeWordWithUnsupportedLanguageReturns422` |
| Free user selects pro-only voice | 403 `该音色仅对 pro 及以上会员开放`. | `TtsControllerValidationIT.synthesizeSentenceWithProVoiceByFreeUserReturns403` |
| Rate limit exceeded | 429 `请{n}秒后重试`. | `TtsRateLimiterTest` |
| Upstream Volcengine failure | 424 `TTS provider error: ...`. | `VolcengineTtsClient` unit/integration tests |

## Voice Listing Example
```jsonc
GET /api/tts/voices?lang=en-US
{
  "default": "en_male_corey_emo_v2_mars_bigtts",
  "options": [
    { "id": "en_male_corey_emo_v2_mars_bigtts", "label": "Corey", "plan": "all" },
    { "id": "en_female_nadia_tips_emo_v2_mars_bigtts", "label": "Nadia", "plan": "pro" }
  ]
}
```
