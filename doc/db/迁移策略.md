# 迁移策略

> 目标：一次性交付订阅/配额/计费相关的基础表结构，并为后续增量迭代、≤5 s 权益同步与 T+7 物理清理提供可重复执行的脚本。

## 1. 工具与命名
- 采用 `golang-migrate` 或等价迁移框架；单个迁移文件包含 `up`/`down` 两个脚本。
- 命名规范：`V{seq}__{feature}.sql`，例如 `V1__core_schema.sql`。
- 所有迁移脚本在 PostgreSQL 事务内执行，确保失败自动回滚。

## 2. V1__core_schema

### 向前（Up）
1. `CREATE EXTENSION pgcrypto`，用于 `gen_random_uuid()`。
2. 创建 `users → subscription_* → subscriptions → entitlement_events`，保持外键依赖顺序。
3. 创建计费表：`billing_orders`、`billing_transactions`、`billing_invoices`。
4. 创建配额表：`quota_daily`、`quota_ledger`。
5. 创建业务表：`lexicon_records`、`export_jobs`、`audit_logs`。
6. 创建唯一索引、部分索引与物化视图 `cleanup_candidates`。
7. `ANALYZE` 关键表，确保查询计划稳定。

### 回滚（Down）
1. `DROP MATERIALIZED VIEW cleanup_candidates;`
2. 逆序删除无依赖表：`audit_logs` → `export_jobs` → `lexicon_records` → `quota_ledger` → `quota_daily`.
3. 删除计费表，再删除 `entitlement_events`、`subscriptions`、`subscription_prices`、`subscription_plans`、`users`。
4. `DROP EXTENSION pgcrypto;`

## 3. 数据回填与校验
1. **基线数据**：用 `COPY subscription_plans` / `subscription_prices` 导入 1.4.4 权益矩阵；各 Plan 的 JSON `entitlements` 需与 SRS 第 11 章保持一致（`doc/需求说明文档/第 11 章 订阅、计费与账单.md:21-44`）。
2. **历史订阅**：若旧系统存在订阅/计费记录，先导入 `users`、`subscriptions`，再导入 `billing_orders/transactions`，最后批量生成 `entitlement_events` 作为消费起点，确保与 SRS 11.12 的 5 s 流程兼容（`doc/需求说明文档/第 11 章 订阅、计费与账单.md:121-134`）。
3. **配额快照**：初始化 `quota_daily` 时把 `limit_value/promo_value` 设为订阅权益表的当前值，并回填 `used_value`=0，满足 SRS 10.3 的“本地自然日 + 活动配额”证据（`doc/需求说明文档/第 10 章 配额、限流与成本控制.md:60-95`）。
4. **一致性校验**：部署后运行一次对账任务，比对订阅域与配额域的限额差异，阈值 >0 即触发补偿（SRS 10.10 要求）。

## 4. 事务与幂等策略
- 订阅/计费写操作必须在同一事务内更新 `subscriptions`、`billing_orders`、`billing_transactions`，并向 `entitlement_events` outbox 插入记录。
- 第三方支付回调写入 `billing_transactions` 时需携带 `idem_key`，依赖唯一索引避免重复入账，与 SRS 11.9 的幂等约束一致。
- `quota_ledger` 依赖 `idempotency_key` 唯一约束，前端需传入 `hash(user_id + entry + config)`，与 SRS 10.3.2 保持一致；迁移完成后即启用唯一索引，避免脏数据。

## 5. 逻辑删除与 T+7 物理清理
- 逻辑删除：业务层将记录 `deleted_at=NOW()`，即刻对外隐藏，满足“逻辑删即时”条款。
- 物理清理：新增定时作业 `cleanup_runner`，每日 UTC 03:00 执行：
  1. `REFRESH MATERIALIZED VIEW cleanup_candidates;`
  2. 对 `deleted_at <= now() - interval '7 days'` 的记录，按表分批（每批 5k）删除。
  3. 将删除结果写入 `audit_logs(scope='cleanup')` 以便追溯。
- 计费流水与审计日志不走物理删除，仅归档到冷存储，以满足 SRS 第 11 章要求的 ≥5 年留存（`doc/需求说明文档/第 11 章 订阅、计费与账单.md:137-145`）。

## 6. 回滚原则
- 若迁移失败，可执行 `migrate ... down 1` 触发上文的 Down 脚本；若已写入业务数据，需先备份相关表再回滚。
- 若仅部分表需要回退（例如计费域延后上线），可在新的 `V2__drop_billing.sql` 中有序删除相关表，禁止手工 `DROP` 以免破坏迁移序列。

## 7. 发布后的健康检查
1. 执行 `SELECT * FROM entitlement_events WHERE status='pending' AND created_at < NOW() - INTERVAL '5 seconds';`，若存在记录需告警（SRS 11.12 SLA）。
2. 对 `quota_daily` 执行抽样，验证 `limit_value` 与订阅 Plan 一致；若发现差异，触发回放任务（SRS 10.10 补偿流程）。
3. 检查 `cleanup_candidates` 中的记录数量，确保 < 阈值（>10 万条需扩容作业频率）。
