# Release Notes · RN-20250110-BILL

| 字段 | 内容 |
| --- | --- |
| Release ID | RN-20250110-BILL |
| Version Tag | `glancy.billing.v1`（CT-03 · 状态机扩展） |
| Window | 2025-01-10 01:00–05:00 UTC · REL-B0→REL-B4（AB 灰度，参照 DEP-2025Q1-002） |
| Scope & Modules | 订阅/计费服务、权益同步、Web/H5 订阅页与账单视图 |
| Change Type | CT-03（默认行为可通过特性开关回退）；Deprecation 日历：DEP-2025Q1-002 |
| User Impact | 新增 `PAUSED` 状态以支持人工冻结/合规审查；订阅页、账单与接口均同步显示 |
| Guardrails | 支付成功 ≤5 s 权益生效、降级流程 SLO 与[AC-UC-08/09](<../需求说明文档/第 20 章 验收标准与测试方案（UC 对齐）.md#ac-uc-08>)一致；429 ≤3%；契约回放≥500 |
| Deployment Plan | 蓝绿→REL-B0 健康→REL-B1 1%（Pro 用户）→REL-B2 5%→REL-B4 50%→REL-B5 全量；2025-02-10 进行 15 分钟棕断演练 |
| Documentation & SDK | `doc/需求说明文档/第 11 章` 状态机章节新增 `PAUSED`；后台运营手册与 SDK（JS/Java v0.9.3）补充枚举 |
| Next Steps | 监控 `subscription.paused` 事件占比；在 2025-03-01 前评估是否进入常态功能并关闭 DEP-2025Q1-002 |
| Approvals | 产品 ✅ · 架构 ✅ · SRE ✅ · 合规 ✅ |

## 新功能

### `PAUSED` 订阅状态（人工冻结/合规审查）
- `Subscription.status` 新增 `PAUSED`，用于手动冻结权益（如监管审查、账单争议、企业客户停用窗口）。冻结期间保留历史与账单，但暂停计费与再生成配额发放。
- `/api/v1/subscription`、订阅页与账单视图会显示“已暂停”标签，提示用户完成资料审核或联系客服恢复；恢复后将状态回到 `ACTIVE` 或 `GRACE` 并重新发放权益。
- **关联用例**： [UC-08 订阅开通/续费](<../需求说明文档/第 4 章 业务流程与用例.md#uc-08-订阅开通续费>), [UC-09 到期自动降级](<../需求说明文档/第 4 章 业务流程与用例.md#uc-09-到期自动降级>), [UC-15 账单与收据查看](<../需求说明文档/第 4 章 业务流程与用例.md#uc-15-账单与收据查看>)
- **关联验收**： [AC-UC-08](<../需求说明文档/第 20 章 验收标准与测试方案（UC 对齐）.md#ac-uc-08>), [AC-UC-09](<../需求说明文档/第 20 章 验收标准与测试方案（UC 对齐）.md#ac-uc-09>), [AC-UC-15](<../需求说明文档/第 20 章 验收标准与测试方案（UC 对齐）.md#ac-uc-15>)

## 修复

- 无额外对外修复；该版本聚焦状态机扩展与 UI 呈现。

## 兼容性变更

- `Subscription.status` 与相关 API 响应新增枚举 `PAUSED`；若客户端未更新解析逻辑，应遵循[22.4.2](<../需求说明文档/第 22 章 变更管理与版本策略（契约弃用期）.md#2242-兼容性分级>) 忽略未知值并以“处理中”文案展示。
- Webhook/事件流水新增 `subscription.paused` 与 `subscription.resumed` 事件类型（Topic 仍为 `subscription.updated`），序列化格式保持 `glancy.billing.v1`。

## 升级影响

- 自有客户端需在 UI 与提醒渠道（站内信/邮件）新增“已暂停”提示，防止用户误以为扣款失败；同时引导用户在后台补充资料或联系客服。
- ERP/计费集成若做状态机映射，需要加入 `PAUSED→ACTIVE/GRACE` 的专用转换路径，避免被动降级；配额域应将 `PAUSED` 视为 Free 档以停止新增额度。
- 审计与报表需新增 `paused_by`、`paused_reason` 字段（若为空则默认为系统触发），以支撑合规追溯。

## 回滚步骤

1. 按[21.12](<../需求说明文档/第 21 章 发布计划与灰度策略.md#2112-上线步骤清单（运行级）>) 冻结发布并回退至 REL-B2，阻断新的暂停操作。
2. 在配置中心关闭“订阅暂停”特性开关（见[21.7](<../需求说明文档/第 21 章 发布计划与灰度策略.md#217-特性开关与配置管理>)) 并回滚 Billing 服务镜像；同时执行数据修复：`UPDATE subscriptions SET status='GRACE' WHERE status='PAUSED';`，随后重放 `entitlement_events` 以同步权益。
3. 通过客服后台通知已暂停的用户，确认其权益恢复并记录回滚 ID。

## 已知问题

- **ISSUE#T03-BILL-01/03/05**：商品矩阵、购买/对账链路与账单导出仍未完成（见[第 11 章 订阅、计费与账单](<../需求说明文档/第 11 章 订阅、计费与账单.md>))，需在后续列车实现以支撑大规模付费。
- **ISSUE#T03-API-07**：订阅/计费域对外 Webhook 仍未上线，`PAUSED` 事件暂时仅写入内部队列与审计日志，对接第三方系统仍需轮询。
