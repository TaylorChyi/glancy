# 第 6 章 非功能性需求（NFR）

> 目的：给出覆盖性能、可用性、可靠性、安全、隐私、可维护性、可观测性、兼容性、国际化与可访问性、成本与配额等的跨域约束，作为第 7–18、20–22 章的上位约束与验收门槛。优先级采用 Must/Should/Could/Will not。

## 6.1 适用范围与引用

- 适用对象：Web 与 H5 前端、后端服务、第三方依赖（Doubao API、登录与支付）、数据与日志流水线。
- 术语口径：延迟、SLO/SLI、trace_id、L1/L2 缓存、幂等键、配额、限流、TTL、tokens_in/out 等按术语表统一。
- 关联章节：性能与容量（[第 16 章](<./第 16 章 端到端性能与容量规划.md>)）、可用性与容灾（[第 13 章](<./第 13 章 可用性、容灾与备份.md>)）、可观测性（[第 14 章](<./第 14 章 可观测性与运维（日志、监控、告警、SLO）.md>)）、国际化与可访问性（[第 15 章](<./第 15 章 国际化与可访问性.md>)）、配额与成本（[第 10 章](<./第 10 章 配额、限流与成本控制.md>)）、安全与合规（[第 12 章](<./第 12 章 安全、隐私与合规.md>)）。

------

## 6.2 汇总一览（按域分组）

| 编号    | 域        | 需求摘要                                                     | 度量与验收                                                   | 优先级 | 关联         |
| ------- | --------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------ | ------------ |
| NFR-001 | 性能      | 首个内容模块渲染完成：P95 ≤ 2.5 s；平均 ≤ 1.2 s                | 线上 APM 5 分钟滚动窗口，按端到端口径；灰度与压测回归必须过线 | Must   | 1.6、16      |
| NFR-002 | 可用性    | 关键接口月度可用性 ≥ 99.9%（lookup、regenerate、history、export） | 合法请求 2xx/3xx 占比；维护窗口不计入                        | Must   | 13、14       |
| NFR-003 | 退化      | 依赖异常时 100% 自动降级为“基础释义 + 模板例句”，并在 UI 明示 | 演练与演习记录；依赖 5xx≥5% 且持续 1 min 触发熔断            | Must   | 1.4.7、13    |
| NFR-004 | 可扩展    | 单一实例水平扩展线性（QPS 翻倍，延迟 P95 增幅 ≤ 20%）        | 压测报告与容量曲线                                           | Should | 16           |
| NFR-005 | 一致性    | 幂等：查词与再生成在重试/回放场景仅一次生效                  | 幂等键 = hash(subject_id+lang_pair+entry_norm+config_hash+profile_etag) 命中率 100%                | Must   | 附录术语     |
| NFR-006 | 安全      | 传输与存储加密；最小权限 RBAC；敏感字段脱敏                  | TLS1.2+、AES-256 at-rest、密钥轮转 ≥ 90d                     | Must   | 12           |
| NFR-007 | 隐私      | 无痕查询不落库原文与结果；用户可导出/删除                    | 黑盒审计与数据抽查为 0；导出回执 ≤ 5 s                       | Must   | 1.4、1.6、12 |
| NFR-008 | 观测      | 全链路 trace_id 贯穿前后端与第三方                           | 99% 请求具备 trace_id；日志与指标三分法齐全                  | Must   | 14、术语     |
| NFR-009 | 维护      | 零停机发布；支持灰度/回滚/契约回放 ≥ 500 样本                | 发布手册与 CI 记录；契约回放通过率 100%                      | Must   | 21、22、术语 |
| NFR-010 | 兼容      | 浏览器与设备兼容矩阵按[第 17 章](<./第 17 章 兼容性与客户端支持矩阵.md>)执行；降级不失能               | 兼容清单通过；关键路径功能可用                               | Must   | 18           |
| NFR-011 | i18n/a11y | UI 语言 zh/en；WCAG 2.1 AA 基线                              | 键盘可达、语义标签、对比度达标                               | Must   | 15           |
| NFR-012 | 成本      | 单次查词平均 tokens_out 控制在预算内；成本报表按日对账       | 成本/请求统计；对账差异 ≤ 1%                                 | Should | 10、术语     |
| NFR-013 | 合规      | 日志与审计可追溯、不可篡改；子处理者清单留档                 | 审计抽样可回放；DPA/SCC 留存                                 | Must   | 12、附录     |

------

## 6.3 性能与容量

> 与[第 1 章「成功标准与关键指标」](<./第 1 章 引言.md#16-成功标准与关键指标>)的目标一致，并细化配额内的端到端性能预算与接口级 SLO。

### 6.3.1 端到端预算（单次查词 Lookup）

| 分段                         | 预算与阈值                                | 验收口径                         |
| ---------------------------- | ----------------------------------------- | -------------------------------- |
| 前端交互与输入校验           | P95 ≤ 100 ms                              | Web Vital + 自测                 |
| 边缘/网关（TLS、鉴权、路由） | P95 ≤ 150 ms                              | APM 分段                         |
| 后端业务编排与缓存命中路径   | P95 ≤ 200 ms                              | APM 分段                         |
| Doubao API 调用（含重试）    | P95 ≤ 3000 ms；P99 ≤ 5000 ms；超时 5.0 s | 外呼指标                         |
| 结构化解析与裁剪             | P95 ≤ 100 ms                              | 解析器计时                       |
| 首个内容模块渲染（非骨架）   | P95 ≤ 2.5 s；平均 ≤ 1.2 s                | 端到端（首个模块渲染完成）       |

> 首个内容模块指实际释义/例句等内容块完成渲染（非骨架 UI），用于端到端性能验收。

**NFR-014（Must）**：缓存命中率基线

- L1（用户级）命中率≥40%，TTL 10 min；L2（共享）命中率≥20%，TTL 30 min。命中则跳过外呼，首屏 P95 ≤ 1.2 s。

**NFR-015（Should）**：并发容量基线

- 初始目标：稳定支撑 300 QPS 查词，突发桶 3 倍，5 分钟内恢复。达到后端到端 P95 不超过 2.5 s。容量翻倍需 1 小时内完成扩容无中断。

### 6.3.2 关键接口 SLO

| 接口             | SLI（成功率） | 延迟 P95   | 备注                             |
| ---------------- | ------------- | ---------- | -------------------------------- |
| POST /lookup     | ≥ 99.9%       | ≤ 2.5 s    | 首屏口径                         |
| POST /regenerate | ≥ 99.5%       | ≤ 3.0 s    | 受再生成配额限制                 |
| GET /history     | ≥ 99.9%       | ≤ 800 ms   | 翻页不落盘重算                   |
| POST /exports    | ≥ 99.0%       | 生成 ≤ 5 s | 返回 202 + 回执，轮询拿一次性链接（TTL 10 min） |

------

## 6.4 可用性、可靠性与故障处理

**NFR-016（Must）**：月度可用性

- 关键接口月度可用性≥99.9%，不含事先公告的维护窗口。超出误差计入错误预算，触发升级与纠偏。

**NFR-017（Must）**：熔断与降级

- 条件：依赖 5xx≥5% 且持续 1 分钟，或外呼超时>阈值。动作：启用半开探测，回退到“基础释义 + 模板例句”，UI 显示“已降级”提示。恢复：半开 3 次成功后闭合。

**NFR-018（Should）**：重试与幂等

- 外呼采用指数退避重试≤2 次；服务端通过幂等键确保重试与回放不重复计费与落库。

**NFR-019（Must）**：数据保护

- 历史记录“逻辑删除”即时可见；物理清理延迟 7 d 可恢复，删除前窗口可撤回。

------

## 6.5 安全与隐私基线

**NFR-020（Must）**：传输与存储加密

- 外部与内部流量统一 TLS1.2+；静态数据 AES-256；密钥集中管理与≥90 天轮转。

**NFR-021（Must）**：最小权限与 RBAC

- 后台导出与审计操作需要角色授权；访问令牌作用域最小化，过期自动失效。

**NFR-022（Must）**：敏感信息处理

- 账号、订单、支付标识与个人信息脱敏存储与日志屏蔽；日志禁止原文词条落库于“无痕查询”场景。

**NFR-023（Must）**：隐私与数据主体权利

- 用户可导出/删除全部历史；导出支持 CSV/JSON，202 + 查询在 P95 ≤ 5 s 内拿到下载链接（TTL 10 min）。

**NFR-024（Should）**：内容策略

- 敏感词拦截命中即拒绝并审计，不落库原文；策略与名单纳入合规清单。

------

## 6.6 数据一致性与完整性

**NFR-025（Must）**：一致性模型

- 写多读多场景采用最终一致性；导出、计费与订阅状态采用强一致或幂等补偿。

**NFR-026（Must）**：契约与版本

- 结构化契约采用语义化版本 glancy.dict.v1；不兼容变更遵循弃用期策略，并提供契约回放≥500 样本的回归校验。

------

## 6.7 可观测性与运维

**NFR-027（Must）**：三类信号完备

- 指标（SLI：可用性/延迟/错误率/配额命中）、日志（脱敏、结构化）、链路（trace_id 贯穿第三方）。99% 请求需带 trace_id。

**NFR-028（Must）**：告警与抑制

- 告警基于阈值+速率+抑制，支持升级路径；错误率、延迟 P95 与配额异常告警必须配置静默与演练。

**NFR-029（Should）**：看板与报表

- 实时看板：SLO、缓存命中、依赖健康、成本/请求；日报含错误预算消耗与配额使用。

------

## 6.8 可维护性与发布

**NFR-030（Must）**：发布与回滚

- 零停机发布；灰度比例可配；出错自动回滚；版本策略与弃用期对齐[第 21 章](<./第 21 章 变更管理与版本策略（契约弃用期）.md>)。

**NFR-031（Must）**：测试与质量门禁

- 单元/契约/集成/端到端测试通过；契约回放样本≥500 条且通过率 100%；结构化输出正确率≥99%。

**NFR-032（Should）**：文档与可读性

- 运行手册、故障手册、Playbook 与 Runbook 完整；新人 1 天内可独立上线一次小变更。

------

## 6.9 兼容性、国际化与可访问性

**NFR-033（Must）**：兼容性

- 浏览器/系统支持矩阵按[第 17 章](<./第 17 章 兼容性与客户端支持矩阵.md>)执行；非支持环境需给出可读提示，不导致核心流程失效。

**NFR-034（Must）**：国际化

- UI 语言至少支持 zh、en；所有文案使用 i18n key 管理，禁止硬编码。默认跟随系统语言，可在设置切换。

**NFR-035（Must）**：可访问性

- 达到 WCAG 2.1 AA：键盘可达、焦点可见、语义标签、表格关联、ARIA 合理；颜色对比度达标；图标需替代文本。[第 15 章](<./第 15 章 国际化与可访问性.md>)细化验收项。

------

## 6.10 成本、配额与限流

**NFR-036（Must）**：配额与限速

- 查词与再生成分别计数；超限返回 429/RATE_LIMITED 并回传剩余额度、重置时间与 X-Quota-Reset-At；限流口径先用户级、再租户级、最后全局。

**NFR-037（Should）**：成本护栏

- 对每类请求记录 tokens_in/out；按日出具成本报表；与订阅状态对账的差异 ≤ 1%，异常 24 h 内结案。

------

## 6.11 依赖与第三方

**NFR-038（Must）**：依赖健康

- 对 Doubao API、登录与支付配置独立健康探针与速率保护；超时与错误触发熔断与降级；依赖状态纳入总看板。

**NFR-039（Must）**：回退方案

- 当外部不可用时，回退为“基础释义 + 模板例句”，并提示“已降级”；恢复后自动回归高质量路径。

------

## 6.12 业务连续性（RPO/RTO 概览）

**NFR-040（Must）**：RTO/RPO 基线

- 历史记录与配置：RTO ≤ 30 min，RPO ≤ 5 min；导出任务：RTO ≤ 15 min。具体演练与备份在[第 13 章](<./第 13 章 可用性、容灾与备份.md>)细化。

------

## 6.13 NFR 验收清单（抽样）

| 步骤 | 验收项   | 通过条件                                                     |
| ---- | -------- | ------------------------------------------------------------ |
| A    | 压测     | 300 QPS、10 分钟、错误率 < 0.1%、端到端 P95 ≤ 2.5 s          |
| B    | 降级演练 | 人为拉高依赖 5xx 与超时，UI 出现“已降级”，结果不为空，日志记录熔断与恢复 |
| C    | 幂等回放 | 对同一幂等键重复提交 3 次，仅一次计费与落库                  |
| D    | 隐私抽查 | 无痕查询场景日志与持久化均无原文                             |
| E    | 可访问性 | 键盘 Tab 全路径可达，NVDA/VoiceOver 可朗读，颜色对比度工具通过 |
| F    | 导出回执 | 触发导出，≤5 s 返回一次性下载链接与回执号，TTL 到期失效      |

------

> 说明：本章作为非功能性“上限与红线”，后续章节若给出更严的约束，以更严者为准；若给出更宽的约束，以本章为准，除非评审通过并在版本策略中声明弃用期。

------