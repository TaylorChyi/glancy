# 第 14 章 可观测性与运维（日志、监控、告警、SLO）

> 目的：定义 Glancy 的**三类信号**（指标/日志/追踪）与端到端可观测性架构、SLI/SLO、告警与错误预算、演练与值班机制，使系统在满足既有性能与可靠性门槛下可诊断、可预警、可回溯、可验收；并严格对齐文档中的范围、接口契约、数据治理、配额与降级策略。相关术语与阈值口径以附录与既有章节为单一事实源（SSoT）。

------

## 14.1 适用范围与对齐关系

- **覆盖对象**：Web/H5 前端、API 网关、BFF/应用层、适配层（Doubao）、异步任务（导出/清理）、缓存与数据库、成本与配额流水线。对“订阅与账单”域仅做状态与事件级观测，不介入计费逻辑。
   关联：产品目标与成功指标（端到端 P95、结构化正确率等）作为体验类 SLO 上位约束。
- **对齐章节**：NFR 观测与告警（NFR‑027/028/029）、错误预算口径、零停机发布与回滚（NFR‑009/030）、降级与熔断（NFR‑017）、配额与成本看板（第 10 章）。
- **契约与数据**：`X-Trace-Id`/`Idempotency-Key`/RateLimit 与 Quota 头、错误模型与码表、匿名会话与主体 ID、导出链接 TTL 口径一律按接口契约执行；日志与审计落库规则按数据模型与留存策略执行。
- **角色与权限**：观测与后台看板仅对“系统管理员/合规审计员/运营管理员”开放相应最小权限视图。

------

## 14.2 总体架构与数据流（Three Signals）

**原则**：统一追踪上下文、最小可识别信息、可回放与演练友好、与降本策略协同。与第 7 章“观测与告警”组件职责一致，由应用层埋点、网关打点、适配层计量，集中进入观测管线。

1. **Trace（链路追踪）**
   - 贯穿前端→网关→BFF/应用→适配层→第三方（Doubao）→存储/队列，统一 `trace_id` 与 `span_id`；前端将 `X-Trace-Id` 回传并在 UI 暴露，用于客服对账。
   - 采样：基线 10% 按流量采样；错误/降级/高延迟请求强制 100% 保留。
2. **Metrics（指标）**
   - 以 SLI 维度聚合：可用性、延迟分位、错误率、配额/429 命中率、缓存命中、成本燃率、队列深度、熔断状态等；按接口和 Persona 关键路径切片。
3. **Logs（结构化日志）**
   - JSON 日志三分法：访问日志、业务事件（见 4.7 事件代码）、审计与安全事件。无痕查询严禁落原文；PII 字段脱敏或散列。

**数据流**（文字版）：前端 RUM 指标与 `X-Trace-Id` 注入 → 网关度量（鉴权/限流/路由） → 应用与适配层记录 tokens_in/out、缓存命中、降级位 → 异步任务（导出/清理）回执与事件 → 统一采集器 → 指标存储、日志存储、追踪存储与告警引擎。

------

## 14.3 SLI 定义与度量口径

> 下表为**度量定义**；SLO 目标见 14.4。度量口径与术语按附录统一，端到端延迟口径以“首个内容模块渲染完成”为准。

### 14.3.1 体验类（End‑to‑End）

| SLI                 | 定义                                              | 统计口径                     |
| ------------------- | ------------------------------------------------- | ---------------------------- |
| 首屏延迟 P95/均值   | 从 `POST /lookup` 到首个内容模块渲染完成时间      | 5 分钟滚动窗口；按端到端口径 |
| 再生成延迟 P95      | `POST /lookup/{id}/regenerate` 返回到例句区块刷新 | 5 分钟窗口                   |
| 导出完成 P95        | `POST /exports` 至可获取一次性下载链接            | 5 分钟窗口；P95 ≤ 5 s 验收   |
| 登录成功率          | 登录请求 2xx/3xx 占比                             | 月度                         |
| 订阅开通/续费成功率 | 订单支付成功占比                                  | 月度，订阅域 SLO 对齐        |

> 上述阈值承接 1.6 与 6.3/6.3.2 的基线与接口级预算。

### 14.3.2 系统与依赖类

| SLI           | 定义                            | 统计口径                   |
| ------------- | ------------------------------- | -------------------------- |
| 接口可用性    | `POST /lookup                   | /regenerate                |
| 错误率        | 5xx/总请求、统一错误码分布      | 5 分钟窗口                 |
| 429 命中率    | 429/总请求，区分 scope=user     | tenant                     |
| 缓存命中率    | L1/L2 命中/查词请求             | 5 分钟窗口；对齐命中率基线 |
| Doubao 健康度 | 依赖 5xx 比例、超时率、熔断状态 | 1 分钟窗口；熔断阈值统一   |
| 成本燃率      | 近 5 分钟成本/日预算            | 阈值联动降级动作           |
| 队列健康      | 导出/清理队列深度、等待时长     | 1 分钟窗口                 |

> 429、成本燃率、熔断与降级动作与第 10 章协同；熔断阈值“依赖 5xx≥5% 且持续 1 分钟”。

### 14.3.3 数据与合规类

- **审计完整性**：审计事件可回放率、下载链接 TTL 有效性、无痕查询零原文。
   口径按数据治理 9.7/9.13 与接口契约 TTL 约定。

------

## 14.4 SLO 目标与错误预算

> SLO 为**验收门槛**；默认按自然月统计。与 NFR 的目标一致或更严者优先采用更严值。

| 类别       | 对象                  | SLO 目标              | 备注           |
| ---------- | --------------------- | --------------------- | -------------- |
| 可用性     | lookup/history/export | 月度可用性 ≥ 99.9%    | 维护窗口不计入 |
| 延迟       | 首屏 P95              | ≤ 2.5 s；平均 ≤ 1.2 s | 端到端口径     |
| 再生成 P95 | ≤ 3.0 s               | 接口级                |                |
| 导出       | 完成 P95 ≤ 5 s        | 含回执与一次性链接    |                |
| 缓存       | L1≥40%，L2≥20%        | 命中则跳过外呼        |                |
| 成本       | 燃率 ≤ 1.2× 日预算    | 阈值驱动降级          |                |

- **错误预算**：
  - 99.9% 月度可用性错误预算 ≈ 43 分 12 秒/30 天；消耗 ≥ 50% 进入变更冻结；≥ 75% 触发高压值班；当月耗尽停止非紧急变更并回滚最近一版。
  - 接口级 99.5%（如 regenerate）对应预算 ≈ 216 分钟/30 天，仅用于该接口。
- **预算归档**：每月生成“预算消耗报告”，纳入发布评审输入。

### 14.4.1 错误预算消耗日报

- **日报节奏与阈值**：工作日每日 09:30 由平台自动生成《错误预算消耗日报》，覆盖全部 SLO 指标；当日消耗 ≥ 5% 或累计 ≥ 40% 时追加红色标记并推送到 SRE/研发群；累计 ≥ 50% 自动触发“发布冻结”流程，累计 ≥ 75% 需进入“高压值班”并将灰度放量控制在 20% 以下，累计 =100% 时仅允许紧急修复且需在 4 小时内回滚最近一次非紧急变更。
- **模板（示例）**：

  | 日期 | 指标 | 月度预算 | 当日消耗 | 累计消耗 | 趋势（7 日） | 所在阶段 | 动作 | 责任人 |
  | ---- | ---- | -------- | -------- | -------- | ------------ | -------- | ---- | ------ |
  | 2025-05-18 | lookup 月度可用性 | 43m12s | 2m10s（5.0%） | 17m05s（39.5%） | ↗ | 正常 | 关注 | oncall@glancy |
  | 2025-05-18 | regenerate 接口可用性 | 216m | 8m（3.7%） | 120m（55.6%） | ↗↗ | 冻结 | 灰度暂停/评估回滚 | release_mgr |

- **准入与联动**：日报在每日 10:00 前同步到发布评审系统；当“所在阶段”进入“冻结”或以上时，灰度策略（见 14.9）需自动限制放量，新的灰度申请必须附日报截图且经平台负责人审批；若“动作”列标记为“评估回滚”或“回滚”，发布系统需在 30 分钟内执行自动回滚或提交人工确认。

> 接口与端到端延迟口径、缓存命中基线与 NFR/性能预算一致。

------

## 14.5 指标体系与看板

**看板分层**（示例）：

1. **总览**：SLO 达成、错误预算、端到端 P95、错误率、429 率、L1/L2 命中、成本燃率、依赖健康。
2. **接口视图**：按 `POST /lookup`、`/regenerate`、`GET /history`、`POST /export` 展示成功率与分位延迟。
3. **依赖视图**：Doubao 成功率、超时、CB 状态与半开恢复轨迹。
4. **配额与限流**：用户/租户/全局 429 命中热力、重置时间分布、重试后成功比。
5. **成本与 tokens**：tokens_in/out、单请求成本 P95、队列深度与导出耗时。
6. **审计与合规**：下载链接 TTL 命中率、无痕零原文抽查、角色变更事件。

### 14.5.1 SLI 指标配置与告警映射

| 指标名称 | 数据源/聚合口径 | 阈值与持续时间 | 告警等级与通道 | 静默与恢复策略 |
| -------- | ---------------- | --------------- | -------------- | --------------- |
| 关键接口可用性 (`/lookup /regenerate /history /export`) | 黑盒探针成功率，5 分钟滚动平均，按接口拆分 | < 99.5%（5 分钟）P1；< 99.7%（15 分钟）P2 | P1：语音+IM；P2：IM+值班看板 | 发布窗口启用升阈静默，恢复到 ≥99.9% 且持续 30 分钟自动闭环 |
| 首屏 P95 延迟 | RUM + APM，5 分钟 P95 | > 2.5 s（连续 3 个窗口）→ P1；> 2.3 s（连续 6 个窗口）→ P2 | 统一告警平台，抄送前端与后端负责人 | 灰度期间白名单静默；恢复到 ≤ 2.3 s 且下降趋势后解除 |
| Doubao 依赖 5xx/熔断 | 适配层指标，1 分钟窗口；5xx 比例与熔断状态 | 5xx ≥ 5% 且 1 分钟 → P1；进入熔断态即 P1；半开失败 3 次 → P1 | 语音+IM，自动同步 Runbook | 人工确认熔断关闭并通过 3 次成功探测才解除；维护窗口静默 |
| L1/L2 缓存命中率 | BFF 指标，5 分钟窗口，区分线路 | L1 < 40% 或 L2 < 20% 持续 10 分钟 → P2 | IM+成本看板 | 成本燃率告警触发后静默 15 分钟避免重复；命中率 ≥目标 +5% 持续 30 分钟自动解除 |
| 导出回执 P95 | 任务队列 + API 指标，5 分钟 P95 | > 5 s 持续 3 个窗口 → P3 | IM | 手工确认积压清零后解除；部署期间可配置 30 分钟静默 |
| RDBMS 复制延迟 | 数据库指标，1 分钟最大延迟 | > 30 s 持续 5 分钟 → P2；> 60 s → P1 | DBA 值班短信+IM | 计划内维护静默，延迟 < 15 s 持续 15 分钟自动关闭 |
| 成本燃率 | 成本流水线，5 分钟窗口 | > 1.5× 日预算 → P2；> 1.8× → P1 | IM+运营抄送 | 与降级动作联动（10 分钟内复核）；恢复到 ≤ 1.2× 且连续 3 个窗口后解除 |
| 错误预算消耗 | 日报系统，按自然日累计 | 当日消耗 ≥ 5% 发送提醒；累计 ≥ 50% → 冻结告警；≥ 75% → 高压升级 | IM+邮件+发布系统红线 | 维护窗口不计入；当月清零自动解除 |

### 14.5.2 合成探针（正常/降级双线路）

- **覆盖路径**：
  - **正常线路**：通过公网入口触发 `/lookup`，要求调用 Doubao 正常返回，校验内容块完整、`degraded=false`。
  - **降级线路**：通过强制注入熔断标头或模拟依赖降级环境，验证回退到“基础释义 + 模板例句”，并校验响应体包含 `degraded=true` 与降级提示 UI 文案。
- **执行策略**：双线路每 2 分钟各执行一次，使用相同的探针框架；探针采集成功率、首屏 P95 与降级标识准确率，指标写入“关键接口可用性”与“降级可用率”维度，纳入 5 分钟聚合窗口。
- **告警与静默**：正常线路失败同“关键接口可用性”规则；降级线路失败（即无法正常降级或未打标）持续 5 分钟触发 P1 并提示检查熔断配置；维护窗口与已知演练场景可配置逐线路静默，静默时需在 Runbook 留痕。

------

## 14.6 日志规范（结构化、脱敏、回放）

### 14.6.1 统一字段

```json
{
  "ts":"2025-11-11T08:00:00Z",
  "lvl":"INFO|WARN|ERROR",
  "trace_id":"3bd2f9...",
  "span_id":"a1b2...",
  "route":"POST /api/v1/lookup",
  "subject_id":"u_xxx|s_xxx",
  "user_id":"<uuid>|null",
  "lang_pair":"en-zh",
  "entry_hash":"sha256(entry_norm)", 
  "cache":"L1|L2|MISS",
  "latency_ms": 820,
  "tokens_in":321,
  "tokens_out":512,
  "quota":{"type":"lookup","remaining":88},
  "degraded":false,
  "error":{"code":null}
}
```

- 原文与 PII：严禁记录无痕原文；用户邮箱、订单号等按数据分级 S2/S3 做脱敏。
- 追踪：`trace_id` 必填；与接口契约 `X-Trace-Id` 对齐。

### 14.6.2 业务事件日志

- 采用第 4 章事件代码，如 `query.request`/`query.success`/`history.export` 等，序列化为 JSON 并入观测流水线。

### 14.6.3 日志级别与采样

- `ERROR` 永不采样；`WARN` 采样上限 50%（动态下调）；`INFO` 按 QPS 自适应采样（默认 10%）。
- 发生熔断/降级/预算越界时，临时将相关路由 `INFO` 采样提至 50%。

### 14.6.4 保留与归档

- 访问与应用日志：30 天；追踪：7–14 天；指标：90 天；审计日志：≥365 天并不可篡改。与 9.7 留存、9.10 脱敏一致。

------

## 14.7 告警策略（阈值、抑制、升级）

### 14.7.1 分级与响应

| 严重级 | 条件示例                                                   | 首次响应  | 目标恢复 |
| ------ | ---------------------------------------------------------- | --------- | -------- |
| P1     | 全局可用性 < 99%（15 分钟）或首屏 P95 > 5 s（连续 5 分钟） | 5 分钟内  | 30 分钟  |
| P2     | 429 全局 > 3%（5 分钟均值）；成本燃率 >1.5×（5 分钟）      | 10 分钟内 | 1 小时   |
| P3     | L1/L2 命中率低于目标 10 分钟；导出 P95 > 5 s               | 30 分钟内 | 当天     |

> 429、成本燃率与命中率阈值与第 10 章对齐；告警/抑制要求与 NFR‑028 对齐。

### 14.7.2 告警规则（摘录）

- **可用性**：关键接口 5xx 比例 > 0.5% 且 5 分钟平均 > 阈值 → P1 告警。
- **熔断**：依赖 5xx≥5% 且 ≥1 分钟 → 进入 CB 打开态并触发 P1；半开 3 次成功自动闭合仅记录 P2。
- **预算**：错误预算当月消耗 > 50% → 发布冻结通知；> 75% → 高压；=100% → 仅安全修复。
- **降级执行**：全局预算达 95% 或燃率 > 1.5× → 自动关闭“再生成”，查词强走缓存/简化路径。

### 14.7.3 抑制与维护窗口

- 维护窗口内（公告且不计入 SLO）对易抖动指标执行静默；相同事件在 2 分钟内去重合并；部署期间启用“升阈静默”。

------

## 14.8 降级、熔断与演练

- **自动降级路径**：回退“基础释义+模板例句”，UI 显示退化提示；不计入生成配额。熔断阈值、半开恢复、退化提示与缓存策略与既有定义一致。
- **演练频率**：每月一次“依赖故障演练”，按 NFR 验收清单验证 UI 提示、链路记录与恢复流程。

------

## 14.9 发布守门与回放

- **契约回放**：每次发布合并 ≥500 条契约样本，100% 通过方可放行；失败自动回滚。
- **零停机与灰度**：蓝绿/小流量，异常自动回滚；发布期间 SLO 受控且误报抑制。

------

## 14.10 值班机制与事件响应（IR）

- **值班与升级**：7×12 小时轮值，P1 10 分钟内语音升级到后端负责人与平台负责人；订阅域问题同步通知计费负责人（权益 5 s 内一致）。
- **Runbook**：对 P1/P2 事件需在工单内附“故障手册”链接（熔断开关/特性开关、缓存降级、限流调参、回滚步骤）。
- **Postmortem**：48 小时内完成无责复盘，输出改进项（监控/阈值/自动化/容量）并纳入下一迭代。

------

## 14.11 采样、成本与数据最小化

- **观测成本护栏**：观测侧存储/流量成本 ≤ 总成本 10%；达阈自动下调正常流量追踪采样比与 INFO 采样比，保留异常全量。
- **数据最小化**：无痕查询仅记配额计数与观测指标，不落正文；导出/下载仅落回执与一次性链接（TTL 10 分钟）。

------

## 14.12 前后端协作与埋点清单（摘录）

- **前端（Web/H5）**：
  - 上报 `ttfb/cls/lcp/fcp` 与“首个内容模块渲染完成”；提交/返回均透传 `X-Trace-Id`；当 `degraded=true` 时呈现退化徽标与文案。
- **后端**：
  - 在 `POST /lookup`、`/regenerate` 命中缓存时带 `X-Cache: HIT|MISS`；输出 `X-RateLimit-*` 与 `X-Quota-*` 头并镜像 `quota` 对象。
- **事件**：统一发射 4.7 的事件代码，带 `trace_id` 与必要脱敏字段。

------

## 14.13 数据留存与权限

- **留存周期**：日志/追踪/指标/审计按 14.6.4 执行；历史、配额与审计表的持久化留存遵循 9.7。
- **权限**：RBAC 最小权限；运维/客服仅见脱敏视图；导出与审计操作强制二次确认与审计。

------

## 14.14 验收标准与测试（对齐 NFR 与 UC）

| 编号   | 验收项         | 通过条件                                                     |
| ------ | -------------- | ------------------------------------------------------------ |
| OBS‑01 | 全链路追踪覆盖 | ≥99% 请求具备 `trace_id`，前后端/第三方贯通                  |
| OBS‑02 | SLO 看板       | 可用性/延迟/错误/429/命中率/燃率看板与阈值齐备，刷新 ≤ 10 s  |
| OBS‑03 | 降级演练       | 注入 Doubao 5xx≥5% 持续 1 分钟，自动熔断并显示退化提示，半开 3 次恢复 |
| OBS‑04 | 预算护栏       | 全局燃率 >1.5× 自动关闭“再生成”，查词走缓存/简化路径         |
| OBS‑05 | 无痕合规       | 无痕查询日志与持久化均无原文，抽查为 0                       |
| OBS‑06 | 回放与回滚     | ≥500 条契约样本回放通过；异常自动回滚成功                    |

> 验收口径复用 NFR‑027/028/029、NFR 验收清单与 UC‑14（降级与熔断回退）。

------

## 14.15 变更与文档

- **变更管理**：观测指标与阈值变更纳入配置中心版本化；重大变更走发布评审与灰度；接口与事件字段变更遵循契约版本策略。
- **文档与培训**：运行/故障手册与 Runbook 全量存档，满足 NFR‑032“新人 1 天内可独立上线一次小变更”。

------

### 附：对象与字段对照（用于埋点与回放）

- **接口字段**：`X-Trace-Id`、`Idempotency-Key`、`X-RateLimit-*`、`X-Quota-*`、错误码与 `error.meta.kind`。
- **数据对象**：`lookups/results/regenerations/quota_daily/audit_events` 与其关键索引，用于事件回放与问题定位。
- **订阅事件**：`subscription.activated|renewed|expired|canceled|refunded` 与 5 s 权益同步 SLO，用于消费侧连通性监控。

> 本章至此，构成“可观测性与运维”的实施与验收基线，并与第 1–11 章的范围、契约、数据与配额完全对齐；如有冲突，以 SSoT 章节为准并通过变更流程修订。