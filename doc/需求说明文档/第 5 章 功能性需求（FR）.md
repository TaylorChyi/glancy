# 第 5 章 功能性需求（FR）

> 说明：本章为 MVP 阶段可交付的功能清单，使用 FR-XXX 编号与 Must/Should/Could/Will not 优先级。所有功能均以[第 1 章 引言](<./第 1 章 引言.md>)的范围、分层能力、配额与数据控制为追溯依据。

## 5.0 章节六段式概览

| 段落     | 摘要                                                                 | 关联小节 |
| -------- | -------------------------------------------------------------------- | -------- |
| 问题背景 | 需要把 UC 主路径转化为可交付的 FR 清单，确保语言、输入、缓存、降级、配额、订阅等规则可执行。 | 全章     |
| 目标     | 以统一模板定义查词、输出、历史、画像、账户/订阅、配额/限流、设置、生成依赖、合规与支付等 FR，形成 UC→FR→AC 映射。 | 5.1–5.12 |
| 范围     | 覆盖最小查词体验到后台对账的 12 大类 FR，共 28 条。                     | 5.1–5.12 |
| 约束     | 每条 FR 均遵循“触发→约束→结果→验收引用”模板，口径以 SSoT（第 1、3、7、8、11 章等）为准，禁止在此重复数值。 | 5.1 开头、5.2–5.11 |
| 依赖     | 依赖 UC（第 4 章）、架构（第 7 章）、接口契约（第 8 章）、订阅矩阵（第 11 章）、性能/NFR（第 6/13–16 章）。 | 4.4、7.2、8、11、6 |
| 验收引用 | 每条 FR 链接对应的[第 20 章 AC 锚点](<./第 20 章 验收标准与测试方案（UC 对齐）.md#2018-验收锚点索引（uc--fr--nfr）>)，并在 20.7/20.17 的测试中落地。 | 20.18 |

------

## 5.1 查词请求与校验

> 模板：每条 FR 按“触发 → 约束 → 结果 → 验收引用”组织，优先级体现在标题括号，验收锚点在[第 20 章](<./第 20 章 验收标准与测试方案（UC 对齐）.md>)以 `AC-FR-*` 命名。

> **图示（查词主路径）**：FigJam [node 230-20](https://www.figma.com/file/glancy-sdd-figjam?type=whiteboard&node-id=230-20#LookupSequence) / PlantUML 源 [`doc/图/src/sequence-lookup.puml`](../图/src/sequence-lookup.puml)。

<details>
<summary>查看查词主成功/降级时序</summary>

```plantuml
!include ../图/src/sequence-lookup.puml
```

</details>

### FR-001 语言对白名单与同语模式（Must）

- **触发**：用户在 UC-01/UC-12 中提交查词或切换语言对。
- **约束**：仅允许 L1–L4（zh↔en、en→en、zh→zh）；同语模式不暴露 translation 字段，且不提供“临时展开”。
- **结果**：若语言对不在白名单，则前端阻止提交并提示可选语言，对绕过前端的请求返回 `ENTRY_NOT_SUPPORTED_LANG_PAIR`；合法请求中译文缺省逻辑依语言对即时生效。
- **验收引用**：[AC-FR-001](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-001>)（映射 TC-API-002）。

### FR-002 输入类型与句子拦截（Must）

- **触发**：用户在输入框提交文本或在无痕模式中尝试通过 API 直接调用 lookup。
- **约束**：输入必须为单词/词组；句子判定遵循[第 8 章 8.10](<./第 8 章 接口与数据契约（APISchema）.md#8100-句子输入判定规范>); 前端基于长度/标点/停用词（硬规则）与语言模型评分（软规则）即时校验。
- **结果**：命中句子规则时阻止提交并提示“请改为词或词组”，保留原输入供编辑；服务端对绕过前端的整句请求返回 4xx `ENTRY_NOT_WORD_OR_PHRASE`，错误体含 `error.hint`。
- **验收引用**：[AC-FR-002](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-002>)（映射 TC-API-001）。

### FR-003 语言识别与不确定性确认（Should）

- **触发**：输入语言与所选语言对不一致或未显式指定语言对。
- **约束**：对输入执行 LID，p≥0.8 自动决定；0.6≤p<0.8 时弹出确认；p<0.6 拒绝并提供改写建议。
- **结果**：用户确认后方可发起查询；拒绝时返回可操作指引并记录 `lid_confidence` 事件。
- **验收引用**：[AC-FR-003](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-003>).

### FR-004 查词幂等与重试（Must）

- **触发**：同一主体在短时间内重复点击“查询”或前端超时后重试。
- **约束**：幂等键 `hash(subject_id + lang_pair + entry_norm + config_hash + profile_etag)` 必须命中；重试不应重复计费/落库/计配额。
- **结果**：3 秒内重复提交返回同一响应，历史列表仅新增 1 条记录，查词配额不重复扣减。
- **验收引用**：[AC-FR-004](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-004>).

------

## 5.2 输出结构与渲染

### FR-010 释义与义项（Must）

- **触发**：UC-01 渲染结果页或 UC-12 切换语言对后重新查询。
- **约束**：默认展示 3 个义项，按相关性排序；详略级别默认为“中”，字符上限遵循统一表（中文 ≤150，英文 ≤220）。
- **结果**：返回结构字段齐全，展开查看更多时保持原排序稳定；模块失败不影响其他模块渲染。
- **验收引用**：[AC-FR-010](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-010>).

### FR-011 个性化例句与控制项（Must）

- **触发**：UC-01 渲染例句或 UC-02/UC-03 触发再生成/风格切换。
- **约束**：例句条数、再生成次数、难度/风格选项由订阅档位定义（引用[第 11 章](<./第 11 章 订阅、计费与账单.md>)）；同语模式不返回译文；切换视作一次再生（不计查词）。
- **结果**：切换“更简单/更难”“口语/商务/学术”等时仅例句模块刷新；超出配额返回 `RATE_LIMITED` 并提示剩余额度与重置时间。
- **验收引用**：[AC-FR-011](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-011>).

### FR-012 搭配、同反义词、派生词族（Must）

- **触发**：UC-01 渲染模块或 UC-03/UC-12 触发重查。
- **约束**：默认条数：常见搭配/固定搭配各 ≥3 条，同/反义词各 ≥4 条，派生与词族 ≥2 条；去重并按相关性排序，展开“更多”分页加载但不重排已渲染内容。
- **结果**：模块输出遵循统一 schema，缺项时以空集合呈现；展开不影响其他模块状态。
- **验收引用**：[AC-FR-012](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-012>).

### FR-013 模块开关、顺序与详略自定义（Must）

- **触发**：UC-07 用户调整设置或 Pro 用户对单词设置词条级偏好。
- **约束**：Free 仅支持开关；Plus/Pro 支持排序+详略，Pro 额外支持词条级偏好；详略级别映射统一字符上限；设置需跨端同步。
- **结果**：拖拽或切换后刷新即生效；词条级偏好应用于对应单词的后续查询，写入画像并触发缓存失效。
- **验收引用**：[AC-FR-013](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-013>).

### FR-014 频率与考试标签（Will not，MVP）

- **触发**：UI 渲染结果页时定位到保留位。
- **约束**：仅保留灰态占位，无数据请求与交互；任何引用需提示“暂不实现”。
- **结果**：不影响布局，并为后续版本预留空间。
- **验收引用**：[AC-FR-014](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-014>).

------

## 5.3 历史记录与数据控制

### FR-020 历史留存与上限（Must）

- **触发**：UC-04/UC-05/UC-06 或后台调度需要读取历史。
- **约束**：留存天数与条数按订阅档位（见[第 11 章](<./第 11 章 订阅、计费与账单.md>))控制；超限滚动清理；无痕模式不写入本地与后端。
- **结果**：响应体返回剩余条数与 `quota` 镜像；启用无痕后查询仅渲染不落库；滚动清理记录 `history.eviction` 事件以供审计。
- **验收引用**：[AC-FR-020](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-020>).

### FR-021 历史清理与分组（Must）

- **触发**：用户在 UC-05 中选择“清理 zh 组/清理 en 组/全部清空”。
- **约束**：必须二次确认；逻辑删除即刻，物理清理延迟 7 天；撤回窗口在物理清理前有效。
- **结果**：操作完成后 ≤5 s 返回回执号；撤回窗口内可提交恢复；清理范围与操作人写入审计日志。
- **验收引用**：[AC-FR-021](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-021>).

### FR-022 数据导出（Must）

- **触发**：UC-06 触发导出任务或后台补发链接。
- **约束**：Free 提供 CSV；Plus/Pro 额外支持 JSON（Pro 允许条件过滤/批量导出）；导出产物脱敏、UTF-8 带表头；对象存储链接 TTL 10 分钟且一次性。
- **结果**：`POST /exports` 返回 202，携带 `exportId/receiptId`；P95 ≤ 5 s 内通过轮询得到下载链接；降级时响应体含 `degraded=true` 与原因。
- **验收引用**：[AC-FR-022](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-022>).

> 图示：FigJam [node 230-40](https://www.figma.com/file/glancy-sdd-figjam?type=whiteboard&node-id=230-40#ExportSequence) / PlantUML 源 [`doc/图/src/sequence-export.puml`](../图/src/sequence-export.puml)。

<details>
<summary>查看导出任务与一次性链接时序</summary>

```plantuml
!include ../图/src/sequence-export.puml
```

</details>

------

## 5.4 个性化画像与风格偏好

### FR-030 画像采集与编辑（Must）

- **触发**：UC-07 设置画像或首次登录引导。
- **约束**：采集字段（学习目标、专业背景、年龄层次、当前水平、语言对、风格标签）遵循[第 3 章 3.5](<./第 3 章 用户画像与角色.md#35-画像字段、采集与使用规则>)；风格标签数量随档位（Free≤3、Plus≤5、Pro≤8）；支持多选排序并可撤回同意。
- **结果**：修改后下一次查询即生效，本地缓存与后端保持一致；撤回后清空画像并回退到默认模板。
- **验收引用**：[AC-FR-030](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-030>).

### FR-031 画像驱动的生成控制（Should）

- **触发**：存在画像字段且用户触发查词或再生成。
- **约束**：画像字段需映射至 Prompt 控制项；若画像为空则使用通用模板；画像变更需记录 `profile_etag` 并触发缓存失效。
- **结果**：当前水平驱动可读性映射，例句与模块排序随画像变化；追踪信息写入 trace 方便回放。
- **验收引用**：[AC-FR-031](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-031>).

------

## 5.5 账户与订阅

### FR-040 账户注册与登录（Must）

- **触发**：UC-10 用户通过邮箱或第三方（微信/Apple/Google）登录。
- **约束**：登录成功率 ≥99%；首次登录必须展示条款/隐私并记录审计；用户可在设置页撤回同意，撤回后必须触发降权与清理入口。
- **结果**：登录成功即建立会话并同步画像初值；撤回同意后立即关闭历史留存并提示能力变化。
- **验收引用**：[AC-FR-040](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-040>).

### FR-041 订阅状态与能力同步（Must）

- **触发**：UC-08 成功支付或 UC-09 到期/降级、退款事件。
- **约束**：支付成功回调 ≤3 s 内完成档位切换；状态机遵循[第 11 章](<./第 11 章 订阅、计费与账单.md>)；需具备幂等更新与对账兜底。
- **结果**：权限即时生效或降级，配额/历史/模块自定义随档位同步；异常回调自动重放。
- **验收引用**：[AC-FR-041](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-041>).

> 图示：FigJam [node 230-60](https://www.figma.com/file/glancy-sdd-figjam?type=whiteboard&node-id=230-60#SubscriptionSequence) / PlantUML 源 [`doc/图/src/sequence-subscription.puml`](../图/src/sequence-subscription.puml)。

<details>
<summary>查看订阅购买/回调/权益同步时序</summary>

```plantuml
!include ../图/src/sequence-subscription.puml
```

</details>

### FR-042 账单与收据展示（Must）

- **触发**：UC-15 访问账单页或下载收据。
- **约束**：展示档位、生效/到期时间、订单号；服务端存 UTC，前端按本地渲染；历史订单可查询与导出。
- **结果**：提供下载链接（PDF/HTML）并记录访问日志。
- **验收引用**：[AC-FR-042](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-042>).

------

## 5.6 配额、限速与再生成

### FR-050 查词与再生成配额（Must）

- **触发**：任何查词或再生成请求抵达后端。
- **约束**：查词/再生成分开计数；按用户本地时区“自然日”在 00:00 重置；具体上限来自[第 11 章](<./第 11 章 订阅、计费与账单.md>)；所有响应需在 Header 返回 `X-RateLimit-*`、`X-Quota-*` 与 `X-Quota-Reset-At`。
- **结果**：超限返回 429 `RATE_LIMITED`，错误体在 `meta.kind` 区分 quota/ratelimit，并给出剩余额度与重置时间；响应体镜像 `quota` 对象。
- **验收引用**：[AC-FR-050](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-050>).

### FR-051 限速与突发控制（Should）

- **触发**：高并发查词/再生成/导出等写操作。
- **约束**：实现用户级、租户级、全局三级限流并支持突发桶；错误语义统一使用 `RATE_LIMITED`；Header 返回 `X-RateLimit-Limit/Remaining/Reset` 与 `X-Quota-Type/Remaining`。
- **结果**：限流命中后在 UI 呈现剩余冷却时间，日志记录限流类型用于可观测性。
- **验收引用**：[AC-FR-051](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-051>).

------

## 5.7 设置与客户端行为

### FR-060 主题、快捷键与界面语言（Must）

- **触发**：用户在设置页切换主题/快捷键/语言或首次进入页面。
- **约束**：主题支持浅色/深色/跟随系统；快捷键可自定义并需冲突检测；界面语言支持 zh/en 且覆盖率 100%。
- **结果**：主题切换无闪屏；快捷键保存后即时生效并跨端同步；语言切换后 UI 文案即时刷新。
- **验收引用**：[AC-FR-060](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-060>).

------

## 5.8 生成依赖、缓存与降级

### FR-070 Doubao API 适配与容错（Must）

- **触发**：UC-01/UC-02/UC-03 调用 LLM 生成释义或例句。
- **约束**：需封装重试、超时、错误语义化与结构化契约解析容错；当依赖 5xx ≥5% 且持续 1 分钟时进入熔断→半开→恢复闭环；降级输出“基础释义+模板例句”并标注退化提示。
- **结果**：降级请求不计入生成配额；恢复后自动切回高质量路径；所有状态变更上报可观测性。
- **验收引用**：[AC-FR-070](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-070>).

### FR-071 L1/L2 缓存（Should）

- **触发**：查词或再生成命中缓存策略。
- **约束**：L1（用户级）TTL 10 分钟、L2（共享级）TTL 30 分钟；Key=`hash(subjectId, lang_pair, entry_norm, config_hash, profile_etag)`；再生成默认绕过 L2。
- **结果**：命中时响应携带 `X-Cache` 标记并记录命中率；缓存过期自动淘汰，画像/档位变更触发失效。
- **验收引用**：[AC-FR-071](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-071>).

------

## 5.9 数据删除与合规

### FR-080 逻辑删除与物理清理（Must）

- **触发**：UC-05/UC-16 或后台合规删除触发删除操作。
- **约束**：逻辑删除即时对前端不可见；物理清理默认 T+7 天并可在窗口内恢复；所有操作必须留有回执号。
- **结果**：清理任务按期执行并记录 `history.cleanup` 事件；在恢复窗口内凭回执可找回；超期后不可恢复。
- **验收引用**：[AC-FR-080](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-080>).

### FR-081 条款与隐私管理（Must）

- **触发**：UC-10 首次登录或用户在 UC-16 撤回同意。
- **约束**：首次登录必须勾选条款/隐私才能继续；设置提供撤回入口并联动数据处理策略；不同意时仅允许离线浏览与退出。
- **结果**：同意/撤回状态可审计；撤回触发导出/删除指引与无痕模式；状态写入 `consent` 记录。
- **验收引用**：[AC-FR-081](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-081>).

------

## 5.10 支付、退款与异常

### FR-090 订阅开通与续费（Must）

- **触发**：UC-08 用户完成支付。
- **约束**：支付成功后 ≤5 s 内下发权益；失败/超时不更改原状态；异常回调需自动重放且具幂等。
- **结果**：订单状态、配额与能力保持一致；升级立即生效并同步至配额域。
- **验收引用**：[AC-FR-090](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-090>).

### FR-091 到期与降级处理（Must）

- **触发**：订阅到期、撤销或退款事件。
- **约束**：自动降级至 Free 并同步能力边界；超过新档位的自定义项需回退到默认；历史记录受新留存上限限制。
- **结果**：降级后立即更新配额与 UI 状态，并通知用户；不产生数据丢失。
- **验收引用**：[AC-FR-091](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-091>).

### FR-092 退款与异常对账（Should）

- **触发**：支付平台触发退款、拒付或对账异常。
- **约束**：状态与权限保持幂等同步；退款完成后档位恢复至到期前状态或 Free；账单需保留痕迹。
- **结果**：异常自动对账并补偿更新；产生的对账记录可追溯。
- **验收引用**：[AC-FR-092](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-092>).

------

## 5.11 端到端性能与首屏体验（与 NFR 对齐的功能侧要求）

### FR-100 首屏渐进渲染（Should）

- **触发**：UC-01 渲染结果页。
- **约束**：释义区块优先渲染，例句/搭配随后加载；单区块失败不阻塞其他区块；遵循 P95 ≤ 2.5 s、平均 ≤ 1.2 s 的端到端预算。
- **结果**：最先的内容块在预算内呈现；各区块提供独立错误提示与重试入口。
- **验收引用**：[AC-FR-100](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-100>).

------

## 5.12 用例映射与验收清单（概览）

> 详细 UC 场景见[第 4 章 业务流程与用例](<./第 4 章 业务流程与用例.md>)；本节为 FR 到 UC 的检查点总览，供测试编排。

| FR 编号 | 关键用例（UC 概览）       | 期望结果（摘录）                      |
| ------- | ------------------------- | ------------------------------------- |
| FR-001  | 选择语言对并查询          | 非白名单拒绝；同语模式无译文          |
| FR-002  | 输入整句触发拦截          | 前端阻止提交，服务端 4xx              |
| FR-011  | 切换例句难度/风格与再生成 | 仅例句区刷新；配额随档位递减          |
| FR-020  | 历史留存与无痕查询        | 无痕不写库；超限滚动清理              |
| FR-022  | 导出 CSV/JSON             | ≤5 s 返回回执与一次性下载链接         |
| FR-041  | 续费成功与到期降级        | 权限即时生效；到期自动降级            |
| FR-050  | 配额超限                  | 返回 429，提示冷却时间                |
| FR-070  | 依赖异常降级              | 回退“基础释义+模板例句”，显示退化提示 |
| FR-071  | 缓存命中                  | 返回缓存标记位，统计命中率            |
| FR-080  | 删除与恢复窗口            | 逻辑删除即时，7 天前可按回执恢复      |

------

**本章到此为止：** 所有 FR 均以“单一事实源”的档位矩阵与术语表为口径，不在此章重复定义，以降低漂移风险。后续章节将给出 NFR、接口契约与测试方案与之对齐。
