# 第 5 章 功能性需求（FR）

> 说明：本章为 MVP 阶段可交付的功能清单，使用 FR-XXX 编号与 Must/Should/Could/Will not 优先级。所有功能均以[第 1 章](<./第 1 章 引言.md>)的范围、分层能力、配额与数据控制为追溯依据。

------

## 5.1 查词请求与校验

**FR-001 语言对白名单与同语模式（Must）**

- **触发**：UC-01/UC-12 中提交查词或切换语言对。
- **约束**：仅接受语言对白名单 L1–L4；同语模式（en→en、zh→zh）禁止返回译文字段；切换需与[第 1 章 1.4.1](<./第 1 章 引言.md#141-语言对白名单>)与[第 4 章 BR-01/02](<./第 4 章 业务流程与用例.md#43-业务规则br>)保持一致。
- **结果**：非白名单请求 4xx（INVALID_LANG_PAIR）并附指引；同语模式响应体与 UI 均不出现 translation；切换后无需刷新即按新语言对查询。
- **验收引用**：[AC-FR-001](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-001>)。

**FR-002 输入类型与句子拦截（Must）**

- **触发**：用户在 UC-01 中输入文本或绕过前端提交整句。
- **约束**：输入仅限“单词或词组”；句子判定遵循[第 8 章 §8.10](<./第 8 章 接口与数据契约（APISchema）.md#8100-句子输入判定规范>)；错误语义需对齐[BR-01](<./第 4 章 业务流程与用例.md#43-业务规则br>)。
- **结果**：前端命中规则时阻止提交并保留原文以供编辑；服务端对绕过请求返回 4xx（ENTRY_NOT_WORD_OR_PHRASE），错误体含 `error.hint="请改为词或词组"`。
- **验收引用**：[AC-FR-002](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-002>)。

**FR-003 语言识别与不确定性确认（Should）**

- **触发**：用户未选择语言对但输入触发查词。
- **约束**：LID 阈值按附录术语（p≥0.8 自动判定、0.6–0.8 需确认、p<0.6 拒绝）；错误提示需与 i18n key 体系一致。
- **结果**：展示识别语言及备选；确认后继续查询；拒绝时给出可操作指引（如“切换语言对再试”）。
- **验收引用**：[AC-FR-003](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-003>)。

**FR-004 查词幂等与重试（Must）**

- **触发**：UC-01 中的重复点击、网络重试或后端回放。
- **约束**：幂等键必须为 `hash(subject_id + lang_pair + entry_norm + config_hash + profile_etag)`，与[第 7 章 7.6](<./第 7 章 系统架构与组件.md#76-缓存策略与一致性>)一致；配额统计遵循[第 10 章 10.2](<./第 10 章 配额、限流与成本控制.md#102-配额模型>)。
- **结果**：3 秒内重复请求返回同一结果且不新增历史；重试不再次扣减“查词上限”。
- **验收引用**：[AC-FR-004](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-004>)。

------

## 5.2 输出结构与渲染

**FR-010 释义与义项（Must）**

- **触发**：UC-01 呈现查词结果。
- **约束**：详略级别与字段长度遵循[第 1 章 1.4.3](<./第 1 章 引言.md#143-分层功能说明>)的字符上限；排序需兼容缓存与幂等策略。
- **结果**：默认展示 ≥3 个义项，结构字段齐全；“中”详略下中文≤150、英文≤220 字符；展开更多保持原排序。
- **验收引用**：[AC-FR-010](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-010>)。

**FR-011 个性化例句与控制项（Must）**

- **触发**：UC-01/02/03 中的初次渲染、再生成、难度/风格切换。
- **约束**：例句数量、再生成次数、风格/难度选项遵循[第 11 章](<./第 11 章 订阅、计费与账单.md>)订阅矩阵；同语模式禁止译文；切换动作计入再生成配额（第 10 章 10.2）。
- **结果**：例句模块随档位显示 1/3/5 条并支持再生成；难度/风格切换仅刷新例句区域，返回 `X-Quota` 更新剩余额度；同语模式不返回 translation 字段。
- **验收引用**：[AC-FR-011](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-011>)。

**FR-012 搭配、同反义词、派生词族（Must）**

- **触发**：UC-01 渲染结果页及用户展开更多。
- **约束**：模块优先级与条数遵循[第 3 章 3.7](<./第 3 章 用户画像与角色.md#37-画像驱动的默认模块优先级与详略>)与[第 4 章 BR-04](<./第 4 章 业务流程与用例.md#43-业务规则br>)；列表需去重、按相关性稳定排序。
- **结果**：常见/固定搭配各 ≥3 条，同/反义词各 ≥4 项，派生与词族 ≥2 项；分页加载不重排已展示内容。
- **验收引用**：[AC-FR-012](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-012>)。

**FR-013 模块开关、顺序与详略自定义（Must）**

- **触发**：UC-07 中的模块偏好设置、结果页的即时调整。
- **约束**：Free 仅允许基础开关；Plus/Pro 支持排序与详略调整；Pro 支持词条级偏好；自定义能力需与[第 11 章](<./第 11 章 订阅、计费与账单.md>)档位一致，并在缓存键加入 `config_hash`。 
- **结果**：拖拽排序后刷新即生效并跨端同步；详略切换遵循统一字符上限；Pro 的词条级偏好持久化并影响后续生成。
- **验收引用**：[AC-FR-013](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-013>)。

**FR-014 频率与考试标签（Will not, MVP）**

- **触发**：UC-01 展示结果页模块。
- **约束**：仅展示灰态占位，不触发任何数据请求；后续若实现需走[第 22 章](<./第 22 章 变更管理与版本策略（契约弃用期）.md>)变更流程。
- **结果**：界面保留徽标位且状态“暂不实现”，无交互入口。
- **验收引用**：[AC-FR-014](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-014>)。

------

## 5.3 历史记录与数据控制

**FR-020 历史留存与上限（Must）**

- **触发**：UC-04 浏览历史、UC-11 无痕查询、系统滚动清理。
- **约束**：留存天数/条数遵循[第 11 章](<./第 11 章 订阅、计费与账单.md>)；无痕模式遵循[第 1 章 1.4.3](<./第 1 章 引言.md#143-分层功能说明>)与[第 9 章 9.7](<./第 9 章 数据模型与数据治理.md#97-数据生命周期与删除语义>)；配额镜像需与[第 10 章 10.2](<./第 10 章 配额、限流与成本控制.md#102-配额模型>)一致。
- **结果**：响应体返回 `quota.history` 剩余情况；超限时按队尾滚动清理并产生日志；无痕模式不写本地/后端，但仍计入实时配额。
- **验收引用**：[AC-FR-020](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-020>)。

**FR-021 历史清理与分组（Must）**

- **触发**：UC-05 发起清理、UC-16 撤回隐私同意。
- **约束**：支持“清理 zh 组/清理 en 组/全部清空”；执行前需二次确认；逻辑删即时、物理清理 T+7d，与[第 9 章 9.7](<./第 9 章 数据模型与数据治理.md#97-数据生命周期与删除语义>)一致。
- **结果**：成功后 5 秒内返回回执并记录审计；在物理清理前允许撤回；受限功能提示用户确认。
- **验收引用**：[AC-FR-021](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-021>)。

**FR-022 数据导出（Must）**

- **触发**：UC-06 导出历史、UC-15 账单导出。
- **约束**：格式/权限按档位区分（Free=CSV、Plus/Pro=CSV/JSON）；导出流程遵循[第 4 章 4.2.4](<./第 4 章 业务流程与用例.md#424-历史记录清理与导出>)与[第 9 章 9.10](<./第 9 章 数据模型与数据治理.md#910-导出与回执治理>)；降级提示与 TTL 10 分钟遵循[第 8 章 8.6](<./第 8 章 接口与数据契约（APISchema）.md#86-导出契约>)。
- **结果**：`POST /exports` 返回 202 + 回执号；P95 ≤ 5 s 内轮询获得一次性 `downloadUrl`；内容脱敏、带表头；降级时返回 `degraded=true` 与原因。
- **验收引用**：[AC-FR-022](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-022>)。

------

## 5.4 个性化画像与风格偏好

**FR-030 画像采集与编辑（Must）**

- **触发**：UC-07 中的画像设置引导、账号首登、设置页变更。
- **约束**：字段与最小采集原则遵循[第 3 章 3.5](<./第 3 章 用户画像与角色.md#35-画像字段采集与使用规则>)；风格标签数量受档位限制（Free≤3、Plus≤5、Pro≤8）；需与 i18n key 一致。
- **结果**：画像保存后下一次生成立即生效并写入画像存储；本地缓存与后端一致；撤回隐私时画像清空。
- **验收引用**：[AC-FR-030](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-030>)。

**FR-031 画像驱动的生成控制（Should）**

- **触发**：UC-01/02/03 在生成或再生成时读取画像。
- **约束**：提示词模板需将画像字段映射到可读性与风格控制；画像为空时回退通用模板；trace_id 需携带画像版本信息。
- **结果**：切换“当前水平”或风格标签立即影响后续生成；日志可按画像版本回放。
- **验收引用**：[AC-FR-031](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-031>)。

------

## 5.5 账户与订阅

**FR-040 账户注册与登录（Must）**

- **触发**：UC-10 登录/注册、UC-01 提示登录、后台会话校验。
- **约束**：支持邮箱 + 第三方（微信/Apple/Google）；首次登录需展示条款与隐私；撤回同意路径与[第 12 章](<./第 12 章 安全、隐私与合规.md>)一致。
- **结果**：登录成功率≥99%；同意状态可审计并可撤回；撤回后触发降权与清理策略入口。
- **验收引用**：[AC-FR-040](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-040>)。

**FR-041 订阅状态与能力同步（Must）**

- **触发**：UC-08/09 订阅开通、续费、到期回调或轮询。
- **约束**：订阅矩阵以[第 11 章](<./第 11 章 订阅、计费与账单.md>)为 SSoT；更新需幂等并在 ≤3 s 内完成；降级/升级需联动缓存与配额失效。
- **结果**：支付成功后立即提权；到期自动降级，能力边界同步；异常回调支持自动补偿。
- **验收引用**：[AC-FR-041](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-041>)。

**FR-042 账单与收据展示（Must）**

- **触发**：UC-15 查看账单、导出账单或对账。
- **约束**：展示档位、生效/到期时间、订单号；时间以 UTC 存储、本地渲染；账单脱敏符合法务要求。
- **结果**：用户可查询历史订单并导出；退款/异常有清晰标注。
- **验收引用**：[AC-FR-042](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-042>)。

------

## 5.6 配额、限速与再生成

**FR-050 查词与再生成配额（Must）**

- **触发**：所有写入查词/再生成配额的操作（UC-01/02/03/11/12/13）。
- **约束**：按“自然日”计数并在用户本地时区 00:00 重置；查词与再生成分开计数；响应需返回 `X-RateLimit/*`、`X-Quota-*` 与 `quota` 镜像。
- **结果**：Free/Plus/Pro 档配额符合[第 11 章](<./第 11 章 订阅、计费与账单.md>)；超限返回 429/RATE_LIMITED，并携带剩余额度与重置时间。
- **验收引用**：[AC-FR-050](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-050>)。

**FR-051 限速与突发控制（Should）**

- **触发**：UC-01/02/03 等接口被高频调用。
- **约束**：用户级、租户级、全局三级限流；支持突发桶；错误语义统一 RATE_LIMITED，Headers 含 `X-RateLimit-Limit/Remaining/Reset` 与 `X-Quota-Reset-At`。
- **结果**：限流命中返回冷却建议并记录观测指标；抑制雪崩并保持配额一致。
- **验收引用**：[AC-FR-051](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-051>)。

------

## 5.7 设置与客户端行为

**FR-060 主题、快捷键与界面语言（Must）**

- **触发**：设置页或快捷入口变更主题、快捷键、界面语言。
- **约束**：主题浅色/深色/跟随系统；快捷键冲突需阻止保存；语言切换即时生效并覆盖 100% 文案。
- **结果**：切换过程无闪屏；冲突提示明确；语言切换后即时刷新 UI。
- **验收引用**：[AC-FR-060](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-060>)。

------

## 5.8 生成依赖、缓存与降级

**FR-070 Doubao API 适配与容错（Must）**

- **触发**：UC-01/02/03 调用 Doubao API。
- **约束**：封装重试、超时、错误语义化与结构化解析；熔断阈值“依赖 5xx≥5% 且持续 1 分钟”；降级路径与[第 7 章 7.4.5](<./第 7 章 系统架构与组件.md#745-熔断与降级>)一致。
- **结果**：触发熔断时回退“基础释义+模板例句”，UI 展示退化提示且不计入生成配额；半开探测通过后自动恢复。
- **验收引用**：[AC-FR-070](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-070>)。

**FR-071 L1/L2 缓存（Should）**

- **触发**：UC-01/02/03 查询命中缓存。
- **约束**：L1 用户级 TTL 10 分钟、L2 共享 TTL 30 分钟；缓存键包含 `subjectId/lang_pair/entry_norm/config_hash/profile_etag`；再生成默认绕过 L2。
- **结果**：命中时返回缓存标记位；统计命中率并写入观测指标；过期自动淘汰。
- **验收引用**：[AC-FR-071](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-071>)。

------

## 5.9 数据删除与合规

**FR-080 逻辑删除与物理清理（Must）**

- **触发**：UC-05 清理历史、UC-16 撤回隐私、用户删除单条历史。
- **约束**：逻辑删即时、物理清理 T+7d；回执号需可追溯；策略与[第 9 章 9.7](<./第 9 章 数据模型与数据治理.md#97-数据生命周期与删除语义>)一致。
- **结果**：删除后前端立即不可见；物理清理任务按期执行；恢复窗口内可按回执找回。
- **验收引用**：[AC-FR-080](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-080>)。

**FR-081 条款与隐私管理（Must）**

- **触发**：UC-10 首次登录、设置页撤回同意、UC-16 数据删除请求。
- **约束**：条款/隐私提示与[第 12 章](<./第 12 章 安全、隐私与合规.md>)一致；撤回后需联动数据处理与功能限制。
- **结果**：同意状态可审计；撤回触发导出/删除指引；不同意时仅允许浏览并提示退出。
- **验收引用**：[AC-FR-081](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-081>)。

------

## 5.10 支付、退款与异常

**FR-090 订阅开通与续费（Must）**

- **触发**：UC-08 发起支付、回调或轮询。
- **约束**：支付成功即刻生效；失败不改变原订阅；回调需幂等并自动重放；遵循[第 11 章](<./第 11 章 订阅、计费与账单.md>)对账策略。
- **结果**：成功后能力即时切换；失败保持原状态并提示重试；回调异常自动补偿。
- **验收引用**：[AC-FR-090](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-090>)。

**FR-091 到期与降级处理（Must）**

- **触发**：UC-09 到期任务或支付回调。
- **约束**：到期自动降级并同步能力边界、配额上限；订阅状态机遵循[第 11 章](<./第 11 章 订阅、计费与账单.md>)。
- **结果**：降级后自定义项回退默认；历史记录受新档位限制但不丢失；通知用户并记录审计。
- **验收引用**：[AC-FR-091](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-091>)。

**FR-092 退款与异常对账（Should）**

- **触发**：退款流程、支付异常、对账任务。
- **约束**：遵循平台规则；状态与权限保持幂等同步；对账差异需在 24 h 内补偿；与[第 11 章](<./第 11 章 订阅、计费与账单.md>)一致。
- **结果**：退款完成后档位恢复为到期前或 Free；账单与收据保留痕迹并可追溯。
- **验收引用**：[AC-FR-092](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-092>)。

------

## 5.11 端到端性能与首屏体验（与 NFR 对齐的功能侧要求）

**FR-100 首屏渐进渲染（Should）**

- **触发**：UC-01 渲染结果页。
- **约束**：释义区块先渲染；例句与搭配异步加载；单区块失败不阻塞其他区块；端到端预算遵循[第 6 章 6.3](<./第 6 章 非功能性需求（NFR）.md#63-性能与容量>)。
- **结果**：P95 ≤ 2.5 s 呈现首个内容模块；各区块具独立错误提示与重试入口。
- **验收引用**：[AC-FR-100](<./第 20 章 验收标准与测试方案（UC 对齐）.md#ac-fr-100>)。

------

## 5.12 用例映射与验收清单（概览）

> 详细 UC 场景见[第 4 章「业务流程与用例」](<./第 4 章 业务流程与用例.md>)；本节为 FR 到 UC 的检查点总览，供测试编排。

| FR 编号 | 关键用例（UC 概览）       | 期望结果（摘录）                      |
| ------- | ------------------------- | ------------------------------------- |
| FR-001  | 选择语言对并查询          | 非白名单拒绝；同语模式无译文          |
| FR-002  | 输入整句触发拦截          | 前端阻止提交，服务端 4xx              |
| FR-011  | 切换例句难度/风格与再生成 | 仅例句区刷新；配额随档位递减          |
| FR-020  | 历史留存与无痕查询        | 无痕不写库；超限滚动清理              |
| FR-022  | 导出 CSV/JSON             | ≤5 s 返回回执与一次性下载链接         |
| FR-041  | 续费成功与到期降级        | 权限即时生效；到期自动降级            |
| FR-050  | 配额超限                  | 返回 429，提示冷却时间                |
| FR-070  | 依赖异常降级              | 回退“基础释义+模板例句”，显示退化提示 |
| FR-071  | 缓存命中                  | 返回缓存标记位，统计命中率            |
| FR-080  | 删除与恢复窗口            | 逻辑删除即时，7 天前可按回执恢复      |

------

**本章到此为止：** 所有 FR 均以“单一事实源”的档位矩阵与术语表为口径，不在此章重复定义，以降低漂移风险。后续章节将给出 NFR、接口契约与测试方案与之对齐。

## 5.13 本章六段式小结

| 维度     | 摘要                                                         |
| -------- | ------------------------------------------------------------ |
| 问题背景 | MVP 需将“查询即理解”拆解为可验收的 FR，覆盖查词、个性化、历史、配额、订阅等全链路。 |
| 目标     | 定义 FR-001～FR-100 的触发、约束、结果与验收引用，保证与 UC/NFR/架构对齐。 |
| 范围     | 查词输入/输出、历史与导出、画像、账户与订阅、配额/限流、设置、生成依赖、数据合规、支付与性能体验。 |
| 约束     | 语言对白名单、幂等键、配额分离、缓存 TTL、降级兜底、逻辑删+T+7d、订阅矩阵与条款同意流程。 |
| 依赖     | 第 3 章 Persona、第 4 章 UC、[第 6 章 NFR](<./第 6 章 非功能性需求（NFR）.md>)、第 7 章 架构、第 8/9/10/11 章契约与配额策略。 |
| 验收引用 | 第 20 章 20.6「UC→FR→AC 覆盖矩阵」对应 AC-FR-001～AC-FR-100；性能与非功能按第 6 章执行。 |
