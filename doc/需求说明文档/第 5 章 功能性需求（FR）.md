# 第 5 章 功能性需求（FR）

> 说明：本章为 MVP 阶段可交付的功能清单，使用 FR-XXX 编号与 Must/Should/Could/Will not 优先级。所有功能均以[第 1 章](<./第 1 章 引言.md>)的范围、分层能力、配额与数据控制为追溯依据。

------

## 5.1 查词请求与校验

**FR-001 语言对白名单与同语模式**

- 内容：仅支持 L1–L4 语言对；同语模式不返回译文，也不提供临时展开。
- 优先级：Must
- 验收要点：
  1. 非白名单语言对直接拒绝并返回指引；2) en→en、zh→zh 默认不出现译文区块，接口亦不返回 translation 字段；3) 切换语言对后立即生效且不需刷新。
- 追溯：语言对白名单与同语模式。

**FR-002 输入类型与句子拦截**

- 内容：仅接受“单词或词组”，句子判定遵循[第 8 章「句子输入判定规范」](<./第 8 章 接口与数据契约（APISchema）.md#9100-句子输入判定规范>)，命中时前端拦截并提示改为词/词组。
- 优先级：Must
- 验收要点：
  1. 前端命中硬规则（句末标点、长度/连词等）或软规则时阻止提交并给出修改建议；2) 保留原输入供用户编辑；3) 服务端对绕过前端的整句请求返回 4xx，错误码 ENTRY_NOT_WORD_OR_PHRASE，并在 error.hint 中提示“改为词或词组”。
- 追溯：输入与查词规则。

**FR-003 语言识别与不确定性确认**

- 内容：对未显式选择语言对的输入进行 LID；p≥0.8 自动判定，0.6–0.8 弹出确认，p<0.6 拒绝。
- 优先级：Should
- 验收要点：
  1. 展示识别语言与备选；2) 用户确认后再发起查询；3) 拒绝时返回可操作指引。
- 追溯：术语表 LID 定义与阈值。

**FR-004 查词幂等与重试**

- 内容：同一主体、同一词条、同一配置短时内重复提交仅计 1 次业务操作，返回同一结果。
- 优先级：Must
- 验收要点：
  1. 生成幂等键 `hash(subject_id + lang_pair + entry_norm + config_hash + profile_etag)`；2) 3 秒内重复点击不会产生多条历史；3) 重试不计入“查词上限”。
- 追溯：术语表“幂等”“查词上限”。

------

## 5.2 输出结构与渲染

**FR-010 释义与义项**

- 内容：默认展示 3 个义项，按相关性排序；详略级别默认为“中”。
- 优先级：Must
- 验收要点：
  1. 返回结构固定字段齐全；2) “中”详略下中文≤150/英文≤220 字符；3) 展开查看更多维持排序稳定。
- 追溯：模块与详略级别基线。

**FR-011 个性化例句与控制项**

- 内容：例句数量、再生成次数、难度与风格随订阅档位受控；同语模式不返回译文；难度与风格切换视为再生成次数（不计查词）。
- 优先级：Must
- 验收要点：
  1. Free/Plus/Pro 档的例句数量、可调范围与再生成配额遵循[第 11 章](<./第 11 章 订阅、计费与账单.md>) SSoT；前端仅引用不复制数值。
  2. 切换“更简单/更难”“口语/书面/学术/商务”等选项计入再生成配额，超限返回 RATE_LIMITED 并提示剩余额度/重置时间。
  3. en→en、zh→zh 模式不返回译文字段，例句模块刷新时不影响其他模块渲染。
- 追溯：分层功能说明与订阅权益。

**FR-012 搭配、同反义词、派生词族**

- 内容：默认条数与优先级遵循结果页模块表；列表去重并按相关性排序。
- 优先级：Must
- 验收要点：
  1. 常见搭配与固定搭配各 3 条；2) 同/反义词 4 项；3) 派生与词族 2 项；4) 展开“更多”时分页加载不重排已渲染内容。
- 追溯：结果页模块配置。

**FR-013 模块开关、顺序与详略自定义**

- 内容：Free 档支持基础开关；Plus/Pro 额外支持模块排序与详略级别选择，Pro 增加“词条级记忆偏好”。
- 优先级：Must
- 验收要点：
  1. 拖拽排序后刷新即生效；2) 详略切换映射统一上限表；3) Pro 对单词的个性化设置被持久化并在跨端同步。
- 追溯：分层自定义能力。

**FR-014 频率与考试标签**

- 内容：徽标位预留但不实现业务逻辑。
- 优先级：Will not（MVP）
- 验收要点：
  1. UI 保留灰态占位；2) 无任何数据请求与交互。
- 追溯：模块说明“暂不实现”。

------

## 5.3 历史记录与数据控制

**FR-020 历史留存与上限**

- 内容：按订阅档位控制留存时长与条数；超限滚动清理；支持无痕查询。

- 优先级：Must

- 验收要点：

  1. Free/Plus/Pro 档的留存天数与条数遵循[第 11 章](<./第 11 章 订阅、计费与账单.md>)定义；前端展示剩余额度并在响应体镜像 quota 对象。
  2. 开启无痕后不写入本地与后端；超限队尾清理产生日志事件，保留审计链路。

- 追溯：历史策略与档位矩阵。

**FR-021 历史清理与分组**

- 内容：支持按语言组清理（zh 组、en 组）或全部清空，要求二次确认。
- 优先级：Must
- 验收要点：
  1. 清理成功后 5 秒内收到回执；2) 支持撤回窗口，物理清理延迟 7 天。
- 追溯：清理规则与删除语义。

**FR-022 数据导出**

- 内容：Free 档 CSV；Plus/Pro 支持 CSV/JSON（Pro 允许条件过滤与批量导出）。
- 优先级：Must
- 验收要点：
  1. POST /exports 返回 202 Accepted，包含 exportId/receiptId；P95 ≤ 5 s 内通过轮询 1–2 次 GET /exports/{id} 获得 downloadUrl。
  2. 响应体与事件均脱敏，导出内容带表头；失败可重新申请。
  3. 降级时返回 degraded=true 与 degradeReason，前端渲染“已降级”提示。
- 追溯：导出能力与统一口径。

------

## 5.4 个性化画像与风格偏好

**FR-030 画像采集与编辑**

- 内容：采集学习目标、专业背景、年龄层次、当前水平、语言对与风格标签；支持多选与排序（风格标签按档位限制数量）。
- 优先级：Must
- 验收要点：
  1. 画像修改后下一次生成即生效；2) 档位差异：Free ≤3、Plus ≤5、Pro ≤8 个风格标签；3) 本地缓存与后端一致。
- 追溯：画像字段与分层限制。

**FR-031 画像驱动的生成控制**

- 内容：画像参与提示词模板，影响义项排序与例句风格/难度。
- 优先级：Should
- 验收要点：
  1. 切换“当前水平”将触发可读性映射；2) 画像为空时回退到通用模板；3) 画像变更被记录于 trace_id 维度便于回放。
- 追溯：提示词模板与可读性映射。

------

## 5.5 账户与订阅

**FR-040 账户注册与登录**

- 内容：支持邮箱登录与第三方登录（如微信、Apple 等）；首次登录展示条款与隐私同意。
- 优先级：Must
- 验收要点：
  1. 登录成功率≥99%；2) 同意状态可在设置内撤回；3) 撤回后触发降权与清理策略入口。
- 追溯：账户与第三方登录、合规提示。

**FR-041 订阅状态与能力同步**

- 内容：订阅开通/续费成功后权限即时生效；到期自动降级并同步能力边界。
- 优先级：Must
- 验收要点：
  1. 支付成功回调≤3 s 内完成能力切换；2) 到期后立即生效的降级不产生数据丢失；3) 幂等更新与对账兜底可见。
- 追溯：订阅开通与到期处理、对账策略。

**FR-042 账单与收据展示**

- 内容：展示档位、生效时间、到期时间与订单号。
- 优先级：Must
- 验收要点：
  1. 时区按本地渲染、服务端存 UTC；2) 历史订单可查询与导出。
- 追溯：支付与账单。

------

## 5.6 配额、限速与再生成

**FR-050 查词与再生成配额**

- 内容：按“自然日”计数并在用户本地时区 00:00 重置；查词与再生成分开计数。
- 优先级：Must
- 验收要点：
  1. Free/Plus/Pro 档配额遵循[第 11 章](<./第 11 章 订阅、计费与账单.md>)定义，所有写接口在响应头返回 X-RateLimit/X-Quota 系列及 X-Quota-Reset-At，并在响应体镜像 quota 对象。
  2. 超限返回 429/RATE_LIMITED，错误体在 meta.kind 中区分 quota|ratelimit，提示剩余额度与重置时间。
- 追溯：订阅与权益、配额口径。

**FR-051 限速与突发控制**

- 内容：用户级、租户级、全局三级限流；支持突发桶。
- 优先级：Should
- 验收要点：
  1. 返回码与错误语义一致，统一使用 RATE_LIMITED。
  2. 响应头包含 X-RateLimit-Limit/Remaining/Reset、X-Quota-Type/Remaining 与 X-Quota-Reset-At。
- 追溯：并发与限速定义。

------

## 5.7 设置与客户端行为

**FR-060 主题、快捷键与界面语言**

- 内容：主题支持浅色/深色/跟随系统；快捷键默认方案可自定义；界面语言支持 zh/en。
- 优先级：Must
- 验收要点：
  1. 主题切换无闪屏；2) 快捷键冲突检测；3) 语言切换即时生效，文案覆盖率 100%。
- 追溯：通用设置。

------

## 5.8 生成依赖、缓存与降级

**FR-070 Doubao API 适配与容错**

- 内容：封装重试、超时、错误语义化与结构化契约解析容错；异常时降级为“基础释义+模板例句”。
- 优先级：Must
- 验收要点：
  1. 调用 5xx≥5% 且持续 1 分钟触发熔断；2) 半开探测通过后自动恢复；3) 降级时 UI 显示退化提示且不计入生成配额。
- 追溯：技术实现最小集与熔断/降级定义。

**FR-071 L1/L2 缓存**

- 内容：L1 为用户级 10 分钟、L2 为共享级 30 分钟的短时缓存；Key 由 user_id+entry+config 组成。
- 优先级：Should
- 验收要点：
  1. 命中缓存返回标记位；2) 缓存过期自动淘汰；3) 统计缓存命中率。
- 追溯：缓存与键组成。

------

## 5.9 数据删除与合规

**FR-080 逻辑删除与物理清理**

- 内容：用户删除记录后立即逻辑删除；物理清理默认在 7 天后执行，可在清理前恢复。
- 优先级：Must
- 验收要点：
  1. 删除即刻对前端不可见；2) 清理任务按期执行；3) 恢复窗口内可基于回执号找回。
- 追溯：删除语义与物理清理策略。

**FR-081 条款与隐私管理**

- 内容：首次登录需同意条款与隐私；设置中提供撤回入口并联动数据处理策略。
- 优先级：Must
- 验收要点：
  1. 同意状态可审计；2) 撤回触发导出/删除选项指引；3) 不同意则仅允许离线浏览与退出登录。
- 追溯：合规与隐私概览。

------

## 5.10 支付、退款与异常

**FR-090 订阅开通与续费**

- 内容：支付成功后即时生效；失败不改变原订阅状态。
- 优先级：Must
- 验收要点：
  1. 异常回调自动重放且具幂等；2) 成功后能力立刻切换；3) 订单状态与权限保持一致。
- 追溯：支付与账单、幂等更新。

**FR-091 到期与降级处理**

- 内容：到期后自动降级并同步能力边界与配额。
- 优先级：Must
- 验收要点：
  1. 降级后超出能力的自定义项回退到默认；2) 历史记录遵守新档位留存上限。
- 追溯：到期处理。

**FR-092 退款与异常对账**

- 内容：遵循目标平台规则，状态与权限保持幂等同步；异常自动对账与补偿更新。
- 优先级：Should
- 验收要点：
  1. 退款完成后档位还原为到期前状态或免费档；2) 账单与收据保留痕迹且可追溯。
- 追溯：退款与异常、订阅对账。

------

## 5.11 端到端性能与首屏体验（与 NFR 对齐的功能侧要求）

**FR-100 首屏渐进渲染**

- 内容：释义区块先行渲染，例句与搭配随后到齐；单区块失败不阻塞其他区块。
- 优先级：Should
- 验收要点：
  1. P95 ≤ 2.5 s 呈现首个区块；2) 各区块都有独立错误提示与重试。
- 追溯：成功标准与端到端口径。

------

## 5.12 用例映射与验收清单（概览）

> 详细 UC 场景见[第 4 章「业务流程与用例」](<./第 4 章 业务流程与用例.md>)；本节为 FR 到 UC 的检查点总览，供测试编排。

| FR 编号 | 关键用例（UC 概览）       | 期望结果（摘录）                      |
| ------- | ------------------------- | ------------------------------------- |
| FR-001  | 选择语言对并查询          | 非白名单拒绝；同语模式无译文          |
| FR-002  | 输入整句触发拦截          | 前端阻止提交，服务端 4xx              |
| FR-011  | 切换例句难度/风格与再生成 | 仅例句区刷新；配额随档位递减          |
| FR-020  | 历史留存与无痕查询        | 无痕不写库；超限滚动清理              |
| FR-022  | 导出 CSV/JSON             | ≤5 s 返回回执与一次性下载链接         |
| FR-041  | 续费成功与到期降级        | 权限即时生效；到期自动降级            |
| FR-050  | 配额超限                  | 返回 429，提示冷却时间                |
| FR-070  | 依赖异常降级              | 回退“基础释义+模板例句”，显示退化提示 |
| FR-071  | 缓存命中                  | 返回缓存标记位，统计命中率            |
| FR-080  | 删除与恢复窗口            | 逻辑删除即时，7 天前可按回执恢复      |

------

**本章到此为止：** 所有 FR 均以“单一事实源”的档位矩阵与术语表为口径，不在此章重复定义，以降低漂移风险。后续章节将给出 NFR、接口契约与测试方案与之对齐。