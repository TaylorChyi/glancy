# 第 11 章 订阅、计费与账单

> 版本说明：当前系统尚未接入真实计费/扣款，仅维护会员等级、有效期与兑换逻辑。本章记录可用能力与缺口，替换原草案中的完整订阅矩阵。

---

## 11.1 当前实现表格

| 序号 | 能力 | 当前实现 | 触发路径 | 代码 |
| --- | --- | --- | --- | --- |
| SUB-001 | 会员等级模型 | `MembershipType`（NONE、PLUS、PRO、PREMIUM）按 `priority` 比较，提供 `canAccess` 与 `fromPlanLabel` 工具方法。 | 供 TTS、兑换等模块判断权限。 | 【F:backend/src/main/java/com/glancy/backend/entity/MembershipType.java†L6-L43】 |
| SUB-002 | 用户会员状态 | `User` 实体保存 `membershipType`、`membershipExpiresAt`、`member` 布尔值；统一通过 `updateMembership`/`synchronizeMembershipStatus` 更新。 | 登录、兑换、后台操作均复用同一逻辑。 | 【F:backend/src/main/java/com/glancy/backend/entity/User.java†L43-L92】 |
| SUB-003 | 会员生命周期服务 | `MembershipLifecycleService` 提供激活、延长、移除操作，并处理延长期起算规则。 | 兑换码、后台任务调用。 | 【F:backend/src/main/java/com/glancy/backend/service/membership/MembershipLifecycleService.java†L24-L79】 |
| SUB-004 | 兑换码授予会员/折扣 | `RedemptionCode` 配置会员延长（小时）或折扣有效期；兑换时校验时间窗、额度并返回权益快照。 | `/api/redemption-codes` 管理 & `/redeem` 用户接口。 | 【F:backend/src/main/java/com/glancy/backend/service/redemption/RedemptionCodeService.java†L62-L207】 |
| SUB-005 | 兑换记录与折扣 | `redemption_record` 保存用户兑换时间；`user_discount_benefit` 保存折扣百分比与有效期。 | 暂未与实际订单系统联动，仅为后续预留。 | 【F:backend/src/main/java/com/glancy/backend/entity/redemption/RedemptionRecord.java†L13-L36】【F:backend/src/main/java/com/glancy/backend/entity/redemption/UserDiscountBenefit.java†L13-L44】 |
| SUB-006 | 功能权限控制 | TTS 语音、日配额依据会员等级调整（同第 10 章）。 | 直接读取 `user.hasActiveMembershipAt`。 | 【F:backend/src/main/java/com/glancy/backend/service/tts/TtsRequestValidator.java†L85-L103】【F:backend/src/main/java/com/glancy/backend/service/tts/quota/TtsQuotaService.java†L71-L75】 |

---

## 11.2 权益与周期说明

1. **默认等级**：新注册用户 `membershipType=NONE`，`member=false`。激活会员时若未提供等级，服务层默认升级到 `PLUS`。 【F:backend/src/main/java/com/glancy/backend/service/membership/MembershipLifecycleService.java†L28-L38】
2. **有效期计算**：延长会员时，如果当前仍在有效期内，则从原到期日开始累加；否则从当前时间起算。 【F:backend/src/main/java/com/glancy/backend/service/membership/MembershipLifecycleService.java†L45-L68】
3. **兑换授予**：会员类兑换码将延长指定小时并返回新到期时间；折扣类兑换码仅写入折扣记录，后续由计费系统消费。 【F:backend/src/main/java/com/glancy/backend/service/redemption/RedemptionCodeService.java†L147-L207】
4. **权限校验**：例如音色 `plan=pro` 时，需 `membershipType>=PRO` 且在有效期内，否则抛 `ForbiddenException`。 【F:backend/src/main/java/com/glancy/backend/service/tts/TtsRequestValidator.java†L85-L103】

---

## 11.3 当前缺失的订阅/计费能力

| 目标项 | 当前状态 | 说明 |
| --- | --- | --- |
| 自动续费 / 周期性扣款 | **未实现**：无支付网关集成 | 需要独立的计费服务或第三方支付回调。 |
| 发票/对账 | **未实现**：无账单、发票实体 | 兑换折扣无法落到财务凭证，需要新增账单表。 |
| 退款 / 退订流程 | **未实现**：仅支持手动移除会员 | 建议结合会员生命周期服务增加退订 API，记录原因。 |
| 订阅矩阵展示 | **未实现**：无静态配置文件 | 若需对外展示权益，需要定义矩阵数据源。 |

---

## 11.4 差异追踪（需建 Issue）

1. **计费系统对接**：确认选型（自建 or 第三方），实现扣款、发票、对账流程，并扩展数据模型（参照第 9 章 TDM-003）。
2. **退订/退款流程**：在会员生命周期服务上新增退订记录与原因，避免直接调用 `removeMembership` 丢失审计信息。 【F:backend/src/main/java/com/glancy/backend/service/membership/MembershipLifecycleService.java†L74-L79】
3. **权益矩阵配置**：补充会员权益数据源（例如 JSON/YAML），供前端展示及权限校验对照。
4. **折扣应用链路**：`UserDiscountBenefit` 目前未被消费，需在未来的订阅订单流中接入使用与失效处理。 【F:backend/src/main/java/com/glancy/backend/entity/redemption/UserDiscountBenefit.java†L13-L44】

以上缺口需在产品路线图中排期，并在 Issue 看板记录优先级。
