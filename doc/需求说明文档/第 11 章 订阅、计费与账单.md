# 第 11 章 订阅、计费与账单

> 本章在[第 1 章「订阅与权益概览」](<./第 1 章 引言.md#144-订阅与权益概览>)、[第 1 章「支付与账单」](<./第 1 章 引言.md#145-支付与账单>)、[第 10 章 配额、限流与成本控制](<./第 10 章 配额、限流与成本控制.md>)的基础上细化订阅商品、计费规则、账单票据、对账与状态机，作为订阅域的单一事实源（SSoT）。所有时间以 UTC 存储，前端按本地时区渲染；下载链接 TTL、删除语义等遵循文档统一约定。

------

## 11.1 目标与范围

- **目标**：以最低耦合实现三档订阅（Free/Plus/Pro）的售卖、续费、升级降级、账单与收据、退款与争议、对账与审计，确保权限与配额在 5 s 内一致。
- **范围**：MVP 仅覆盖 Web/H5 外部支付；个人账户模型；不含组织/家庭共享与礼品卡。原生商店内购列入后续阶段评估。
- **非目标（MVP 外）**：预付余额钱包、企业价、礼品订阅、税务发票自动开具。

## 11.2 原则

1. **SSoT**：订阅矩阵与权益以本章为唯一权威来源，被其他章节引用而非复制。
2. **最小数据采集**：仅存储订单与账单所必需字段；支付敏感数据不落库明文。
3. **幂等与可回放**：一切付费侧状态更新以幂等键保障一次生效；失败可安全重试。
4. **回调优先，轮询兜底**：第三方异步通知优先驱动状态，定时轮询弥补丢失回调。
5. **到期自动降级**：订阅到期或撤销后，能力边界与配额即时同步。

## 11.3 名词与对象

| 名称         | 定义                             | 关键字段                                                     |
| ------------ | -------------------------------- | ------------------------------------------------------------ |
| Plan         | 订阅档位（Free/Plus/Pro）        | plan_id、name、entitlements                                  |
| Price        | 某 Plan 在特定周期与币种下的价格 | price_id、plan_id、period=monthly/yearly、currency、amount、store_product_id |
| Subscription | 用户与 Plan 的时间绑定           | sub_id、user_id、plan_id、start_at、end_at、status           |
| Order        | 一次购买意图与支付总单           | order_id、user_id、price_id、channel、amount、currency、status |
| Transaction  | 支付平台交易记录                 | txn_id、order_id、platform_txn_id、status、paid_at           |
| Invoice      | 出具给用户的账单/收据            | invoice_id、order_id、items[]、amount、tax、discount、link_ttl |
| Refund       | 订单的全部/部分退款              | refund_id、order_id、amount、reason、status                  |
| Entitlement  | 权益快照                         | plan_id、limits（查词、再生成等）                            |

> 计费与配额两个域通过 entitlement 同步，见 11.12 与[第 10 章 配额、限流与成本控制](<./第 10 章 配额、限流与成本控制.md>)。

## 11.4 商品与价格矩阵

- **周期**：月度、年度。
- **币种**：按渠道支持的币种集合（Web/H5 以 CNY 起步）。
- **价格来源**：
  - iOS/Android：预留商店价映射（非 MVP），服务端维护 `price_id ↔ store_product_id` 以备后续扩展。
  - Web/H5：以后台配置价为准，可灰度。
- **展示**：价格与权益并排展示；权益取自[第 1 章「订阅与权益概览」](<./第 1 章 引言.md#144-订阅与权益概览>)表格并作为渲染数据源。

## 11.5 生命周期与状态机

**状态集合**：`NONE → TRIALING → ACTIVE → GRACE → PAST_DUE → CANCELED → EXPIRED → REVOKED → REFUNDED`

- `TRIALING`：试用期，未扣费。
- `ACTIVE`：已支付或商店自动续费成功。
- `GRACE`：续费失败的宽限期（配置：月订阅 3 天，年订阅 7 天），权益保持。
- `PAST_DUE`：宽限期后仍未扣费，仅对自托管循环扣款适用。
- `CANCELED`：用户取消自动续费，当前周期末失效。
- `EXPIRED`：到期未续。
- `REVOKED`：商店撤销或拒付/拒付胜诉，立即移除权益。
- `REFUNDED`：完成退款；全额退款立即移除权益，部分退款仅记账。

**迁移规则（摘录）**

- 支付成功：`TRIALING|NONE → ACTIVE`
- 周期切换点续费失败：`ACTIVE → GRACE`
- 宽限期结束仍失败：`GRACE → PAST_DUE → EXPIRED`
- 用户取消自动续费：`ACTIVE → CANCELED（到期）→ EXPIRED`
- 退款成功：`ACTIVE|EXPIRED → REFUNDED`
- 拒付/撤销：`ACTIVE → REVOKED`
- 权益同步保障：任一状态迁移后立即写入 `entitlement_events` 并触发权益域 webhook，确保在 ≤5 s 内将最新权益/配额落库与缓存命中路径；若 3 s 内未收到回执，则发起一次内部补偿重试。

> 到期自动降级与能力边界同步为硬要求。

## 11.6 购买、续费、升降级

### 11.6.1 开通与续费

- **iOS/Android**：商店托管续费（非 MVP）；保留回调/票据校验流程以备扩展。
- **Web/H5**：默认非自动续费；到期前 7/3/1 天与到期日 T+0 发送站内通知与邮件。

### 11.6.2 升级

- **生效**：立即生效（Immediate）。
- **计费**：按剩余时间比例抵扣旧计划，补差价；抵扣规则向下取分（cent）。
- **权益**：支付成功后 ≤5 s 下发新 Plan entitlements。

### 11.6.3 降级

- **生效**：默认周期末生效（At Period End）。
- **计费**：不退差（除非本地政策要求），下周期按低档价扣费/结算。
- **配置**：支持“立即降级”开关，仅用于合规场景（默认关闭）。

### 11.6.4 变更与并发

- 幂等键：`idem_key = hash(user_id + plan_id + period + request_ts_bucket)`；重复请求仅一次入账。

## 11.7 试用、优惠与促销（MVP 可选）

- **试用**：新品或回流促销可配置 3–7 d 试用，仅新用户可领，每用户限 1 次。
- **优惠**：支持百分比/固定额券；不可叠加；过期作废。
- **防刷**：设备指纹+账户+支付指纹多信号去重；命中风控不发放。
- **结算**：优惠在生成账单行前应用，账单展示原价、优惠、应付三列。

## 11.8 币种、税务与支付通道

- **币种**：随渠道能力配置；账单以订单币种展示，不做跨币种换算回写。
- **税务**：遵循各渠道含/不含税规则，账单标注税额字段；不承诺代开税票（MVP）。
- **通道（MVP）**：Web/H5 仅接入微信支付与支付宝；一次性扣款，无循环代扣。iOS/Android 应用商店计费不在 MVP 范围，留待后续阶段。

## 11.9 账单与收据

- **账单字段（Invoice）**：`invoice_id、order_id、user_id、plan/price、周期、币种、原价、优惠、税额、应付、支付渠道、交易号、下发时间、生效/到期时间、收据下载链接`。
- **收据下载**：生成一次性下载链接，TTL 10 分钟，过期需重新申请。
- **呈现**：账单列表可按时间、渠道、状态过滤；详情页展示订单与交易关联关系。
- **可追溯**：每张账单带 `trace_id` 串联调用链路。

## 11.10 退款、撤销与争议

- **原则**：退款与争议处理遵循渠道规则，保持权限与状态幂等同步。
- **全额退款**：立即移除权益并回滚到免费态；记录退款原因与证据快照。
- **部分退款**：不影响权益，仅做财务记账与标签标注。
- **拒付/撤销**：收到渠道撤销/拒付成功事件后，状态置 `REVOKED` 并立即移除权益。
- **边界**：降级后发生的退款不反向提升权益。

## 11.11 对账与幂等

- **回调**：渠道 webhook → 幂等校验 → 按顺序更新订单/交易/订阅 → 生成 `entitlement_events` 推送权益域；权益域在 ≤5 s 内反馈“配额/权益同步完成”，否则记录补偿任务。
- **轮询**：对账任务每 15 分钟增量，T+1 全量校验；差异以“本地为准/渠道为准”可配置；若轮询比对发现权益域未在 5 s 内反馈，则立即重放 `entitlement_events` 并直连权益服务确认状态。
- **账龄**：生成应收/已收视图，支持 M0/M1/M2 账龄分析。
- **审计**：合规相关操作写入审计日志，定期归档且不可篡改。

## 11.12 权益下发与配额同步

- **触发**：订单支付成功、升级成功、到期、撤销、退款事件。
- **时效**：服务端计算新 entitlement 后 ≤5 s 同步到配额域与缓存（用户级 L1 10 分钟、共享 L2 30 分钟）。
- **一致性**：写后读不一致容忍 ≤5 s；期间以“更宽松不超限”为策略，绝不低发权益。
- **映射**：Plan → 限额（每日查词、再生成、历史留存上限、导出能力、模块自定义能力）来自[第 1 章「订阅与权益概览」](<./第 1 章 引言.md#144-订阅与权益概览>)表。

## 11.13 数据模型与表结构要点（逻辑）

- `plans`：`plan_id(pk)、name、level、entitlements(jsonb)、status`
- `prices`：`price_id(pk)、plan_id(fk)、period、currency、amount、store_product_id、active`
- `subscriptions`：`sub_id(pk)、user_id、plan_id、start_at、end_at、status、cancel_at_period_end(bool)`
- `orders`：`order_id(pk)、user_id、price_id、channel、amount、currency、status、idem_key、created_at`
- `transactions`：`txn_id(pk)、order_id、platform_txn_id、status、paid_at、raw_cb(blob)`
- `invoices`：`invoice_id(pk)、order_id、amount、tax、discount、receipt_url(ttl)、issued_at`
- `refunds`：`refund_id(pk)、order_id、amount、reason、status、refunded_at`
- **索引**：`user_id+status`、`platform_txn_id`、`idem_key` 唯一索引。
- **留存**：订单/账单/交易保留 ≥5 年；回调原文加密存储。

## 11.14 接口与交互（API/前端）

> 契约命名遵循语义化版本 `glancy.billing.v1`，不兼容变更需弃用期。

### 11.14.1 服务端 API（摘录）

- **API-12-001 获取当前订阅**
   `GET /v1/subscriptions/current` → `{ plan_id, status, start_at, end_at, entitlements }`
- **API-12-002 创建订单（预览账单）**
   `POST /v1/orders` body:`{ price_id, channel, coupon? }` → `{ order_id, invoice_preview }`
- **API-12-003 确认支付（Web/H5）**
   `POST /v1/orders/{order_id}/confirm` → `{ txn_id, subscription }`
- **API-12-004 升级订阅**
   `POST /v1/subscriptions/upgrade` body:`{ target_price_id }`
- **API-12-005 取消自动续费/到期不续**
   `POST /v1/subscriptions/cancel` body:`{ cancel_at_period_end: true }`
- **API-12-006 账单列表与详情**
   `GET /v1/invoices`、`GET /v1/invoices/{invoice_id}`
- **API-12-007 恢复购买（商店）**
   `POST /v1/store/restore` body:`{ receipt/token }`
- **API-12-008 支付回调**
   `POST /v1/webhooks/{provider}`（验签、幂等、事件幂等落库）

### 11.14.2 前端/UX 要求

- 订阅页：三档权益矩阵与价格对比；选中后进入对应渠道支付。
- 结果页：支付成功即显示“已解锁”并提示权益变更；失败给出可重试与客服入口。
- 管理页：显示当前 Plan、周期、到期日、自动续费状态、账单列表与收据下载。
- 恢复购买：移动端提供“恢复购买”入口。
- 通知：到期提醒、续费失败、成功续费、试用结束 4 类消息。

## 11.15 事件流与审计

- **业务事件**：`order.created|paid|failed`、`subscription.activated|renewed|canceled|expired|upgraded|downgraded`、`billing.invoice.issued`、`billing.refund.succeeded`、`billing.chargeback.accepted`；所有事件均携带 `traceId`。
- **审计事件**：合规敏感操作（退款、撤销、恢复）写入不可篡改日志，周期归档。

## 11.16 性能与 SLO（订阅域）

| 指标                 | 目标                                  |
| -------------------- | ------------------------------------- |
| 订阅开通与续费成功率 | ≥ 98%（与[第 1 章「成功标准与关键指标」](<./第 1 章 引言.md#16-成功标准与关键指标>)保持一致） |
| 权益同步时延（P95）  | ≤ 5 s（支付成功到 entitlements 生效） |
| 回调处理时延（P95）  | ≤ 2 s                                 |
| 账单生成成功率       | ≥ 99.5%                               |
| 幂等冲突率           | ≤ 0.1%                                |

## 11.17 风险与回退

| 风险             | 表现             | 回退/补救                                                    |
| ---------------- | ---------------- | ------------------------------------------------------------ |
| 回调丢失或延迟   | 状态不同步       | 启动轮询对账，按“渠道为准/本地为准”策略纠偏；不影响已下发权益。 |
| 双扣或重复下单   | 并发导致多笔交易 | 幂等键拦截；多余交易自动退款或不入账。                       |
| 升级中配额未刷新 | 短时不一致       | 读写穿透 + 5 s 内兜底刷新；以更宽松策略避免误限流。          |
| 渠道争议/拒付    | 权益被动撤销     | 立即 REVOKED 并通知用户；保留人工申诉入口。                  |

## 11.18 验收要点（UC 对齐）

- **UC-11-01 开通订阅（Web/H5）**：下单→支付→回调→ACTIVE→权益到位。
- **UC-11-02 续费成功（Web/H5）**：到期前提醒→用户确认续费→支付成功→权益延长。
- **UC-11-03 升级订阅**：即时补差→权限即时提升→配额上限变更。
- **UC-11-04 降级到期生效**：设置到期不续/降级→当前周期不变→到期 EXPIRED/新 Plan 生效。
- **UC-11-05 退款（全额）**：平台退款→状态 REFUNDED→权益移除→账单红冲。
- **UC-11-06 拒付**：渠道争议成立→REVOKED→立即移除权益并告警。
- **UC-11-07 收据下载**：账单详情生成一次性链接→10 分钟有效→可重复申请。

------

**与前文衔接说明**：

- 权益与限额的具体数值、模块自定义能力、历史留存与导出能力，均以[第 1 章「订阅与权益概览」](<./第 1 章 引言.md#144-订阅与权益概览>)为准；配额重置口径与计量统一规则见附表。
- 幂等键、回放样本、契约版本、下载链接 TTL、审计与归档口径与附录（含[附录 A 术语与缩略语](<./Appendix/附录 A 术语与缩略语.md>)）保持一致。

> 本章作为订阅域 SSoT，后续若有价格、周期或状态机调整，需在此章更新并触发契约弃用流程。