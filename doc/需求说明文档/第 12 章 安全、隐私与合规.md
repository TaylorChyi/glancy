# 第 12 章 安全、隐私与合规

> 目的：建立贯穿“产品→接口→数据→运营”的安全与隐私控制基线，落实合规职责与验收口径，作为 MVP 的强制门槛与后续演进的上位约束。本章位置与编号以文档目录为准。
>  适用对象：前后端与平台服务、任务与存储、第三方依赖（登录、支付、Doubao）。本章与第 1 章范围、术语与成功标准以及第 6 章 NFR 的既有红线一致。

------

## 12.1 目标与范围

- **目标**
  1. 保障端到端机密性、完整性、可用性；2) 以最小化与可撤回为隐私基线；3) 提供可回放、不可篡改的审计；4) 落实下载链接与删除语义等统一口径；5) 与订阅/配额/架构契合，不引入冲突。
- **范围**
   传输与存储加密、身份与访问控制（RBAC/最小权限）、输入校验与降级、密钥与证书、日志与审计、隐私与数据主体权利、跨境与子处理者、事件响应与披露、SDLC 安全与发布。上述条目与 NFR-006/007/013/020 等条款保持一致。

------

## 12.2 基本原则

1. **契约与单一事实源**：接口、下载 TTL、删除语义、配额/限流均以既有章节口径为 SSoT，不在本章重复数值。
2. **最小化**：仅收集与查词与订阅所需字段，默认关闭非必要留存；无痕查询不落原文。
3. **默认安全**：TLS1.2+ 传输、AES‑256 at‑rest；密钥集中管理与周期轮转≥90 天。
4. **最小权限与可审计**：后台操作最小角色、二次确认与全链路 trace_id。
5. **故障优雅退化**：依赖异常时回退“基础释义+模板例句”，并在 UI 明示。

------

## 12.3 风险模型与威胁面（摘要）

- **资产**：账户/订阅、画像、查词原文与结果、历史与导出、计费与收据、密钥与令牌。
- **入口**：Web/H5、API 网关、第三方 Webhook、对象存储下载、后台管理。
- **主要威胁**：越权与权限提升、凭证滥用、注入与 SSRF、XSS/CSRF、数据外泄（日志/导出/跨境）、DoS 与成本滥用、供应链与第三方失陷。
- **对策总览**：RBAC+最小作用域令牌、输入/输出校验与 CSP、速率限制与熔断、字段与对象级访问控制（Row/Column）、下载一次性链接与签名、审计不可篡改与追踪、SAST/DAST/依赖检查、供应商评估清单。

------

## 12.4 身份与访问控制（IAM/RBAC）

- **鉴权与会话**
   所有 API 采用 `Authorization: Bearer <token>`；支持用户态 JWT 与 `GUEST` JWT，Webhook 采用 HMAC 验签；请求与响应统一传回 `X-Trace-Id`。
- **RBAC 与角色边界**
   采用第 3 章角色矩阵（R1–R6）。后台导出、审计与限流配置仅限具备相应角色的人员，权限变更需双人复核并写入审计。
- **最小作用域**
   令牌按用途设置 Scope（lookup/regen/history/exports/admin），过期自动失效；`GUEST` 会话仅允许查词、再生成与导出申请。
- **会话安全**
   JWT 采用短时有效期与刷新机制；撤销或登出后黑名单失效；跨域仅允许受控来源（见 12.7 CSP）。

### <a id="1241-guest-multiquota"></a>12.4.1 游客多维配额模型（Guest Multi-Dimension Quota）

| 维度（键）                        | 指标                      | 每日上限（硬编码初始值） | 说明 |
| --------------------------------- | ------------------------- | ------------------------ | ---- |
| 会话级 `guest_user_id`           | 查词次数 `LOOKUP_PER_SESSION_PER_DAY` | 20                     | 解析自 HttpOnly Cookie `glancy_guest_session`；清除 Cookie 仅重置该维度。 |
|                                   | LLM 次数 `LLM_PER_SESSION_PER_DAY`   | 5                      | 计入例句再生成等高成本 LLM 调用。 |
| IP 级 `client_ip`                | 查词次数 `LOOKUP_PER_IP_PER_DAY`     | 60                     | 防止同一 IP 扩充游客会话横向刷量。 |
|                                   | LLM 次数 `LLM_PER_IP_PER_DAY`        | 15                     | 包含所有 `GUEST` 会话及浏览器实例。 |
| 设备指纹级 `device_fingerprint`   | 查词次数 `LOOKUP_PER_DEVICE_PER_DAY` | 60                     | 指纹按 12.4.2 的算法生成，在 `POST /api/v1/sessions/guest` 中必传。 |
|                                   | LLM 次数 `LLM_PER_DEVICE_PER_DAY`    | 15                     | 与 IP 同级阈值，辅助识别频繁清 Cookie 的同一设备。 |
| 新建游客会话（IP 级）            | `GUEST_SESSION_CREATE_PER_IP_PER_DAY` | 5 次                  | 针对 `POST /api/v1/sessions/guest`；超过后禁止创建新会话。 |

- **统一判定规则**
  - 查词/LLM 请求：计算 `session_remaining`、`ip_remaining`、`device_remaining`，真实剩余额度取三者最小值。任一维度<=0 则拒绝，返回 `429 LIMIT_EXCEEDED`，响应体：
    ```json
    {
      "errorCode": "LIMIT_EXCEEDED",
      "errorMessage": "Daily quota exceeded for guest user",
      "limitType": "GUEST_DAILY_LOOKUP"  // 或 GUEST_DAILY_LLM
    }
    ```
  - `POST /api/v1/sessions/guest`：计算 `ip_new_session_remaining`，若<=0 则返回 `429 GUEST_CREATION_LIMIT_EXCEEDED`，响应体：
    ```json
    {
      "errorCode": "GUEST_CREATION_LIMIT_EXCEEDED",
      "errorMessage": "Too many guest sessions created from this IP today"
    }
    ```
- **配额一致性**
  - 清除 Cookie 仅重置“会话级”计数，不会影响 IP、设备指纹与新建会话次数；同一 IP + 设备组合在达到阈值后，即使重新申请游客会话仍会被拒绝。
  - 配额命中日志需写入 `quota_events` 表，包含 `dimension`、`limitType`、`subjectId`、`client_ip`、`device_fingerprint`，供反滥用策略与审计使用。
  - 配额阈值归口第 10 章，如需调节需同步更新此处 SSoT，并在 20 章验收中追加测试。

### <a id="1242-device-fp"></a>12.4.2 设备指纹规范（Device Fingerprint Requirements）

- **用途与强制性**
  - `device_fingerprint` 与 IP、会话一起组成游客防刷/配额的三条主轴，**为必传字段**，不是“二期优化”。
  - 用于识别“同一 IP 下反复清 Cookie 的同一设备”，协助配额判定与风控策略；**不作为身份认证**，也不与手机号/邮箱/实名等敏感信息关联。
  - 仅用于资源保护与反滥用，不用于广告、跨站追踪或画像。
- **前端生成策略（初始化阶段执行）**
  1. 收集字段：`User-Agent`、屏幕分辨率（宽、高）、浏览器语言、时区（IANA zone）、可用的 Client Hints（如 `Sec-CH-UA-Platform`、`Sec-CH-UA-Full-Version`）。
  2. 对字段统一做小写、去首尾空格、长度截断（建议≤128 字符）。
  3. 以固定顺序拼接为字符串：`ua|widthxheight|lang|tz|platform|uaVersion`。
  4. 使用 SHA-256（或更强算法）计算哈希 → `device_fingerprint`（HEX 或 Base64URL）。
  5. 首次调用 `POST /api/v1/sessions/guest` 必须随请求体上传；后续请求沿用同一指纹。
  6. 若浏览器阻止某字段，使用占位值 `unknown`，但仍需生成哈希。
- **后端存储与计数**
  - Redis Key 结构：`guest:quota:device:{device_fingerprint}:{metric}:{YYYYMMDD}`，其中 `metric ∈ {lookup, llm}`，TTL=1 天，与每日配额周期一致（00:00 本地日）。
  - 写入时同时增加 `guest:quota:ip:{client_ip}:{metric}:{YYYYMMDD}` 等键，保证设备/IP 并行计数；任一耗尽即触发 12.4.1 中的 `LIMIT_EXCEEDED`。
  - 创建游客会话时记录 `guest:session:create:ip:{client_ip}:{YYYYMMDD}`，配合同维度判断是否超过 `GUEST_SESSION_CREATE_PER_IP_PER_DAY`。
  - 若收到请求缺失 `deviceFingerprint`，允许临时按 IP 维度判定，但需：① 记录 `quota_events` 中 `dimension=device_missing`；② 触发告警，提示客户端修复；③ 在响应头 `X-Quota-Warning: device_fingerprint_missing` 标记。
- **隐私说明**
  - 指纹仅存哈希，不落原始 UA/分辨率组合；禁用反向恢复。
  - 不与实名信息结合，不用于广告或跨站追踪；只在配额与风控日志中用于聚合统计，留存期与 `quota_events` 一致（默认 30 天）。

### 12.4.3 游客模式能力边界

- **可明确防御**：
  - 同一 `guest_user_id`/Cookie 在 20 次查词或 5 次 LLM 内受限，清除 Cookie 仅重置会话维度；
  - 同一 IP + 设备指纹组合在 60 次查词 / 15 次 LLM 内受限，即便切换浏览器或无痕模式仍受约束；
  - 每个 IP 每天最多 5 次创建游客会话，无法无限刷新的“薅羊毛”。
- **部分抑制**：
  - 同一 C 段内大量自动化请求，可通过多维配额 + 17 章反滥用策略（黑名单、行为检测）联合降速，但仍依赖 OPS/SRE 观察；
  - 低成本代理轮换但未伪造设备信息的脚本，会迅速触发 IP/设备指纹维度并被速率限制。
- **无法绝对防止**：
  - 在不收集手机号、邮箱、实名等 PII 的前提下，系统不能保证“每个真人一个配额”；
  - 高强度攻击者若持续更换 IP、伪造指纹甚至使用僵尸网络，仅靠游客配额无法完全阻断，需要额外的黑名单、指纹信誉、行为分析等策略（第 17 章覆盖）；
  - 游客模式不会主动采集或储存可识别个体的资料，因此天然无法达到实名级风控强度。

> 综上，游客模式的目标是“提高滥用成本并保护核心资源”，而非提供与实名用户等价的身份鉴别能力。

------

## 12.5 数据安全与加密

- **分类分级与保护**
   按第 9 章分级：S0–S3，邮箱/订单/下载链接等 S2–S3 字段列级脱敏与最小留存；导出文件视作 S3，下载链接一次性，TTL 10 分钟。
- **传输与存储**
   全链路 TLS1.2+；静态数据采用 AES‑256。密钥集中管理，≥90 天轮转；对象存储采用服务端加密与最小访问策略。
- **删除语义**
   逻辑删除即时可见，物理清理 T+7 天定时任务执行；窗口内可恢复。
- **历史与无痕**
   历史留存与条数随订阅档位；无痕查询不落原文，仅计配额。

------

## 12.6 网络与边界安全

- **边界**：WAF 与 API 网关统一接入，执行 TLS 终止、速率限制、统一错误码与观测起点。
- **分段**：前端静态资源/CDN 与后端服务域划分；内部与外部出入口最小暴露；到 Doubao 的外呼设置熔断与半开。
- **下载面**：导出与收据下载固定使用一次性签名 URL，TTL 10 分钟，到期失效。

------

## 12.7 应用安全（输入/输出、内容安全）

- **输入校验**
   仅接受“单词/词组”；句子输入按 8.10.0 判定规范拒绝并返回统一错误体。
- **输出与前端安全基线**
   前端开启 CSP（default‑src 'self'；禁止混合内容；仅允许受控域脚本）、X‑Frame‑Options=DENY、SameSite=Lax Cookie、Referrer‑Policy=strict‑origin‑when‑cross‑origin。
- **防滥用与成本护栏**
   速率限制与配额独立生效；命中 429 时返回剩余额度、冷却与重置时间；在预算阈值 80%/95% 触发强缓存与关闭再生成等降级。
- **降级与熔断**
   依赖 5xx≥5% 且持续 1 分钟触发熔断，统一回退“基础释义+模板例句”，前端展示退化提示。

------

## 12.8 密钥、证书与机密管理

- **密钥来源**：使用集中式 KMS/Secrets 管理；严禁将密钥/令牌入库或写入代码仓库。
- **轮转策略**：业务密钥≥90 天轮转；证书到期前 30 天预警并自动续签；轮转记录进入审计日志（不可篡改）。
- **访问控制**：按最小权限授予服务账号；跨环境（Dev/Staging/Prod）密钥隔离。

------

## 12.9 日志、审计与证据保全

- **日志三分法**：指标/日志/追踪完整；99% 请求具备 `trace_id`；日志脱敏并禁止记录无痕原文。
- **审计不可篡改**：权限变更、下载、删除恢复、计费与退款等写入 `audit_events`，按 365–730 天归档策略执行。
- **回放与对账**：订阅与回调幂等落库，可按 `trace_id` 回放链路；对账与票据留痕遵循第 11 章。

------

## 12.10 隐私与数据主体权利（DSR）

- **同意与撤回**：首次登录展示条款与隐私；设置页提供撤回入口。撤回后停止非必要处理并提示导出/删除路径。
- **导出**：用户可导出历史（CSV/JSON）；POST /exports 返回 202 与回执，P95 ≤ 5 s 获得一次性下载链接（TTL 10 分钟）。
- **删除**：删除即刻逻辑删除，T+7 天物理清理；窗口期可按回执恢复。无痕模式下不落历史正文。
- **最小化与目的限制**：画像字段与用途、留存与清理与第 3、9 章一致，避免将提示词等冗余上下文持久化。

------

## 12.11 跨境、子处理者与第三方

- **子处理者清单**：Doubao、登录与支付、对象存储、观测平台等第三方纳入清单并维护 DPA/SCC 与数据类别、地区与保留期。
- **跨境规则**：跨境传输仅限必要最小集，传输与存储加密；在合规模板中记录处理目的、类别与保留期并定期复核。
- **Webhook 安全**：支付与订阅回调采用 HMAC 验签与幂等写入；重试指数退避。

------

## 12.12 Cookie 与追踪

- **Cookie 策略**：仅使用必要 Cookie；身份 Cookie 标记 HttpOnly、Secure、SameSite=Lax；可在设置关闭非必要追踪。
- **指纹**：`GUEST` 会话仅存指纹哈希，限定于配额统计用途。

### 12.12.1 游客模式数据收集与使用

- **收集项（游客会话）**
  - `client_ip`（含 CIDR 解析）；
  - `user_agent`（浏览器/设备类型）；
  - `screen_resolution`（例如 `1920x1080`）；
  - `timezone_offset` 与 `accept_language`；
  - 游客 `guest_user_id`（由 `POST /api/v1/sessions/guest` 创建）；
  - `device_fingerprint` 哈希值（由分辨率、UA、语言等组合生成，12.4.2 所述算法）。
- **用途限定**
  - 仅用于游客防刷、速率限制与多维配额判定；不参与广告投放、画像或第三方追踪。
  - 不与手机号、邮箱、实名资料等做关联；用于风控的日志中仅出现游客 ID 与指纹哈希。
- **留存策略**
  - 配额计数（`guest:quota:*` 与 `guest:session:create:*`）按日粒度保存 1 天，自动到期清理。
  - 安全日志与审计事件按 12.9 的既有策略保留，可更长但不得反推出真实身份，且仅在安全事件分析时访问。
- **合规声明**
  - 游客模式仅保留必要的游客技术指标，无法形成长期可识别行为轨迹；如需对外披露或更新《隐私政策》，同步加入：“游客模式下不保存长期可识别个人行为轨迹，仅保留必要的游客技术数据用于防滥用与服务稳定性。”

------

## 12.13 支付与账单数据保护

- **账单/收据**：账单下载链接一次性且 TTL 10 分钟；订单/交易/回调原文加密存储；退款/撤销立刻同步权限。
- **对账一致性**：回调优先、轮询兜底；幂等键保证一次生效；差异≤1% 目标与 NFR 一致。

------

## 12.14 安全事件响应与披露（SIRT）

- **分级**：P1 数据外泄/凭证泄露；P2 可利用漏洞；P3 限定影响的故障。
- **时效**：检测→确认≤30 min；隔离≤60 min；根因与补救≤24 h；合规披露按监管与合同要求执行。
- **联动**：与 13 章可用性与备份演练同步，定期桌面演练与复盘纳入变更流程。

------

## 12.15 安全 SDLC 与发布

- **设计阶段**：威胁建模（STRIDE）与数据流图；接口契约评审与弃用期策略。
- **开发阶段**：SAST/依赖漏洞扫描、Secrets 扫描；敏感字段脱敏单测；契约回放≥500 样本。
- **测试与发布**：DAST/端到端安全用例；零停机发布、灰度/回滚与自动化回归。

------

## 12.16 合规映射（摘录）

| 主题                       | 控制与实现                                                   | 章节对齐               |
| -------------------------- | ------------------------------------------------------------ | ---------------------- |
| 数据最小化与目的限制       | 画像字段与留存最小化；无痕不落原文；导出/删除可用            | 3.5、9.7、8.6          |
| 数据主体权利（导出/删除）  | `/exports` 与删除/清理 API；10 分钟一次性下载链接；T+7 物理清理 | 8.6、1.4.3、9.13       |
| 传输/存储加密与轮转        | TLS1.2+/AES‑256、KMS 管理、≥90 天轮转                        | 6.5（NFR-020）         |
| 审计与可追溯               | trace_id 贯穿；审计表不可篡改；事件回放                      | 6.2、9.5、9.9          |
| 速率限制与公平隔离         | 用户/租户/全局三级限流与配额、预算护栏与自动降级             | 10.4、10.7、10.10      |
| 订阅权益一致与合规对账     | 回调优先与幂等；5 s 权益下发；退款/撤销即时降权              | 11.5、11.12、11.15     |
| 子处理者清单与跨境传输记录 | 合规模板维护 DPA/SCC、地区与数据类别；定期复核               | 7.9、2.7、目录 24 预留 |

------

## 12.17 控制矩阵与验收（与 NFR 对齐）

| 编号   | 验收项（必须）              | 通过条件（抽样口径）                                         |
| ------ | --------------------------- | ------------------------------------------------------------ |
| SEC‑01 | 传输/存储加密与轮转         | TLS 检测仅 1.2+；数据库与对象存储 at‑rest 加密开启；KMS 轮转记录≤90 天；抽样 10 项无明文密钥。 |
| SEC‑02 | 下载与清理语义              | 导出≤5 s 返回回执；下载链接一次性、TTL 10 分钟到期失效；删除后 T+7 天物理清理可验证。 |
| SEC‑03 | RBAC 最小权限与后台操作审计 | 管理操作存在二次确认与审计记录；审计样本可回放；越权访问被拒并记录。 |
| SEC‑04 | 输入拦截与错误模型          | 句子输入被前端拦截；服务端返回统一错误体与错误码；日志脱敏。 |
| SEC‑05 | 配额、限流与预算护栏        | 429 返回包含 `retry_after_ms` 与重置；80%/95% 预算阈值触发强缓存/关闭再生成，并写入事件流。 |
| SEC‑06 | 熔断与降级                  | 人工拉高依赖 5xx 触发熔断；结果回退基础释义且标注退化；半开探测恢复。 |
| SEC‑07 | 审计不可篡改与追踪          | 99% 请求具备 trace_id；审计事件保存≥365 天；下载/删除操作具备回执与追踪链路。 |
| SEC‑08 | 订阅对账幂等与权益同步      | 支付回调重放不重复入账；P95 ≤ 5 s 权益到位；退款/拒付即时降权。 |

> 以上验收项作为第 20 章测试方案的强制前置门槛，安全/隐私不达标不得发布。

------

## 12.18 组织与文档

- **制度与模板**：隐私政策、使用条款、RoPA、DPA/SCC、子处理者清单与变更公告模板，归档于“合规模板与第三方清单（附录）”并定期评审。
- **术语一致**：术语、计量与阈值严格采用附录 A。

------

### 附：与相关章节的联动索引（摘取）

- **范围/白名单/删除语义/下载 TTL**：第 1 章、8.6、9.13。
- **RBAC/角色**：第 3 章。
- **架构/网关/熔断与降级**：第 7 章。
- **NFR 红线（加密/隐私/审计/可观测）**：第 6 章。
- **配额/限流/预算护栏**：第 10 章。
- **订阅/账单/对账**：第 11 章。

> 本章为实施与验收的上位约束；后续若有更严要求，以更严者为准；若有更宽放宽，须在变更管理流程中声明并更新弃用期与回归样本。
