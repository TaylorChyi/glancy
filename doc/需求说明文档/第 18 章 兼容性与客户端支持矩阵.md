# 第 18 章 兼容性与客户端支持矩阵

> 目的：定义 MVP 阶段 Web/H5 的“浏览器/系统/设备/内嵌 WebView”支持边界、降级策略与验收标准，使之与“范围（仅 Web/H5、不要求离线）”“端到端性能与可访问性门槛”“TLS 与数据控制”等上位条款保持一致。本章为 NFR‑033/010 的落地细化。

------

## 18.1 设计目标与原则

- **以用为先**：核心链路（UC‑01/02/03/04/05/08/14）在“支持矩阵”内必须可用；非关键增强在不满足前提时自动降级且**不失能**。
- **范围约束**：MVP 仅交付 **Web/H5**；不提供离线与原生客户端能力；支付仅对接微信支付与支付宝。
- **性能基线**：端到端首个内容模块渲染 P95 ≤ 2.5 s、均值 ≤ 1.2 s；降级不得使 P95 恶化超过 10%。
- **安全与隐私**：仅 HTTPS（TLS 1.2+），一次性下载链接 TTL 10 分钟；无痕查询不落库原文。
- **i18n/a11y**：UI 至少支持 zh/en，达到 WCAG 2.1 AA（键盘可达、语义标签、对比度）。

> 交叉引用校正：NFR‑010/033 中“按第 17 章执行”的兼容性条款，统一指向本章（第 18 章）。

------

## 18.2 支持级别定义

| 级别             | 定义                                                    | 验收总则                                         |
| ---------------- | ------------------------------------------------------- | ------------------------------------------------ |
| A 级（完全支持） | 满足功能、性能、a11y 全量要求；无需用户干预             | 全链路 UC 覆盖；无视觉/交互差异；P95/SLO 达标    |
| B 级（功能支持） | 核心功能可用，增强能力按策略降级；视觉/动画可有轻微差异 | 功能不失能；降级提示可见；性能目标不退化超过 10% |
| C 级（不支持）   | 无法保证功能闭环或存在重大安全/隐私风险                 | 显示“受支持环境列表”与下载指引；禁止进入关键链路 |

------

## 18.3 浏览器/系统/设备矩阵（MVP）

> 版本口径：**“近两个稳定大版本”** 或 **“操作系统近两个大版本”** 的**自动更新浏览器**；非自动更新浏览器需达到等效内核版本或列入 B 级。

### 18.3.1 桌面（Desktop）

| OS      | 浏览器                  | 版本策略                          | 级别 | 备注                         |
| ------- | ----------------------- | --------------------------------- | ---- | ---------------------------- |
| Windows | Chrome、Edge、Firefox   | 最近 2 个稳定版                   | A    | 需支持 ES Modules/Fetch/Intl |
| macOS   | Safari、Chrome、Firefox | Safari/Chrome/Firefox 最近 2 大版 | A    | 触控板与键盘可达性验收       |

### 18.3.2 移动（Mobile Web/H5）

| OS         | 浏览器                   | 版本策略               | 级别 | 备注                        |
| ---------- | ------------------------ | ---------------------- | ---- | --------------------------- |
| iOS/iPadOS | Safari（含系统 WebView） | 最近 2 个 iOS 大版本   | A    | 支付页拉起按 H5 流程验收    |
| Android    | Chrome（含系统 WebView） | 最近 24 个月内的稳定版 | A    | 系统 WebView 需开启自动更新 |

### 18.3.3 内嵌 WebView（支付/内置浏览器）

| 宿主             | 内核来源                               | 级别 | 说明                                                         |
| ---------------- | -------------------------------------- | ---- | ------------------------------------------------------------ |
| 微信内置浏览器   | iOS WKWebView / Android System WebView | B    | H5 支付直连；若 JS Bridge 不可用，回退 H5 跳转/二维码指引（桌面）。 |
| 支付宝内置浏览器 | 同上                                   | B    | 同上；回调幂等由服务端保障。                                 |

> 任何低于上述边界的环境统一判定为 C 级，并展示“受支持环境列表与升级指引”。

------

## 18.4 前端能力基线与 Polyfill 策略

- **JavaScript**：ES Modules、`fetch`、`Promise`、`Intl`、`URL` 必备；不满足则阻断并提示升级。
   Polyfill 仅对 `Intl.PluralRules/DateTimeFormat` 与 `IntersectionObserver` 做**按需加载**，其余一律通过构建目标与浏览器列表解决。
- **CSS**：Flex/Grid 为布局基线；`prefers-reduced-motion` 用于动画降级。
- **存储**：`localStorage`、`sessionStorage` 用于轻量偏好与一次性回执；禁用时切回内存会话态，不影响 UC‑01/02/03。
- **网络**：XHR/Fetch 双栈可替换；断网不提供离线，直接提示重试（与“**不要求离线**”一致）。

------

## 18.5 功能降级与回退路径（关键清单）

| 能力/场景                | 依赖                                    | 降级/回退                                                    |
| ------------------------ | --------------------------------------- | ------------------------------------------------------------ |
| 结构化结果渐进渲染       | ES Modules、Fetch、IntersectionObserver | 关掉懒加载，整体渲染；保底显示“基础释义 + 模板例句”。        |
| 再生成（难度/风格切换）  | Fetch、Event Loop                       | 失败不致命；保留上次结果并显示配额提示。                     |
| 历史/导出                | 下载链接、CSV/JSON、一次性 URL          | 链接失效提示“重新申请”；TTL 10 分钟写明。                    |
| 订阅开通/续费（H5 支付） | 内嵌 WebView JS 能力/外跳               | JS 能力缺失时回退 H5 外跳/扫码；回调丢失由轮询兜底与幂等更新。 |
| 无痕查询                 | 存储能力                                | 仅渲染态，不写本地/后端；提示“本次不留痕”。                  |
| 同语模式                 | UI 翻译位                               | 永不显示译文位，避免误渲染。                                 |

------

## 18.6 可访问性与国际化协同

- **语言**：默认跟随系统语言，支持 zh/en 切换；所有文案均使用 i18n key。
- **a11y**：键盘可达、焦点可见、语义标签、表格关联、ARIA 合理；对“减少动画”用户关闭过渡动画。验收口径按 NFR‑035。

------

## 18.7 性能与网络适配（客户端侧）

- **资源预算**：首屏所需 JS/CSS 控制在满足端到端 P95 目标的前提下最小化；按页面拆包与懒加载。
- **缓存协同**：客户端不做长期结果缓存；依赖服务端 L1/L2 与降级链路（“基础释义 + 模板例句”）。
- **弱网策略**：当 `navigator.connection.effectiveType` 显示 2G/slow‑2G 时，自动降详略一档、关闭动画。

------

## 18.8 安全与隐私前置条件（客户端约束）

- **传输**：仅 HTTPS（TLS 1.2+）；混合内容（HTTP 资源）一律拒绝加载。
- **令牌**：使用 `Authorization: Bearer`；禁止通过 URL 传递敏感参数与令牌。
- **下载**：一次性链接，TTL=10 分钟，过期需重新申请；链接绑定用户主体。

------

## 18.9 兼容性监测与告警

- **埋点**：上报浏览器 UA 归一化指纹、特性探测结果、渲染降级位、下载失败与原因、支付回调耗时。事件与指标遵循第 14 章三分法；trace_id 贯穿。
- **看板**：A/B 维度展示 A/B 级环境的 P95、错误率、429 命中率与降级率，联动“成本燃率与缓存命中”看板。

------

## 18.10 兼容性测试矩阵（抽样）

> 以“近两版”为原则，每类至少挑选“最新 + 上一版”进行回归；以下为模板。

| 分组 | 平台/浏览器样例                              | 场景                    | 预期                       |
| ---- | -------------------------------------------- | ----------------------- | -------------------------- |
| D‑A  | Windows + Chrome 最新/上一版                 | UC‑01/02/03 首屏与再生  | P95 达标，结构化正确率达标 |
| D‑B  | macOS + Safari 最新/上一版                   | UC‑04/05 历史/清理/导出 | 链接 TTL 正确、回执 ≤ 5 s  |
| M‑A  | iOS + Safari 最近 2 大版                     | H5 支付与回调           | ≤ 5 s 权益到位、回调幂等   |
| M‑B  | Android + Chrome 最近 24 个月内稳定版        | 无痕查询/导出           | 无痕不落库、导出一次性     |
| W‑B  | 微信/支付宝内置浏览器（iOS/Android 各 1 款） | 支付失败/回退链路       | 外跳/扫码回退可用          |

验收口径对齐第 20 章测试方案与 UC 对齐清单。

------

## 18.11 客户端特性白名单与灰名单

- **白名单（允许使用）**：ES Modules、Fetch、Intl、History API、IntersectionObserver、Clipboard（非必须）。
- **灰名单（可用即用，不可用即降级）**：`navigator.connection`、`prefers-reduced-motion`、Service Worker。
- **黑名单（MVP 禁止）**：通知权限、持久化存储、后台同步、跨域第三方脚本注入。

------

## 18.12 变更与版本策略

- **浏览器列表更新**：按季度评估一次，遵循“近两版/近两年”口径；任何收敛或放宽需走第 22 章的变更与弃用流程，并在前端展示“将停止支持”的 Sunset 文案。
- **契约不变更原则**：客户端兼容性调整不得影响 `glancy.dict.v1` 接口契约；如需变更，按语义化版本与弃用期执行。

------

## 18.13 风险与回退

| 风险场景              | 表现                   | 回退/补救                                                  |
| --------------------- | ---------------------- | ---------------------------------------------------------- |
| 内嵌 WebView 能力差异 | 支付拉起失败或回调延迟 | 外跳 H5、二维码回退；后台轮询与幂等更新保障状态一致。      |
| 低配设备/弱网         | 首屏超时               | 降详略、减少例句条数，优先渲染释义模块；显示“已降级”徽标。 |
| 本地存储被禁          | 偏好与回执丢失         | 内存态会话回退；功能不失能（UC‑01/02 正常）。              |
| 旧版浏览器（C 级）    | 无法加载或功能异常     | 显示“受支持环境列表与升级指引”，阻止进入关键链路。         |

------

## 18.14 验收清单（与 NFR/UC 对齐）

| 编号    | 验收项                                    | 通过条件                                                    |
| ------- | ----------------------------------------- | ----------------------------------------------------------- |
| C‑18‑01 | A 级环境 UC‑01/02/03/04/05/08/14 全量通过 | 端到端 P95/平均值达标；结构化输出正确率 ≥ 99%；降级位=0。   |
| C‑18‑02 | B 级环境“降级不失能”                      | 功能可用；降级提示可见；P95 恶化 ≤ 10%。                    |
| C‑18‑03 | 支付/回调（内嵌 WebView）                 | 直连成功；失败外跳/扫码回退可用；权益 ≤ 5 s 到位。          |
| C‑18‑04 | 下载与回执                                | 链接 TTL 10 分钟；≤ 5 s 返回回执与下载链接。                |
| C‑18‑05 | a11y 与 i18n                              | 键盘可达、对比度达标；zh/en 切换即时生效、文案覆盖率 100%。 |

------

**与前文衔接说明**

- 本章落地 NFR‑033/010 的“兼容性矩阵与降级不失能”，与“范围（仅 Web/H5）”“性能门槛”“安全/隐私”“i18n/a11y”保持一致；支付内嵌浏览器场景遵循订阅与账单的回调/幂等策略。
