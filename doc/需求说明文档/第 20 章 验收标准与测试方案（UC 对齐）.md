# 第 20 章 验收标准与测试方案（UC 对齐）

> 作用：把“目标/范围（第 1–2 章）→ 用例（第 4 章）→ 功能/非功能（第 5–6 章）→ 接口契约（第 8 章）→ 架构与配额/订阅/数据（第 7、9–11 章）”串成一套可执行的验收与测试体系，作为 MVP 发布门槛与持续回归基线。章节位置与命名以《目录》为准。 

------

## 20.1 目标与范围

- **目标**：以 UC 为主线定义可度量的验收标准（AC）与测试方案，覆盖功能正确性、端到端性能、可靠性/降级、配额与限流、数据与隐私、接口契约、兼容性、i18n/a11y 与订阅对齐。基准阈值承接第 1 章成功标准与第 6 章 NFR。  
- **范围**：Web/H5 形态，语言对白名单 L1–L4，输入仅“单词/词组”，同语模式不显示译文。  
- **方法**：UC→FR→AC 逐条映射；接口以 `glancy.dict.v1` 为契约事实源，契约不兼容变更走弃用与回放样本策略。 

------

## 20.2 相关事实源（SSoT）

- 成功标准与端到端阈值：第 1 章 1.6。
- 用例与业务规则：第 4 章（UC-01…UC-16）。
- 功能需求：第 5 章（FR-xxx）。
- 非功能约束与 SLO/SLA：第 6 章（NFR-xxx）。
- 架构/缓存/降级与发布：第 7 章。
- 接口与错误模型/幂等/分页/Quota Header：第 8 章。
- 数据模型/删除语义/导出 TTL：第 9 章。
- 配额/限流/成本护栏：第 10 章。
- 订阅/账单/权益同步（SSoT）：第 11 章。
- 术语口径与幂等键定义：附录 A。

------

## 20.3 验收门槛摘要（发布必过）

| 领域       | 门槛                                                         | 口径与来源                                               |
| ---------- | ------------------------------------------------------------ | -------------------------------------------------------- |
| 端到端性能 | 首个内容模块渲染：P95 ≤ 2.5 s；平均 ≤ 1.2 s                  | 以端到端口径统计；首屏定义见第 1 章与第 6 章 6.3/6.3.1。 |
| 可用性     | `lookup/regenerate/history/exports` 月度可用性 ≥ 99.9%        | 第 6 章 NFR-002。                                        |
| 熔断与降级 | 依赖 5xx≥5% 且持续 1 分钟触发；100% 自动回退“基础释义+模板例句”并标注退化 | NFR-003/NFR-017 与第 7 章熔断策略。                      |
| 语言/输入  | 仅 L1–L4；同语模式不显示译文；句子输入拒绝并返回统一错误     | 第 1 章 1.4.1/1.4.2 与第 8 章 8.10。                     |
| 配额/限流  | 自然日按本地时区重置；查词与再生成分开计数；命中 429 返回剩余额度与重置时间 | 第 10 章 10.2/10.3/10.4 与第 8 章限流/Quota 头。         |
| 缓存       | L1=10 分钟、L2=30 分钟；`X-Cache` 命中标记                   | 第 7 章 7.6 与第 8 章 8.4。                              |
| 数据语义   | 逻辑删即时；物理清理 T+7d；导出链接一次性且 TTL 10 分钟      | 第 9 章 9.7 与第 8 章 8.6。                              |
| 安全/隐私  | TLS1.2+、AES‑256 at‑rest、最小权限 RBAC、无痕不落正文        | 第 6 章 6.5 与第 9 章 9.7。                              |
| 订阅对齐   | 支付成功 ≤5 s 内权益生效；到期自动降级且能力边界同步         | 第 11 章 11.12/11.5。                                    |
| 契约回放   | 每次发布≥500 条样本，回放通过率 100%                         | 第 6 章 NFR‑031 与第 7 章 7.10。                         |

------

## 20.4 验收环境与数据

- **环境**：Dev/Staging/Prod 隔离；蓝绿/小流量灰度与自动回滚。
- **数据**：构造匿名与登录主体、Free/Plus/Pro 三档、不同时区用户；准备 500+ 契约样本与典型词条集（含多义项、同/反义、固定搭配等）。无痕场景禁止落正文。
- **账号**：订阅状态机样例（ACTIVE/GRACE/EXPIRED/REVOKED/REFUNDED），含升级/降级与退款路径。

------

## 20.5 测试类型矩阵

| 类别           | 目标                                                 | 关键工具/口径                                                |
| -------------- | ---------------------------------------------------- | ------------------------------------------------------------ |
| 功能与回归     | UC/FR 全量覆盖，异常与边界齐备                       | UC-01…16；错误码与提示对齐第 8 章。                          |
| 接口与契约     | `glancy.dict.v1` 字段/长度/同语模式校验；Idempotency | JSON Schema 校验＋500 样本回放；幂等键口径见附录 A/第 8 章。 |
| 性能与容量     | 首屏 P95/均值、依赖分段；300 QPS 稳定                | 第 6 章 6.3/6.3.2 与第 7 章 7.11。                           |
| 稳定性/降级    | 熔断触发/恢复、半开探测、退化提示                    | NFR‑017 与第 7 章 7.4.5。                                    |
| 配额/限流/成本 | 日配额重置、429 冷却、三层限流、预算护栏             | 第 10 章 10.2/10.4/10.7/10.10。                              |
| 数据/隐私/导出 | 删除语义、无痕、导出 TTL、脱敏                       | 第 9 章 9.7/9.10 与第 8 章 8.6。                             |
| 订阅与账单     | 权益下发 ≤5 s、对账幂等、退款/撤销策略               | 第 11 章 11.12/11.11/11.10。                                 |
| 兼容/i18n/a11y | 浏览器支持、zh/en 文案、WCAG 2.1 AA                  | 第 6 章 NFR‑010/NFR‑034/NFR‑035 与第 1 章 1.4.6。            |
| 观测与告警     | trace_id 贯穿率≥99%，关键告警演练                    | 第 6 章 NFR‑008/027/028 与第 7 章 7.6。                      |

------

## 20.6 UC→FR→AC 覆盖矩阵（摘录）

> 全量 UC-01…UC-16 列表见第 4 章；此处给出可执行级 AC 断言模板。

| UC                     | 关联 FR                | 关键 AC（通过即标绿）                                        |
| ---------------------- | ---------------------- | ------------------------------------------------------------ |
| UC‑01 查询词条         | FR‑001/002/004/010/011 | ① 非白名单拒绝并回 `INVALID_LANG_PAIR`；② 句子输入前端拦截，绕过后端返回 `ENTRY_NOT_WORD_OR_PHRASE`；③ 同语模式不出现 `translation` 字段；④ `X-Cache` 命中与否正确标注；⑤ 结构化输出满足 `glancy.dict.v1` 与详略预算；⑥ 首屏 P95 ≤ 2.5 s。 |
| UC‑02 再生成           | FR‑011/03              | ① 计入“再生成”而非“查词”配额；② 默认绕过 L2；③ 例句区块刷新不影响其他模块。 |
| UC‑03 难度/风格切换    | FR‑011/04              | ① 计入再生成配额；② `difficulty/style` 生效且受档位约束；③ 超限 429 返回冷却与 `X-Quota` 头。 |
| UC‑04/05 历史/清理     | FR‑020/021             | ① 留存时长/条数按档位；② 清理 5 s 内返回回执；③ 逻辑删即时、T+7d 物理清理可审计。 |
| UC‑06 导出             | FR‑022                 | ① `POST /exports` 202 回执，P95 ≤ 5 s 获得一次性链接（TTL 10 分钟）；② 内容脱敏、UTF‑8、表头固定；③ 演练记录符合 13.4.3（DR-04），导出 RTO ≤15 min。 |
| UC‑07 画像/偏好        | FR‑030/031             | ① 标签数量按档位限制；② 下次生成立即生效；③ 本地缓存与后端一致。 |
| UC‑08/09 订阅开通/到期 | FR‑041/091             | ① 成功 ≤5 s 内权益更新；② 到期自动降级、能力边界同步；③ 幂等更新与对账兜底。 |
| UC‑10 登录/注册        | FR‑040                 | ① 登录成功率 ≥99%；② 条款同意与撤回可追溯。                  |
| UC‑11 无痕查询         | FR‑020/012             | ① 不落正文与日志；② 仍计入实时配额。                         |
| UC‑12 语言对切换       | FR‑013/050             | ① 切换后立即按新语言对返回结果；② 非白名单拒绝。             |
| UC‑13 限流/配额提示    | FR‑050/051             | ① `RATE_LIMITED` 错误体含 `retry_after_ms` 与 `X-RateLimit/*`；② 本地日界限重置点正确。 |
| UC‑14 降级与熔断       | FR‑070                 | ① 触发阈值生效；② 退化徽标显示并返回“基础释义 + 模板例句”且 `degraded=true`；③ 半开 3 次成功后闭合；④ 演练记录符合 13.4.3（DR-01/DR-03/REL-ZD-01）。 |

------

## 20.7 接口与契约测试（示例步骤）

- **契约协商**：`Accept: application/vnd.glancy.dict.v1+json` 优先，落回 JSON 时响应体携带 `schemaVersion` 字段。校验 `406` 与降级路径。
- **幂等键**：写操作必须携带 `Idempotency-Key`，算法、有效期与冲突处理参见[附录 A 术语与缩略语](<./Appendix/附录 A 术语与缩略语.md#idempotency-key>)。
- **错误码**：触发 `ENTRY_NOT_WORD_OR_PHRASE/EXAMPLE_COUNT_EXCEEDS_TIER/RATE_LIMITED` 等，校验错误体元数据与 Header。
- **分页与下载**：游标分页 `nextCursor` 正确推进；导出链接一次性与 TTL 失效。

------

## 20.8 性能与容量压测

- **分段预算**：网关 80–150 ms、BFF+缓存 50–120 ms、LLM 未命中 P95 ≤ 3000 ms；合成首屏 P95 ≤ 2.5 s。
- **并发目标**：稳定 300 QPS，突发 3×，5 分钟恢复；P95 不超 2.5 s。
- **缓存命中**：L1≥40%、L2≥20% 基线；命中首屏 P95 ≤ 1.2 s。

------

## 20.9 稳定性/降级演练

- **触发**：将上游 5xx 提升至≥5% 持续 1 分钟；验证熔断与半开探测。
- **断言**：结果退化但不为空；UI 显示“已降级”；恢复后自动回归直连。
- **脚本与记录**：执行 13.4.2 的 `DR-SQL-01`（数据库容灾）与 `REL-ZD-01`（零停机发布回滚），并按 13.4.3 提交 DR-01、DR-03、DR-05 验收记录模板；演练事件编号同步 13.5 回溯机制。

------

## 20.10 配额、限流与成本护栏测试

- **重置口径**：用户本地 00:00 自然日；匿名配额为 Free 的 1/3。
- **三层限流**：用户级/租户级/全局级依次拦截，命中返回 429 与冷却建议。
- **成本阶梯**：80% 开启强缓存；95% 禁止“再生成”走简化路径。

------

## 20.11 数据、隐私与合规验收

- **删除语义**：逻辑删即时可见，物理清理 T+7d；窗口期可恢复。
- **无痕模式**：不落库原文与结果，仅计配额与观测。
- **导出**：CSV/JSON、UTF‑8、表头固定、一次性链接 TTL 10 分钟。
- **安全基线**：TLS1.2+、AES‑256 at‑rest、最小权限 RBAC、敏感字段脱敏。

------

## 20.12 订阅/账单与权益同步测试

- **即时生效**：支付成功→≤5 s 权益下发，`/subscription` 与配额镜像一致。
- **到期/撤销/退款**：自动降级/REVOKED/REFUNDED 即刻生效且幂等。

------

## 20.13 兼容性、i18n 与可访问性

- **兼容矩阵**：遵循 NFR‑010；不支持环境给出可读提示且不致使关键路径失效。
- **i18n**：界面语言 zh/en，切换即时生效，文案 100% 覆盖。
- **a11y**：键盘可达、语义标签、对比度达标（WCAG 2.1 AA）。

------

## 20.14 可观测性与运维演练

- **trace_id 贯穿**：≥99% 请求具备 trace_id；指标/日志/追踪三分法齐全。
- **告警抑制**：错误率、P95、配额异常具备阈值+速率+抑制策略并完成演练。

------

## 20.15 发布前检查清单（抽样）

1. 压测：300 QPS、10 分钟、错误率 <0.1%、端到端 P95 ≤ 2.5 s。
2. 降级演练：UI 出现“已降级”，日志记录熔断与恢复。
3. 契约回放：≥500 样本 100% 通过。
4. 导出回执：≤5 s 返回一次性链接与回执号，TTL 过期失效。
5. 订阅对齐：支付→权益≤5 s，同步到配额域。

------

## 20.16 缺陷分级与退出准则

- **P0**：突破安全/隐私/合规红线，或 P95/可用性达不到门槛，或契约/订阅 SSOT 不一致。禁止发布。 
- **P1**：影响核心 UC 主路径（UC‑01/02/03/08/14）。需修复或启用降级与已知问题说明后再评审。
- **P2**：非关键问题，记录在案进入后续版本。
- **退出**：所有 P0/P1 清零，P2 可接受；检查清单全部通过。

------

## 20.17 关键测试用例（示例 12 条，可扩展）

> 采用“Given/When/Then + 度量”结构，ID 可直接导入测试管理系统。

1. <a id="tc-api-001"></a>**TC‑API‑001 句子输入被拒**
    Given 输入 `"I hope this helps."`
    When `POST /lookup`
    Then 返回 400，`code=ENTRY_NOT_WORD_OR_PHRASE`，`error.hint` 指向“改为词或词组”。
2. <a id="tc-api-002"></a>**TC‑API‑002 同语模式无译文**
    Given `langPair=en→en`
    Then `modules.definitions[*].translation` 缺失或为 null；UI 无译文区。
3. <a id="tc-api-003"></a>**TC‑API‑003 Idempotency 生效**
    Given 同一主体/词条/配置 2 次点击，均携带相同 `Idempotency-Key`
    Then 仅 1 次计费/落库，历史仅 1 条。
4. <a id="tc-perf-001"></a>**TC‑PERF‑001 首屏 P95**
    Given 典型词条集 2000 样本
    Then 首个内容模块渲染 P95 ≤ 2.5 s；平均 ≤ 1.2 s。
5. <a id="tc-cache-001"></a>**TC‑CACHE‑001 L1/L2 命中与 Header**
    When 连续两次相同请求
    Then 第二次 `X-Cache=HIT`；10/30 分钟内 TTL 命中有效。
6. <a id="tc-quota-001"></a>**TC‑QUOTA‑001 重置口径**
    Given 用户时区 UTC+8，已用完“查词”配额
    When 本地 00:00 后
    Then `X-Quota-Remaining` 重置为上限值。
7. <a id="tc-rate-001"></a>**TC‑RATE‑001 三层限流回执**
    When 压测命中用户级/租户级/全局级限流
    Then 返回 429 `RATE_LIMITED`，`retry_after_ms` 与 `X-RateLimit-*` 正确。
8. <a id="tc-degrade-001"></a>**TC‑DEGRADE‑001 熔断退化**
    Given 上游 5xx≥5% 持续 1 分钟
    Then 输出“基础释义+模板例句”，标记退化，告警触发；恢复后半开闭合。
9. <a id="tc-data-001"></a>**TC‑DATA‑001 无痕不落正文**
    Given 开启无痕
    Then `lookups/results/history` 不写正文，`quota_daily` 仅计数。
10. <a id="tc-export-001"></a>**TC‑EXPORT‑001 导出一次性链接**
     When `POST /exports` → 轮询 `GET /exports/{id}`
     Then ≤5 s 获得 `downloadUrl`，TTL 10 分钟到期不可复用。
11. <a id="tc-bill-001"></a>**TC‑BILL‑001 订阅升级即时生效**
     When 升级 Plus→Pro 支付成功
     Then ≤5 s `/subscription` 与 `/quotas` 体现新上限。
12. <a id="tc-ux-a11y-001"></a>**TC‑UX‑a11y‑001 键盘可达**
     Then 结果页主路径 Tab 全路径可达，屏幕阅读器朗读语义标签通过。

### DR 系列验收用例（映射第 13 章 DR‑01…DR‑06）

1. <a id="dr-01"></a>**DR‑01 熔断降级演练**
    Given Doubao 模拟器将 `/api/v1/lookup` 依赖的上游 5xx 提升至 ≥5% 且持续 1 分钟
    When 连续调用 `POST /api/v1/lookup` 查询同一词条
    Then 响应 200 并返回 `degraded=true` 与“基础释义+模板例句”，`X-Quota-Regenerate-Remaining` 不减少，日志记录熔断→半开→恢复的状态流转。

2. <a id="dr-02"></a>**DR‑02 RDBMS PITR 验收**
    Given 已创建若干 `lookupId` 并在 `/api/v1/history` 中可见，记录目标恢复时间点 T
    When 触发 RDS PITR 至时间点 T，完成主从提升与连接串切换
    Then `GET /api/v1/history` 返回至 T 的数据且删除记录保持删除状态，`POST /api/v1/lookup` 新写入成功，`RPO` 误差 ≤5 分钟。

3. <a id="dr-03"></a>**DR‑03 跨区切换演练**
    Given 激活 Warm-Standby 区域并断开主区域写流量
    When 将异步只读副本提升为主并在 30 分钟内完成流量切换
    Then `POST /api/v1/lookup`、`GET /api/v1/history` 与 `POST /api/v1/exports` 均恢复 200，关键接口 4 小时窗口内可用性 ≥99.0%，切换日志具备追溯。

4. <a id="dr-04"></a>**DR‑04 导出链路恢复**
    Given 导出队列回退至备用节点且清理对象存储中断
    When 重新启用任务编排并执行 `POST /api/v1/exports`
    Then ≤5 分钟内 `GET /api/v1/exports/{exportId}` 获得一次性 `downloadUrl`（TTL 10 分钟），失效后返回 410，配额字段与第 8 章契约一致。

5. <a id="dr-05"></a>**DR‑05 发布失败自动回滚**
    Given 蓝绿发布前契约回放 ≥500 样本且通过率 100%
    When 灰度流量触发 `POST /api/v1/lookup` 结构性回归（如字段缺失）
    Then 自动回滚到上一版本，无 5xx 漏出；期间 `POST /api/v1/lookup` 与 `GET /api/v1/config` 全程可用，回滚事件在发布审计中留痕。

6. <a id="dr-06"></a>**DR‑06 成本护栏演练**
    Given 全局预算使用率模拟至 95%，启用成本护栏开关
    When 调用 `POST /api/v1/lookup` 与 `POST /api/v1/lookup/{lookupId}/regenerate`
    Then 查词命中强缓存并标记 `costGuardrail=true`，再生成返回 403（`error.meta.kind=guardrail`），端到端 P95 相比基线恶化 <10%。

------

## 20.18 验收锚点索引（UC / FR / NFR）

> 本节给出 `AC-UC-* / AC-FR-* / AC-NFR-*` 锚点，供各章节引用。锚点指向在 20.5、20.7、20.13–20.17 等章节中已定义的测试或演练脚本，便于 CI/测试管理系统落表。
> 交付时需使用 [AC-Index](../验收标准/AC-Index.md) 中的唯一清单版本，以版本批次视图同步验收记录。

### 20.18.1 UC 锚点

| 锚点 ID | 关联对象 | 验证重点 | 对应章节/测试 |
| ------- | -------- | -------- | -------------- |
| <a id="ac-uc-01"></a>AC-UC-01 | UC-01 查询词条 | 输入合法性、语言白名单、`X-Cache` 标记、首屏 P95 | 20.17 TC-API-001/TC-API-002、TC-CACHE-001、TC-PERF-001 |
| <a id="ac-uc-02"></a>AC-UC-02 | UC-02 再生成例句 | 再生成独立计数、变体渲染、降级提示 | 20.17 TC-QUOTA-001、TC-DEGRADE-001 |
| <a id="ac-uc-03"></a>AC-UC-03 | UC-03 难度/风格切换 | 档位限制、再生成记账、429 冷却提示 | 20.17 TC-QUOTA-001、TC-RATE-001 |
| <a id="ac-uc-04"></a>AC-UC-04 | UC-04 查看与筛选历史 | 留存窗口、分页过滤、脱敏字段 | 20.17 TC-DATA-001 |
| <a id="ac-uc-05"></a>AC-UC-05 | UC-05 清理历史 | 按语言清理、5 s 回执、T+7 d 物理清理 | 20.17 TC-DATA-001、DR-02 |
| <a id="ac-uc-06"></a>AC-UC-06 | UC-06 导出历史 | CSV/JSON、5 s 回执、一次性下载链接 TTL 10 分钟 | 20.17 TC-EXPORT-001、DR-04 |
| <a id="ac-uc-07"></a>AC-UC-07 | UC-07 画像与模块偏好 | 字段上限、跨端同步、撤回同意回退 | 20.5 功能回归（Profile 脚本）、3.5 画像校验 |
| <a id="ac-uc-08"></a>AC-UC-08 | UC-08 订阅开通/续费 | 支付≤5 s 权益同步、幂等回放 | 20.17 TC-BILL-001、TC-QUOTA-001 |
| <a id="ac-uc-09"></a>AC-UC-09 | UC-09 到期自动降级 | 自动降级、配额调整、幂等对账 | 20.17 TC-BILL-001、DR-03 |
| <a id="ac-uc-10"></a>AC-UC-10 | UC-10 登录/注册 | 邮箱+第三方登录、条款同意、撤回入口 | 20.5 功能回归（Auth 脚本）、12.3 合规抽查 |
| <a id="ac-uc-11"></a>AC-UC-11 | UC-11 无痕查询 | 不落正文、仍计实时配额 | 20.17 TC-DATA-001、审计抽样 HK-05 |
| <a id="ac-uc-12"></a>AC-UC-12 | UC-12 切换语言对并重查 | 缓存失效、白名单校验、译文策略 | 20.17 TC-API-002、TC-CACHE-001 |
| <a id="ac-uc-13"></a>AC-UC-13 | UC-13 限流/配额提示 | 429 错误体、冷却时间、Header 字段 | 20.17 TC-QUOTA-001、TC-RATE-001 |
| <a id="ac-uc-14"></a>AC-UC-14 | UC-14 降级与熔断回退 | 熔断阈值、退化徽标、半开恢复 | 20.17 TC-DEGRADE-001、DR-01、DR-05 |
| <a id="ac-uc-15"></a>AC-UC-15 | UC-15 账单与收据查看 | 订单详情、收据下载、时区渲染 | 20.17 TC-BILL-001 |
| <a id="ac-uc-16"></a>AC-UC-16 | UC-16 撤回隐私同意/删除 | 撤回后关闭留存、T+7 d 清理、回执号 | 20.17 TC-DATA-001、DR-02 |

### 20.18.2 FR 锚点

| 锚点 ID | 关联 FR | 验证重点 | 对应章节/测试 |
| ------- | ------- | -------- | -------------- |
| <a id="ac-fr-001"></a>AC-FR-001 | FR-001 语言对白名单与同语模式 | 仅 L1–L4、同语不返译文 | 20.17 TC-API-002 |
| <a id="ac-fr-002"></a>AC-FR-002 | FR-002 输入类型与句子拦截 | 句子拦截、错误码一致 | 20.17 TC-API-001 |
| <a id="ac-fr-003"></a>AC-FR-003 | FR-003 语言识别与确认 | LID 置信度分支、确认弹窗 | 20.5 功能回归（LID 脚本） |
| <a id="ac-fr-004"></a>AC-FR-004 | FR-004 查词幂等与重试 | 幂等键命中、配额不重复扣减 | 20.17 TC-API-003 |
| <a id="ac-fr-010"></a>AC-FR-010 | FR-010 释义与义项 | 3 个义项、字符上限、排序稳定 | 20.17 TC-API-002、TC-PERF-001 |
| <a id="ac-fr-011"></a>AC-FR-011 | FR-011 个性化例句 | 档位限制、再生计数、译文策略 | 20.17 TC-QUOTA-001、TC-RATE-001 |
| <a id="ac-fr-012"></a>AC-FR-012 | FR-012 搭配/同反义/派生 | 条数与排序、展开不重排 | 20.17 TC-API-002 |
| <a id="ac-fr-013"></a>AC-FR-013 | FR-013 模块自定义 | 开关/排序/详略同步、Pro 词条偏好 | 20.5 功能回归（Settings 脚本） |
| <a id="ac-fr-014"></a>AC-FR-014 | FR-014 频率与考试标签 | UI 占位保留、无数据请求 | 20.5 UI 巡检 |
| <a id="ac-fr-020"></a>AC-FR-020 | FR-020 历史留存与上限 | 档位留存、无痕不落库 | 20.17 TC-DATA-001 |
| <a id="ac-fr-021"></a>AC-FR-021 | FR-021 历史清理与分组 | 按语言清理、5 s 回执、可恢复 | 20.17 TC-DATA-001、DR-02 |
| <a id="ac-fr-022"></a>AC-FR-022 | FR-022 数据导出 | CSV/JSON、202→轮询、TTL 10 分钟 | 20.17 TC-EXPORT-001、DR-04 |
| <a id="ac-fr-030"></a>AC-FR-030 | FR-030 画像采集与编辑 | 字段上限、跨端同步、撤回清空 | 20.5 功能回归（Profile 脚本） |
| <a id="ac-fr-031"></a>AC-FR-031 | FR-031 画像驱动生成 | Prompt 参数随画像变化、trace 记录 | 20.7 事件/日志、观测脚本 |
| <a id="ac-fr-040"></a>AC-FR-040 | FR-040 账户注册与登录 | 邮箱/第三方、条款同意 | 20.5 功能回归（Auth 脚本） |
| <a id="ac-fr-041"></a>AC-FR-041 | FR-041 订阅状态同步 | 支付≤5 s、幂等对账 | 20.17 TC-BILL-001 |
| <a id="ac-fr-042"></a>AC-FR-042 | FR-042 账单与收据 | 订单详情、下载收据 | 20.17 TC-BILL-001 |
| <a id="ac-fr-050"></a>AC-FR-050 | FR-050 查词/再生配额 | Header/Body quota、429 错误体 | 20.17 TC-QUOTA-001 |
| <a id="ac-fr-051"></a>AC-FR-051 | FR-051 限速与突发 | 三层限流、`retry_after_ms` | 20.17 TC-RATE-001 |
| <a id="ac-fr-060"></a>AC-FR-060 | FR-060 设置与客户端 | 主题/快捷键/i18n 即时生效 | 20.17 TC-UX-a11y-001、20.13 |
| <a id="ac-fr-070"></a>AC-FR-070 | FR-070 Doubao 适配 | 熔断阈值、降级回退 | 20.17 TC-DEGRADE-001、DR-01 |
| <a id="ac-fr-071"></a>AC-FR-071 | FR-071 L1/L2 缓存 | L1/L2 TTL、`X-Cache` 标记 | 20.17 TC-CACHE-001 |
| <a id="ac-fr-080"></a>AC-FR-080 | FR-080 逻辑删除/物理清理 | 立即不可见、T+7 d 可恢复 | 20.17 TC-DATA-001、DR-02 |
| <a id="ac-fr-081"></a>AC-FR-081 | FR-081 条款与隐私 | 首登同意、撤回触发导出/删除 | 20.17 TC-DATA-001、审计抽样 |
| <a id="ac-fr-090"></a>AC-FR-090 | FR-090 订阅开通/续费 | 支付成功即生效、失败不降级 | 20.17 TC-BILL-001 |
| <a id="ac-fr-091"></a>AC-FR-091 | FR-091 到期与降级 | 自动降级、能力回退、历史受限 | 20.17 TC-BILL-001、DR-03 |
| <a id="ac-fr-092"></a>AC-FR-092 | FR-092 退款与异常对账 | 退款回退档位、账单痕迹 | 20.5 Billing 回归脚本、对账演练 |
| <a id="ac-fr-100"></a>AC-FR-100 | FR-100 首屏渐进渲染 | 渐进加载、模块独立错误提示 | 20.17 TC-PERF-001、TC-UX-a11y-001 |

### 20.18.3 NFR 锚点

| 锚点 ID | 关联 NFR | 验证重点 | 对应章节/测试 |
| ------- | -------- | -------- | -------------- |
| <a id="ac-nfr-001"></a>AC-NFR-001 | NFR-001 性能 | 首屏 P95 ≤2.5 s、平均 ≤1.2 s | 20.17 TC-PERF-001、RUM 报表 |
| <a id="ac-nfr-002"></a>AC-NFR-002 | NFR-002 可用性 | 月度 ≥99.9%、维护窗口脱敏 | 13.4 DR-03、可用性看板 |
| <a id="ac-nfr-003"></a>AC-NFR-003 | NFR-003 退化 | 熔断→降级→半开恢复 | 20.17 TC-DEGRADE-001、DR-01 |
| <a id="ac-nfr-004"></a>AC-NFR-004 | NFR-004 可扩展 | QPS 翻倍延迟增幅≤20% | 16.4 压测脚本 |
| <a id="ac-nfr-005"></a>AC-NFR-005 | NFR-005 一致性 | 幂等键命中率 100% | 20.17 TC-API-003 |
| <a id="ac-nfr-006"></a>AC-NFR-006 | NFR-006 安全 | TLS1.2+/AES-256、密钥轮转 | 12.4/13.5 安全演练、Key rotation 报告 |
| <a id="ac-nfr-007"></a>AC-NFR-007 | NFR-007 隐私 | 无痕不落库、导出≤5 s | 20.17 TC-DATA-001、DR-02、审计抽样 |
| <a id="ac-nfr-008"></a>AC-NFR-008 | NFR-008 观测 | 99% trace_id、三分法完整 | 14.2 信号演练、观测看板 |
| <a id="ac-nfr-009"></a>AC-NFR-009 | NFR-009 维护 | 零停机/灰度/回滚 | DR-05 发布演练、21.4 发布手册 |
| <a id="ac-nfr-010"></a>AC-NFR-010 | NFR-010 兼容 | 浏览器矩阵通过、降级不失能 | 18.2 兼容测试矩阵 |
| <a id="ac-nfr-011"></a>AC-NFR-011 | NFR-011 i18n/a11y | zh/en 切换、WCAG AA | 20.17 TC-UX-a11y-001、15.3 a11y 清单 |
| <a id="ac-nfr-012"></a>AC-NFR-012 | NFR-012 成本 | tokens_out 成本报表差异 ≤1% | 10.4 成本看板、16.5 成本护栏演练 |
| <a id="ac-nfr-013"></a>AC-NFR-013 | NFR-013 合规 | 审计日志可追溯、子处理者留档 | 13.6 数据生命周期、附录 B DPA/SCC |

------

## 20.19 验收工件与度量回收

- **工件**：用例库（含 UC/FR/AC 映射）、自动化脚本、契约样本集、压测报告、降级演练记录、导出回执样例、订阅状态机录屏、a11y 检查报告。
- **度量**：端到端 P95/均值、错误率、缓存命中、429 命中率、成本燃率、trace 覆盖率、导出 SLA、权益同步时延。指标维持在第 6 章告警阈值之内。

------

## 20.20 角色与职责

- **测试负责人**：编排 UC 回归、性能/稳定性与契约回放；出具发布评审报告。
- **后端负责人**：配额/限流/降级/订阅对齐与观测项落地。
- **前端负责人**：输入拦截、模块渲染与 i18n/a11y。
- **运维与合规**：告警演练、审计与数据留存核查。

------

## 20.21 变更与回归

- 任意影响白名单、配额、契约或订阅权益的变更，必须先更新对应 SSoT 章节并触发弃用/回放流程，再进入本章回归清单。 

------

## 20.22 UC→AC→测试用例→发布批次追踪表

> 该追踪表把 UC、AC、测试用例（TC/DR）与 21.4.2 的灰度批次（Release Batch，简称 **REL-Bx**）串联，供变更单、发布审批与 19 章风险钩子共用。

**发布批次代号（取自 21.4.2）**
- `REL-B0`：Step 0 蓝绿健康检查（内部白名单 0.5%）。
- `REL-B1`：Step 1，1% Canary（Pro、L2/L3 语言对）。
- `REL-B2`：Step 2，5%（扩展 Plus，纳入 L1/L4）。
- `REL-B3`：Step 3，15%（含 Free，开放导出/历史链路）。
- `REL-B4`：Step 4，50%（上线前最后观察窗）。
- `REL-B5`：Step 5，100% 翻转（旧版本保留 30–60 分钟以便回滚）。

| UC（主路径）        | 验收标准（AC ID）                                                                                                                    | 对应测试用例（TC/DR）                       | 发布批次（REL-Bx）                                                                                                     | 备注 / 追踪说明                                                                                                 |
| ------------------- | ------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------- |
| UC‑01 查词主路径    | AC‑UC01‑01 输入合法性；AC‑UC01‑02 同语不显示译文；AC‑UC01‑03 `X-Cache` 标记；AC‑UC01‑04 首屏 P95 ≤ 2.5 s                             | TC-API-001、TC-API-002、TC-CACHE-001、TC-PERF-001 | REL-B0（烟囱检查）<br>REL-B1（1% Canary）                                                                               | HK‑01/HK‑06 纳入放量守门项；REL-B1 通过后才允许进入 REL-B2。                                                    |
| UC‑02/03 再生成与难度切换 | AC‑UC02‑01 再生成独立计费；AC‑UC03‑01 档位限制；AC‑UC03‑02 429 冷却提示                                                          | TC-QUOTA-001、TC-RATE-001、TC-DEGRADE-001    | REL-B2（5% Plus）<br>REL-B3（15% 含 Free）                                                                              | 通过 REL-B2 验证档位后再在 REL-B3 打开 Free，并以 HK‑03/HK‑04 监控成本与限流。                                   |
| UC‑04/05 历史与清理 | AC‑UC04‑01 留存窗；AC‑UC05‑01 清理 5 s 回执；AC‑UC05‑02 T+7d 物理清理                                                               | TC-DATA-001、DR-02                            | REL-B2（5%）<br>REL-B3（15%）                                                                                           | 与 DR-02 PITR 联动；REL-B3 观察是否触发批量清理导致缓存/导出指标抖动。                                           |
| UC‑06 导出          | AC‑UC06‑01 5 s 回执；AC‑UC06‑02 TTL 10 分钟；AC‑UC06‑03 RTO ≤ 15 分钟                                                                | TC-EXPORT-001、DR-04                          | REL-B3（15% 含导出）<br>REL-B4（50% 全量前）                                                                            | DR-04 记录在 REL-B3 内完成；若 TTL 验证失败则禁止进入 REL-B4。                                                   |
| UC‑08/09 订阅开通/到期 | AC‑UC08‑01 支付≤5 s 权益同步；AC‑UC09‑01 自动降级；AC‑UC09‑02 幂等对账                                                           | TC-BILL-001、TC-QUOTA-001、订阅演练脚本       | REL-B1（Pro）<br>REL-B2（Plus）                                                                                          | 成本护栏 HK‑03 触发即锁定 REL-B2；观测点写入 21.10 的订阅看板。                                                  |
| UC‑11 无痕查询      | AC‑UC11‑01 不落正文；AC‑UC11‑02 仍计实时配额                                                                                         | TC-DATA-001、审计抽样（HK‑05）               | REL-B1（1%）<br>REL-B5（100% 翻转后复核）                                                                               | HK‑05 >0 立即回滚；REL-B5 复核确保翻转后仍满足隐私约束。                                                         |
| UC‑14 降级/熔断     | AC‑UC14‑01 熔断阈值触发；AC‑UC14‑02 退化徽标与 `degraded=true`；AC‑UC14‑03 半开 3 次成功后闭合                                      | TC-DEGRADE-001、DR-01、DR-03、DR-05          | REL-B0（演练）<br>REL-B4（50%）<br>REL-B5（翻转）                                                                       | DR 演练编号写入发布单；REL-B4/5 再次抽样验证回滚脚本仍可执行。                                                   |
| DR 系列灾备         | AC‑DR‑01 熔断退化；AC‑DR‑02 PITR；AC‑DR‑03 跨区切换；AC‑DR‑04 导出恢复；AC‑DR‑05 发布回滚；AC‑DR‑06 成本护栏                         | DR-01～DR-06                                   | REL-B0（演练）<br>REL-B4（50% 观察窗）                                                                                  | 灰度前演练结果纳入 REL-B0；REL-B4 再抽测 1 条记录，确保脚本仍可复用。                                             |

> 追踪矩阵同步到测试管理系统与变更单，供 21.5 守门指标、22 章变更流程以及 19 章风险钩子统一引用。

------

> **交付提示**：本章为“可复制执行”的验收与测试蓝本。落地时将 AC 表与用例脚本导入测试管理系统；接口校验以 `glancy.dict.v1` 为唯一契约；配额/订阅/数据等口径以对应 SSoT 章节为准。  
