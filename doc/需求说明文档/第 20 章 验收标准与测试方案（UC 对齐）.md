# 第 20 章 验收标准与测试方案（UC 对齐）

> 作用：把“目标/范围（第 1–2 章）→ 用例（第 4 章）→ 功能/非功能（第 5–6 章）→ 接口契约（第 8 章）→ 架构与配额/订阅/数据（第 7、9–11 章）”串成一套可执行的验收与测试体系，作为 MVP 发布门槛与持续回归基线。章节位置与命名以《目录》为准。 

------

## 20.1 目标与范围

- **目标**：以 UC 为主线定义可度量的验收标准（AC）与测试方案，覆盖功能正确性、端到端性能、可靠性/降级、配额与限流、数据与隐私、接口契约、兼容性、i18n/a11y 与订阅对齐。基准阈值承接第 1 章成功标准与第 6 章 NFR。  
- **范围**：Web/H5 形态，语言对白名单 L1–L4，输入仅“单词/词组”，同语模式不显示译文。  
- **方法**：UC→FR→AC 逐条映射；接口以 `glancy.dict.v1` 为契约事实源，契约不兼容变更走弃用与回放样本策略。 

------

## 20.2 相关事实源（SSoT）

- 成功标准与端到端阈值：第 1 章 1.6。
- 用例与业务规则：第 4 章（UC-01…UC-16）。
- 功能需求：第 5 章（FR-xxx）。
- 非功能约束与 SLO/SLA：第 6 章（NFR-xxx）。
- 架构/缓存/降级与发布：第 7 章。
- 接口与错误模型/幂等/分页/Quota Header：第 8 章。
- 数据模型/删除语义/导出 TTL：第 9 章。
- 配额/限流/成本护栏：第 10 章。
- 订阅/账单/权益同步（SSoT）：第 11 章。
- 术语口径与幂等键定义：附录 A。

------

## 20.3 验收门槛摘要（发布必过）

| 领域       | 门槛                                                         | 口径与来源                                               |
| ---------- | ------------------------------------------------------------ | -------------------------------------------------------- |
| 端到端性能 | 首个内容模块渲染：P95 ≤ 2.5 s；平均 ≤ 1.2 s                  | 以端到端口径统计；首屏定义见第 1 章与第 6 章 6.3/6.3.1。 |
| 可用性     | `lookup/regenerate/history/exports` 月度可用性 ≥ 99.9%        | 第 6 章 NFR-002。                                        |
| 熔断与降级 | 依赖 5xx≥5% 且持续 1 分钟触发；100% 自动回退“基础释义+模板例句”并标注退化 | NFR-003/NFR-017 与第 7 章熔断策略。                      |
| 语言/输入  | 仅 L1–L4；同语模式不显示译文；句子输入拒绝并返回统一错误     | 第 1 章 1.4.1/1.4.2 与第 8 章 8.10。                     |
| 配额/限流  | 自然日按本地时区重置；查词与再生成分开计数；命中 429 返回剩余额度与重置时间 | 第 10 章 10.2/10.3/10.4 与第 8 章限流/Quota 头。         |
| 缓存       | L1=10 分钟、L2=30 分钟；`X-Cache` 命中标记                   | 第 7 章 7.6 与第 8 章 8.4。                              |
| 数据语义   | 逻辑删即时；物理清理 T+7d；导出链接一次性且 TTL 10 分钟      | 第 9 章 9.7 与第 8 章 8.6。                              |
| 安全/隐私  | TLS1.2+、AES‑256 at‑rest、最小权限 RBAC、无痕不落正文        | 第 6 章 6.5 与第 9 章 9.7。                              |
| 订阅对齐   | 支付成功 ≤5 s 内权益生效；到期自动降级且能力边界同步         | 第 11 章 11.12/11.5。                                    |
| 契约回放   | 每次发布≥500 条样本，回放通过率 100%                         | 第 6 章 NFR‑031 与第 7 章 7.10。                         |

------

## 20.4 验收环境与数据

- **环境**：Dev/Staging/Prod 隔离；蓝绿/小流量灰度与自动回滚。
- **数据**：构造匿名与登录主体、Free/Plus/Pro 三档、不同时区用户；准备 500+ 契约样本与典型词条集（含多义项、同/反义、固定搭配等）。无痕场景禁止落正文。
- **账号**：订阅状态机样例（ACTIVE/GRACE/EXPIRED/REVOKED/REFUNDED），含升级/降级与退款路径。

------

## 20.5 测试类型矩阵

| 类别           | 目标                                                 | 关键工具/口径                                                |
| -------------- | ---------------------------------------------------- | ------------------------------------------------------------ |
| 功能与回归     | UC/FR 全量覆盖，异常与边界齐备                       | UC-01…16；错误码与提示对齐第 8 章。                          |
| 接口与契约     | `glancy.dict.v1` 字段/长度/同语模式校验；Idempotency | JSON Schema 校验＋500 样本回放；幂等键口径见附录 A/第 8 章。 |
| 性能与容量     | 首屏 P95/均值、依赖分段；300 QPS 稳定                | 第 6 章 6.3/6.3.2 与第 7 章 7.11。                           |
| 稳定性/降级    | 熔断触发/恢复、半开探测、退化提示                    | NFR‑017 与第 7 章 7.4.5。                                    |
| 配额/限流/成本 | 日配额重置、429 冷却、三层限流、预算护栏             | 第 10 章 10.2/10.4/10.7/10.10。                              |
| 数据/隐私/导出 | 删除语义、无痕、导出 TTL、脱敏                       | 第 9 章 9.7/9.10 与第 8 章 8.6。                             |
| 订阅与账单     | 权益下发 ≤5 s、对账幂等、退款/撤销策略               | 第 11 章 11.12/11.11/11.10。                                 |
| 兼容/i18n/a11y | 浏览器支持、zh/en 文案、WCAG 2.1 AA                  | 第 6 章 NFR‑010/NFR‑034/NFR‑035 与第 1 章 1.4.6。            |
| 观测与告警     | trace_id 贯穿率≥99%，关键告警演练                    | 第 6 章 NFR‑008/027/028 与第 7 章 7.6。                      |

------

## 20.6 UC→FR→AC 覆盖矩阵（摘录）

> 全量 UC-01…UC-16 列表见第 4 章；此处给出可执行级 AC 断言模板。

| UC                     | 关联 FR                | 关键 AC（通过即标绿）                                        |
| ---------------------- | ---------------------- | ------------------------------------------------------------ |
| UC‑01 查询词条         | FR‑001/002/004/010/011 | ① 非白名单拒绝并回 `INVALID_LANG_PAIR`；② 句子输入前端拦截，绕过后端返回 `ENTRY_NOT_WORD_OR_PHRASE`；③ 同语模式不出现 `translation` 字段；④ `X-Cache` 命中与否正确标注；⑤ 结构化输出满足 `glancy.dict.v1` 与详略预算；⑥ 首屏 P95 ≤ 2.5 s。 |
| UC‑02 再生成           | FR‑011/03              | ① 计入“再生成”而非“查词”配额；② 默认绕过 L2；③ 例句区块刷新不影响其他模块。 |
| UC‑03 难度/风格切换    | FR‑011/04              | ① 计入再生成配额；② `difficulty/style` 生效且受档位约束；③ 超限 429 返回冷却与 `X-Quota` 头。 |
| UC‑04/05 历史/清理     | FR‑020/021             | ① 留存时长/条数按档位；② 清理 5 s 内返回回执；③ 逻辑删即时、T+7d 物理清理可审计。 |
| UC‑06 导出             | FR‑022                 | ① `POST /exports` 202 回执，P95 ≤ 5 s 获得一次性链接（TTL 10 分钟）；② 内容脱敏、UTF‑8、表头固定。 |
| UC‑07 画像/偏好        | FR‑030/031             | ① 标签数量按档位限制；② 下次生成立即生效；③ 本地缓存与后端一致。 |
| UC‑08/09 订阅开通/到期 | FR‑041/091             | ① 成功 ≤5 s 内权益更新；② 到期自动降级、能力边界同步；③ 幂等更新与对账兜底。 |
| UC‑10 登录/注册        | FR‑040                 | ① 登录成功率 ≥99%；② 条款同意与撤回可追溯。                  |
| UC‑11 无痕查询         | FR‑020/012             | ① 不落正文与日志；② 仍计入实时配额。                         |
| UC‑12 语言对切换       | FR‑013/050             | ① 切换后立即按新语言对返回结果；② 非白名单拒绝。             |
| UC‑13 限流/配额提示    | FR‑050/051             | ① `RATE_LIMITED` 错误体含 `retry_after_ms` 与 `X-RateLimit/*`；② 本地日界限重置点正确。 |
| UC‑14 降级与熔断       | FR‑070                 | ① 触发阈值生效；② 退化徽标显示；③ 半开 3 次成功后闭合。      |

------

## 20.7 接口与契约测试（示例步骤）

- **契约协商**：`Accept: application/vnd.glancy.dict.v1+json` 优先，落回 JSON 时响应体携带 `schemaVersion` 字段。校验 `406` 与降级路径。
- **幂等键**：写操作传 `Idempotency-Key = hash(subjectId+langPair+entryNorm+configHash+profileEtag)`；30 s 内重复提交仅一次计费/落库。 
- **错误码**：触发 `ENTRY_NOT_WORD_OR_PHRASE/EXAMPLE_COUNT_EXCEEDS_TIER/RATE_LIMITED` 等，校验错误体元数据与 Header。
- **分页与下载**：游标分页 `nextCursor` 正确推进；导出链接一次性与 TTL 失效。

------

## 20.8 性能与容量压测

- **分段预算**：网关 80–150 ms、BFF+缓存 50–120 ms、LLM 未命中 P95 ≤ 3000 ms；合成首屏 P95 ≤ 2.5 s。
- **并发目标**：稳定 300 QPS，突发 3×，5 分钟恢复；P95 不超 2.5 s。
- **缓存命中**：L1≥40%、L2≥20% 基线；命中首屏 P95 ≤ 1.2 s。

------

## 20.9 稳定性/降级演练

- **触发**：将上游 5xx 提升至≥5% 持续 1 分钟；验证熔断与半开探测。
- **断言**：结果退化但不为空；UI 显示“已降级”；恢复后自动回归直连。

------

## 20.10 配额、限流与成本护栏测试

- **重置口径**：用户本地 00:00 自然日；匿名配额为 Free 的 1/3。
- **三层限流**：用户级/租户级/全局级依次拦截，命中返回 429 与冷却建议。
- **成本阶梯**：80% 开启强缓存；95% 禁止“再生成”走简化路径。

------

## 20.11 数据、隐私与合规验收

- **删除语义**：逻辑删即时可见，物理清理 T+7d；窗口期可恢复。
- **无痕模式**：不落库原文与结果，仅计配额与观测。
- **导出**：CSV/JSON、UTF‑8、表头固定、一次性链接 TTL 10 分钟。
- **安全基线**：TLS1.2+、AES‑256 at‑rest、最小权限 RBAC、敏感字段脱敏。

------

## 20.12 订阅/账单与权益同步测试

- **即时生效**：支付成功→≤5 s 权益下发，`/subscription` 与配额镜像一致。
- **到期/撤销/退款**：自动降级/REVOKED/REFUNDED 即刻生效且幂等。

------

## 20.13 兼容性、i18n 与可访问性

- **兼容矩阵**：遵循 NFR‑010；不支持环境给出可读提示且不致使关键路径失效。
- **i18n**：界面语言 zh/en，切换即时生效，文案 100% 覆盖。
- **a11y**：键盘可达、语义标签、对比度达标（WCAG 2.1 AA）。

------

## 20.14 可观测性与运维演练

- **trace_id 贯穿**：≥99% 请求具备 trace_id；指标/日志/追踪三分法齐全。
- **告警抑制**：错误率、P95、配额异常具备阈值+速率+抑制策略并完成演练。

------

## 20.15 发布前检查清单（抽样）

1. 压测：300 QPS、10 分钟、错误率 <0.1%、端到端 P95 ≤ 2.5 s。
2. 降级演练：UI 出现“已降级”，日志记录熔断与恢复。
3. 契约回放：≥500 样本 100% 通过。
4. 导出回执：≤5 s 返回一次性链接与回执号，TTL 过期失效。
5. 订阅对齐：支付→权益≤5 s，同步到配额域。

------

## 20.16 缺陷分级与退出准则

- **P0**：突破安全/隐私/合规红线，或 P95/可用性达不到门槛，或契约/订阅 SSOT 不一致。禁止发布。 
- **P1**：影响核心 UC 主路径（UC‑01/02/03/08/14）。需修复或启用降级与已知问题说明后再评审。
- **P2**：非关键问题，记录在案进入后续版本。
- **退出**：所有 P0/P1 清零，P2 可接受；检查清单全部通过。

------

## 20.17 关键测试用例（示例 12 条，可扩展）

> 采用“Given/When/Then + 度量”结构，ID 可直接导入测试管理系统。

1. **TC‑API‑001 句子输入被拒**
    Given 输入 `"I hope this helps."`
    When `POST /lookup`
    Then 返回 400，`code=ENTRY_NOT_WORD_OR_PHRASE`，`error.hint` 指向“改为词或词组”。
2. **TC‑API‑002 同语模式无译文**
    Given `langPair=en→en`
    Then `modules.definitions[*].translation` 缺失或为 null；UI 无译文区。
3. **TC‑API‑003 Idempotency 生效**
    Given 同一主体/词条/配置 2 次点击，均携带相同 `Idempotency-Key`
    Then 仅 1 次计费/落库，历史仅 1 条。
4. **TC‑PERF‑001 首屏 P95**
    Given 典型词条集 2000 样本
    Then 首个内容模块渲染 P95 ≤ 2.5 s；平均 ≤ 1.2 s。
5. **TC‑CACHE‑001 L1/L2 命中与 Header**
    When 连续两次相同请求
    Then 第二次 `X-Cache=HIT`；10/30 分钟内 TTL 命中有效。
6. **TC‑QUOTA‑001 重置口径**
    Given 用户时区 UTC+8，已用完“查词”配额
    When 本地 00:00 后
    Then `X-Quota-Remaining` 重置为上限值。
7. **TC‑RATE‑001 三层限流回执**
    When 压测命中用户级/租户级/全局级限流
    Then 返回 429 `RATE_LIMITED`，`retry_after_ms` 与 `X-RateLimit-*` 正确。
8. **TC‑DEGRADE‑001 熔断退化**
    Given 上游 5xx≥5% 持续 1 分钟
    Then 输出“基础释义+模板例句”，标记退化，告警触发；恢复后半开闭合。
9. **TC‑DATA‑001 无痕不落正文**
    Given 开启无痕
    Then `lookups/results/history` 不写正文，`quota_daily` 仅计数。
10. **TC‑EXPORT‑001 导出一次性链接**
     When `POST /exports` → 轮询 `GET /exports/{id}`
     Then ≤5 s 获得 `downloadUrl`，TTL 10 分钟到期不可复用。
11. **TC‑BILL‑001 订阅升级即时生效**
     When 升级 Plus→Pro 支付成功
     Then ≤5 s `/subscription` 与 `/quotas` 体现新上限。
12. **TC‑UX‑a11y‑001 键盘可达**
     Then 结果页主路径 Tab 全路径可达，屏幕阅读器朗读语义标签通过。

------

## 20.18 验收工件与度量回收

- **工件**：用例库（含 UC/FR/AC 映射）、自动化脚本、契约样本集、压测报告、降级演练记录、导出回执样例、订阅状态机录屏、a11y 检查报告。
- **度量**：端到端 P95/均值、错误率、缓存命中、429 命中率、成本燃率、trace 覆盖率、导出 SLA、权益同步时延。指标维持在第 6 章告警阈值之内。

------

## 20.19 角色与职责

- **测试负责人**：编排 UC 回归、性能/稳定性与契约回放；出具发布评审报告。
- **后端负责人**：配额/限流/降级/订阅对齐与观测项落地。
- **前端负责人**：输入拦截、模块渲染与 i18n/a11y。
- **运维与合规**：告警演练、审计与数据留存核查。

------

## 20.20 变更与回归

- 任意影响白名单、配额、契约或订阅权益的变更，必须先更新对应 SSoT 章节并触发弃用/回放流程，再进入本章回归清单。 

------

> **交付提示**：本章为“可复制执行”的验收与测试蓝本。落地时将 AC 表与用例脚本导入测试管理系统；接口校验以 `glancy.dict.v1` 为唯一契约；配额/订阅/数据等口径以对应 SSoT 章节为准。  