# 第 19 章 风险、依赖与假设

> 目的：以“UC→FR/NFR→发布/变更”主线，建立可执行的风险登记册、内外部依赖清单与业务/技术假设库，形成触发阈值、监测指标与处置 Runbook 的闭环，支撑 MVP 的发布与持续运营。所有阈值与口径以既有章节的单一事实源为准，不在本章重复定义。 

------

## 19.1 适用范围与引用

- **覆盖对象**：Web/H5 前端、BFF/应用层、缓存与数据层、Doubao 适配层、登录与支付集成、可观测与运维。 
- **对齐基线**：
  - 功能范围与输入规则：仅支持“单词/词组”，语言对白名单 L1–L4，同语模式不显示译文。
  - 端到端目标与 SLO：首屏 P95 ≤ 2.5 s、均值 ≤ 1.2 s；关键接口月度可用性 ≥ 99.9%。 
  - 配额/限流与成本护栏：日配额本地 00:00 重置；80%/95% 日预算阈值触发分级降级。
  - 降级与熔断：依赖 5xx ≥ 5% 且持续 1 分钟触发熔断，回退“基础释义+模板例句”。 

------

## 19.2 风险分级方法（RAG）与触发阈值

- **概率（L）**：1 罕见（≤5%）/ 2 不太可能 / 3 可能 / 4 很可能 / 5 几乎必然。
- **影响（I）**：1 轻微 / 2 次要 / 3 中等 / 4 重大 / 5 致命（跨越 SLO 或合规红线）。
- **暴露度（E）**：`E = L × I`；E≥16 记为**红**，9–15 为**橙**，≤8 为**黄/绿**。
- **统一触发样例**：
  - 延迟/可用性：`POST /lookup` 端到端 P95 连续 5 分钟 > 2.5 s → Yellow；> 3.0 s → Orange；依赖 5xx≥5% 且 1 分钟 → Red。
  - 成本与预算：近 5 分钟燃率/日预算 > 0.8 → Yellow；> 0.95 → Red，停止“再生成”。
  - 合规与隐私：出现“无痕查询落库正文”一例即 Red，立即冻结功能面。

------

## 19.3 风险登记册（Top Risks 选摘）

> 字段：ID｜类别｜描述｜触发信号｜影响｜L｜I｜E｜Owner（RACI）｜**事前缓解**｜**事后应急**｜关联 FR/NFR/UC。
>  角色参照 RBAC：R4 运营管理员、R5 审计员、R6 系统管理员；产品/平台/数据/合规为协作方。

| ID   | 类别         | 描述                              | 触发信号（监控项）                   | 影响                 | L    | I    | E    | Owner     | 事前缓解（Proactive）                             | 事后应急（Reactive）                                | 关联                   |
| ---- | ------------ | --------------------------------- | ------------------------------------ | -------------------- | ---- | ---- | ---- | --------- | ------------------------------------------------- | --------------------------------------------------- | ---------------------- |
| R-01 | 外部依赖     | Doubao API 抖动或不可用           | 依赖 5xx≥5% 且 1 分钟；外呼超时异常  | 延迟飙升、失败率上升 | 3    | 5    | 15   | 平台/R6   | 熔断+半开探测；L1/L2 缓存优先；提示词模板冗余校验 | 启用“基础释义+模板例句”退化；开启强缓存；公告状态页 | NFR-017、FR-070、UC-14 |
| R-02 | 契约         | 上游返回结构损坏，解析失败        | Schema 校验失败率>阈；契约回放不通过 | 结果页空白/错乱      | 3    | 4    | 12   | 平台/数据 | CI ≥500 契约样本回放；解析容错                    | 退化输出 + 告警；回滚至上版适配器                   | 8.11、7.10、NFR-031    |
| R-03 | 成本         | tokens_out 异常导致成本失控       | 燃率>0.8/0.95；单请求 P95 超阈       | 预算透支、被动限流   | 4    | 4    | 16   | 平台/R6   | 限条/详略下移；成本看板与阈值告警                 | 关闭“再生成”；强制 L2→L1→退化链路                   | 10.7、10.10、NFR-012   |
| R-04 | 配额/限速    | 错参或热更新失误导致误限流/放开   | 429 命中率异常；限流参数变更         | 体验劣化/滥用窗口    | 3    | 4    | 12   | 平台/R6   | 干跑模式 + 灰度 5% + 审批                         | 一键回滚参数；白名单放行                            | 10.11、FR-051          |
| R-05 | 缓存         | 缓存击穿/雪崩（热点词条）         | L1/L2 命中率骤降；QPS 激增           | 延迟抖动、成本上升   | 3    | 4    | 12   | 平台/R6   | L1/L2 TTL 10/30 分钟；请求合并 + 幂等键           | 临时提升 TTL ×2；热点预填充                         | 7.6、10.6、FR-004      |
| R-06 | 输入         | 句子输入绕过前端拦截              | ENTRY_NOT_WORD_OR_PHRASE 增多        | 模型成本与失败率上升 | 3    | 3    | 9    | 前端/平台 | 前端强校验 + 服务端兜底                           | 返回 4xx + 引导改为词/词组                          | 1.4.2、8.10、FR-002    |
| R-07 | 隐私         | “无痕查询”误落库正文              | 审计抽查>0；黑盒检测异常             | 合规风险（Red）      | 2    | 5    | 10   | 合规/R5   | 黑名单路由；日志脱敏校验                          | 立即冻结该功能面；批量清理与报告                    | NFR-007、9.7、9.15     |
| R-08 | 导出         | 一次性下载链接被滥用/过期配置错误 | TTL≠10min；异常下载频度              | 数据泄露/投诉        | 2    | 5    | 10   | 平台/合规 | 链接签名 + 一次性；TTL 10 分钟                    | 撤销链接；强制登录校验                              | 8.6、7.3、9.7          |
| R-09 | 支付         | 回调丢失/对账差异                 | 回调延迟>2 s；差异>1%                | 权益不同步/投诉      | 3    | 3    | 9    | 运营/R4   | 回调优先、轮询兜底；幂等                          | 触发对账修复；不低发权益                            | 11.11–11.12、6.3.2     |
| R-10 | 订阅矩阵漂移 | 客户端硬编码权益与 SSoT 不一致    | 能力/配额错配                        | 错配与埋点失真       | 3    | 3    | 9    | 产品/平台 | 以 11 章为 SSoT 动态下发                          | 清缓存 + 下发最新配置                               | 11.2、8.9              |
| R-11 | 兼容性       | 非支持环境导致关键流程失效        | 兼容性测试未过                       | 交易/留存受阻        | 3    | 3    | 9    | 前端      | 兼容矩阵校验；降级提示                            | 关闭非关键交互                                      | NFR-033、18 章对齐     |
| R-12 | 观测         | trace_id 贯穿率不足               | 贯穿率 < 99%                         | 溯源困难             | 3    | 2    | 6    | 运维      | SDK 统一注入；强校验                              | 热修复 & 合并上报                                   | NFR-008、8.1           |
| R-13 | 数据一致性   | 画像/订阅变更未失效相关缓存       | 命中旧结果                           | 个性化错配           | 2    | 3    | 6    | 平台      | 更新触发缓存失效                                  | 主动刷新 & 降级裁剪                                 | 7.6、3.5.2             |
| R-14 | 发布         | 零停机发布失败或回滚迟缓          | 发布窗口异常；回放样本不通过         | 服务中断             | 2    | 4    | 8    | 运维/R6   | 灰度+自动回滚；契约回放                           | 立即回滚；开 Kill Switch                            | NFR-009、7.10          |
| R-15 | 风控         | 滥用与抓取导致异常流量            | 429 上升、成本飙升                   | 成本/体验受损        | 3    | 3    | 9    | 平台/合规 | 用户/租户/全局三级限流；指纹联动                  | 临时更严限速与配额封顶                              | 10.4、10.13、17 章联动 |
| R-16 | 历史与删除   | 逻辑删与物理清理窗口混淆          | 用户误解/投诉                        | 体验与合规风险       | 2    | 3    | 6    | 运营/R4   | 二次确认 + 可恢复窗口说明                         | 预约恢复或提前物理清理                              | 1.4.3、9.7、FR-021     |

> 注：完整登记册（含低风险项）在项目 RAID Log 维护，并在每次发布前复核。

------

## 19.4 依赖清单与回退策略（Dependencies）

| 依赖                | 性质      | 契约/口径                             | 关键 SLO/阈值                            | 退化/回退                   | 备注                 |
| ------------------- | --------- | ------------------------------------- | ---------------------------------------- | --------------------------- | -------------------- |
| Doubao API          | 外部      | `glancy.dict.v1` 上游产出由适配层解析 | 调用 P95 ≤ 3000 ms；5xx≥5% 且 1 分钟熔断 | 基础释义+模板例句；半开恢复 | 7.4.5、8.11、NFR-017 |
| 第三方登录提供方    | 外部      | OAuth/OIDC                            | 登录成功率 ≥ 99%                         | 切至邮箱登录/匿名会话       | 4.1 参与方泳道       |
| Web/H5 支付渠道     | 外部      | 订阅域 SSoT                           | 权益同步 P95 ≤ 5 s；回调 P95 ≤ 2 s       | 回调优先 + 轮询兜底         | 11.6、11.12、11.16   |
| CDN/WAF/API 网关    | 内部/基础 | 边缘与接入层                          | P95 80–150 ms                            | 就近回源/临时旁路           | 7.2、7.3             |
| Redis（L1/L2/限流） | 内部      | TTL：L1 10m / L2 30m                  | L1≥40%、L2≥20% 命中                      | TTL×2、请求合并             | 7.6、6.3、10.6       |
| RDBMS（OLTP）       | 内部      | UTC、Schema 版本化                    | 关键表可用性 ≥ 99.9%                     | 只读降级、延迟写            | 9.5、9.6             |
| 对象存储            | 内部      | 导出与回放样本                        | 链接 TTL 10 分钟                         | 重新申请链接/延长 TTL       | 7.3、8.6、9.13       |

------

## 19.5 关键假设（Assumptions）与验证

| 编号 | 假设                                    | 依据         | 验证方式           | 失效影响           | 备选/行动                |
| ---- | --------------------------------------- | ------------ | ------------------ | ------------------ | ------------------------ |
| A-01 | MVP 仅 Web/H5，不含原生客户端与商店内购 | 2.1          | 范围评审与发布清单 | 范围膨胀、周期拉长 | 22 章变更流程+版本弃用期 |
| A-02 | 输入仅词/词组；整句拒绝                 | 1.4.2/8.10   | 前后端双拦截抽测   | 成本/失败率上升    | 规则兜底与用户教育       |
| A-03 | 同语模式不显示译文                      | 1.4.1/5.2    | 端到端回归         | 输出一致性问题     | 强约束契约字段           |
| A-04 | 配额按“用户本地 00:00”重置              | 10.2         | 对比本地时区日志   | 体验/对账争议      | 统一显示倒计时           |
| A-05 | 降级回退路径始终可用                    | 1.4.7/6.4    | 演练与演习记录     | 页面空白/投诉      | Kill Switch 与状态页     |
| A-06 | 下载链接 TTL 固定 10 分钟               | 7.3/8.6/9.7  | 链接抽检           | 数据泄露/失效      | 重签名与 TTL 统一配置    |
| A-07 | RBAC 最小权限与审计开启                 | 7.9/9.10/3.4 | 审计抽样           | 后台越权           | 最小集权限回收           |
| A-08 | 订阅权益以 11 章为 SSoT                 | 11.2/11.12   | 对账抽检           | 能力漂移           | 配置中心单源下发         |

------

## 19.6 风险处置流程与 RACI

1. **发现与分级**：告警接入事件流，按 19.2 阈值标记 RAG。
2. **隔离与退化**：若 Red，第一时间切换退化路径与强缓存；记录 `trace_id` 批次。
3. **定位与回滚**：比对最近发布、参数热更新与依赖健康；必要时自动回滚。
4. **善后与复盘**：出具 5 Whys 与改进项，更新登记册与 Runbook。

**RACI 快表**：

- 平台/R6：Responsible（技术处置）、Accountable（熔断/限流/回滚）。
- 运营/R4：Responsible（对账与用户沟通）。
- 审计/R5：Consulted（合规核查）。
- 产品：Informed（范围/节流提示），配合 21 章灰度切流。

------

## 19.7 成本与配额相关风险的分级降级

- **Yellow（≥80% 日预算）**：L2 优先 + TTL ×2；例句条数下调一档。
- **Red（≥95% 日预算）**：暂停“再生成”；仅放行查词且优先缓存/退化路径；恢复阈值 < 70%。
- **审计**：`tokens_in/out` 与 `cost_request` 分层看板，差异 ≤ 1%。

------

## 19.8 演练与验证（Chaos/Drill）

- **降级演练**：人为拉高依赖 5xx 与超时，验证 UI“已降级”提示与可用性。
- **限流演练**：用户/租户/全局三层限流干跑 → 强制，观测 429 率与回退表现。
- **导出演练**：≤5 s 返回回执与一次性链接，TTL 到期自动失效。

------

## 19.9 里程碑与风险门禁（与 2.5、21、22 章联动）

- **M0**：契约 `glancy.dict.v1` 冻结，≥500 回放样本通过；缓存与熔断策略联调完成。
- **M1**：UC-01～UC-05、UC-08～UC-14 首轮验收通过；P95 ≤ 2.5 s；降级链路演练通过。 
- **M2（发布）**：订阅对账闭环、导出回执、日志与告警齐备；灰度与回滚脚本就绪。

------

## 19.10 RAID Log 与开放问题（Issues）

- **Risks**：见 19.3。
- **Assumptions**：见 19.5。
- **Issues（开放项）**：
  1. 频率/考试徽标仅占位，是否在后续阶段纳入能力与成本模型（与 22 章评审）。
  2. 兼容性与客户端支持矩阵的最终清单与回退提示文案固化（与 18 章对齐）。
- **Dependencies**：见 19.4。

------

## 19.11 文档与持续更新

- 风险登记册与 Runbook 作为运维工单与发布手册的附录，随每次发布复核；若阈值或口径调整，须走 22 章变更流程并标注弃用期。

------

### 附：本章与既有章节的关键引用对照

- 端到端目标与 SLO：1.6、6.3.2。 
- 降级与熔断：1.4.7、6.4、7.4.5。  
- 配额/限流/预算：10.2、10.4、10.7、10.10。
- 下载链接与清理：7.3、8.6、9.7。  
- RBAC 与审计：3.4、7.9、9.10。  


------

## 19.12 风险监控钩子与看板映射

| 风险/假设编号 | 关键监控钩子（指标/日志/追踪） | 看板/预警动作 | 灰度/回滚联动 |
| ------------- | -------------------------------- | -------------- | -------------- |
| R-01/R-02     | Doubao 5xx、`contract_validation_failure_rate`、熔断状态 | 发布看板 `upstream_health`，触发自动降级并记录 `trace_id` | 21.5.2 自动回滚一阶；Kill Switch 退回旧版本 |
| R-03/R-04     | `cost_burn_rate`、429 命中率、限流参数变更审计日志 | 成本护栏面板、限流参数审计告警 | 21.5.3 启用成本护栏/限流干跑 → 21.6 回滚 |
| R-05/R-13     | L1/L2 命中率、缓存穿透请求样本、`cache_miss_trace` | 缓存看板与热点词条采样 | 21.4 阶梯中 Step 1/3 打标缓存策略；回滚时强制 TTL×2 |
| R-07/A-05     | `audit_event` 日志、无痕抽检、降级演练记录 | 合规看板 `privacy_guard`、降级演练周报 | 21.11 降级演练步骤；22 章弃用流程留痕 |
| R-09/R-10     | `/subscription` 与 `/quotas` 时延、回调状态码 | 订阅域看板 `entitlement_sync_latency` | 21.4 Step 2 放量与 21.5 成本/429 守门；异常先保持旧版本 |
| A-02/A-04     | 输入拒绝率、`X-Quota-ResetAt` 计算差异 | 输入验证与配额看板 | 20.10 配额测试脚本；21.4 Step 3 前完成复核 |
| A-08          | 订阅矩阵版本号、配置中心审计 | 订阅/配置中心看板 | 21.7 配置管理与 22.6 双写清单联动 |

> 告警触发时在发布 Runbook 中追加“风险 ID + trace_id”记录，并在 21.16 发布复盘与 22 章变更档案中闭环。

> 本章作为“风险、依赖与假设”的执行基线，后续若新增语言对、客户端或模块能力，均视为范围扩张，须在 22 章发起变更并更新本章登记册与阈值。
