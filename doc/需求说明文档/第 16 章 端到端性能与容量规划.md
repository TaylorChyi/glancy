# 第 16 章 端到端性能与容量规划

> 本章为《目录》中第 16 章，作为性能与容量的**唯一实施方案**，对齐成功指标、NFR、架构与接口契约，给出可落地的预算、测评、扩缩容与验收口径。

------

## 16.1 目标与范围

- **目标**：确保“首个内容模块渲染完成”在**P95 ≤ 2.5 s、平均 ≤ 1.2 s**，并在可预期成本下承载高峰流量；异常时可退化且不中断核心路径。
- **范围**：覆盖 Web/H5 全链路查词与再生成、历史/导出、订阅与回执等关键接口，落地性能预算、并发与突发容量、缓存策略、降级与回退、压测与监控、扩缩容 Runbook。
- **对齐关系**：本章细化并承接第 1 章“成功标准”、第 6 章 NFR、 第 7 章“性能预算与架构”、第 8 章“接口契约”、第 10 章“配额与限流”、第 11 章“权益同步”。

------

## 16.2 术语与度量口径

- **端到端延迟**：以“首个内容模块非骨架渲染完成”为口径统计 P50/P95/P99；窗口 5 分钟滚动。
- **trace_id / SLI / SLO / P95 / TTL / L1/L2** 等术语及单位统一采用《附录 A》。

------

## 16.3 设计基线与硬约束

1. **端到端目标**：P95 ≤ 2.5 s、均值 ≤ 1.2 s；关键接口 SLO：`/lookup` 成功率 ≥ 99.9%，P95 ≤ 2.5 s。
2. **段内预算**：边缘与网关 P95 ≤ 150 ms；后端命中缓存路径 P95 ≤ 200 ms；上游 Doubao 调用 P95 ≤ 3000 ms（超时 5.0 s）。
3. **缓存分层**：L1（用户级）TTL 10 分钟，L2（共享）TTL 30 分钟；再生成默认绕过 L2。
4. **NFR 命中率**：L1 命中率≥40%、L2 命中率≥20%；命中即跳过外呼，首屏 P95 目标 ≤ 1.2 s。
5. **容量基线**：稳定支撑 300 QPS 查词，突发 3 倍，5 分钟内恢复；扩容在 1 小时内完成且无中断。
6. **限速与突发**：用户级/租户级/全局三级 Token Bucket；全局保护阈值触发配比放行与强缓存策略。
7. **降级与熔断**：依赖 5xx≥5% 且持续 1 分钟或外呼超时超阈即触发，回退“基础释义 + 模板例句”，半开探测恢复。

------

## 16.4 端到端性能预算（细化版）

> 在 6.3 与 7.11 的分段之上，细化各场景预算和失败回退口径。

### 16.4.1 分层性能预算（网关/BFF/LLM 适配/缓存/存储）

| 层级               | 平均预算 | P95 预算 | 说明与依赖                                                                                   |
| ------------------ | -------- | -------- | -------------------------------------------------------------------------------------------- |
| **边缘/网关**      | ≤60 ms   | ≤150 ms  | 含 TLS 握手复用、WAF/ACL、Token 校验；结合 CDN/CDS，80% 以上静态资源命中边缘缓存。        |
| **BFF**            | ≤80 ms   | ≤180 ms  | 负责画像、策略判定、缓存编排与请求拆并；命中缓存时 95% 请求在 100 ms 内返回。              |
| **LLM 适配层**     | ≤250 ms  | ≤600 ms* | 含 prompt 裁剪、参数注入、响应流式解析；星号表示仅对外呼成功子集统计。                     |
| **上游 LLM 调用**  | ≤900 ms  | ≤3000 ms | Doubao API 端到端 SLA（含网络抖动）；超 5.0 s 触发熔断与降级。                               |
| **缓存层（L1/L2）**| ≤40 ms   | ≤80 ms   | L1（内存）平均 10 ms / P95 40 ms；L2（Redis）平均 25 ms / P95 80 ms，命中即跳过外呼。        |
| **持久化/存储**    | ≤30 ms   | ≤80 ms   | 包含查询历史、订阅计数读取；批量写入经异步队列，主链路仅计索引查询。                       |
| **前端渲染**       | ≤700 ms  | ≤900 ms  | 渐进渲染首块释义优先，骨架屏占用 <100 ms；异步模块超 1.0 s 自动降级为精简展示。             |

> 备注：整链 P95 `150 + 180 + 600 + 3000 + 80 + 900 ≈ 4910 ms` 为最坏路径（未命中 + 外呼成功）。
> 若仅依据 52% 缓存命中率、48% 正常外呼衡量，整体 P95 会被拖至约 4.9 s，无法满足“端到端 P95 ≤ 2.5 s”。
> 为实现 SLO，我们将“命中 + 快速降级”覆盖率提升至 **≥95%**：
> - 缓存命中按 NFR 目标维持 ~52%，首屏 P95 ≈ 1.2 s；
> - 对剩余 ~48% 未命中请求，BFF 在 **2.3 s** 设置超时，超时即返回“基础释义+模板例句”降级响应（P95 ≤ 1.8 s），并异步刷新缓存；
> - 仅保留 ≤5% 请求等待外呼成功（P99 ≈ 4.9 s）以保留高质量答案兜底。
> 由此累计 52% + 43% = 95% 请求在 2.3 s 内完成，可保证整体 P95 ≤ 2.3 s、均值 ≤ 1.2 s。

### 16.4.2 关键场景预算

| 场景                         | 预算分段（P95）                                              | 备注与回退                    |
| ---------------------------- | ------------------------------------------------------------ | --------------------------------------------------- |
| **查词 `/lookup`（命中）**   | 网关 ≤150 ms + BFF/L1/L2 ≤200 ms + 渲染 ≤900 ms              | 命中时跳过外呼；返回 `X-Cache:HIT`。                |
| **查词 `/lookup`（未命中）** | 网关 ≤150 ms + BFF ≤120 ms + Doubao ≤2300 ms + 解析 ≤100 ms + 渲染 ≤1000 ms | `2.3 s` 未完成即返回降级语义；结果异步写缓存，返回 `degraded=true`。 |
| **再生成 `/regenerate`**     | 同未命中，但默认绕过 L2；P95 ≤3000 ms                        | 计入“再生成”配额；命中 L1 则同命中路径。            |
| **历史/导出**                | `/history` P95 ≤800 ms；导出回执 ≤5 s                        | 下载链接 TTL 10 分钟，一次性。                    |

------

## 16.5 容量模型与算量方法

### 16.5.1 交通画像与请求类型占比（建议）

- 默认占比：**Lookup 70% / Regenerate 20% / 历史与导出 8% / 其他 2%**。不同阶段以监控回填修正。
- 配额与限速对占比的边界由第 10 章定义；达全局保护阈值时优先保障 Lookup。

### 16.5.2 有效外呼率与上游并发

- **联合命中率** = `L1 + (1 - L1) × L2`。以 NFR 基线 L1=40%、L2=20% 计，**联合命中 ≥ 52%**。则仅 **48%** 请求触发上游外呼。
- 在 **300 QPS** 时，**上游 QPS ≈ 300 × 0.48 = 144 QPS**；若上游 P95 约 3 s，则需**上游并发水位 ≈ 144 × 3 = 432**。保守加 25% 余量，配置**540**并发许可及队列。

### 16.5.3 计算公式（抄写即用）

- 上游外呼 QPS：`QPS_upstream = QPS_total × (1 - hit_L1 - (1-hit_L1)×hit_L2)`
- 上游并发水位（P95 估）：`Concurrency_upstream ≈ QPS_upstream × P95_upstream_seconds`
- BFF 计算并发：`Concurrency_BFF ≈ QPS_total × P95_BFF_seconds × α`（α=1.2~1.5 容差）
- 渲染预算：`T_render_first_block = Target_P95 - (T_edge + T_bff + T_upstream + T_parse)`
   以上口径与“首个内容模块”定义保持一致。

### 16.5.4 容量分档与扩展策略

- **基线（MVP）**：承载 300 QPS，外呼并发许可 540；L1/L2 目标 40%/20%；端到端 P95 ≤ 2.5 s。
- **×2 扩展（600 QPS）**：保持 L1/L2 目标不降，将上游并发许可线性提升至 ~1080；BFF 线程/连接池与队列深度等比例扩。
- **×3 突发（900 QPS，≤5 分钟）**：触发全局保护阈值与强缓存策略（L2 优先，TTL×2），临时关闭“再生成”。

### 16.5.5 分层容量与冗余比（核算口径）

| 层级               | 基线容量（300 QPS）                                          | 突发目标 | 冗余比（基线→突发） | 备注 |
| ------------------ | ------------------------------------------------------------ | -------- | -------------------- | ---- |
| **边缘/网关**      | 4× 实例，每实例 2 vCPU / 2 GiB；单实例 150 QPS；活跃连接 ≤6k | 900 QPS  | 1.5×                 | 无状态部署，路由按权重自动扩。 |
| **BFF**            | 6× 实例，每实例 2 vCPU / 4 GiB；线程池 256；并发许可 450     | 900 QPS  | 1.8×                 | `α=1.3`，保障队列等待 <50 ms。 |
| **LLM 适配层**     | 12× Worker，每 Worker 1 vCPU；连接池 600；并发许可 540        | 1350 QPS | 2.5×                 | 覆盖再生成峰值，突发时可借调配额。 |
| **缓存 L1（BFF 内存）**| 每实例 2 GiB 共享，热键上限 5M；命中率目标 40%        | 300 QPS  | 1.2×                 | 溢出触发 LRU 淘汰，监控内存水位。 |
| **缓存 L2（Redis 集群）**| 3 分片 * 主从；吞吐 ≥120k ops/s；P95 80 ms             | 900 QPS  | 2.0×                 | Pipeline + Cluster，突发时 TTL×2。 |
| **存储（RDBMS）**  | 主从各 8 vCPU / 32 GiB；读 QPS 5k、写 QPS 1k；P95 50 ms       | 900 QPS  | 3.0×                 | 含只读副本 1 台热备，备份异地。 |
| **上游 LLM 并发**  | 并发许可 540；排队深度 200                                 | 1350 QPS | 2.5×                 | 含 25% 安全余量，熔断前排队 <1 s。 |

冗余比定义：`Capacity_spike / Capacity_baseline`；评审时需结合实测更新。

### 16.5.6 限流与队列参数（初始值 & 回滚阈值）

| 组件/层级          | 初始限流/队列参数                                                | 监控指标                         | 回滚阈值与动作                                                | 备注 |
| ------------------ | ----------------------------------------------------------------- | -------------------------------- | ------------------------------------------------------------- | ---- |
| **边缘网关**       | 用户级：120 RPM；租户级：600 RPM；全局桶：1200 RPS，突发 2×       | 429 比例、桶水位、延迟           | 5 分钟内 429 >3% 或延迟 >200 ms：回滚至用户 150 RPM、租户 750 RPM，并通知限流章配置 | 配额章（第 10 章）保护阈值一致 |
| **BFF 请求队列**   | 并发许可 450；排队深度 200；排队超时 150 ms                       | 队列深度、等待时间、拒绝率       | 等待 >120 ms 且持续 2 分钟：回滚到并发 360、排队 120，并触发“再生成降级” | 参数写入 Ops 配置中心 |
| **LLM 适配层**     | 并发许可 540；排队深度 300；突发窗口 30 s                         | Upstream 并发、排队 >1 s 比例     | 排队 >1 s 比例 >5% 且 1 分钟：回滚到并发 420、排队 200，同时打开“强缓存 TTL×2” | 与 Doubao SLA 联动 |
| **导出任务队列**   | Worker 24 个；批处理并发 48；单任务限速 1 rps；队列长度告警 2k    | 队列长度、任务等待、RTO          | 等待 >5 分钟或 RTO >10 分钟：回滚到并发 32、暂停低优先级导出，并触发人工扩容 | 保障 RTO ≤15 分钟 |
| **订阅更新推送**   | 批量推送 200 TPS；单租户突发 5 TPS；重试队列 500；延迟阈值 2 分钟 | 推送成功率、重试堆积、端到端延迟 | 重试堆积 >200 或延迟 >2 分钟：回滚突发到 3 TPS，并启用“只推摘要模式” | 回执逻辑见第 11 章 |

> **回滚原则**：所有回滚动作需记录于变更单，并同步第 10 章“配额与限流”中的保护策略表；恢复前须通过压测或实测复核。


------

## 16.6 缓存与裁剪协同

- **键设计与失效**：`hash(subjectId, lang_pair, entry_norm, config_hash, profile_etag)`；画像、档位、模块开关变动必须失效相关键。
- **命中提升动作**：低于目标 10 分钟告警；自动开启“共享释义先于个性化例句”的缓存策略；必要时提高 L2 TTL 到 60 分钟并降条数/详略一档。
- **降本口径**：缓存命中记 0 成本但记 1 次业务配额；tokens_in/out 仅对未命中请求计量。

------

## 16.7 压测与基准（必做）

> 以“场景驱动 + 门槛式验收”为原则，联动 NFR-13 验收清单。

### 16.7.1 场景与流量模型

1. **S1：稳态 300 QPS**（10 分钟）
   - 组成：Lookup 70% / Regenerate 20% / 其他 10%
   - 期望：端到端 P95 ≤ 2.5 s，错误率 < 0.1%，L1≥40%、L2≥20%。
2. **S2：突发 900 QPS**（3 分钟）
   - 验证全局保护阈值、强缓存、再生成关停的自动策略。
3. **S3：上游异常**（人为注入 5xx≥5% 且 1 分钟）
   - 期望：熔断触发，**100%** 回退“基础释义+模板例句”，UI 明示退化，恢复半开探测。
4. **S4：降级态基线**（300 QPS，持续 5 分钟）
   - 触发条件：主动拉高上游延迟至 5 s 并开启熔断，验证降级路径 P95 ≤ 1.8 s、均值 ≤ 0.9 s。
   - 期望：缓存命中率 ≥60%，强缓存 TTL×2 生效，成本燃率 <0.8× 正常态。

### 16.7.2 指标采集与门槛

- APM 必须分段上报：Edge、BFF、Cache、Upstream、Parse、Render；99% 请求带 trace_id。
- **通过条件**：S1/S2/S3/S4 分别满足 NFR、降级基线与回退口径；契约回放样本≥500 条通过（发布门禁）。

------

### 16.7.3 压测脚本清单（流式查词/导出/订阅）

| 编号 | 场景                | 测试工具 & 脚本路径                       | 流量模型与关键参数                                                  | 采集指标                                         | 验收门槛 |
| ---- | ------------------- | ------------------------------------------ | -------------------------------------------------------------------- | ------------------------------------------------ | -------- |
| P1   | 流式查词稳态（S1）  | `perf/lookup_steady.jmx`（JMeter）         | 300 QPS，Lookup 70% / Regenerate 20% / 其他 10%；HTTP/2 + streaming  | 端到端 P50/P95、错误率、L1/L2 命中、成本燃率    | P95 ≤2.5 s，错误率 <0.1%，命中率达标 |
| P2   | 流式查词突发（S2）  | `perf/lookup_spike.gatling`（Gatling）     | 90→900 QPS 梯度 60 s，保持 3 分钟；突发窗口触发强缓存               | 队列深度、429 比例、熔断触发情况                | 突发期无累计超时>1 s，策略按 80%/95% 触发 |
| P3   | 上游异常降级（S3）  | `perf/lookup_upstream_fault.jmx`           | 注入 5% 503，延迟抬升至 5 s；持续 5 分钟                              | 降级命中率、fallback 耗时、告警触发            | 降级路径 P95 ≤1.8 s，熔断 30 s 内生效 |
| P4   | 再生成降级稳态      | `perf/regenerate_degraded.locustfile`      | 120 QPS，再生成占比 100%；命中率设为 0 以压测适配层                   | Upstream 并发、适配层耗时、token 消耗           | 适配层 P95 ≤600 ms，token 成本 ≤基线 1.1× |
| P5   | 导出任务 RTO        | `perf/export_task_rto.py`（Locust）        | 10 并发导出，每个 5k 条；批处理并发 48，持续 30 分钟                  | 任务完成时间、RTO、失败/重试率                  | RTO ≤15 分钟，失败率 <1% |
| P6   | 订阅更新推送        | `perf/subscription_push.ts`（k6）          | 200 TPS 批量推送，订阅 5 万；模拟延迟 & 重试                           | 端到端延迟、重试堆积、推送成功率                | 成功率 ≥99%，延迟 ≤2 分钟 |

脚本统一存放于 `scripts/perf/` 目录，附 `README.md` 说明参数；执行后需上传原始指标至可观测性平台留痕。

------

## 16.8 监控面板与告警

- **看板最少卡片**：端到端 P50/P95、成功率、429 命中率、L1/L2 命中率、成本燃率、上游错误与超时率、上游并发水位、队列深度、下载 TTL 失效率。
- **告警规则**：
  - 5 分钟滚动 429 比例 >3% 告警；成本燃率 >1.2× 告警，>1.5× 进入强降级；L1 或 L2 命中低于目标 10 分钟告警。
- **链路贯穿**：前后端与第三方统一 trace_id；日志三分法齐全。

------

## 16.9 扩缩容 Runbook（可执行）

1. **触发条件**
   - 上游并发 >80% 且持续 5 分钟；端到端 P95 超 10% 红线；队列等待 >500 ms。
2. **扩容步骤**
   - 横向扩容应用实例与适配层实例，按线性比例提升连接池与并发许可；同步提高网关路由权重。
3. **强保护**（预算 80%/95% 阶梯）
   - 80%：开启“L2 优先 + TTL×2”；95%：停止再生成，仅放行查词并走简化路径。
4. **回收与复位**
   - 30 分钟内负载回落则自动回撤强缓存与禁用开关；记录 `downgrade_applied` 事件。

------

## 16.10 成本‑性能协同与验收产物

### 16.10.1 成本‑性能协同策略

- 计量：`cost = a*tokens_in + b*tokens_out`；监控 Burn Rate 与单请求成本 P95，超阈自动降条数/详略。
- 订阅事件 ≤5 s 内下发新 entitlement，同步至配额与缓存；读写不一致容忍 ≤5 s 期间按“更宽松不超限”。

### 16.10.2 性能预算责任表（首屏指标）

| 负责团队       | 分段预算（均值 / P95）                     | 工程动作                                   | 验收口径                                   |
| -------------- | ------------------------------------------- | ------------------------------------------ | ------------------------------------------ |
| 前端 & CDN     | 600 ms / 900 ms                             | 骨架屏 + 首包预取、HTTP/2 push/预加载      | Web Vitals + 自研 APM，上报 `firstContent` |
| 边缘 / 网关    | 60 ms / 150 ms                              | 连接复用、WAF 缓存、Token 校验优化         | 网关 APM + 链路日志；每日审查 429          |
| BFF            | 80 ms / 180 ms                              | 缓存编排、策略判定、并发控制               | Trace 分段统计；缓存命中率大盘             |
| LLM 适配层     | 250 ms / 600 ms（成功子集）                 | Prompt 裁剪、参数注入、流式解析            | 适配层日志 + 上游 SLA 对齐                 |
| 上游 LLM       | 900 ms / 3000 ms（含网络）                  | 双 Region 配额、熔断策略、成本监控         | 供应商监控 + 本地代理链路                 |
| 缓存（L1/L2）  | 40 ms / 80 ms                               | 热键治理、TTL 调整、预热脚本               | Redis 监控、BFF 内存指标                  |
| 存储 / 导出    | 30 ms / 80 ms（查询）；导出回执 ≤5 s       | 只读副本、批任务拆分、异步写入             | SQL 慢查询、任务队列监控                  |

> 表格为发布前评审与上线后复盘的唯一依据；若某段 P95 超红线 >10%，需在变更记录中登记整改计划。

### 16.10.3 压测报表模板（样例）

| 指标                     | S1（稳态 300 QPS） | S2（突发 900 QPS） | S3（上游异常） | S4（降级稳态） | 结论回填（第 10 章配额/限流） |
| ------------------------ | ------------------ | ------------------ | -------------- | -------------- | ----------------------------- |
| 端到端延迟 P95          | **2.18 s** ✅        | 2.42 s ✅            | 1.75 s ✅        | 1.62 s ✅        | 全局限流阈值维持 1200 RPS；突发策略有效 |
| 错误率 / 429 比例        | 0.06% ✅             | 2.1% ⚠️（触发保护）   | 0% ✅            | 0% ✅            | 429 峰值 2.1% < 3%，无需调整 |
| L1 / L2 命中率          | 42% / 23% ✅         | 55% / 28% ✅         | 68% / 30% ✅     | 63% / 35% ✅     | L2 TTL×2 生效；缓存策略需在第 10 章更新 |
| 上游并发峰值            | 410 ✅               | 980 ⚠️（借用突发配额）| 120 ✅           | 0（熔断） ✅      | Doubao 并发维持 540 +25% 余量 |
| 导出任务 RTO            | 11 分钟 ✅           | 13 分钟 ✅           | 12 分钟 ✅       | 10 分钟 ✅       | 导出并发保持 48；队列阈值 2k 复核 |
| 订阅推送端到端延迟      | 1.4 分钟 ✅          | 1.8 分钟 ✅          | 1.5 分钟 ✅      | 1.2 分钟 ✅      | 配额章订阅推送突发保持 5 TPS     |
| 成本燃率（tokens/请求） | 0.92× ✅             | 1.05× ⚠️             | 0.48× ✅         | 0.55× ✅         | 突发期成本 <1.1×，暂不调整价格 |

> **备注**：带 ⚠️ 的指标需在会后评审中确认是否追加动作；“结论回填”列用于同步第 10 章配额/限流策略与第 11 章权益同步阈值。

### 16.10.4 交付清单

- `性能预算责任表（16.10.2）`：存档于 Confluence《性能预算》，周会复盘。
- `压测脚本清单（16.7.3）`：脚本位于仓库 `scripts/perf/`，附 README。
- `压测报表模板（16.10.3）`：导出 `.xlsx` + 监控截图，发布前后各一次。
- `限流与队列参数表（16.5.6）`：同步至运维 Runbook，与第 10 章限流章节互为引用。

------

## 16.11 依赖稳健性与回退矩阵

| 依赖          | 异常阈值                     | 动作                                              | 恢复条件                    |
| ------------- | ---------------------------- | ------------------------------------------------- | --------------------------- |
| Doubao API    | 5xx≥5% 且 ≥1 分钟，或超时>阈 | 打开熔断，降级为“基础释义+模板例句”；开启半开探测 | 连续 3 次探测成功后闭合熔断 |
| 支付/订阅回调 | 丢失/延迟                    | 启动轮询对账，幂等更新                            | 回调恢复或轮询一致          |

以上动作 UI 必须明示“已降级”。

------

## 16.12 数据层与持久化性能

- **RDBMS 写路径**：历史落库与计数器更新 P95 20–50 ms；大表采用分区与到期清理，删除语义“逻辑删即时、物理清理 T+7 天”。
- **导出任务**：202 + 回执，P95 ≤ 5 s 获取一次性下载链接，TTL 10 分钟。

------

## 16.13 前后端协作与渲染

- **渐进渲染**：释义先行，例句/搭配随后；单区块失败不阻塞；同语模式不展示译文且接口不返回 `translation`。
- **错误模型**：统一 `RATE_LIMITED`、`UPSTREAM_UNAVAILABLE`、`CIRCUIT_OPEN` 语义；返回配额/限速头与体镜像。

------

## 16.14 环境与发布门禁

- **环境分层**：Dev/Staging/Prod 隔离；Prod 采用蓝绿/小流量灰度与自动回滚。
- **门禁**：契约回放样本≥500 条、端到端 S1/S2/S3 场景过线、NFR-13 抽样通过。

------

## 16.15 验收标准（对齐 UC 与 NFR）

| 编号     | 验收项            | 通过条件                                                   |
| -------- | ----------------- | ---------------------------------------------------------- |
| 16-AC-01 | 稳态 300 QPS 压测 | 10 分钟端到端 P95 ≤ 2.5 s、错误率 <0.1%、L1≥40%/L2≥20%     |
| 16-AC-02 | 突发 900 QPS      | 触发全局保护阈值，强缓存与“停再生成”生效，5 分钟内恢复稳态 |
| 16-AC-03 | 上游故障演练      | 熔断与降级 100% 生效，UI 明示，半开恢复后自动闭合          |
| 16-AC-04 | 导出 SLA          | 回执 ≤5 s，一次性链接 TTL 10 分钟，可重复申请              |
| 16-AC-05 | 配额与头信息      | 返回 `X-RateLimit/*`、`X-Quota-*` 与 body `quota` 镜像一致 |

以上与第 6 章“压测/降级/幂等/隐私/导出”验收清单一致。

------

## 16.16 风险、依赖与缓解

- **缓存穿透**：热门词条配置变化导致大面积失效 → 键包含 `profile_etag` 与档位，发布窗口分批失效。
- **成本飙升**：tokens_out 异常 → 自动降条数/详略，密切监控 Burn Rate 阶梯。
- **订阅不同步**：回调延迟 → 轮询兜底 ≤15 分钟，≤5 s 内对配额域做“更宽松不超限”。

------

## 16.17 变更与追溯

- 契约与阈值的破坏性调整需走版本与弃用期流程；所有变更以 trace_id 贯穿并可回放。

------

### 附：实施清单（落地优先序）

1. 接入 APM 分段与 trace_id（端到端/段内）。
2. 落地 L1/L2 缓存命中统计与 TTL 热更新。
3. 上游并发许可与队列深度仪表盘；强保护自动化策略。
4. S1/S2/S3 压测脚本与回放样本≥500 条门禁。
5. 灰度与回滚脚手架（蓝绿 + 小流量）。

> 至此，第 16 章给出“目标‑预算‑容量‑压测‑监控‑扩缩容‑验收”的闭环方案，与第 1/6/7/8/9/10/11 章一致，可直接交付实施与验收。