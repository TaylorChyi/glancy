# 第 9 章 数据模型与数据治理

> 版本说明：与第 8 章同步，本章根据 Spring Data JPA 实体与服务层逻辑梳理当前持久化模型，涵盖词典缓存、搜索历史、TTS 配额、会员权益及兑换记录。原先的抽象 ER 草图已替换为直接链接代码的表格，以便开发、产品与数据团队共用。

---

## 9.1 当前实现表格

| 序号 | 实体/表 | 关键字段与约束 | 关联关系 | 数据治理要点 | 代码 |
| --- | --- | --- | --- | --- | --- |
| DM-001 | `users` | `username`/`phone` 唯一；`membershipType`、`membershipExpiresAt`、`member` 状态字段 | 与搜索记录、TTS 用量、兑换记录等多表关联 | 会员状态统一通过 `updateMembership` & `synchronizeMembershipStatus` 维护，避免布尔标记漂移。 | 【F:backend/src/main/java/com/glancy/backend/entity/User.java†L19-L92】 |
| DM-002 | `search_records` | 关联 `user_id`，`term`、`language`、`flavor` 组合；`favorite` 标记 | `SearchRecord` 一对多 `SearchResultVersion` | 保存前会按最近 20 条做归一化去重，非会员每日最多 10 条。 | 【F:backend/src/main/java/com/glancy/backend/entity/SearchRecord.java†L17-L39】【F:backend/src/main/java/com/glancy/backend/service/SearchRecordService.java†L38-L179】 |
| DM-003 | `search_result_versions` | `version_number`、`model`、`content` LOB；可选 `word_id` | 版本归属 `SearchRecord`、`User`，可回溯具体词条 | 结果内容存 Markdown/JSON 字符串，预览字段便于历史列表快速渲染。 | 【F:backend/src/main/java/com/glancy/backend/entity/SearchResultVersion.java†L17-L59】 |
| DM-004 | `words` 及子表 | `term` 与 `normalized_term` + `language` + `flavor` 双重唯一索引；多组 `@ElementCollection`（definitions/synonyms 等） | 缓存词典静态数据，供查询命中 | 归一化键由 `DictionaryTermNormalizer` 生成，与搜索记录复用。 | 【F:backend/src/main/java/com/glancy/backend/entity/Word.java†L17-L61】 |
| DM-005 | `word_issue_reports` | `term`、`language`、`flavor`、`issue_category`；可选 `description`、`source_url`、`userId` | 无外键约束，轻量收集用户反馈 | 描述限制 2000 字、来源 500 字，避免滥用。 | 【F:backend/src/main/java/com/glancy/backend/entity/WordIssueReport.java†L17-L35】【F:backend/src/main/java/com/glancy/backend/dto/WordIssueReportRequest.java†L10-L17】 |
| DM-006 | `tts_usage` | (`user_id`, `date`) 唯一；`count` 记录当日合成次数 | 与 `users` 多对一 | 与 `TtsQuotaService` 联动，按会员等级读取每日限额。 | 【F:backend/src/main/java/com/glancy/backend/entity/TtsUsage.java†L17-L33】【F:backend/src/main/java/com/glancy/backend/service/tts/quota/TtsQuotaService.java†L34-L75】 |
| DM-007 | 兑换体系 | `redemption_code`、`redemption_record`、`user_discount_benefit` | 兑换码配置与用户兑换记录、折扣权益一一对应 | 通过乐观锁控制总额度，`normalizeCode` 保证大小写一致。 | 【F:backend/src/main/java/com/glancy/backend/entity/redemption/RedemptionCode.java†L17-L144】【F:backend/src/main/java/com/glancy/backend/service/redemption/RedemptionCodeService.java†L62-L207】 |

---

## 9.2 目标契约与差异

| 序号 | 目标项 | 当前状态 | 说明 |
| --- | --- | --- | --- |
| TDM-001 | 搜索历史采用游标分页（cursor） | **未实现**：现使用页码分页 `page/size` | 若需支持 cursor，需扩展 `SearchRecordPageRequest` 并调整仓库查询。 【F:backend/src/main/java/com/glancy/backend/controller/SearchRecordController.java†L54-L64】 |
| TDM-002 | 词典缓存应存储音频元数据 | **未实现**：`words` 表暂无音频字段 | 现阶段音频通过 TTS 动态生成，如需缓存需新增列及清理策略。 |
| TDM-003 | 兑换折扣应用到计费流水 | **未实现**：系统仅记录折扣有效期，未与实际计费流水对接 | 留待第 11 章差异处理，需后续 Issue。 |

其余数据结构目标与当前一致。

---

## 9.3 关系与治理策略

1. **用户与会员状态**：`MembershipLifecycleService` 统一入口激活、续期、移除会员，依赖 `User` 实体内部的同步逻辑，避免直接修改字段造成脏数据。 【F:backend/src/main/java/com/glancy/backend/service/membership/MembershipLifecycleService.java†L24-L79】【F:backend/src/main/java/com/glancy/backend/entity/User.java†L58-L92】
2. **搜索记录去重**：保存时先在最近 20 条历史中按归一化词条匹配，命中则刷新 `updatedAt` 并复用记录，从而保持 UI 按最近访问排序且避免表爆炸。 【F:backend/src/main/java/com/glancy/backend/service/SearchRecordService.java†L87-L179】
3. **版本化存储**：`SearchResultVersion` 记录生成模型、预览与完整内容，便于历史回查与差异分析；与 `SearchRecord`、`Word` 均为懒加载，降低常规查询开销。 【F:backend/src/main/java/com/glancy/backend/entity/SearchResultVersion.java†L17-L59】
4. **TTS 配额记录**：`TtsUsage` 与配置文件 `tts-config.yml` 同步，按会员等级使用不同每日额度；`countCachedAsUsage=false` 表示缓存命中不计入。 【F:backend/src/main/java/com/glancy/backend/service/tts/quota/TtsQuotaService.java†L34-L75】【F:backend/src/main/resources/tts-config.yml†L17-L35】
5. **兑换权益治理**：兑换前验证有效期、总额度、单用户额度，成功后写入 `redemption_record` 并返回会员或折扣快照。 【F:backend/src/main/java/com/glancy/backend/service/redemption/RedemptionCodeService.java†L101-L145】

---

## 9.4 差异追踪（需建 Issue）

1. **分页模型一致性**：若产品决定统一使用游标分页，需要新增字段并补充文档。当前所有 API 使用页码形式。
2. **音频缓存策略**：前端存在 `fetchWordAudio` 调用但后端无存储字段，需明确是删除调用还是扩展数据模型。 【F:website/src/shared/api/words.js†L119-L128】
3. **计费流水表**：兑换折扣仅写入 `user_discount_benefit`，尚无实际账单或对账表；后续若实现订阅计费需扩展数据模型。

请在项目 Issue 看板登记上述差异，作为下一迭代的需求评估输入。
