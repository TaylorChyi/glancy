# 第 13 章 可用性、容灾与备份

> 目的：落实“关键接口 99.9% 月度可用、依赖异常自动降级、RTO/RPO 基线与定期演练”到可执行、可验证、可追责的体系，作为业务连续性（BCP）的落地章节；本章约束与 1–12 章保持口径一致。可用性统计剔除事先公告的维护窗口。

------

## 13.1 SLA 指标

### 13.1.1 统计口径

- **对象范围**：`/lookup`、`/regenerate`、`/history`、`/exports` 以及导出回执接口，含 Web/H5 UI 对应的 BFF。
- **维护窗口**：仅限经 SRE 公告且不少于 24 小时预告的基础设施变更，窗口内请求全量剔除出 SLA 统计，事件记录在案。
- **失败定义**：满足以下任一即记为不可用分钟：
  1. 网关层 5xx / 499≥5% 且持续 ≥1 分钟；
  2. 端到端 P95 > 2.5 s 且持续 ≥5 分钟；
  3. 触发熔断后无降级响应（缺少“基础释义 + 模板例句”或 `degraded=true` 标识）。
- **观测机制**：合成探针（正常线路 + 降级线路）、真实流量 SLI、告警抑制策略与 trace 贯穿率 ≥99%。

### 13.1.2 指标与公式

| 指标类别                     | 公式/阈值                                                                 | 备注                                                                 |
| ---------------------------- | -------------------------------------------------------------------------- | -------------------------------------------------------------------- |
| 月度可用性（SLA）            | `(总分钟 − 维护窗口分钟 − 不可用分钟) ÷ (总分钟 − 维护窗口分钟)` ≥ 99.9%  | 不可用分钟来自 13.1.1 的失败定义；每月统计并发布。                 |
| 端到端性能基线（SLO）        | 首个内容模块渲染：P95 ≤ 2.5 s，均值 ≤ 1.2 s                               | 以 BFF 监控与前端 RUM 交叉验证。                                     |
| 成本护栏联动                 | 当日预算 ≥95%：禁用“再生成”，查词强缓存，仍需满足 SLA/SLO               | 护栏事件在成本看板留痕并纳入回溯。                                   |
| RTO/RPO（见 13.1.4）         | 历史/配置 RTO ≤30 min，RPO ≤5 min；导出 RTO ≤15 min                       | 触发演练与实战均需测得并记录。                                       |
| 降级响应率                   | 依赖异常时 100% 返回“基础释义 + 模板例句”并标 `degraded=true`             | 统计口径来自 UC-14 降级合成探针与日志。                               |

### 13.1.3 样例计算

- **场景**：30 天月份，共 43,200 分钟；维护窗口 2 次共 240 分钟；本月记录 22 分钟不可用（含 15 分钟 Doubao 熔断失败、7 分钟数据库故障）。
- **计算**：`(43,200 − 240 − 22) ÷ (43,200 − 240) = 42,938 ÷ 42,960 = 99.9487%`。
- **结论**：满足 ≥99.9% SLA；事件编号 DR-2024-07-02 与 DR-2024-07-03 必须在 13.5 回溯表留痕。

### 13.1.4 RTO/RPO 指标分解

| 数据/域                                  | RTO     | RPO    | 校验方式                                                       |
| ---------------------------------------- | ------- | ------ | -------------------------------------------------------------- |
| 历史与配置（`lookups/results/profiles`） | ≤30 min | ≤5 min | PITR 恢复 + 删除日志回放；演练需提交恢复耗时与数据比对截图。 |
| 导出任务与回执                           | ≤15 min | N/A    | 任务编排重放 + 链接重发；验收 `POST /exports` 回执 ≤5 s。     |
| 订阅/订单/账单                           | ≤30 min | ≤5 min | 订单与权益对账；权益域 5 s 内一致性截图。                     |
| Redis 缓存/配额计数                      | ≤10 min | 可丢失 | 视作可重建；命中率恢复曲线附在验收报告。                      |

------

## 13.2 依赖拓扑

### 13.2.1 分层拓扑视图

```
用户 → CDN/WAF → API 网关 → BFF/应用 → (LLM 适配层 ↔ Doubao)
                                 ↘ RDBMS 主从集群
                                 ↘ Redis L1/L2 集群
                                 ↘ 对象存储（导出产物 CRR）
                                 ↘ 任务编排/消息队列
                                 ↘ 第三方（登录/支付）
```

- **区域策略**：同区多 AZ 主备 + 跨区域 Warm-Standby。无状态组件（网关、BFF、适配层）Active‑Active；有状态组件（RDBMS、Redis、对象存储）Active‑Standby 或可重建。
- **依赖分级**：P0（Doubao、RDBMS、Redis、支付）、P1（对象存储、导出任务编排）、P2（画像偏好、审计归档）。

### 13.2.2 组件级冗余与切换

| 组件                   | HA/切换策略                          | 切换触发阈值与执行人                                 |
| ---------------------- | ------------------------------------ | ---------------------------------------------------- |
| API 网关/WAF/CDN       | 多实例 + 健康探测 + 权重切流         | 错误率 ≥1% 或探测失败；网络组执行。                  |
| BFF/应用（模块化单体） | 无状态扩缩容，蓝绿/灰度发布，自动回滚 | 合成探针失败、契约回放失败；应用 owner 执行。        |
| LLM 适配层（Doubao）   | 熔断/半开/恢复；降级回退             | 第三方 5xx ≥5% 且 1 分钟；AI 平台值班执行。          |
| RDBMS（PostgreSQL）    | 同区主从/托管 HA；跨区只读副本；PITR | 主从失联或写失败；DBA 执行提升与指向更新。           |
| Redis                  | 主从/集群；AOF + RDB 快照；脚本重建   | 节点漂移或不可用；缓存 owner 执行重建。              |
| 对象存储               | 多 AZ + 版本化 + CRR                 | 区域故障或下载报错；存储 owner 切换区域与链接。      |
| 任务编排               | 幂等任务、死信/重放                  | 队列堆积 > 阈值；任务 owner 触发重放。               |
| 登录/支付              | 回调优先、轮询兜底、幂等更新         | 回调超时 >3 分钟；支付 owner 启动轮询脚本。          |

### 13.2.3 数据保护与备份（B&R）

- **RDBMS**：每日全量 + 15 分钟增量/WAL；保留 7 日（日备）+ 4 周（周备）+ 3 月（月备）；跨区异步副本延迟阈值 30 s，超阈告警。
- **对象存储**：版本化 + 跨区复制；导出产物生命周期 24–48 h；删除请求 T+7 天内可恢复。
- **Redis**：AOF 每秒刷盘，RDB 每 6 h；跨区不做热备，按脚本重建键空间（允许冷启动）。
- **配置/密钥**：配置中心定时快照；密钥存于密管服务，密封备份轮转 ≤90 天。

------

## 13.3 降级矩阵

| 故障域                 | 监测信号                                      | 降级/回退动作                                                                 | SLA/SLO 影响与补救                                      | 责任角色 |
| ---------------------- | --------------------------------------------- | ----------------------------------------------------------------------------- | ------------------------------------------------------- | -------- |
| Doubao（LLM 依赖）     | 5xx ≥5% 且 1 分钟；超时率 ≥10%                | 触发熔断 → 100% 返回“基础释义 + 模板例句”，响应体标 `degraded=true`；UI 显示“已降级”。 | 降级响应成功率 ≥99.9%；恢复后半开 3 次成功才闭合熔断。 | AI 平台  |
| RDBMS 主库             | 主从复制延迟 >5 s 或写失败                    | 提升同步从库为主；锁定写入；完成后回放删除与配额补偿。                       | RTO ≤30 min，RPO ≤5 min；变更记录入库。                | DBA      |
| Redis 集群             | 节点不可达或命中率降至 <20%                  | 切换主从或执行重建脚本；期间启用“缓存旁路 + 强 L2”。                         | 首屏可用，缓存命中率 60 分钟内恢复 ≥80% 基线。         | 缓存组   |
| 对象存储/导出          | 下载失败率 ≥2% 或 CRR 延迟 >60 s             | 切换到备区域；延长临时链接；失败导出任务重放。                               | 导出 RTO ≤15 min；一次性链接 TTL 10 分钟保持有效。     | 存储组   |
| 登录/支付第三方        | 回调失败率 ≥5% 或 3 分钟无回调               | 启动轮询；状态机幂等更新；必要时提示人工确认。                               | 权益 5 s 内同步；失败订单在 30 分钟内补偿。            | 支付组   |
| 成本护栏               | 当日预算 ≥80%/95%                            | 80%：启用强缓存；95%：禁用“再生成”，走简化路径。                             | SLA 不变；成本事件纳入回溯与财务审批。                 | 财务/SRE |
| 发布/契约异常          | 契约回放 <100% 或灰度错误率 >0.1%            | 自动回滚；Kill switch 降级；恢复后重新回放 500 样本。                         | 零停机发布；AC 确认无残留故障。                        | 发布组   |

------

## 13.4 演练计划

### 13.4.1 频率与覆盖

| 演练类型             | 频率              | 必测指标                                                 |
| -------------------- | ----------------- | -------------------------------------------------------- |
| 熔断/降级（UC-14）   | 每月              | 降级成功率 ≥99.9%；日志含熔断→半开→恢复全链路。        |
| 数据库 PITR + 切换   | 双月（偶数月）    | RTO ≤30 min；RPO ≤5 min；删除日志回放无遗漏。           |
| 跨区灾备切换         | 每季度            | 切换 ≤30 min，切换期间 SLA ≥99.0%，次日恢复 ≥99.9%。     |
| 零停机发布 + 回滚    | 每次重大发布前    | 灰度失败自动回滚；500 样本契约回放 100% 通过。           |
| 成本护栏预案         | 每季度            | 95% 护栏时再生成禁用、缓存命中率 ≥80%、P95 不恶化 >10%。 |

### 13.4.2 演练脚本（示例）

**脚本 DR-SQL-01：主库故障 → 跨区只读副本提升**

1. **准备**：在 Staging 注入延迟 + 触发主库只读，确认监控报警；记录起始时间 `T0`。
2. **动作**：
   - DBA 执行 `promote` 脚本提升只读副本；
   - 更新连接串并逐步放量；
   - 业务 owner 验证查询/写入，回放删除队列与配额补偿任务。
3. **验收**：
   - 记录恢复时间 `T1`，计算 `T1 − T0` ≤30 min；
   - 数据差异 ≤RPO（≤5 min）；
   - 降级日志无缺失；
   - 事件单更新与截图上传到验收模板（见 13.4.3）。

**脚本 REL-ZD-01：零停机发布与快速回滚**

1. **准备**：产出 500 条契约样本；设置灰度比例 5%。
2. **动作**：
   - 发布至蓝环境 → 运行契约回放 → 成功后切 5% 流量；
   - 手工注入错误（如返回字段缺失），观察错误率 >0.1%；
   - 验证自动回滚触发，流量回到绿环境；
   - 重新运行契约回放确认恢复。
3. **验收**：
   - 整个过程用户请求无 5xx；
   - 回滚耗时 ≤5 分钟；
   - 监控记录在案，附带截图与日志哈希。

### 13.4.3 验收清单与记录模板

**必备验收项（抽样）**

| 编号  | 演练/验收项         | 通过条件                                                                 |
| ----- | ------------------ | ------------------------------------------------------------------------ |
| DR-01 | Doubao 熔断降级    | 手工将 5xx 提升 ≥5%；API 返回“基础释义 + 模板例句”并标 `degraded=true`；UI 显示“已降级”；降级请求不计再生成配额。 |
| DR-02 | RDBMS PITR         | 指定时间点恢复成功，RTO ≤30 min，RPO ≤5 min，删除日志回放完成。         |
| DR-03 | 跨区灾备切换       | 提升副本 ≤30 min，切流成功后当日 SLA ≥99.0%，次日 ≥99.9%。             |
| DR-04 | 导出链路           | `POST /exports` ≤5 s 返回一次性链接（TTL 10 分钟）；失败任务可重试。   |
| DR-05 | 零停机发布回滚     | 灰度错误率 >0.1% 时自动回滚；500 样本契约回放恢复后 100% 通过。         |
| DR-06 | 成本护栏演练       | 日预算 95% 演练：再生成禁用、强缓存命中率 ≥80%、P95 不恶化 >10%。       |

**验收记录模板（提交至变更/事件系统）**

| 字段               | 填写说明                                                                 |
| ------------------ | ------------------------------------------------------------------------ |
| 演练编号/日期      | 统一格式 `DR-YYYYMMDD-XX`；日期=执行日。                                  |
| 场景/脚本 ID       | 如 `DR-SQL-01`、`REL-ZD-01`。                                            |
| 负责人/参与人      | 含 SRE、应用、第三方；需留值班联系方式。                                  |
| 触发条件与起止时间 | 记录 T0/T1、切换耗时、影响范围。                                        |
| 指标测量结果       | SLA、RTO、RPO、降级成功率、P95 等数据 + 截图链接。                       |
| 回放/补偿步骤      | 删除队列、配额补偿、契约回放等执行情况。                                |
| 事件编号与结论     | 如影响线上则挂事件单；结论分“通过/需改进”。                              |
| 后续行动项         | 列出负责人与截止日期，闭环后在 13.5.2 更新状态。                         |

------

## 13.5 回溯机制

### 13.5.1 事件追踪与审计

- **日志与追踪**：所有可用性事件必须具备 trace_id、熔断状态、降级标识、切换命令哈希；日志留存 ≥180 天。
- **事件管理**：使用统一事件库（与第 14 章告警联动），事件状态包括 Open/Monitoring/Closed；事件编号需与 13.4 验收记录对应。
- **数据取证**：
  - SLA 计算底稿：保留原始探针/监控数据、排除维护窗口的证据；
  - RTO/RPO 证明：上传恢复耗时截图、数据差异对比结果；
  - 降级证据：抽样 3 条请求的响应体与 UI 截图。

### 13.5.2 复盘与责任闭环

| 步骤           | 内容                                                         | 截止时间 | 责任人 |
| -------------- | ------------------------------------------------------------ | -------- | ------ |
| 事件归档       | 在事件库补齐指标、影响、根因、恢复措施。                     | +1 工作日 | 值班 SRE |
| 复盘会议       | 跨团队评审，输出行动项（含依赖补强、脚本更新）。             | +5 工作日 | SRE/业务 owner |
| 行动项跟踪     | 在行动项看板登记，状态 ToDo/In Progress/Done；完成后更新 13.5.3。 | +10 工作日 | 行动项 owner |
| 报告发布       | 月度可用性报告 + 演练成果汇总，提交至 PMO 与高层。           | 次月 5 日 | PMO    |

### 13.5.3 行动项汇总（样例）

| 行动项 ID | 来源事件     | 描述                             | 负责人 | 截止日期 | 状态 |
| ---------- | -------------- | -------------------------------- | ------ | -------- | ---- |
| AI-2024-07 | DR-2024-07-02  | Doubao SDK 增加熔断重试延迟配置 | AI 团队 | 2024-07-20 | 进行中 |
| DB-2024-08 | DR-2024-07-03  | 增加跨区复制延迟自动化验证脚本   | DBA 团队 | 2024-08-05 | 待开始 |

> 交付说明：本章为实施与验收的唯一依据；涉及阈值或口径与 1–12 章冲突时，以更严格者为准。所有演练与实战记录均需引用本章条款编号，方便审计追溯。
