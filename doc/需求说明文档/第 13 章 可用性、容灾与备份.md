# 第 13 章 可用性、容灾与备份

> 目的：落实“关键接口 99.9% 月度可用、依赖异常自动降级、RTO/RPO 基线与定期演练”到可执行的体系与验收标准，作为业务连续性（BCP）的落地章节；本章约束与 1–12 章保持口径一致。可用性统计不包含事先公告的维护窗口。

------

## 13.1 目标与范围

- **目标**
  1. 关键接口月度可用性 ≥ 99.9%；2) 依赖异常 100% 自动降级为“基础释义 + 模板例句”；3) 历史与配置数据 RTO ≤ 30 分钟、RPO ≤ 5 分钟；导出任务 RTO ≤ 15 分钟；4) 零停机发布与快速回滚。
- **范围**
   覆盖边缘与网关、BFF/应用单体、LLM 适配层、RDBMS、Redis、对象存储、任务编排、第三方依赖（登录、支付、Doubao）以及降级与演练。架构基线采用“多可用区 + 模块化单体 + 独立基础设施服务”。
- **对齐关系**
   可用性与性能/配额/数据治理/订阅域规则相互约束：端到端 P95 ≤ 2.5 s、下载链接 TTL 10 分钟、逻辑删即时且 T+7 天物理清理、订阅/配额在 5 s 内一致。

------

## 13.2 指标与门槛（SLO/SLA 口径）

- **关键接口可用性（按月）**：`/lookup /regenerate /history /export` 成功率 ≥ 99.9%，维护窗口不计入；UI 需呈现降级标识。
- **端到端性能基线**：首个内容模块渲染完成 P95 ≤ 2.5 s、均值 ≤ 1.2 s，缓存命中时显著优于该值。
- **熔断与降级阈值**：第三方 5xx ≥ 5% 且持续 1 分钟触发；半开探测 3 次成功后恢复；降级结果以“基础释义 + 模板例句”返回并明示。
- **RTO/RPO**：历史与配置 RTO ≤ 30 min、RPO ≤ 5 min；导出 RTO ≤ 15 min。
- **配额与成本护栏对可用性的影响**：当全局预算 ≥95% 时关闭“再生成”，查词走强缓存与简化路径，保障可用先于质量。

------

## 13.3 高可用架构与冗余

> 采用**Active‑Active（无状态）+ Active‑Standby（有状态）**组合，按组件差异化设计冗余与切换策略。

### 13.3.1 拓扑层次

1. **多可用区（同区域 AZ）**：Web/H5、网关、BFF/应用、LLM 适配器横向扩展；RDBMS 主从/托管高可用；Redis 主从或哨兵/托管集群；对象存储多 AZ 冗余。
2. **跨区域（Warm‑Standby）**：RDBMS 异步只读副本、对象存储跨区域复制（CRR）、配置中心与审计日志异地归档；Redis 为缓存层，跨区仅作冷备与快速重建，不做强一致复制。

### 13.3.2 组件级策略

| 组件                   | HA/切换策略                          | 备注                                             |
| ---------------------- | ------------------------------------ | ------------------------------------------------ |
| API 网关/WAF/CDN       | 多实例+健康探测+权重切流             | 统一错误码与限流口径，观测起点一致。             |
| BFF/应用（模块化单体） | 无状态扩容，蓝绿/灰度发布，自动回滚  | 首屏渐进渲染不阻塞；Kill switch 支持。           |
| LLM 适配层（Doubao）   | 熔断/半开/恢复；降级回退             | 失败走“基础释义+模板例句”，UI 明示退化。         |
| RDBMS（PostgreSQL）    | 同区主从/托管 HA；跨区只读副本；PITR | 索引与分区策略支撑历史与导出；备份/恢复见 13.5。 |
| Redis                  | 主从/集群；AOF/RDB 快照；失效重建    | L1/L2 TTL：10/30 分钟；跨区重建而非回放。        |
| 对象存储               | 多 AZ 与版本化；一次性下载链接       | 导出链接 TTL 10 分钟；CRR 与生命周期策略。       |
| 任务编排               | 幂等任务与重试；死信/重放            | 导出≤5 s 回执；物理清理 T+7 天。                 |
| 登录/支付              | 回调优先、轮询兜底、幂等更新         | 权益 ≤5 s 同步到配额域。                         |

------

## 13.4 故障域与失效模式

- **第三方依赖**：Doubao 超时/5xx、登录/支付回调卡顿。动作：熔断降级、幂等轮询兜底。
- **存储类**：RDBMS 主库故障、Redis 节点丢失、对象存储临时不可用。动作：主从提升、缓存重建、导出延期。
- **网络与边缘**：单 AZ/单机房网络劣化、网关策略误配。动作：权重切流与快速回滚。
- **应用侧**：契约解析失败、发布事故。动作：契约回放≥500 样本、自动回滚。

------

## 13.5 灾难恢复（DR）策略与切换流程

### 13.5.1 RTO/RPO 分解（按域）

| 数据/域                                  | RTO     | RPO    | 说明                                                  |
| ---------------------------------------- | ------- | ------ | ----------------------------------------------------- |
| 历史与配置（`lookups/results/profiles`） | ≤30 min | ≤5 min | 逻辑删即时可见，物理清理 T+7 天；恢复后重放删除队列。 |
| 导出任务与回执                           | ≤15 min | N/A    | 失败可重试；下载链接 10 分钟有效。                    |
| 订阅/订单/账单                           | ≤30 min | ≤5 min | 权益同步 ≤5 s；账单留存年限遵从订阅域。               |
| Redis 缓存/配额计数                      | ≤10 min | 可丢失 | 视作可重建；命中率 KPI 单独监控。                     |

### 13.5.2 备份与复制

- **RDBMS**：
  - **同区**：同步复制（托管 HA 或同步 Standby）+ 每日全量 + 15 分钟增量/WAL；启用 PITR。
  - **跨区**：异步只读副本（延迟报警阈值可配，默认 30 s）；每 24 h 校验校验和与基线快照。
- **对象存储**：版本化与跨区域复制；导出产物生命周期 24–48 h（与回执审计分离）。
- **Redis**：开启 AOF 每秒刷盘与 RDB 每 6 h 快照；跨区不做热备，按脚本重建键空间（L1/L2 缓存允许冷启动）。

### 13.5.3 切换流程（示意）

1. 检测到灾难 → 2) 进入事件指挥（IM）→ 3) 依据域别判定“同区容错/跨区切换”→ 4) 提升只读副本为主、重新指向写流量 → 5) 恢复 Redis 与任务编排 → 6) 回放“逻辑删除/配额/订阅”补偿 → 7) 放量与复盘。（配额与订阅补偿事件由权益域触发，5 s 内最终一致。）

------

## 13.6 备份与恢复（B&R）制度

- **备份策略**
  - RDBMS：每日全量、小时级增量/WAL；保留 7 日（日备）+ 4 周（周备）+ 3 月（月备）；加密存储与访问审计。
  - 对象存储：开启版本化与回收站策略；删除请求在 T+7 天窗口内可恢复。
  - 配置与密钥：配置中心定时快照；密钥仅存密管服务，备份为密封副本且轮转 ≥90 天。
- **恢复演练**
  - 每月抽样“PITR 到指定时间点（近 24 h）”与“跨区副本提升”双场景演练；必须在演练报告留痕与可回放。
- **恢复强制步骤**
  - 用户触发删除遵循“逻辑删即时、物理清理 T+7 天”的统一语义；每次数据库或对象存储恢复后，必须回放删除日志/队列，验证上述语义，避免复活已删除数据（与本章 13.11「删除语义一致」保持一致）。

------

## 13.7 降级与业务连续性（BCP）

- **降级内容**：当 Doubao 不可用或被熔断时返回“基础释义 + 模板例句”，并以 `degraded=true` 标注；UI 显示“已降级”。
- **计量口径**：降级请求**不消耗再生成配额**；查词仍计 1 次业务配额（缓存命中同理计 1 次，成本记 0）。
- **预算护栏联动**：当成本燃率超阈，统一启用强缓存与条数/详略自动降一档，优先保障可用性与端到端 P95。

------

## 13.8 监控、演练与告警（与第 14 章对齐）

- **必备 SLI**：可用性、P95 延迟、错误率、熔断状态、L1/L2 命中率、RDBMS 复制延迟、对象存储 CRR 延迟、导出回执时延、成本燃率。阈值与看板口径沿用 NFR 与成本章。
- **合成探针**：`/lookup` 正常与降级两条线路的黑盒探测，5 分钟窗口滚动汇总。
- **演练频率**：
  - 月度：熔断降级演练、导出链路回执 ≤5 s 验收。
  - 季度：跨区故障切换桌面演练 + 随机 PITR。
- **告警抑制**：基于阈值+速率+静默，避免风暴；错误预算消耗日报。

------

## 13.9 维护窗口与发布

- **零停机发布**：蓝绿/小流量灰度，契约回放≥500 样本通过；失败自动回滚。
- **维护窗口**：仅限基础设施变更；需提前公告，窗口内的可用性不计入 SLO 统计。

------

## 13.10 运行手册（Runbook）要点（节选）

| 场景              | 判定阈值         | 首要动作                                   | 60 分钟内恢复目标                              |
| ----------------- | ---------------- | ------------------------------------------ | ---------------------------------------------- |
| Doubao 大面积失败 | 5xx≥5% 且 1 分钟 | 触发熔断，启用降级；记录 `degraded`        | 降级可用率≥99.9%，P95≤1.2 s（缓存优先）        |
| RDBMS 主库故障    | 主从失联或写失败 | 提升同步从库为主；更新连接串；锁定写入窗口 | RTO≤30 min，RPO≤5 min；回放删除日志            |
| Redis 集群降级    | 主从漂移/不可用  | 切换主从或重建；开启“缓存旁路 + 强 L2”     | 首屏可用，命中率逐步恢复（告警不超过 10 分钟） |
| 跨区故障          | 区域健康探针失败 | 切换到 Warm‑Standby；降级开关全开          | 关键接口可用性恢复≥99.0% 当日，次日≥99.9%      |
| 成本燃率失控      | 日预算≥95%       | 禁用再生成、加倍 TTL、简化路径             | 服务可用，端到端 P95 不恶化>10%                |

------

## 13.11 合规与数据治理衔接

- **最小留存与脱敏**：日志与导出遵循“下载链接一次性且 TTL 10 分钟、导出脱敏”；审计不可篡改与归档。
- **删除语义一致**：逻辑删除即时，物理清理 T+7 天；备份恢复后重放删除队列确保一致。
- **订阅/账单**：权益下发与配额 5 s 内一致；支付丢回调由轮询对账兜底。

------

## 13.12 与其他章节的依赖映射

- 与**NFR 章**的门槛一致（NFR‑002/017/040 等）；与**架构 章**的熔断、缓存与部署策略对齐；与**接口契约**的降级标识与错误模型一致；与**数据模型**的留存与物理清理一致；与**配额/成本**的强缓存与预算护栏协同；与**订阅/计费**的权益同步时延一致。

------

## 13.13 验收清单（抽样）

| 编号  | 验收项       | 通过条件                                                     |
| ----- | ------------ | ------------------------------------------------------------ |
| DR‑01 | 熔断降级演练 | 人为拉高 Doubao 5xx，UI 出现“已降级”，日志记录熔断/半开/恢复；降级请求不计入再生成配额。 |
| DR‑02 | RDBMS PITR   | 指定时间点恢复成功，业务读写恢复，RPO ≤ 5 min；删除队列回放完成。 |
| DR‑03 | 跨区切换     | 将只读副本提升为主，流量切换完成 ≤ 30 min，关键接口可用性恢复≥99.0%。 |
| DR‑04 | 导出链路     | POST /exports 后 ≤ 5 s 返回回执与一次性下载链接（TTL 10 分钟）；过期自动失效。 |
| DR‑05 | 发布回滚     | 契约回放≥500 样本通过；灰度失败自动回滚，零停机。            |
| DR‑06 | 成本护栏     | 日预算 95% 演练：再生成被禁、强缓存生效、端到端 P95 不恶化 >10%。 |

------

## 13.14 目录与交付位置

- 本章在整体文档结构中位于第 13 节“可用性、容灾与备份”，与第 14 章“可观测性与运维（SLO/SLA）”相邻，按《目录》中的位置接受联检。

------

> 交付说明：本章为实施与验收的唯一依据；涉及阈值或口径与 1–12 章冲突时，以更严格者为准。