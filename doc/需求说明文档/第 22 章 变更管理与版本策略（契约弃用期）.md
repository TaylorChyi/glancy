# 第 22 章 变更管理与版本策略（契约弃用期）

> 本章给出 Glancy 在 MVP 及后续阶段对“契约优先、零停机发布、灰度与回滚、弃用期与清退”的统一制度、流程与度量，覆盖 API/Schema、数据模型、配置项与用户可见行为。与既有“语义化契约 `glancy.dict.v1`/`glancy.billing.v1`、/api/v1、Sunset 头、契约回放≥500 样本、零停机与灰度回滚”等约束保持一致。

> 索引提示：目录已为本章预留“22. 变更管理与版本策略（契约弃用期）”。

------

## 22.1 目标与适用范围

- **目标**：以最小风险交付变更，确保**契约稳定**、**无感升级**与**可回退**，并对不兼容变更提供明确**弃用期与迁移路径**。
- **适用范围**：
  1. 外部 API 与前后端契约（`/api/v1`、`Accept: application/vnd.glancy.dict.v1+json`）；
  2. 内部适配契约（Doubao 适配层）；
  3. 数据模型与迁移；
  4. 配额/限流、下载链接 TTL、错误模型等**统一口径**项；
  5. 订阅/计费域契约（`glancy.billing.v1`）。

------

## 22.2 原则（与上位约束对齐）

1. **契约优先**：所有对内/对外消息遵循结构化契约，默认 `glancy.dict.v1`；不兼容升级发布新 MAJOR 并走弃用期。
2. **零停机发布与可回滚**：支持灰度、契约回放（≥500 样本）、自动回滚。
3. **SSoT**：订阅矩阵、权益与相关阈值以订阅章为**单一事实源**，其他章节仅引用。
4. **最小影响**：优先采用向后兼容（Additive）策略；非兼容变更必须给出迁移与双写方案。
5. **统一信号与可观测**：所有变更贯穿 `trace_id`，纳入发布门禁与 SLO。

------

## 22.3 变更对象列表

| 类别       | 变更对象                                                     | 说明                                                  |
| ---------- | ------------------------------------------------------------ | ----------------------------------------------------- |
| API/Schema | `/api/v1` 路由、请求/响应字段、错误码、限流与配额回传头（X‑RateLimit/X‑Quota）；`Accept: application/vnd.glancy.dict.v1+json` | 非兼容升至 `glancy.dict.v2`，旧版响应附 `Sunset` 头。 |
| 内部适配   | Doubao 适配请求/响应骨架、降级信号 `degraded` 与成本计量     | 对上保持 `DictResult` 稳定输出。                      |
| 数据模型   | DDL/索引/幂等键/留存口径/清理编排                            | 大表变更走分批迁移与异步回填。                        |
| 统一口径   | 配额/限流（429 模型）、下载链接 TTL=10 分钟、逻辑删除 + T+7 天物理清理 | 作为跨域“共同语义”，变更须统一生效点。                |
| 订阅域     | `glancy.billing.v1` 契约、状态机与权益映射                   | 权益→配额在 ≤5 s 内同步。                             |

------

## 22.4 版本策略（契约命名与增量规则）

### 22.4.1 契约命名

- **主契约**：`glancy.dict.v{MAJOR}`，当前为 `v1`；内容协商优先使用 `Accept: application/vnd.glancy.dict.v1+json`。
- **计费契约**：`glancy.billing.v{MAJOR}`，当前为 `v1`。

### 22.4.2 兼容性分级

| 级别                     | 示例                                                         | 策略                                                         |
| ------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **非兼容（MAJOR）**      | 字段移除/重命名、必填新增、语义/单位改变、错误码语义改变     | 发布 `v{MAJOR+1}`，旧版进入弃用期；必须提供迁移指南与回放样本≥500。 |
| **向后兼容（Additive）** | 可选字段新增、枚举追加取值、新增端点、不影响默认行为的头/字段 | 仍属 `v1`；通过特性开关与灰度放量。                          |
| **实现变更（透明）**     | 性能优化、内部字段重排、缓存/限流参数调整（口径不变）        | 不变更契约；仅发布说明与观测对齐。                           |

### 22.4.3 `glancy.dict` 版本时间线与支持策略

| 时点                   | 版本状态                               | 支持与动作                                                                 |
| ---------------------- | -------------------------------------- | -------------------------------------------------------------------------- |
| 2024-09（MVP 发布）    | `glancy.dict.v1` GA，冻结 Breaking 变更 | 建立 Schema Registry 条目；所有客户端默认 `Accept: application/vnd.glancy.dict.v1+json`。 |
| 2025-03（Feature Pack）| `glancy.dict.v1` Additive 增量          | 仅新增可选字段；回放样本扩大至新字段；文档同步。                                           |
| 2025-06（Preview）     | `glancy.dict.v2` Beta 公测             | 提供并行 `/api/v1` 输出 `contract: glancy.dict.v2`（需 `Accept` 头协商）；收集客户端兼容性反馈。 |
| 2025-09（GA & Sunset） | `glancy.dict.v2` GA，`v1` 宣布弃用      | 发布弃用公告，启动 90 天 Sunset；`v1` 响应加入 `Sunset` 与 `Link rel="deprecation"`。      |
| 2025-12（清退）        | `glancy.dict.v1` 退役                  | 执行“棕断”→`410 Gone / CONTRACT_RETIRED`；完成代码与样本归档。                               |

> 任何新的 MAJOR 版本必须沿用上述节奏：**Beta ≥90 天 + Sunset ≥90 天**，期间保持 v1/v2 双轨输出与回滚能力。

------

## 22.5 弃用期（Deprecation & Sunset）政策

### 22.5.1 标准时长

- **标准弃用期**：**90 天**（自然日），适用于外部 API/Schema 的非兼容变更；到期后可清退旧版。
- **内部适配/数据层**：**30–60 天**，视影响面确定；必须完成双写与校验窗口。
- **紧急合规/安全修补**：允许缩短至 **0–14 天**，需记录风险评估与批准。
   以上策略与“零停机、灰度回滚、契约回放”共同执行。

### 22.5.2 对客户端的信号

- 在旧版响应统一输出：
   `Sunset: <ISO8601>`；`Link: <https://.../deprecation-notes>; rel="deprecation"`；保留 `schemaVersion: "glancy.dict.v1"` 字段。
   当进入末期“棕断（brown‑out）”窗口，按发布计划对旧版进行短时限流或返回可恢复错误提示，帮助暴露隐患。旧版最终清退时返回 `410 Gone` 与错误码 `CONTRACT_RETIRED`。

### 22.5.3 弃用公告周期

1. **D-90（宣布）**：发布《弃用与迁移公告》，更新接口文档、SDK Release Note 与管理后台公告；对重点客户启动 1:1 沟通。
2. **D-60（提醒）**：复核迁移进度；在旧版响应中加入 `Warning` 头与日志侧告警；产品运营推送站内信/邮件。
3. **D-30（棕断预告）**：公布棕断演练时间，要求客户端在演练前验证容错；技术支持准备迁移 FAQ。
4. **D-7（棕断执行）**：执行 30 分钟限流或错误注入演练，记录未兼容客户端名单并跟进整改。
5. **D（切换日）**：执行最终切换，返回 `410 Gone`；发布复盘与影响说明。

> 所有公告材料须关联 RFC 与 Trace ID，确保可追溯与审计。

------

## 22.6 变更流程（RFC→评审→实现→灰度→清退）

> 与第 21 章发布与灰度策略联动，这里给出跨域的强制步骤与门禁。关键环节依赖“契约回放≥500 样本”。

1. **起案（RFC）**
   - 填写《变更 RFC 模板》（见 22.12），列出对象、影响面、是否 MAJOR、拟定 Sunset。
   - 标注是否触及 SSoT（订阅矩阵、限流/配额口径、删除语义、TTL）。
2. **影响分析与评审**
   - 对齐 FR/NFR/UC 追溯与验收策略；评审是否需双写/回放/灰度参数。
3. **契约与样本**
   - 更新 Schema Registry 的 JSON Schema；补充/更新 ≥500 条契约回放样本进入 CI。
4. **实现与双写**
   - DB：先加列/新表→双写→异步回填→读路径切换→老列下线。
   - API：新增 `v2` 端点与聚合 BFF，保持 `v1` 并行输出。
5. **灰度与观测**
   - 5%→25%→50%→100% 流量分阶段；看板观察 P95/错误率/429/成本燃率与缓存命中率。异常自动回滚。
6. **弃用期运行**
   - 立即在 `v1` 响应附 `Sunset`；第 30/60/85 天触发告警与“棕断”演练。
7. **清退与收尾**
   - 到期统一切断旧版：返回 `410 Gone / CONTRACT_RETIRED`；清理老字段与代码路径，归档契约与样本。

------

## 22.7 变更类型矩阵（判定与要求）

| 编号  | 变更类型                   | 兼容性 | 必备动作                                  |
| ----- | -------------------------- | ------ | ----------------------------------------- |
| CT‑01 | 新增可选字段               | 兼容   | Schema 增量、Mock/回放更新、灰度最小 1 天 |
| CT‑02 | 新增端点                   | 兼容   | 文档/SDK 增量、AB 灰度                    |
| CT‑03 | 改变默认值但可通过参数恢复 | 边界   | 开关保护 + 7 天灰度 + 回放对比            |
| CT‑04 | 枚举删除/重命名            | 非兼容 | 发布 v2、Sunset≥90 天、迁移指引           |
| CT‑05 | 字段移除/必填新增/语义更改 | 非兼容 | 发布 v2、双写/双读、Sunset≥90 天          |
| CT‑06 | 错误码/状态码语义改变      | 非兼容 | 码表变更公告、v2 输出、Sunset≥90 天       |
| CT‑07 | 配额/限流口径改变          | 边界   | 与第 10 章一致化，公告与灰度验证 14 天    |
| CT‑08 | TTL/删除语义变更           | 非兼容 | 与第 8 章/第 9 章统一回溯与迁移           |

------

## 22.8 契约回放、样本与门禁

- **样本要求**：每次发布前 ≥**500** 条回放样本通过（100%），覆盖主路径与错误路径。CI 失败即阻断发布。
- **回放来源**：真实脱敏请求、边界构造样本、历史错误回归集。
- **对比维度**：结构完整性（必填字段）、字段预算（详略级别字符上限）、错误码/头一致、`schemaVersion` 常量值。

------

## 22.9 数据库与数据迁移策略

- **先加后删**：新增列/表优先，不覆盖旧数据；大表默认值采用异步回填避免写放大。
- **双写/双读**：在迁移窗口内保持新旧列一致；读路径优先新列，回退时切回旧列。
- **清退顺序**：读切换稳定≥7 天→停止双写≥7 天→删除旧列。流程由编排表追踪与审计。

------

## 22.10 对外信号与错误模型扩展

- **弃用期头**：`Sunset` + `Link rel="deprecation"` 作为统一信号（旧版响应仍返回 `schemaVersion` 字段）。
- **新增错误码**：
  - `410 / CONTRACT_RETIRED`：旧版契约到期清退；
  - `406 / NOT_ACCEPTABLE`：不支持的 `Accept` vendor；与 8.1 内容协商一致。

------

## 22.11 角色、职责与沟通

| 角色             | 责任                                            |
| ---------------- | ----------------------------------------------- |
| 产品与架构评审会 | MAJOR 变更准入、Sunset 时长裁定、跨章口径一致性 |
| 后端负责人       | 契约实现、双写/回放、灰度与回滚编排             |
| 前端负责人       | 版本切流、兼容层与 UI 文案                      |
| 数据负责人       | DDL 方案、数据质量与回填计划                    |
| 运维与合规       | 看板与告警、审计与公告归档                      |

> RBAC 与后台审计遵循“最小权限 + 操作留痕”。

------

## 22.12 模板与示例

### 22.12.1《变更 RFC 模板》（摘录）

- 背景与动机（引用 FR/UC/NFR/SSoT）
- 变更对象（API/Schema/数据/配额/错误码）
- 兼容性判定（CT‑XX）与 Sunset 建议
- 契约差异（Before/After JSON 示例）
- 灰度与回滚计划（比例与判停阈值）
- 回放样本覆盖与门禁
- 迁移指引与风险评估

### 22.12.2《弃用与迁移公告模板》

```
Title: [Deprecation Notice] glancy.dict.v1 → v2
Scope: /api/v1/lookup, /api/v1/lookup/{id}
Sunset: 2026-01-31T00:00:00Z
Change: <要点>
Impact: <客户端需改动>
Action: 请在 Sunset 前切换 Accept: application/vnd.glancy.dict.v2+json
Brown-outs: D+30, D+60, D+85 各 30 分钟演练
Contact: <Owner/Trace>
```

> 公告须同步到接口文档与管理后台，旧版响应在 Sunset 期间附头部信号。

------

## 22.13 验收与度量（与第 20 章联动）

- **门禁 A**：契约回放 ≥500，**通过率 100%**。
- **门禁 B**：灰度 24–72 小时内 P95、错误率、429 命中率、成本燃率与缓存命中率均未恶化；否则自动回滚。
- **门禁 C**：弃用期信号与文档就绪（Sunset/Link、迁移指南、公告归档）。

------

## 22.14 与相关章节的约束对齐

- **契约与语义化版本**：7.1、7.8、8.2、8.12 明确“契约优先、`glancy.dict.v1`、不兼容走弃用期并升级 MAJOR”。
- **性能与运维门槛**：NFR‑009、NFR‑027、NFR‑030 要求“零停机发布、三类可观测、契约回放”。
- **统一口径**：限流/配额与下载 TTL、删除语义由第 8、9、10、11 章集中定义，本章仅**引用**不复制。
- **范围变更**：新增语言对/输入形态/模块能力等“范围扩大”必须走本章流程（2.8）。

------

## 22.15 `/exports` 变更兼容策略与迁移指导

- **场景**：`/exports` 提供批量导出结果文件，遵循 `glancy.dict.v{MAJOR}` 契约返回导出进度、下载链接与错误摘要。
- **兼容策略**：
  1. **Additive 变更优先**：新增可选字段（如 `checksum`、`expires_at`）时保持默认行为不变，并在响应 `meta.compatibility` 中标记新增字段列表，客户端未识别字段须忽略。
  2. **语义变更防护**：若需调整导出状态枚举或下载地址口径，先在 `v1` 中增加新枚举值/字段，并保持旧值 90 天；通过特性开关灰度新语义。
  3. **MAJOR 升级路径**：无法兼容时发布 `glancy.dict.v2` 导出响应，通过内容协商提供并行响应体；`/exports` 请求头必须接受 `Accept: application/vnd.glancy.dict.v2+json` 才返回新格式。
- **迁移指导**：
  1. 客户端需实现**容错解析**：忽略未知字段、按文档读取 `contract` 标识选择解析器。
  2. 在 Sunset 期间更新 SDK/客户端，使其自动根据 `Sunset` 头提示迁移；测试环境需启用 `?contract=preview` 查询参数验证 `v2` 响应。
  3. 若客户端依赖导出文件结构，必须完成端到端回归，包括下载链接有效期、签名策略、压缩格式等；必要时双写导出作业（旧版与新版各生成一份）供对比。
  4. 发布当日按公告节奏执行棕断；未升级客户端在棕断窗口收到 `429` 或 `Warning` 提示，帮助提前暴露问题。

> `/exports` 相关的发布说明与回滚方案应纳入第 21 章发布灰度计划，并在 Schema Registry 中维护历次版本的 JSON Schema 与样本。

## 22.16 Deprecation 日历与提前量管理

| 时间窗口 | 契约/功能 | 里程碑 | 提前量（相对于切换日） | 联动动作 |
| -------- | ---------- | ------ | ---------------------- | ---------- |
| 2024-Q4 | `glancy.dict.v1` GA 稳定期 | 维持 v1 SLO、补充样本 ≥500 条 | — | 21.17 发布周报、合规归档 |
| 2025-03 | Feature Pack（Additive） | 发布增量字段；保持双写 30 天 | D-90 公告（预告潜在 v2） | 21.4 Step 2 订阅验收、20.6 表更新测试用例 |
| 2025-06 | `glancy.dict.v2` Beta | 开启并行响应（需 `Accept` 头） | D-120 Beta 邀请 | 21.4 Step 1 内测 + 22.6 RFC 审批 |
| 2025-09 | `glancy.dict.v2` GA & `v1` Sunset 宣布 | 发布正式版，Sunset=2025-12-31 | D-90 正式公告 | 21.17 Release Notes + 22.12 公告模板 |
| 2025-12 | `glancy.dict.v1` 退役 | 执行棕断→410 清退 | D-30 棕断预告、D-7 演练 | 21.6 回滚剧本演练、22.6 清退步骤 |
| 滚动项 | `/exports` 结构调整 | 若涉及枚举/字段弃用，纳入 v2 轨道 | D-120 提前向重点客户沟通 | 20.6 UC‑06 测试、21.4 Step 3 放量 |

- **提前量策略**：所有非兼容变更必须 ≥90 天 Sunset；若需缩短（安全/合规），须在 RFC 中写明批准人并提供替代方案。
- **日历维护**：由产品/发布管理员在 Confluence 与发布档案同步更新，每周例会审阅；若变更发布日期，需重新计算 D-90/D-60/D-30/D-7 节点并在 21.17 公告模板中体现。
- **提醒机制**：CI 任务 `deprecation-calendar check` 每日校验下一次 Sunset 与公告发送状态，未满足提前量时阻断合并并提示相关负责人。

------

### 本章交付物清单

- 《变更 RFC 模板》《弃用与迁移公告模板》
- Schema 与样本回放清单（≥500 条）
- 灰度编排参数与回滚手册
- Sunset 日历与“棕断”演练计划

> 以上流程与策略为“强约束”。若需突破，必须在 RFC 中明确风险、替代方案与批准人，并在发布后 48 小时内提交复盘与制度更新建议。