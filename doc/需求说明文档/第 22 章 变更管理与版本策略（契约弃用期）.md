# 第 22 章 变更管理与版本策略（契约弃用期）

> 本章给出 Glancy 在 MVP 及后续阶段对“契约优先、零停机发布、灰度与回滚、弃用期与清退”的统一制度、流程与度量，覆盖 API/Schema、数据模型、配置项与用户可见行为。与既有“语义化契约 `glancy.dict.v1`/`glancy.billing.v1`、/api/v1、Sunset 头、契约回放≥500 样本、零停机与灰度回滚”等约束保持一致。

> 索引提示：目录已为本章预留“22. 变更管理与版本策略（契约弃用期）”。

------

## 22.1 目标与适用范围

- **目标**：以最小风险交付变更，确保**契约稳定**、**无感升级**与**可回退**，并对不兼容变更提供明确**弃用期与迁移路径**。
- **适用范围**：
  1. 外部 API 与前后端契约（`/api/v1`、`Accept: application/vnd.glancy.dict.v1+json`）；
  2. 内部适配契约（Doubao 适配层）；
  3. 数据模型与迁移；
  4. 配额/限流、下载链接 TTL、错误模型等**统一口径**项；
  5. 订阅/计费域契约（`glancy.billing.v1`）。

------

## 22.2 原则（与上位约束对齐）

1. **契约优先**：所有对内/对外消息遵循结构化契约，默认 `glancy.dict.v1`；不兼容升级发布新 MAJOR 并走弃用期。
2. **零停机发布与可回滚**：支持灰度、契约回放（≥500 样本）、自动回滚。
3. **SSoT**：订阅矩阵、权益与相关阈值以订阅章为**单一事实源**，其他章节仅引用。
4. **最小影响**：优先采用向后兼容（Additive）策略；非兼容变更必须给出迁移与双写方案。
5. **统一信号与可观测**：所有变更贯穿 `trace_id`，纳入发布门禁与 SLO。

------

## 22.3 变更对象列表

| 类别       | 变更对象                                                     | 说明                                                  |
| ---------- | ------------------------------------------------------------ | ----------------------------------------------------- |
| API/Schema | `/api/v1` 路由、请求/响应字段、错误码、限流与配额回传头（X‑RateLimit/X‑Quota）；`Accept: application/vnd.glancy.dict.v1+json` | 非兼容升至 `glancy.dict.v2`，旧版响应附 `Sunset` 头。 |
| 内部适配   | Doubao 适配请求/响应骨架、降级信号 `degraded` 与成本计量     | 对上保持 `DictResult` 稳定输出。                      |
| 数据模型   | DDL/索引/幂等键/留存口径/清理编排                            | 大表变更走分批迁移与异步回填。                        |
| 统一口径   | 配额/限流（429 模型）、下载链接 TTL=10 分钟、逻辑删除 + T+7 天物理清理 | 作为跨域“共同语义”，变更须统一生效点。                |
| 订阅域     | `glancy.billing.v1` 契约、状态机与权益映射                   | 权益→配额在 ≤5 s 内同步。                             |

------

## 22.4 版本策略（契约命名与增量规则）

### 22.4.1 契约命名

- **主契约**：`glancy.dict.v{MAJOR}`，当前为 `v1`；内容协商优先使用 `Accept: application/vnd.glancy.dict.v1+json`。
- **计费契约**：`glancy.billing.v{MAJOR}`，当前为 `v1`。

### 22.4.2 兼容性分级

| 级别                     | 示例                                                         | 策略                                                         |
| ------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **非兼容（MAJOR）**      | 字段移除/重命名、必填新增、语义/单位改变、错误码语义改变     | 发布 `v{MAJOR+1}`，旧版进入弃用期；必须提供迁移指南与回放样本≥500。 |
| **向后兼容（Additive）** | 可选字段新增、枚举追加取值、新增端点、不影响默认行为的头/字段 | 仍属 `v1`；通过特性开关与灰度放量。                          |
| **实现变更（透明）**     | 性能优化、内部字段重排、缓存/限流参数调整（口径不变）        | 不变更契约；仅发布说明与观测对齐。                           |

------

## 22.5 弃用期（Deprecation & Sunset）政策

### 22.5.1 标准时长

- **标准弃用期**：**90 天**（自然日），适用于外部 API/Schema 的非兼容变更；到期后可清退旧版。
- **内部适配/数据层**：**30–60 天**，视影响面确定；必须完成双写与校验窗口。
- **紧急合规/安全修补**：允许缩短至 **0–14 天**，需记录风险评估与批准。
   以上策略与“零停机、灰度回滚、契约回放”共同执行。

### 22.5.2 对客户端的信号

- 在旧版响应统一输出：
   `Sunset: <ISO8601>`；`Link: <https://.../deprecation-notes>; rel="deprecation"`；保留 `schemaVersion: "glancy.dict.v1"` 字段。
   当进入末期“棕断（brown‑out）”窗口，按发布计划对旧版进行短时限流或返回可恢复错误提示，帮助暴露隐患。旧版最终清退时返回 `410 Gone` 与错误码 `CONTRACT_RETIRED`。

------

## 22.6 变更流程（RFC→评审→实现→灰度→清退）

> 与第 21 章发布与灰度策略联动，这里给出跨域的强制步骤与门禁。关键环节依赖“契约回放≥500 样本”。

1. **起案（RFC）**
   - 填写《变更 RFC 模板》（见 22.12），列出对象、影响面、是否 MAJOR、拟定 Sunset。
   - 标注是否触及 SSoT（订阅矩阵、限流/配额口径、删除语义、TTL）。
2. **影响分析与评审**
   - 对齐 FR/NFR/UC 追溯与验收策略；评审是否需双写/回放/灰度参数。
3. **契约与样本**
   - 更新 Schema Registry 的 JSON Schema；补充/更新 ≥500 条契约回放样本进入 CI。
4. **实现与双写**
   - DB：先加列/新表→双写→异步回填→读路径切换→老列下线。
   - API：新增 `v2` 端点与聚合 BFF，保持 `v1` 并行输出。
5. **灰度与观测**
   - 5%→25%→50%→100% 流量分阶段；看板观察 P95/错误率/429/成本燃率与缓存命中率。异常自动回滚。
6. **弃用期运行**
   - 立即在 `v1` 响应附 `Sunset`；第 30/60/85 天触发告警与“棕断”演练。
7. **清退与收尾**
   - 到期统一切断旧版：返回 `410 Gone / CONTRACT_RETIRED`；清理老字段与代码路径，归档契约与样本。

------

## 22.7 变更类型矩阵（判定与要求）

| 编号  | 变更类型                   | 兼容性 | 必备动作                                  |
| ----- | -------------------------- | ------ | ----------------------------------------- |
| CT‑01 | 新增可选字段               | 兼容   | Schema 增量、Mock/回放更新、灰度最小 1 天 |
| CT‑02 | 新增端点                   | 兼容   | 文档/SDK 增量、AB 灰度                    |
| CT‑03 | 改变默认值但可通过参数恢复 | 边界   | 开关保护 + 7 天灰度 + 回放对比            |
| CT‑04 | 枚举删除/重命名            | 非兼容 | 发布 v2、Sunset≥90 天、迁移指引           |
| CT‑05 | 字段移除/必填新增/语义更改 | 非兼容 | 发布 v2、双写/双读、Sunset≥90 天          |
| CT‑06 | 错误码/状态码语义改变      | 非兼容 | 码表变更公告、v2 输出、Sunset≥90 天       |
| CT‑07 | 配额/限流口径改变          | 边界   | 与第 10 章一致化，公告与灰度验证 14 天    |
| CT‑08 | TTL/删除语义变更           | 非兼容 | 与第 8 章/第 9 章统一回溯与迁移           |

------

## 22.8 契约回放、样本与门禁

- **样本要求**：每次发布前 ≥**500** 条回放样本通过（100%），覆盖主路径与错误路径。CI 失败即阻断发布。
- **回放来源**：真实脱敏请求、边界构造样本、历史错误回归集。
- **对比维度**：结构完整性（必填字段）、字段预算（详略级别字符上限）、错误码/头一致、`schemaVersion` 常量值。

------

## 22.9 数据库与数据迁移策略

- **先加后删**：新增列/表优先，不覆盖旧数据；大表默认值采用异步回填避免写放大。
- **双写/双读**：在迁移窗口内保持新旧列一致；读路径优先新列，回退时切回旧列。
- **清退顺序**：读切换稳定≥7 天→停止双写≥7 天→删除旧列。流程由编排表追踪与审计。

------

## 22.10 对外信号与错误模型扩展

- **弃用期头**：`Sunset` + `Link rel="deprecation"` 作为统一信号（旧版响应仍返回 `schemaVersion` 字段）。
- **新增错误码**：
  - `410 / CONTRACT_RETIRED`：旧版契约到期清退；
  - `406 / NOT_ACCEPTABLE`：不支持的 `Accept` vendor；与 8.1 内容协商一致。

------

## 22.11 角色、职责与沟通

| 角色             | 责任                                            |
| ---------------- | ----------------------------------------------- |
| 产品与架构评审会 | MAJOR 变更准入、Sunset 时长裁定、跨章口径一致性 |
| 后端负责人       | 契约实现、双写/回放、灰度与回滚编排             |
| 前端负责人       | 版本切流、兼容层与 UI 文案                      |
| 数据负责人       | DDL 方案、数据质量与回填计划                    |
| 运维与合规       | 看板与告警、审计与公告归档                      |

> RBAC 与后台审计遵循“最小权限 + 操作留痕”。

------

## 22.12 模板与示例

### 22.12.1《变更 RFC 模板》（摘录）

- 背景与动机（引用 FR/UC/NFR/SSoT）
- 变更对象（API/Schema/数据/配额/错误码）
- 兼容性判定（CT‑XX）与 Sunset 建议
- 契约差异（Before/After JSON 示例）
- 灰度与回滚计划（比例与判停阈值）
- 回放样本覆盖与门禁
- 迁移指引与风险评估

### 22.12.2《弃用与迁移公告模板》

```
Title: [Deprecation Notice] glancy.dict.v1 → v2
Scope: /api/v1/lookup, /api/v1/lookup/{id}
Sunset: 2026-01-31T00:00:00Z
Change: <要点>
Impact: <客户端需改动>
Action: 请在 Sunset 前切换 Accept: application/vnd.glancy.dict.v2+json
Brown-outs: D+30, D+60, D+85 各 30 分钟演练
Contact: <Owner/Trace>
```

> 公告须同步到接口文档与管理后台，旧版响应在 Sunset 期间附头部信号。

------

## 22.13 验收与度量（与第 20 章联动）

- **门禁 A**：契约回放 ≥500，**通过率 100%**。
- **门禁 B**：灰度 24–72 小时内 P95、错误率、429 命中率、成本燃率与缓存命中率均未恶化；否则自动回滚。
- **门禁 C**：弃用期信号与文档就绪（Sunset/Link、迁移指南、公告归档）。

------

## 22.14 与相关章节的约束对齐

- **契约与语义化版本**：7.1、7.8、8.2、8.12 明确“契约优先、`glancy.dict.v1`、不兼容走弃用期并升级 MAJOR”。
- **性能与运维门槛**：NFR‑009、NFR‑027、NFR‑030 要求“零停机发布、三类可观测、契约回放”。
- **统一口径**：限流/配额与下载 TTL、删除语义由第 8、9、10、11 章集中定义，本章仅**引用**不复制。
- **范围变更**：新增语言对/输入形态/模块能力等“范围扩大”必须走本章流程（2.8）。

------

### 本章交付物清单

- 《变更 RFC 模板》《弃用与迁移公告模板》
- Schema 与样本回放清单（≥500 条）
- 灰度编排参数与回滚手册
- Sunset 日历与“棕断”演练计划

> 以上流程与策略为“强约束”。若需突破，必须在 RFC 中明确风险、替代方案与批准人，并在发布后 48 小时内提交复盘与制度更新建议。