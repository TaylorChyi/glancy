# 第 15 章 国际化与可访问性

## 15.1 目标与范围

- **目标**：为 Web/H5 在 MVP 阶段提供可落地的国际化（i18n）与可访问性（a11y）规范，达到 WCAG 2.1 AA 基线，并保证与“同语模式、订阅与配额、降级与熔断、导出与删除语义”等既有能力协同。该目标与 NFR-011/NFR-034/NFR-035 一致。
- **范围**：UI 语言仅支持 zh、en；默认语言由设置控制；所有文案通过 i18n key 管理，禁止硬编码；日期时间按“UTC 存储、前端本地渲染”的统一口径执行。
- **与目录衔接**：本章在[目录](https://chatgpt.com/g/g-p-690ce154ad1c8191b5ea360736e3600e-glancy/c/目录.md)中为第 15 章，后续章节（16–25）引用本章作为 i18n/a11y 的单一事实源。

------

## 15.2 语言与地区策略（i18n 基线）

1. **受支持语言**：`zh`、`en`；同语模式（en→en、zh→zh）不显示译文，接口亦不回传 `translation`，与 FR-001/FR-011、API 契约保持一致。
2. **语言切换**：设置页提供语言切换；默认值遵循产品设置（默认 zh），即时生效、无需刷新。
3. **白名单与配置发现**：前端在启动时调用 `GET /api/v1/config` 拉取 `langWhitelist`，并将其作为 UI 切换与校验的数据源。
4. **时间与地区格式**：所有时间服务端存 UTC，前端按“用户本地时区”渲染；下载链接 TTL 与显示到期时间遵循统一口径（默认 10 分钟）。
5. **数字、单位与列表**：统一使用前端格式化库处理数字分组、百分比与列表连接（zh 使用“、”，en 使用 “, / and”），避免硬编码。与字符预算映射见 15.3 与 1.4.3。
6. **文本方向**：MVP 不引入 RTL；如后续新增 RTL 语种，需启动版本化变更并更新本章。

### 15.2.1 语言/地区矩阵（与第 18 章兼容性矩阵一致）

| 语言 | Locale 标记 | 日期与数字格式化 | 复数/选择规则 | 兼容策略 |
| ---- | ----------- | ---------------- | ------------- | -------- |
| 简体中文 (`zh-CN`) | `zh-CN` | `Intl.DateTimeFormat('zh-CN', { dateStyle: 'medium', timeStyle: 'short' })`；数字使用 `Intl.NumberFormat('zh-CN')`；列表连接使用“、”。 | 使用 `Intl.PluralRules('zh-CN')`，仅 `other` 分支；复数文案通过选择语句处理。 | UI 默认语言；与[第 18 章]所列桌面端 Chrome/Edge 版本完全一致。 |
| 繁体中文（待扩展） | `zh-TW`（预留） | 暂不启用；文案资源与格式化函数预留占位，需先在第 18 章增加支持矩阵。 | 同 `zh-CN`；新增前需完成资源翻译。 | 作为“候选”标记，受配置白名单控制。 |
| 英文 (`en-US`) | `en-US` | `Intl.DateTimeFormat('en-US', { dateStyle: 'medium', timeStyle: 'short' })`；数字使用 `Intl.NumberFormat('en-US')`；列表连接使用 `Intl.ListFormat('en', { type: 'conjunction' })`。 | `Intl.PluralRules('en')` 覆盖 `one/other`；错误提示与配额说明遵循复数分支。 | 默认回退语言；所有浏览器需满足[第 18 章]的 Chromium/Safari 版本要求。 |
| 英式英文（待扩展） | `en-GB`（预留） | 同 `en-US`，但日期默认 `dd/MM/yyyy`；作为配置灰度使用，正式支持需在兼容性矩阵增加 Safari macOS/iOS 版本。 | 同 `en`。 | 通过配置开关控制；未启用时回退到 `en-US`。 |

> 兼容性：上述矩阵引用第 18 章的支持环境，确保未在兼容性矩阵中列出的浏览器/Locale 不会被误开放，避免冲突。

### 15.2.2 日期/数字/复数规则

- **日期时间**：统一使用 `Intl.DateTimeFormat`，并依据 `Intl.Locale` 解析用户设置的 Locale；若浏览器不支持，回退到 ISO 8601 文本并在 a11y 提示中说明（遵循 NFR-033）。
- **数字与货币**：采用 `Intl.NumberFormat`，订阅价格引用订阅域提供的货币代码；百分比统一使用 `{ style: 'percent', maximumFractionDigits: 1 }`，避免手动拼接 `%`。与第 11 章的价格展示保持一致。
- **列表与枚举**：使用 `Intl.ListFormat`；当浏览器不支持时以语言配置的连接符兜底。
- **复数/选择**：所有计数类文案（剩余额度、导出条目数、收藏夹条目）使用 `Intl.PluralRules` 定义分支；中文仅 `other` 分支，英文覆盖 `one/other`，扩展语言需同步更新资源文件。

### 15.2.3 RTL 支持策略

- MVP 阶段无 RTL 语言，布局组件使用 `logical` 属性（`margin-inline`、`padding-inline`）预留扩展能力。
- 若后续引入 RTL，需：1) 在第 18 章更新浏览器矩阵；2) 开启 `dir="rtl"` e2e 走查；3) 更新 15.7 组件规范以覆盖镜像布局；4) 与设计稿同步重新评审对比度。

------

## 15.3 文案与长度预算

- **详略级别预算**：沿用统一“短/中/长”字符上限（中文 80/150/220；英文 120/220/320），UI 在渲染时以预算为裁剪基线，避免排版抖动。
- **截断与可读性**：当超出预算时采用语义截断并保留“展开”交互；`truncated=true` 的数据在结果 JSON 中标记并可回放。
- **中文排版要点**：中文段落不添加额外空格；中英文混排时，标点随源语；避免将半角标点置于行首。此规则为呈现规范，不改变接口载荷。

------

## 15.4 i18n 工程实践

1. **Key 规范**：`<域>.<页面>.<模块>.<语义>`，例如 `dict.result.degrade.badge`; 禁止直接在代码中出现可见中文或英文。与 NFR-034 的“i18n key 管理”一致。
2. **占位与复数**：使用参数化消息与复数/选择占位；严禁字符串拼接构造句子，避免语序问题。
3. **缺失与回退**：缺失 key 在开发环境以“伪本地化（加标记）+ 控制台告警”呈现；生产环境回退到英文并打点一次。
4. **提取与冻结**：在 M1/M2 前，完成文案抽取与“关键路径字符串冻结”；所有变更走 MR 审核清单（含中英双稿与截图）。
5. **契约与模块文案**：接口返回的结构化内容与模块名（释义/例句/搭配/同反义/派生）保持一致，前端仅本地化 UI 框架文案，不对结构化“内容字段”做二次翻译。
6. **资源加载与回退**：i18n 资源按语言拆分懒加载 bundle（`/i18n/<lang>.json`），首屏同步加载默认语言，其余语言于切换时按需请求并缓存；加载失败时回退英文并在控制台输出一次性警告。与 website `config/i18n.ts` 的资源发现策略保持一致。
7. **伪本地化环境**：`lang=zz` 作为开发环境伪本地化标识，自动替换字符并扩展 30% 长度，用于发现排版问题；需保证与第 18 章“兼容性矩阵”中标注的最低浏览器同样可加载。

------

## 15.5 与同语模式、降级与状态提示的对齐

- **同语模式**：en→en/zh→zh 不显示译文区块，UI 也不提供“临时展开译文”，与 FR-001、API 约束保持一致。
- **退化/降级提示**：当 `degraded=true` 时，结果页需显式展示“已降级”徽标与说明；该提示需可被读屏朗读且不依赖颜色单一信号。
- **配额与限流提示**：命中 429 时，错误体中的剩余额度与重置时间需以本地化文案+本地时区渲染，并提供键盘可达的“重试”与“升级订阅”按钮。

------

## 15.6 可访问性基线（WCAG 2.1 AA）

> 目标：NFR-011/NFR-035 要求的 WCAG 2.1 AA。验收在[第 6 章 6.13-E「可访问性」]同步执行。

1. **可感知（Perceivable）**
   - 文本与交互元素对比度：普通文本≥4.5:1，较大文本≥3:1；禁用态与徽标不计入对比度但需可辨识。
   - 非文本内容：所有图标和操作性图形必须有 `aria-label` 或可见文本；装饰性图标使用 `aria-hidden="true"`。
   - 状态与反馈：加载、成功、失败、降级、配额用尽等状态需提供文本说明，不以颜色作为唯一信号。与降级/限流语义对齐。
2. **可操作（Operable）**
   - 键盘可达：全站 Tab 顺序与视觉顺序一致；提供“跳到主内容”链接；模态对话框捕获焦点，关闭后焦点回到触发源。
   - 焦点可见：使用统一的焦点样式，满足对比度要求。
   - 手势与目标尺寸：触控元素的命中区域≥44×44 dp。
3. **可理解（Understandable）**
   - 表单与错误：输入限制（“仅词/词组”）命中时提供明确错误与修复建议，错误代码与提示一致（如 `ENTRY_NOT_WORD_OR_PHRASE`）。
   - 语言标记：页面 `lang` 与局部 `lang` 标记正确设置，便于读屏切换发音。
4. **稳健（Robust）**
   - 语义化结构：标题层级、列表、表格关联（`th`/`scope`/`aria-describedby`）正确；动态区域采用 `aria-live="polite"` 播报配额与降级变更。
   - 兼容性：与[第 18 章「兼容性与客户端支持矩阵」]联动，非支持环境给出可读提示，不导致核心流程失效（NFR-033）。

------

### 15.6.1 A11y 检查清单（发布门槛≥20 项）

| ID | 检查点 | 页面/模块示例 | 说明 |
| -- | ------ | ------------- | ---- |
| A11y-C01 | 首屏提供“跳到主内容”链接 | 桌面端首页导航 | 链接需在键盘焦点时可见，并指向 `#main`。 |
| A11y-C02 | 全局导航焦点顺序与视觉一致 | 顶部导航/侧栏 | 验证 Tab 顺序与文案提示一致，避免跳跃。 |
| A11y-C03 | 当前导航项使用 `aria-current="page"` | 顶部导航 | 与 15.7 要求一致，读屏应播报“当前页”。 |
| A11y-C04 | 搜索输入具备 `<label>` 或 `aria-label` | 查词页查词框 | 组合输入（IME）时提醒“按 Enter 提交”。 |
| A11y-C05 | 搜索按钮具备键盘可激活能力 | 查词页查词框 | `Enter` 与 `Space` 均可触发，焦点样式满足 4.5:1。 |
| A11y-C06 | 自动完成/历史下拉可通过方向键导航 | 查词框历史记录组件 | 下拉开启时焦点限定在列表，`Esc` 关闭并回到输入框。 |
| A11y-C07 | 结果模块标题语义正确 | 释义/例句模块 | 模块标题使用 `h2/h3`，并与折叠按钮 `aria-controls` 关联。 |
| A11y-C08 | 流式渲染区域提供 `aria-live="polite"` | 释义流式/增量组件 | 读屏需感知新增释义，参考 website `markdown.extractMarkdownPreview` 测试样例。 |
| A11y-C09 | 配额与降级状态同时提供文本提示 | 429/降级提示条 | 禁止仅靠颜色区分，文本需说明“剩余 X 次，重置时间”。 |
| A11y-C10 | 错误页提供行动按钮 | 429、500 页面 | “重试”“升级订阅”支持键盘操作与读屏文案。 |
| A11y-C11 | 模态对话框锁定焦点并可 `Esc` 关闭 | 设置>语言切换弹窗 | 关闭后焦点回到触发按钮。 |
| A11y-C12 | Toast/通知在 5s 内可暂停或关闭 | 操作反馈通知 | 通过显式“关闭”按钮与 `role="alert"` 语义保证可操作。 |
| A11y-C13 | 表格头部使用 `scope="col"` | 订阅计划对比表 | 读屏朗读列标题，支持横向滚动。 |
| A11y-C14 | 表单错误提供修复建议 | 句子输入限制错误 | 错误提示中包含“请改为词或词组”，与错误码一致。 |
| A11y-C15 | 颜色对比度符合 4.5:1 | 所有正文文本 | 使用自动化工具验证，暗模式同样适配。 |
| A11y-C16 | 错误边框与文本组合使用 | 表单校验失败态 | 不仅依赖颜色，还需图标或文本说明。 |
| A11y-C17 | 图片/图标具备替代文本 | 引导页插画、功能图标 | 装饰性图标标记 `aria-hidden="true"`。 |
| A11y-C18 | 骨架屏不被读屏朗读 | 加载骨架组件 | 骨架容器设置 `aria-hidden` 并在数据就绪时移除。 |
| A11y-C19 | 键盘可访问的分页/更多按钮 | 结果模块分页 | 按钮需具备 `aria-label` 指出页码/动作。 |
| A11y-C20 | 语言切换控件显示当前语言 | 设置页语言切换 | 通过 `aria-pressed` 或 `aria-selected` 标识选中状态。 |
| A11y-C21 | 移动端触控目标 ≥44×44 dp | H5 底部操作条 | 通过样式与测试确认命中区域。 |
| A11y-C22 | 低带宽/降级模式仍可操作 | 释义降级提示 | 当仅返回基础释义时，提示条可键盘关闭且 `aria-live` 播报一次。 |

> 上表涵盖 22 个发布前检查项，与第 18 章列出的端侧环境无冲突，所有示例页面均在当前 MVP 范围内。

------

## 15.7 关键组件的 a11y 规范

| 组件/模式               | 要求（节选）                                                 |
| ----------------------- | ------------------------------------------------------------ |
| 顶部导航/侧栏           | 提供“跳到主内容”；当前页面以 `aria-current="page"` 标记；图标按钮需可见文本或 `aria-label`。 |
| 搜索输入（查词框）      | 组合输入（IME）期间禁用“提交”快捷键；命中“句子输入”规则时以区域提示+错误帮助文本呈现，可由 `Esc` 关闭。 |
| 结果模块（释义/例句等） | 模块标题为 `h2/h3` 级；分页或“展开更多”按钮具备显式文本；同语模式隐藏译文字段且不占用可聚焦控件。 |
| 模态/抽屉               | 打开时锁定焦点，按 `Esc` 关闭；背景标记 `aria-hidden`；恢复焦点到触发源。 |
| Toast/通知              | 采用 `role="status"`（非阻塞）或 `role="alert"`（阻塞），并可暂停与关闭；内容包含可读文字而非仅图形。 |
| 进度与骨架屏            | 以 `aria-busy` 标识容器；骨架不被读屏朗读为真实内容。        |
| 表格与列表              | 表头与单元格语义化；分页、排序、筛选有可见标签与 `aria` 属性；空列表提供空状态指引。 |
| 错误页/429 提示         | 错误标题、原因、可操作按钮（重试/升级）可键盘操作，并通过 `aria-live` 播报；时间与配额文本采用本地化格式。 |

上述要求与“输入规则、错误码、同语模式、配额/限流语义”保持一致。

------

## 15.8 动画、动效与减弱动效

- 尊重用户“减少动效”偏好；在该偏好下使用淡入/淡出替代大型位移动画，并禁止无限循环动画。
- 骨架屏与微动效不应干扰读屏阅读顺序，重要状态通过文本与语义告知。与 NFR“UI 可访问性”对齐。

------

## 15.9 i18n/a11y 测试与验收（与 UC/AC 对齐）

1. **自动化校验**：集成 a11y 扫描任务至 CI；i18n 静态检查（key 存在性、未翻译计数、占位符匹配）。通过阈值作为发布门禁。
2. **读屏与键盘走查**：
   - Windows（浏览器）与移动端（H5）分别完成：导航、查词、再生成、导出、订阅购买流程的全键盘与读屏走查。
   - 关键用例参照[第 4 章 UC-01/02/03/06/08/14]，并在[第 20 章]编制 AC。
3. **可访问性验收清单**：继承 NFR 6.13-E：Tab 全路径可达、读屏可朗读、颜色对比度工具通过，并逐条核对 15.6.1 的 22 项检查点。
4. **伪本地化回归**：对关键页面启用伪本地化，检查溢出与断行；不得出现被硬编码的中文或英文。
5. **前端测试引用**：保留并扩展 website 测试样例，如 `website/src/shared/utils/__tests__/markdown.extractMarkdownPreview.test.js`、`website/src/features/dictionary-experience/hooks/__tests__/useDictionaryExperience.history-fetch.test.jsx`，确保覆盖流式渲染组件与增量解析；新增测试需验证 `aria-live`、格式化函数与降级提示协同工作。

------

## 15.10 监控与运维对齐

- **a11y 指标**：记录 a11y 扫描违例数、对比度问题数、键盘陷阱数；纳入可观测性看板，与错误预算并列。
- **降级场景**：当依赖异常触发“基础释义+模板例句”降级时，确保“已降级”提示被播报且不阻塞主要内容，满足“可用且可理解”的退化要求。

------

## 15.11 与订阅/配额、导出/删除的协同

- **订阅与能力文案**：权益与限额由订阅域 SSoT 输出，UI 只做本地化呈现，不复制数值；升级/降级后的权限提示需本地化且可读屏。
- **配额与限流**：429 错误提示包含 `retry_after`、重置时间、剩余额度，采用本地时区、本地化格式显示。
- **导出与回执**：导出回执与一次性链接 TTL 文案需本地化，且包含屏幕阅读友好说明（例如“链接 10 分钟内有效”）。
- **删除与恢复窗口**：逻辑删除即时、物理清理 T+7 d 的时间说明需清晰、无歧义并本地化展示。

------

## 15.12 风险、边界与路线

- **边界（MVP）**：仅 zh/en；不支持 RTL 与多复数规则复杂语种；不支持服务端按地区自动改写 UI 语言。
- **常见风险**：
  1. 硬编码文案导致不可翻译；2) 颜色唯一信号；3) 读屏顺序与视觉顺序不一致；4) 文字溢出影响交互；5) “同语模式”误显示译文。对策见 15.4–15.7。
- **演进路线**：当新增语种或 RTL 时，需在[第 22 章「变更管理与版本策略」]走不兼容变更流程，并扩展 `glancy.dict.*` 契约与 UI 语言包。

------

## 15.13 验收项（与第 20 章联动）

| 编号    | 验收内容             | 通过条件（摘要）                                             |
| ------- | -------------------- | ------------------------------------------------------------ |
| I18N-01 | 文案与 key 管理      | 代码零硬编码；CI 检查未翻译条目=0；占位符匹配率=100%         |
| I18N-02 | 同语模式译文禁显     | en→en/zh→zh 渲染无译文区块，API 不含 `translation` 字段      |
| I18N-03 | 时间与配额文本本地化 | 所有时间按本地时区渲染；配额与 429 文案含“剩余/重置时间”，格式正确 |
| A11Y-01 | 键盘可达与焦点可见   | 全主流程 Tab 可达；焦点环可见；无键盘陷阱                    |
| A11Y-02 | 读屏与状态播报       | 降级、配额用尽、导出完成等状态通过 `aria-live` 播报，文案完整 |
| A11Y-03 | 对比度与色盲适配     | 重要文本对比度达 4.5:1；状态不以颜色为唯一信号               |
| A11Y-04 | 句子输入与错误提示   | 命中“句子输入”规则时，错误体与 UI 提示一致且可读屏（含修复建议） |
| A11Y-05 | NFR 回归（6.13-E）   | 通过 Tab 路径、读屏朗读、对比度工具三项检查                  |

上述验收与 NFR、UC 和接口契约对齐，用于[第 20 章「验收标准与测试方案」]的测试编排与门禁。

------

## 15.14 附：与相关章节的引用关系

- 范围、白名单与详略预算：见[第 1 章 1.4.1/1.4.3/1.4.6]。
- NFR 基线与 a11y 验收：见[第 6 章 6.2、6.9、6.13]。
- 接口与错误语义、降级标记：见[第 8 章 8.1/8.6/8.10/8.11]。
- 配额与限流文案：见[第 10 章]。
- 订阅与权益展示：见[第 11 章]。
- 数据契约与截断标记：见[第 9 章]。
- 业务用例联动：见[第 4 章]（用于测试路径与读屏走查）。

> 至此，i18n 与 a11y 的目标、工程与验收闭环与现有文档一致，满足 MVP 发布门槛及后续演进需要。