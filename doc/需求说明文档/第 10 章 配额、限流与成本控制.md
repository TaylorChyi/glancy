# 第 10 章 配额、限流与成本控制

> 版本说明：本章聚焦当前代码中已落地的配额、限流、成本防护逻辑。旧版文档的令牌桶/多级配额描述已替换为真实实现（搜索日限 + TTS 配额/速率）。

---

## 10.1 当前实现表格

| 序号 | 控制对象 | 指标 | 当前策略 | 触发后的系统行为 | 代码 |
| --- | --- | --- | --- | --- | --- |
| QL-001 | 搜索历史（非会员） | 日次数 | 默认 `10` 次/日（配置化 `search.limit.nonMember`） | 超限抛出 `InvalidRequestException("非会员每天只能搜索10次")`，HTTP 422；不会写入新记录。 | 【F:backend/src/main/java/com/glancy/backend/config/SearchProperties.java†L6-L16】【F:backend/src/main/java/com/glancy/backend/service/SearchRecordService.java†L70-L131】 |
| QL-002 | TTS 合成（日配额） | 成功合成次数 | `tts-config.yml` 中按会员区分：Free=5 次/日、Pro=100 次/日；缓存命中不计数 (`countCachedAsUsage=false`) | 超限抛出 `QuotaExceededException("今日配额已用完")`，HTTP 403。 | 【F:backend/src/main/java/com/glancy/backend/service/tts/quota/TtsQuotaService.java†L34-L75】【F:backend/src/main/resources/tts-config.yml†L17-L35】 |
| QL-003 | TTS 合成（速率限制） | 用户/分钟、IP/分钟、突发与冷却 | 内存令牌桶：默认用户 30 req/min、IP 120 req/min、突发 20、冷却 60 秒 | 超限抛出 `RateLimitExceededException("请X秒后重试")`，HTTP 429。 | 【F:backend/src/main/java/com/glancy/backend/service/tts/ratelimit/TtsRateLimiter.java†L38-L88】【F:backend/src/main/resources/tts-config.yml†L26-L30】 |
| QL-004 | TTS 音色权限 | 会员等级 | `TtsRequestValidator` 根据 voice plan 与用户 `membershipType` 判定 | 无权限抛 `ForbiddenException`，HTTP 403，提示所需等级。 | 【F:backend/src/main/java/com/glancy/backend/service/tts/TtsRequestValidator.java†L40-L103】【F:backend/src/main/java/com/glancy/backend/entity/MembershipType.java†L6-L43】 |
| QL-005 | 兑换码 | 总额度 + 单用户额度 + 有效期 | 创建/兑换时校验时间窗与剩余额度；使用乐观锁防止并发超额 | 超限抛 `InvalidRequestException`（422）。 | 【F:backend/src/main/java/com/glancy/backend/service/redemption/RedemptionCodeService.java†L66-L145】 |

---

## 10.2 目标契约与缺口

| 目标项 | 当前状态 | 说明 |
| --- | --- | --- |
| 在查词、历史接口响应中返回 `X-Quota-*` 头或 JSON 字段 | **未实现**：仅 TTS 异常文本提示 | 若需用户可视化剩余额度，需在 `WordService`/`SearchRecordService` 返回结构中扩展。 |
| TTS 速率限制持久化/多节点共享 | **未实现**：当前为单节点内存桶 | 集群部署需引入 Redis 或外部限流服务。 |
| 成本监控（tokensIn/out） | **未实现**：无字段记录模型 token 消耗 | 若未来接入 LLM 成本分析，需在版本表或日志中补充。 |

---

## 10.3 异常与用户反馈

1. **配额用尽**：TTS、兑换等会返回 403/422，消息体为人类可读中文提示，前端可直接展示。 【F:backend/src/main/java/com/glancy/backend/exception/GlobalExceptionHandler.java†L88-L95】
2. **速率限制**：TTS 速率限制返回 429，提示需等待秒数；当前未设置 `Retry-After` 响应头。 【F:backend/src/main/java/com/glancy/backend/service/tts/ratelimit/TtsRateLimiter.java†L41-L83】【F:backend/src/main/java/com/glancy/backend/exception/GlobalExceptionHandler.java†L96-L101】
3. **会员音色限制**：当用户请求高等级音色时会收到 403，并附带“仅对 pro/premium 开放”文案。 【F:backend/src/main/java/com/glancy/backend/service/tts/TtsRequestValidator.java†L85-L103】
4. **搜索日限**：触发后返回 422，文案固定“非会员每天只能搜索10次”。 【F:backend/src/main/java/com/glancy/backend/service/SearchRecordService.java†L108-L118】

---

## 10.4 差异追踪（需建 Issue）

1. **统一配额反馈**：在查词/历史/TTS 成功响应中增加剩余额度字段或响应头，以满足产品体验（参见第 8 章 TGT-003）。
2. **分布式限流**：若计划多节点部署，需要评估基于 Redis/令牌桶服务的替代实现。
3. **成本指标留存**：若要实现成本监控或与订阅计费挂钩，需要在搜索版本或日志中记录 token/时长等指标。
