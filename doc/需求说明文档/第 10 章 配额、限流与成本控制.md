# 第 10 章 配额、限流与成本控制

> 本章在[第 1 章 引言](<./第 1 章 引言.md>)定义的术语、1.4 分层功能与 1.4.4 订阅权益矩阵基础上细化落地规则，作为产品、后端与运维在“查词”“再生成”两大路径上的统一实施标准。

## 10.0 对齐结果（T03，2025-02）

> 说明：当前代码仅对“非会员每日查词次数”做了基础限制，尚未实现 SRS 描述的多档配额、限流与成本护栏。本节给出现状与缺口，10.1 起保留原目标描述。

### 10.0.1 当前实现表

| 范畴 | 实现方式 | 细节 | 溯源 |
| --- | --- | --- | --- |
| 查词次数 | `SearchRecordService.saveRecord` 针对 `!user.hasActiveMembershipAt(now)` 的用户统计 `countByUserIdAndDeletedFalseAndCreatedAtBetween(今日)`，超过 `search.limit.nonMember`（默认 10）抛出 `InvalidRequestException` | 仅限制“新增历史记录”，未区分查词/再生成，也未按时区；会员无上限 | [SearchRecordService](../../backend/src/main/java/com/glancy/backend/service/SearchRecordService.java#L64-L121)，[SearchProperties](../../backend/src/main/java/com/glancy/backend/config/SearchProperties.java) |
| 会员判定 | `User.hasActiveMembershipAt` 基于 `membershipType` + `membershipExpiresAt` | 会员状态完全依赖 `users` 表，未关联订阅/计划；升级/降级需额外逻辑 | [User](../../backend/src/main/java/com/glancy/backend/entity/User.java#L21-L81) |
| 再生成计数 | 未实现，再生成接口亦缺失 | — | — |
| 配额查询 API / Header | 无 `/api/quotas`；`WordController` 返回 200 + `WordResponse`，不附带任何 `X-RateLimit-*` 或 body quota | 浏览器无法得知剩余额度或重置时间 | [WordController](../../backend/src/main/java/com/glancy/backend/controller/WordController.java) |
| TTS 限流 | `TtsRateLimiter`（内存 Token Bucket）与 `TtsConfig.ratelimit` 已实现，但 `TtsController` 未调用 `validate` | 当前 TTS 请求不受限流保护 | [TtsRateLimiter](../../backend/src/main/java/com/glancy/backend/service/tts/ratelimit/TtsRateLimiter.java)，[TtsController](../../backend/src/main/java/com/glancy/backend/controller/TtsController.java) |
| TTS 配额 | `TtsQuotaService` 负责 `tts_usage` 增量，但未注入 Controller；`TtsConfig.quota` 仅保存在内存 | 每日配额无法生效 | [TtsQuotaService](../../backend/src/main/java/com/glancy/backend/service/tts/quota/TtsQuotaService.java) |
| 成本 / tokens | `WordSearcherImpl` 未返回 tokens；`WordResponse` 无 `tokensIn/out` 字段 | 无法统计成本，也无法驱动预算护栏 | [WordSearcherImpl](../../backend/src/main/java/com/glancy/backend/llm/service/WordSearcherImpl.java)，[WordResponse](../../backend/src/main/java/com/glancy/backend/dto/WordResponse.java) |
| 预算事件 / 降级 | 未实现任何燃率监控或降级策略；`ServiceDegradedException` 仅用于异常兜底 | 章节 10.7–10.11 描述的护栏尚未落地 | [GlobalExceptionHandler](../../backend/src/main/java/com/glancy/backend/exception/GlobalExceptionHandler.java) |

### 10.0.2 目标契约表（原 SRS 摘要）

| 要素 | SRS 约定 | 当前状态 | Issue |
| --- | --- | --- | --- |
| 多档日配额（Free/Plus/Pro）、升级降级规则（10.3） | 分档次数、活动桶、幂等键、示例计算 | 仅非会员 10 次限制，会员无限制 | ISSUE#T03-QUOTA-01 |
| `POST /lookup` / `regenerate` 中配额计数与 `quota` header/body（10.3.3、10.8） | 每次查词/再生成返回 `X-RateLimit-*` + body `quota` | 未返回任何 quota 字段 | ISSUE#T03-QUOTA-02 |
| 再生成独立桶（10.3） | 再生成次数不与查词共用 | 无再生成接口/计数 | ISSUE#T03-QUOTA-03 |
| Token Bucket（用户/租户/全局）与限流事件（10.4、10.9） | 429 时返回 `retry_after` 与事件 | 限流逻辑不存在（TTS 亦未接） | ISSUE#T03-QUOTA-04 |
| `quota_daily/rate_limits` 持久化（与 9 章一致） | 以 `subject_id + quota_date_local` 落库 | 无落库表 | ISSUE#T03-QUOTA-05 |
| 成本 / 预算护栏（10.7） | `tokens_in/out`、燃率监控、降级策略 | 缺失 tokens 字段，无法计算预算 | ISSUE#T03-QUOTA-06 |
| 配额查询 API `GET /v1/quota`（10.9.1） | 返回 plan + lookup/regenerate 剩余 | 无 API | ISSUE#T03-QUOTA-07 |
| 事件 `rate_limited/budget_breach/downgrade_applied`（10.9.2） | 异步事件供监控/客服使用 | 未实现 | ISSUE#T03-QUOTA-08 |

### 10.0.3 Issues（配额 / 限流）

- **ISSUE#T03-QUOTA-01**：需根据会员档位建立查词/再生成日配额模型，并将 `search.limit.nonMember` 扩展为计划驱动。
- **ISSUE#T03-QUOTA-02**：`WordController`（以及未来的再生成接口）必须输出 `X-RateLimit-*`、`X-Quota-*` 与 body `quota`，并在 `Website` API 层展示。
- **ISSUE#T03-QUOTA-03**：缺少再生成 API 与独立配额桶，无法满足 8.4/10.3 的场景。
- **ISSUE#T03-QUOTA-04**：`TtsRateLimiter` 尚未接入，其他接口完全无限流，需要在入口（如 `WordController`）加入 Token Bucket。
- **ISSUE#T03-QUOTA-05**：`quota_daily` 等存证表缺失，现有“按天 count(*)”方式无法满足审计/幂等校验。
- **ISSUE#T03-QUOTA-06**：缺失 `tokensIn/out` 统计与预算护栏；需在 `WordSearcherImpl` 解析模型返回值、记录 tokens，并根据 10.7 触发降级。
- **ISSUE#T03-QUOTA-07**：需新增 `/api/v1/quotas` 或等价查询接口，供前端展示与客服排查。
- **ISSUE#T03-QUOTA-08**：预算/限流事件未发射，监控无法感知；需结合 14 章 Observability 一并落地。

------

## 10.1 目标与原则

| 目标     | 说明                                                         |
| -------- | ------------------------------------------------------------ |
| 体验稳定 | 在高峰与异常情况下，仍保证各档位用户“可用且可预期”的响应。   |
| 成本可控 | 以 tokens_in/out 为核心度量，设置日/月预算与燃率护栏，避免失控消耗。 |
| 公平隔离 | 采用“用户级 → 租户级 → 全局级”三级限流，避免噪声用户拖垮整体。 |
| 透明可见 | 对客户端与后台输出一致的剩余额度、重置时间与冷却信息。       |
| 易于运营 | 支持灰度、干跑与临时活动配额，不需重发版即可灵活调参。       |

------

## 10.2 名词与口径补充

- **配额（Quota）**：按“用户本地自然日”统计（重置点为用户本地 00:00；服务端统一存 UTC），与限速正交，仅限制**总次数**。查词与再生成各自独立计数；`quota_daily.quota_date_local + time_zone` 落库存证该口径。
- **限流（Rate Limit）**：按秒级 Token Bucket 控制**速率与突发**，命中返回 429 并给出冷却。优先级：用户级 > 租户级 > 全局级。
- **计数口径**：成功返回或命中缓存均计入“查词”配额；失败（4xx/5xx）与客户端重试在具备幂等键或命中 L1/L2 缓存时不重复计数。
- **成本口径**：tokens_in/out 均记成本；缓存命中记 0 成本但仍计 1 次业务配额。

------

## 10.3 配额模型（按订阅档位）

> 与 1.4.4 保持一致；此处仅细化重置、升级/降级与活动叠加规则。

### 10.3.1 日配额基线

- 档位划分：Free / Plus / Pro，具体查词与再生成日配额以[第 11 章 订阅、计费与账单](<./第 11 章 订阅、计费与账单.md>)权益矩阵为唯一事实来源，此处仅引用不复刻数值。
- **重置**：按用户本地时区自然日重置；前端显示重置倒计时；后台以 `quota_daily.time_zone` 佐证重置口径。
- **升级/降级**：升级即时生效，已用次数保持不变，**上限**变为新档位上限；降级即时生效，若已用超过新上限，则剩余为 0。
- **活动配额（可选）**：支持“运营加赠”与“问题赔偿”两类临时桶，消耗顺序为：活动桶 → 订阅桶。活动桶默认 7 d 过期。

### 10.3.2 幂等与重试

- 幂等键 `idempotency_key = hash(user_id + entry + config)`，有效期 30 s。命中同键的后续请求**不重复计费/计数**，直接复用前次结果或 L1 缓存。

### 10.3.3 配额计数公式与验算

- **查词配额**：`used_lookup(d) = \sum_{req \in lookup(d)} 1`。无论命中缓存还是降级返回，均计 1 次业务配额，成本可为 0。
- **再生成配额**：`used_regenerate(d) = \sum_{req \in regenerate(d)} [req.result_mode \neq degraded]`。当请求被熔断/降级并返回“基础释义 + 模板例句”时（与[第 13 章 可用性、容灾与备份](<./第 13 章 可用性、容灾与备份.md>) 13.7 节口径一致），该次**不消耗**再生成配额。
- **剩余额度**：`remaining = max(limit + promo - used, 0)`，其中 `promo` 为活动配额桶余额（见 10.3.1），`used` 为当日累积值。

> **验算示例**（Plus 档，再生成日上限 20）：
> - 用户当日发起查词 18 次，其中 5 次命中 L2 缓存，3 次处于降级路径；`used_lookup = 18`。
> - 同日发起再生成 12 次，其中 2 次命中缓存复用、3 次因 Doubao 熔断触发降级；`used_regenerate = 12 - 3 = 9`。
> - 用户前一日获赠活动配额 5 次，尚余 4 次。则剩余额度：查词 `remaining_lookup = max(limit_lookup + 4 - 18, 0)`；再生成 `remaining_regenerate = max(20 + 4 - 9, 0) = 15`。
> - 日终对账时，缓存命中与降级均记录成本 0，但查词计数保持 18 次，再生成为 9 次，确保 UI 与后台一致。

------

## 10.4 限流与突发控制

### 10.4.1 Token Bucket 参数（按用户级）

| 档位 | 平均速率（令牌/秒） | 突发桶（令牌） | 并发执行上限 | 说明                         |
| ---- | ------------------- | -------------- | ------------ | ---------------------------- |
| Free | 1                   | 5              | 2            | 保障偶发连点但抑制长时间冲击 |
| Plus | 2                   | 10             | 4            | 适配学习冲刺与批量查询       |
| Pro  | 5                   | 20             | 6            | 面向重度用户与多端并发       |

> 令牌消耗单位：一次“查词”或一次“再生成”各消耗 1 枚令牌。

### 10.4.2 租户级与全局级阈值

- **租户级**：默认 300 RPS，突发 600；排队最长 3 s，超时返回 429。
- **全局级**：默认 800 RPS，突发 1600；全局保护阈值触发时按档位配额权重分配最小份额：Pro≥60%，Plus≥30%，Free≥10%。

### 10.4.3 429 返回契约

```json
{
  "error": {
    "code": "RATE_LIMITED",
    "message": "Too many requests",
    "scope": "user|tenant|global",
    "retry_after_ms": 1200,
    "limit": 10,
    "remaining": 0,
    "reset_at": "2025-11-08T10:01:23Z",
    "trace_id": "8f6c..."
  }
}
```

同时在响应头输出：

```
X-RateLimit-Limit: <number>
X-RateLimit-Remaining: <number>
X-RateLimit-Reset: <unix-epoch-seconds>
```

> 返回码与“冷却时间”口径与附录统一。

------

## 10.5 队列与优先级调度

- **多级优先队列**：Pro > Plus > Free，同级按 FIFO。
- **防饥饿**：每 10 个高优先级任务插入 1 个低优先级任务。
- **队列深度阈值**：用户级 20，租户级 5k，全局 20k；超过阈值触发 UI 退避提示与渐进降级。

------

## 10.6 缓存与降级协同

| 层级         | Key                  | TTL     | 命中效果                    |
| ------------ | -------------------- | ------- | --------------------------- |
| L1（用户级） | user_id+entry+config | 10 分钟 | 零成本快速返回，计 1 次配额 |
| L2（共享）   | entry+config_norm    | 30 分钟 | 零成本快速返回，计 1 次配额 |

- **熔断触发**：第三方 5xx≥5% 且持续≥1 分钟时，进入半开；期间统一回退“基础释义+模板例句”，并标注“已降级”。

------

## 10.7 成本控制与预算护栏

### 10.7.1 成本度量

- **请求维度**：`cost_request = a * tokens_in + b * tokens_out`（a、b 来自价格簿，后台配置）。
- **会话与用户维度**：聚合到 user_id/日、user_id/月。
- **系统维度**：聚合到租户与全局，输出 Burn Rate（近 5 分钟成本/日预算）。

### 10.7.2 预算与护栏

| 层级 | 预算类型 | 触发阈值              | 恢复阈值（建议） | 冷却时间 | 动作                                                                 |
| ---- | -------- | --------------------- | ---------------- | -------- | -------------------------------------------------------------------- |
| 全局 | 日预算   | 80%                   | <75%             | 10 分钟  | 开启强缓存优先策略（L2 优先、TTL×2），提示运营关注燃率              |
| 全局 | 日预算   | ≥95%                  | <90%             | 30 分钟  | 禁止“再生成”、强制强缓存、详略自动降一级，优先保障查词可用性       |
| 全局 | 月预算   | 100%                  | <95%             | 1 小时   | 仅允许缓存命中与“基础释义”降级，冻结非必要运营活动                 |
| 用户 | 月度成本 | 可配（默认 120% 基线） | <90%             | 24 小时  | 触发提醒，必要时限速为 0.5× 基线；与客服联动确认是否继续使用       |
| 词条 | 单次成本 | P95 上限              | <P90             | 5 分钟   | 例句条数自动降到 1，详略降 1 档，命中后 5 分钟内不再放宽            |

> 触发与恢复阈值采用滞回区间，冷却时间内保持已启用的动作，避免预算波动引发频繁抖动。与[第 13 章 可用性、容灾与备份](<./第 13 章 可用性、容灾与备份.md>) 13.7 节可用性护栏保持同口径；降级路径与“统一详略级别基线”一致，不突破用户设置的最少条数下限。

------

## 10.8 客户端与后台可见性

- **客户端展示**：
  - “今日剩余：查词 X/再生成 Y；重置倒计时 hh:mm:ss”。
  - 命中限流时展示“冷却 xx s 后重试”与本次 trace_id。
- **后台（运营/客服）**：
  - 可按用户/时间段查询配额与消耗明细、限流命中记录与 trace_id。
  - 支持一键发放活动配额与撤销。

------

## 10.9 接口与事件

### 10.9.1 查询剩余额度（API-QUOTA-GET）

```
GET /v1/quota
Authorization: Bearer <token>
→ 200
{
  "date": "2025-11-08",
  "plan": "plus|pro|basic",
  "lookup": {"limit": 100, "used": 37, "reset_at": "2025-11-08T16:00:00Z"},
  "regenerate": {"limit": 10, "used": 2, "reset_at": "2025-11-08T16:00:00Z"}
}
```

### 10.9.2 限流与预算事件（异步）

| 事件                | 触发          | 载荷                                     |
| ------------------- | ------------- | ---------------------------------------- |
| `rate_limited`      | 命中任一限流  | user_id、scope、retry_after_ms、trace_id |
| `budget_breach`     | 日/月底线越界 | 层级、阈值、建议动作                     |
| `downgrade_applied` | 自动降级生效  | 用户级与全局动作记录                     |

------

## 10.10 配额结算与时效保障

- **结算流程**：订阅权益变更（购买/升级/降级/退款）→ 订阅域发出 `subscription.updated` 事件 → 配额域消费事件并更新 `quota_limit` 表 → 在 5 秒内推送最新配额到缓存与 UI（API `/v1/quota`）。
- **SLA 与补偿**：

| 环节                         | 时效性 SLA           | 失败补偿策略                              |
| ---------------------------- | -------------------- | ----------------------------------------- |
| 权益事件入队至配额域消费     | ≤ 2 s                | 事件队列监控 + 死信复投                   |
| 配额域落库并刷新缓存         | ≤ 5 s（含 API 可见） | 每 1 分钟对账订阅与配额差异，必要时回放事件 |
| UI/运营后台展示与导出更新     | 下一次轮询 ≤ 30 s    | 客服后台允许手动触发重同步                 |

- **补偿流程**：当监控发现“订阅权益与配额差异 >0 且持续 >5 s”时，自动触发对账任务（订阅域为基准），按用户粒度回放最近 15 分钟内的权益事件；若仍失败，升级到人工处理并补偿活动配额，确保用户可用性。

> 订阅与配额同步的 5 秒时效要求与[第 13 章 可用性、容灾与备份](<./第 13 章 可用性、容灾与备份.md>) 13.1、13.5.3 节一致，作为跨域一致性的验收标准。

------

## 10.11 监控与告警（SLO 对齐）

| 指标           | 口径                 | 阈值/目标      | 告警                         |
| -------------- | -------------------- | -------------- | ---------------------------- |
| 429 命中率     | 429/总请求           | ≤ 3%（全局）   | 5 分钟均值 >3% 告警          |
| 成本燃率       | 近 5 分钟成本/日预算 | ≤ 1.2×         | >1.2× 告警，>1.5× 进入强降级 |
| L1/L2 命中率   | 命中/查词            | L1≥40%，L2≥20% | 低于目标 10 分钟告警         |
| 单请求成本 P95 | tokens_in/out 折算   | 低于阈值       | 超阈值自动降条数/详略        |
| 并发占用率     | 进行中/并发上限      | ≤ 80%          | >90% 持续 2 分钟告警         |

> 端到端 P95 ≤ 2.5 s 的性能目标不变，限流与降级策略不得使 P95 恶化超过 10%。

------

## 10.12 运营与灰度

- **参数热更新**：限速、预算、突发桶、并发上限支持后台即时下发，版本化并记录生效时间。
- **干跑（Dry-run）**：先只打标不执行拦截，评估一周后再切换为强制模式。
- **A/B 验证**：按用户 5% 流量灰度新参数，比较 429 率、成本与满意度。

------

## 10.13 典型场景与处理

1. **同一词条频繁再生成**（Plus 用户 10 次/日已满）：
   - 返回 429 与剩余冷却；提供“次日再试”与“升级订阅”入口。
2. **晚高峰全局压测**：
   - 触发全局保护阈值，按档位配比放行，同时统一开启强缓存与简化路径。
3. **预算即将透支（全局 95%）**：
   - 关闭“再生成”，查词走 L2→L1→简化回退链路，弹出“今天服务限速提示”。

------

## 10.14 安全与反滥用衔接

- 限流策略与“反滥用与风控策略”（[第 17 章 反滥用与风控策略](<./第 17 章 反滥用与风控策略.md>)）联动：异常设备指纹或可疑 IP 段触发**独立更严**的临时限速与配额封顶。
- 敏感词/违规输入被拒绝时**不计入配额**且不落库原文。

------

## 10.15 验收标准（NFR-11）

| 编号      | 描述                                                | 级别   |
| --------- | --------------------------------------------------- | ------ |
| NFR-11-01 | 按档位的日配额与重置规则准确生效，升级/降级即时同步 | Must   |
| NFR-11-02 | 用户级、租户级、全局级三层限流可独立配置并叠加生效  | Must   |
| NFR-11-03 | 命中限流返回 429，包含 `retry_after_ms` 与重置时间  | Must   |
| NFR-11-04 | 幂等 30 s 内不重复计费/计数，缓存命中 0 成本        | Must   |
| NFR-11-05 | 成本护栏在 80%/95% 阶梯触发对应降级动作             | Must   |
| NFR-11-06 | 后台可实时查看与发放活动配额，均有审计日志          | Should |
| NFR-11-07 | L1/L2 缓存命中率可监控并可阈值告警                  | Should |
| NFR-11-08 | 参数热更新与干跑模式可灰度发布                      | Should |

------

### 附：实现提示（非规范性）

- 使用高性能内存限流器（如 Redis + Lua）统一承载三层桶；令牌按“查词/再生成”权重分别配置。
- 将配额与限流状态缓存到用户态会话，避免每次查询都命中后端。
- 以 `trace_id` 贯穿计费、限流与日志，便于客服对账和回溯。

> 本章与“[附录 A 术语与缩略语](<./Appendix/附录 A 术语与缩略语.md>)”及“计量与阈值统一表”的口径保持一致，作为后续实现与验收的唯一依据。
