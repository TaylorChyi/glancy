# 第 17 章 反滥用与风控策略

> 目的：在不牺牲“查询即理解”体验的前提下，建立一套**可解释、可灰度、可审计**的反滥用与风控体系，联动配额/限流、降级策略与订阅域，降低自动化刷量、账号共享、异常并发、抓取与计费风险。本文为第 17 章正式规范，目录位置见总目录。 

------

## 17.1 目标与范围

- **体验优先**：对正常用户无感，异常用户逐级加摩擦（限速/降级/挑战/封禁）。降级路径与“基础释义 + 模板例句”一致。
- **成本可控**：与配额/限流和预算护栏协同，优先使用缓存与简化路径，必要时关闭再生成。 
- **合规最小化**：仅收集反滥用所必需的信号；无痕查询不落库原文；审计可回放且脱敏。
- **契约优先**：新增风险相关头与错误码遵循 API 契约与错误模型扩展规则。 

适用对象：边缘与网关、BFF/应用层、限流与配额服务、订阅与对账、任务编排、对象存储及管理后台。 

------

## 17.2 威胁模型（Threat Model）

| 类别               | 典型表现                                                 | 影响                         | 相关对策                                           |
| ------------------ | -------------------------------------------------------- | ---------------------------- | -------------------------------------------------- |
| 自动化刷量/抓取    | 高频短时并发、词条序列化遍历、命中句子输入拦截仍反复提交 | 成本飙升、缓存失效、体验劣化 | 用户/租户/全局三级限流、强缓存、退化输出、风险分桶 |
| 账号共享与令牌滥用 | 同一 `user_jwt` 在多 ASN/国家快速切换，匿名会话批量创建  | 配额绕过、对账异常           | 会话合并、设备指纹权重、异常登录风险分级           |
| 支付/订阅欺诈      | 试用/优惠反复套取、退款后继续使用                        | 权益错配、收入损失           | 订阅状态机联动 REVOKED/REFUNDED、权益即时收回      |
| 拒绝服务/资源耗尽  | 再生成滥用、异常突发                                     | SLO 下滑                     | 突发桶与并发上限、再生成关闭、降级路径             |
| 内容策略违规       | 敏感词、非白名单语言/整句输入反复撞规则                  | 法规/合规风险                | 输入拦截与审计、拒绝不计配额、不落原文             |

支撑与引用：语言对白名单与句子拦截、熔断降级与“基础释义”、配额与限流、订阅状态机与退款/撤销、审计与数据分级。

------

## 17.3 在线信号（Signals）

> 风控只使用最少必要信号，并尽量在网关与 BFF 层即时判定，避免引入额外往返。

- **主体与会话**：`subjectId = u_<userId> | s_<sessionId>`、匿名会话指纹哈希、会话合并事件。 
- **速率与并发**：用户/租户/全局三层令牌桶、并发执行上限、突发桶占用率。 
- **调用结构特征**：`lookup:regen` 比、缓存 `HIT/MISS` 比、连续未命中 L2 的比例、同词条高频再生。 
- **地理/网络**：IP 段、ASN、同一令牌的地理速度（geovelocity）异常。
- **协议/客户端**：UA 稀有度、头部熵、Cookie/Token 旋转频率异常。
- **错误与规则命中**：短时多次触发 `ENTRY_NOT_WORD_OR_PHRASE`、`INVALID_LANG_PAIR`、429/RATE_LIMITED。 
- **付费侧事件**：`subscription.reVOKED|refunded|expired`、拒付/撤销。 

数据最小化要求：不记录无痕查询原文；风险事件写入审计但脱敏。 

------

## 17.4 风险分级与评分（在线）

- **R0 正常**：风险分 0–24，放行，仅常规配额/限流。
- **R1 可疑**：25–49，动作：提示 + 轻量限速（0.5× 用户级速率）、再生成上限下调 50%。 
- **R2 高风险**：50–79，动作：强缓存优先（L2→L1）、禁用再生成、统一走简化/退化路径。
- **R3 阻断**：80–100，动作：返回 4xx 并提示“异常活动已被拦截”；必要时吊销令牌与临时封 IP/ASN。

触发示例（5 分钟滑窗，示意阈值）：

- 匿名会话创建 > 30 次/IPv4 C 段 且 `lookup:regen < 1:3` → R2。 
- 单用户并发执行数 ≥ 并发上限 × 2 或 429 命中率 > 20% → R2/R3。 
- 同一 `user_jwt` 在 15 分钟内出现在 ≥3 个 ASN → R3。
- 句子拦截 20 次/10 分钟且语言对无效命中 ≥5 次 → R1/R2。 

------

## 17.5 处置动作矩阵（渐进式）

| 动作             | 描述                       | 用户可见性                | 契约/返回                   |
| ---------------- | -------------------------- | ------------------------- | --------------------------- |
| **限速加严**     | 用户级速率与突发桶临时降档 | 提示“已限速，xx 秒后重试” | 429 + `retry_after_ms`      |
| **强缓存优先**   | 先查 L2 再 L1，MISS 则退化 | UI 显示“已降级”徽标       | `degraded=true`             |
| **关闭再生成**   | 禁用 UC-02/UC-03 行为      | 再生成按钮禁用            | 4xx + 错误体 `kind='abuse'` |
| **挑战**（可选） | 轻量挑战/验证邮箱          | 弹层/跳转                 | 4xx + `CHALLENGE_REQUIRED`  |
| **阻断**         | 拒绝请求并记录审计         | 错误页                    | 4xx + `ABUSE_BLOCKED`       |
| **账户处置**     | 撤销令牌/封禁/移除权益     | 通知与邮件                | 与订阅域事件流一致          |

所有降级与拦截路径均与既有熔断/降级与错误模型保持一致。

------

## 17.6 架构落地（联动 7/10 章）

- **拦截层级**：WAF/网关前置黑白名单与 IP/ASN 限制 → API 网关用户级速率限制 → 风控内核判定 → 应用层执行处置（限速/降级/阻断）。 
- **与配额/限流联动**：R1/R2 将**叠加**一套“风险桶”，与常规三层桶并行，参数可热更新与灰度。 
- **降级编排**：进入 R2 时强制走“基础释义 + 模板例句”，半开探测恢复。 
- **成本护栏联动**：当全局预算 ≥80%/95% 阶梯，R1/R2 人群优先被降级或关闭再生成。 

------

## 17.7 API 契约补充（兼容 8 章）

**响应头（新增，向后兼容）**

- `X-Risk-Score: 0..100`（整数）
- `X-Abuse-Action: none|throttle|degrade|challenge|block`
- `X-Policy-Id: <字符串>` 风险策略版本标识

**错误码扩展（并入 8.10）**

| HTTP | code               | 说明                                         |
| ---- | ------------------ | -------------------------------------------- |
| 403  | CHALLENGE_REQUIRED | 需完成挑战后再试（非 MVP 可选）              |
| 403  | ABUSE_BLOCKED      | 高风险阻断，错误体 `error.meta.kind='abuse'` |

错误体结构与 `RATE_LIMITED/ENTRY_NOT_WORD_OR_PHRASE` 等保持一致；返回 `traceId` 便于申诉与客服排查。 

------

## 17.8 数据模型与留存（与 9 章一致）

- **事件表**：`abuse_events(event_id, subject_id, risk_score, action, reason, trace_id, created_at)`；写入时**不含**查询原文。
- **配置表**：`abuse_policies(policy_id, rules, rollout, active)`；支持灰度与回滚。
- **留存**：`abuse_events` 默认 180 天、可配置；与 `audit_events` 关联检索。 
- **权限**：仅合规审计与系统管理员可读，按 RBAC 最小权限落地。 

------

## 17.9 与配额/限流/成本控制的联动规则

1. **独立更严**：风险命中后即时切换至“风险桶”参数，且不影响常规配额计数口径。 
2. **计费口径**：被拒绝/阻断请求不计入业务配额与成本；降级成功响应计入配额但记 0 成本。 
3. **队列优先级**：Pro/Plus/Free 的优先队列仍生效，但 R2 将整体降 1 档。 

------

## 17.10 订阅/计费风控（与 11 章一致）

- 当收到 `REVOKED/REFUNDED` 等事件，立即移除权益，风险分提升至 R2–R3，并锁定导出能力与高级自定义。 
- 升级/续费成功 ≤5 s 同步权益，但若账户处于 R2，维持限速与降级直至风险回落。 

------

## 17.11 告警、审计与申诉

- **告警**：5 分钟窗口内 R2+ 占比 > 5% 或 `ABUSE_BLOCKED` > 1% 触发 P1 告警；与错误预算看板并列展示。 
- **审计**：所有处置写入 `audit_events`，可按 `trace_id/subject_id/policy_id` 回放。 
- **申诉**：管理后台提供“风险解除/白名单”一次性操作，双人复核，审计留痕。 

------

## 17.12 指标与 SLO（验收口径）

| 指标             | 目标/阈值                      | 验收口径            |
| ---------------- | ------------------------------ | ------------------- |
| 误封率（FP）     | ≤ 0.5%                         | 随机抽样 + 回放样本 |
| 自动化流量占比   | 下降 ≥ 70%（相对基线）         | 发布前后 7 天对比   |
| 风险处置时延 P95 | ≤ 20 ms（不含网络）            | APM 分段            |
| 降级回退正确性   | 100% 命中“基础释义 + 模板例句” | UC-14 契约回放      |
| 端到端 P95 影响  | < +10%                         | 与 1.6 指标组合验收 |

与第 6 章 NFR、1.6 成功标准与 10.10 监控指标联动验收。

------

## 17.13 规则样例（MVP 默认启用）

| 编号 | 规则         | 条件（5 分钟窗）                                           | 动作                      |
| ---- | ------------ | ---------------------------------------------------------- | ------------------------- |
| R-01 | 匿名会话滥用 | 同一 C 段创建匿名会话 ≥ 30，且 `lookup:regen < 1:3`        | R2：强缓存 + 禁用再生成   |
| R-02 | 句子撞库     | `ENTRY_NOT_WORD_OR_PHRASE` ≥ 20 且 `INVALID_LANG_PAIR` ≥ 5 | R1：轻限速 + 提示正确输入 |
| R-03 | 再生成滥用   | 再生成/查词 ≥ 5，平均间隔 < 1s                             | R2：禁用再生成            |
| R-04 | 并发异常     | 并发执行数 ≥ 档位并发上限 × 2                              | R2：限速为 0.3×           |
| R-05 | 跨 ASN 共享  | 单 `user_jwt` 15 分钟内 ≥3 ASN                             | R3：阻断 + 吊销令牌       |

涉及口径、并发与配额参数引用 10 章与 11 章。

------

## 17.14 前后端与 UX 要求

- 结果页在 `degraded=true` 时展示“已降级”徽标；再生成被禁用时按钮置灰并显示剩余冷却与原因。 
- 429 返回统一展示“冷却 xx 秒后重试”，并显示 `traceId` 用于客服定位。 
- 申诉入口链接到“帮助与支持”，附 `traceId/policyId`。

------

## 17.15 运维流程与剧本

- **演练**：每月一次“全局压测 + 强降级”演练，验证熔断/半开、退化路径与成本护栏协同。 
- **灰度**：风险策略以 `policy_id` 灰度 5%→25%→100%，任一阶段 FP 超阈即回滚。
- **回退**：策略回退不影响审计；历史处置可批量撤销并通知。

------

## 17.16 与测试/验收（20 章）对齐的用例

- **UC-14 降级与熔断回退**：在人工注入 R2 条件下，结果页退化且契约 `degraded=true`。 
- **UC-13 限流/配额用尽**：命中风控限速返回 429，并含 `retry_after_ms` 与额外 `X-Abuse-Action`。 
- **UC-06 导出历史**：R2 用户禁止导出，返回 4xx + `kind='abuse'`（不计配额）。 

------

## 17.17 演进路线（与 7.12 对齐）

- **MVP**：基于规则与阈值的在线风控，支持灰度与审计回放。
- **阶段二**：引入轻量特征聚合与统计学习（无监督聚类/阈值自适应），但仍以规则为主；数据最小化与合规不变。
- **阶段三**：跨区域黑产画像共享与信誉分，策略多队列优先级与分级惩戒精细化。 

------

### 附：对其他章节的直接影响清单（变更项归口）

1. **8.10 错误码表** 增补 `CHALLENGE_REQUIRED/ABUSE_BLOCKED`；**8.1 基线规范** 增补风险相关响应头。 
2. **10 章** 增加“风险桶”参数集与看板指标；与 10.13 的联动说明落地为显式策略。 
3. **11 章** 明确 REVOKED/REFUNDED → 风险分升级与权益即时收回的联动时序。 
4. **9 章** 新增风控事件与策略配置两类表，留存与脱敏口径与审计对齐。 

> 本章为“反滥用与风控”的单一事实源，凡涉及风险分级、处置动作、响应头/错误码与留存口径的后续变更，须以本文为准并通过弃用期流程更新相应契约与用例。 

------

**跨章引用索引**：
 1 章（范围、成功标准、降级路径）、2 章（MVP 边界）、4 章（UC 与事件）、5 章（错误模型/句子拦截/模块行为）、6 章（NFR 与隐私/降级要求）、7 章（架构与组件/熔断与降级）、8 章（契约与错误码）、9 章（数据治理/审计）、10 章（配额/限流/预算护栏/联动）、11 章（订阅计费状态机）。

------