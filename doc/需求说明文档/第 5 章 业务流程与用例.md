# 第 5 章 业务流程与用例

> 本章在第 1 章所定义的范围、分层、白名单与数据控制基础上，抽象核心业务泳道、关键业务规则（BR）与标准用例（UC），为第 6 章功能性需求与第 21 章验收方案提供可追溯的“UC→FR→AC”主线。

------

## 5.1 参与方与系统边界

| 参与方/泳道            | 描述与职责                                                   |
| ---------------------- | ------------------------------------------------------------ |
| 用户（匿名/登录/订阅） | 触发查词、再生成、切换难度/风格，管理画像、历史与导出，发起订阅与续费。 |
| 前端（Web/H5）         | 输入校验（仅词或词组）、语言识别提示、UI 渲染、模块开关/顺序/详略控制、下载链接处理。 |
| 词典后端（Glancy）     | 配额与限流、缓存策略、提示词模板封装、结构化契约校验、历史留存与清理、审计与告警。 |
| Doubao API             | 生成释义、例句、搭配、同反义与派生；遵循结构化契约输出。     |
| 登录提供方             | 邮箱与第三方登录（微信、Apple、Google），返回身份令牌。      |
| 支付与订阅平台         | 订阅开通/续费/到期回调，对账与异常处理。                     |
| 任务调度/存储          | 延迟物理清理（T+7d）、导出打包与一次性下载链接生成（TTL 10 分钟）、归档与审计日志。 |

------

## 5.2 核心业务流程（泳道文字版）

> 详图请见“附录·图示：系统上下文与时序（26.x）”，本处为可执行级文字流程。

### 5.2.1 首次使用与登录

1. 用户打开页面 → 前端加载默认语言对与主题。
2. 若未登录：可匿名查词；提示可登录以启用历史留存与订阅权益。
3. 登录/注册：前端拉起登录提供方，后端校验并创建会话与用户档案初值（画像为空、默认设置）。
4. 首次进入展示并确认《使用条款/隐私》；记录审计事件。

### 5.2.2 查词（主流程）

1. 输入校验：仅允许“单词或词组”；若为整句，弹出提示并拒绝提交。
2. 语言识别与白名单检查：不在 L1–L4 列表则拒绝并提示（可切换语言对重试）。
3. 配额与限流：校验“每日查词上限”；超限返回 429 与剩余冷却时间。
4. 缓存查询：先查 L1（用户级，TTL 10 分钟），未命中再查 L2（共享级，TTL 30 分钟）。
5. 未命中则生成：
   - 组装 Prompt（结合画像、风格标签与详略级别），附幂等键 hash(user_id+entry+config)。
   - 调用 Doubao API（重试/超时/熔断生效）。
   - 校验返回是否满足 glancy.dict.v1 契约；失败则按降级策略回退到“基础释义+模板例句”。
6. 结果渲染：按模块优先级与详略级展示；同语模式不显示译文。
7. 历史落库：若开启留存则写入；无痕模式仅会话渲染态，不落库。
8. 记录指标：trace_id、延迟、缓存命中、tokens_in/out、错误率分类。

### 5.2.3 再生成与难度/风格切换

1. 用户在结果页点击“再生成”或切换“难度/风格”。
2. 校验“再生成”日配额；超限则提示。
3. 生成策略：
   - 再生成默认绕过 L2 共享缓存，优先 L1 命中新变体；必要时强制新采样以提升多样性。
   - 切换难度/风格等同一次再生成（计入再生成配额，不计入查词配额）。
4. 渲染新版本；保留本次会话内“版本切换”能力。

### 5.2.4 历史记录、清理与导出

1. 列表：按时间倒序，支持按语言对过滤。
2. 清理：支持“清理 zh 组/清理 en 组/全部清空”，触发二次确认；立即逻辑删除，T+7d 物理清理。
3. 导出：发起 CSV/JSON 打包任务，返回一次性下载链接（TTL 10 分钟）与回执号。

### 5.2.5 画像与偏好管理

1. 用户设置学习目标、专业背景、当前水平、风格标签与模块详略；
2. 保存至本地缓存与后端画像；影响后续生成排序与可读性映射。

### 5.2.6 订阅开通、续费与到期降级

1. 用户发起开通/续费 → 跳转支付 → 支付成功回调。
2. 后端校验并同步档位（普通/Plus/Pro），即时生效：查词上限、再生成上限、历史留存与模块自定义能力等。
3. 到期：自动降级到普通档并同步能力边界；若处于 Grace，展示提醒条。
4. 异常：支付超时/回调丢失，轮询兜底并幂等更新。

### 5.2.7 异常、限流与降级

1. 限流/超额：返回 429，UI 提示剩余时间。
2. Doubao 5xx/超时：进入熔断，前端展示降级提示与基础释义。
3. 契约解析失败：重试若仍失败，输出兜底结构与告警。
4. 登录与订阅异常：保持会话安全，展示只读/受限状态。

------

## 5.3 业务规则（BR）

| 编号  | 规则                                                         | 依据与说明                  |
| ----- | ------------------------------------------------------------ | --------------------------- |
| BR-01 | 输入必须为“单词或词组”，整句一律拒绝并提示。                 | 见 1.4.2。                  |
| BR-02 | 仅支持语言对白名单 L1–L4；同语模式不显示译文。               | 见 1.4.1。                  |
| BR-03 | 查词配额与再生成配额分离，按自然日重置；跨端共享。           | 见 1.4.3。                  |
| BR-04 | 模块按优先级渲染；详略级别受档位与用户设置影响；超限裁剪。   | 见 1.4.3 与“统一详略级别”。 |
| BR-05 | L1/L2 双层缓存：L1 用户级 10 分钟，L2 共享级 30 分钟；再生成默认绕过 L2。 | 见 1.4.7 与术语表。         |
| BR-06 | 降级策略：依赖异常时回退“基础释义+模板例句”，并标注退化提示。 | 见 1.4.7。                  |
| BR-07 | 历史：普通 10d/100 条；Plus 90d/1000 条；Pro 永久；无痕模式不落库。 | 见 1.4.3 分层与 1.4.4。     |
| BR-08 | 清理语义：逻辑删除即时；物理清理 T+7d；导出链接 TTL 10 分钟，一次性使用。 | 见 1.4.3、1.4.7 与术语表。  |
| BR-09 | 订阅到期自动降级；档位为单一事实源，影响配额、历史、模块自定义等能力。 | 见 1.4.4–1.4.5。            |
| BR-10 | 幂等：同一 user+entry+config 生成请求具备幂等键；重试不重复计数。 | 见术语“幂等键”。            |

------

## 5.4 用例清单（UC 索引）

> 优先级采用 Must/Should/Could/Will not；后续在第 6 章为每个 UC 映射 FR-* 编号。

| UC 编号 | 名称                       | 主要参与者         | 优先级 |
| ------- | -------------------------- | ------------------ | ------ |
| UC-01   | 查询词条                   | 用户、后端、Doubao | Must   |
| UC-02   | 再生成例句                 | 用户、后端、Doubao | Must   |
| UC-03   | 难度/风格切换              | 用户、后端、Doubao | Must   |
| UC-04   | 查看与筛选历史             | 登录用户、后端     | Must   |
| UC-05   | 清理历史（按语言/全部）    | 登录用户、后端     | Must   |
| UC-06   | 导出历史（CSV/JSON）       | 登录用户、后端     | Should |
| UC-07   | 设置个性化画像与模块偏好   | 登录用户、后端     | Must   |
| UC-08   | 订阅开通/续费              | 登录用户、支付平台 | Must   |
| UC-09   | 到期自动降级               | 后端、支付平台     | Must   |
| UC-10   | 登录/注册（邮箱/第三方）   | 用户、登录提供方   | Must   |
| UC-11   | 无痕查询                   | 用户、后端         | Should |
| UC-12   | 切换语言对并重查           | 用户、后端         | Should |
| UC-13   | 限流/配额用尽提示          | 用户、后端         | Must   |
| UC-14   | 降级与熔断回退             | 用户、后端、Doubao | Must   |
| UC-15   | 账单与收据查看             | 登录用户、后端     | Should |
| UC-16   | 撤回隐私同意与数据删除请求 | 登录用户、后端     | Should |

------

## 5.5 典型用例规格说明

> 规格模板字段：目标、参与者、前置条件、后置条件、主成功场景、扩展/异常、数据与日志、NFR 提示。

### UC-01 查询词条

- **目标**：在满足白名单与配额前提下，返回结构化结果页。
- **参与者**：用户（匿名或登录）、前端、后端、Doubao。
- **前置条件**：输入为词或词组；语言对白名单 L1–L4；查词配额未用尽。
- **后置条件**：若开启历史留存则写入一条记录；更新配额计数与指标。
- **主成功场景**
  1. 前端校验输入与语言对；
  2. 后端校验配额与限流；
  3. L1/L2 缓存命中则直接返回；未命中则调用 Doubao；
  4. 校验 glancy.dict.v1 契约并渲染模块；
  5. 写入历史（无痕跳过）。
- **扩展/异常**
  - 1a 句子输入：提示“请改为词或词组”。
  - 2a 超配额：返回 429 与剩余冷却时间。
  - 3a Doubao 超时/5xx：转 UC-14。
- **数据与日志**：trace_id、tokens_in/out、缓存命中位、延迟 P50/P95、错误码。
- **NFR**：端到端 P95 ≤ 2.5s；结构化输出正确率 ≥ 99%。

### UC-02 再生成例句

- **目标**：在不重复计入查词次数的前提下，产出新的例句变体。
- **前置条件**：已有查询结果；再生成配额充足。
- **主成功场景**：校验配额 → 组装新变体 Prompt（继承画像与风格）→ 调用 Doubao（绕过共享缓存）→ 渲染版本切换。
- **异常**：配额不足提示；依赖异常转 UC-14。
- **NFR**：单次再生成平均 ≤ 1.0s（缓存命中除外）。

### UC-03 难度/风格切换

- **目标**：依据可读性映射与风格标签生成同义项下的新表达。
- **规则**：计入再生成配额；不计查词配额。
- **流程**：读取画像 → 更新 Prompt 控制项（难度/风格）→ 生成与渲染 → 记录操作事件。

### UC-04 查看与筛选历史

- **目标**：按时间与语言对浏览查询记录，支持分页。
- **前置条件**：登录且开启历史留存。
- **流程**：前端请求列表 → 后端返回脱敏字段与分页游标 → 用户展开明细。

### UC-05 清理历史（按语言/全部）

- **目标**：按语言对或全部清理历史。
- **规则**：二次确认；立即逻辑删除，T+7d 物理清理；可恢复窗口在物理清理前有效。
- **异常**：无权限或未登录则拒绝。

### UC-06 导出历史（CSV/JSON）

- **目标**：生成一次性下载链接并回执。
- **流程**：提交导出请求 → 异步打包 → 返回链接（TTL 10 分钟）与回执号 → 下载完成即失效。
- **NFR**：≤5s 返回回执与链接；导出脱敏、UTF-8、带表头。

### UC-07 设置个性化画像与模块偏好

- **目标**：保存学习目标、背景、水平、风格标签与模块详略/顺序。
- **效果**：影响 Prompt 与结果排序；Plus/Pro 解锁更多标签与自定义。

### UC-08 订阅开通/续费

- **目标**：完成支付并即时生效档位能力。
- **流程**：创建订单 → 跳转支付 → 成功回调 → 幂等更新档位与权益 → 前端展示“已生效”。
- **异常**：回调丢失/超时 → 轮询兜底；失败退款按平台规则处理。

### UC-09 到期自动降级

- **目标**：到期后回退到“普通档”并同步能力边界。
- **触发**：到期轮询或平台回调。
- **结果**：减少配额与历史留存上限；保留数据不丢失但受新上限约束。

### UC-10 登录/注册（邮箱/第三方）

- **目标**：安全创建/验证身份并建立会话。
- **流程**：前端发起 → 第三方完成授权 → 后端换取令牌 → 创建/合并账号 → 会话下发。
- **合规**：首次登录展示并记录条款同意；设置中提供撤回入口。

### UC-11 无痕查询

- **目标**：不持久化历史，仅渲染当次结果。
- **规则**：仍计入实时配额与限流；下载导出不可用。

### UC-12 切换语言对并重查

- **目标**：在同一词条上切换 L1–L4 并重查。
- **流程**：切换语言对 → 清理与语言对相关的缓存键 → 重新发起 UC-01。

### UC-13 限流/配额用尽提示

- **目标**：在用户维度限流或配额耗尽时，明确提示剩余冷却时间与可用操作（如升级订阅）。
- **结果**：HTTP 429 与 UI 提示；记录告警阈值。

### UC-14 降级与熔断回退

- **目标**：依赖异常时仍保证可用与可理解。
- **策略**：基础释义+模板例句；标记退化徽标；后台告警与半开探测恢复。

### UC-15 账单与收据查看

- **目标**：展示订阅档位、生效/到期时间与订单号；可下载收据。

### UC-16 撤回隐私同意与数据删除请求

- **目标**：撤回后停止非必要处理；提交删除请求后按逻辑删除即刻生效、T+7d 物理清理。
- **影响**：关闭历史留存；部分功能受限（导出不可用）。

------

## 5.6 用例到功能需求（FR）映射预案

> 第 6 章将以此为骨架补齐 FR-*，本处先给出映射占位。

| UC    | 预期 FR（占位）                                  |
| ----- | ------------------------------------------------ |
| UC-01 | FR-01 查词请求与结构化渲染；FR-02 缓存与契约校验 |
| UC-02 | FR-03 再生成与变体管理                           |
| UC-03 | FR-04 难度/风格控制                              |
| UC-04 | FR-05 历史列表与过滤                             |
| UC-05 | FR-06 历史清理与恢复窗口                         |
| UC-06 | FR-07 导出任务与下载链接                         |
| UC-07 | FR-08 画像与偏好存储                             |
| UC-08 | FR-09 订阅开通与权益同步                         |
| UC-09 | FR-10 到期降级与状态机                           |
| UC-10 | FR-11 登录与会话管理                             |
| UC-11 | FR-12 无痕模式                                   |
| UC-12 | FR-13 语言对切换                                 |
| UC-13 | FR-14 限流与配额提示                             |
| UC-14 | FR-15 降级与熔断策略                             |
| UC-15 | FR-16 账单与收据                                 |
| UC-16 | FR-17 同意/撤回与删除工单                        |

------

## 5.7 事件与日志（可观测性对齐）

| 事件代码              | 触发时机       | 关键字段（示例）                                        |
| --------------------- | -------------- | ------------------------------------------------------- |
| `query.request`       | UC-01 提交     | user_id, entry, lang_pair, config_hash, trace_id        |
| `query.success/fail`  | UC-01 结束     | latency_ms, cache_hit(L1/L2), tokens_in/out, error_code |
| `regen.request`       | UC-02/03 提交  | reason(regen/difficulty/style), variant_id              |
| `history.export`      | UC-06 回执返回 | receipt_id, format, size, ttl                           |
| `subscription.change` | UC-08/09 成功  | from_tier, to_tier, order_id, effective_at, expire_at   |
| `privacy.withdraw`    | UC-16 撤回     | consent_revoked_at                                      |

------

## 5.8 验收要点（与第 21 章联动）

- UC-01～UC-05、UC-08～UC-14 标记为“首轮验收必测”；
- 每个 UC 至少提供 3 个契约回放样本，发布前 CI 校验 ≥500 条契约样本通过；
- 关键 SLO：首屏查词 P95 ≤ 2.5s，导出回执 ≤ 5s，登录成功率 ≥ 99%。

------

> 本章定义的流程、规则与用例与“分层功能说明、订阅权益、技术最小集、术语表”保持一致；后续章节（FR、NFR、接口契约、测试方案）以此为唯一参照展开与对齐。