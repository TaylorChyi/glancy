# FR-091 到期与降级处理（Must）

- **前置**
  - Plus 账号已开启自定义模块和较高历史上限。
  - 计费系统可触发 `SUBSCRIPTION_EXPIRED` 或 `SUBSCRIPTION_REVOKED` 事件。
  - 历史表含超出 Free 上限的记录，以观察回退效果。
- **步骤**
  1. 触发到期事件，观察 UI 与 `GET /subscription` 是否立即显示 Free 档。
  2. 检查模块自定义设置是否回退到默认（例如例句详略重置为中）。
  3. 查看历史记录，确认大于 Free 上限的旧记录被标记待清理或隐藏。
  4. 若发生降级后再次收到成功支付，确认自动升级并恢复自定义设置。
- **期望**
  - 到期后立即更新配额、模块能力与 UI 文案，并通知用户。
  - 超出新档位的自定义项被安全回退，不出现异常配置。
  - 历史记录遵循新上限，多余部分排队清理但可提供导出/提醒。
- **数据**
  - API：`GET /api/v1/subscription`、`GET /api/v1/settings/modules`、`GET /api/v1/history`。
  - 事件：`subscription.downgraded`、`history.truncate_scheduled`。
  - 阈值：Free 历史 ≤100 条（示例）。
- **优先级**：P0（Must）
- **关联 UC**：UC-09
- **关联 AC**：AC-FR-091，AC-UC-09
