# FR-051 限速与突发控制（Should）

- **前置**
  - Gatling/JMeter 压测脚本，可在 1 分钟内将查词流量从 10 QPS 拉升至 200 QPS。
  - 具备多租户账号或在 Header 中注入 `X-Tenant-Id` 以模拟租户级限流。
  - 前端 UI 已实现剩余冷却时间提示。
- **步骤**
  1. 单一用户在 10 秒内发起 ≥30 次查词触发用户级限流，观察响应 Header 与 UI 提示。
  2. 同一租户下并发 200 QPS，逼近租户级桶上限，捕捉返回 429 对象，确认 `error.meta.limitScope=tenant`。
  3. 继续提升到 900 QPS，触发全局限流，验证告警记录以及 UI 提示“系统繁忙”。
  4. 记录每种限流下的 `X-RateLimit-Limit/Remaining/Reset` 与 `X-Quota-Type`，并检查日志写入限流类型。
- **期望**
  - 用户级/租户级/全局限流均返回统一错误码 `RATE_LIMITED`，`meta.kind` 指明 scope，UI 显示冷却倒计时。
  - Header 显示对应桶的 limit、remaining、reset 秒数，且 Reset 时间与监控一致。
  - 观测系统记录 `rate_limit.triggered` 指标，包含 `scope`，供 SLO 告警。
- **数据**
  - API：`POST /api/v1/lookup`、`POST /api/v1/lookup/{id}/regenerate`、`POST /api/v1/exports`（导出写操作）。
  - Header：`X-RateLimit-Limit`, `X-RateLimit-Remaining`, `X-RateLimit-Reset`, `X-Quota-Type`。
  - 压测脚本参数：用户级限流阈值 20 req/30s，租户级 300 req/60s，全局 800 req/60s（示例）。
- **优先级**：P1（Should）
- **关联 UC**：UC-01，UC-02，UC-03，UC-06
- **关联 AC**：AC-FR-051，AC-UC-02，AC-UC-03，AC-UC-06
