# FR-041 订阅状态与能力同步（Must）

- **前置**
  - Sandbox 支付网关，可模拟 `PAYMENT_SUCCEEDED`、`SUBSCRIPTION_EXPIRED`、`REFUND_COMPLETED` 回调。
  - 监控 `subscription.state` 表、配额域、历史留存配置。
  - 幂等键=`transactionId`，需准备重复回调测试。
- **步骤**
  1. 触发 `PAYMENT_SUCCEEDED`（升级 Free→Plus），计时权限同步至 UI（目标 ≤3 s）。
  2. 立即调用 `GET /api/v1/quota` 与 `GET /api/v1/settings/modules`，确认档位能力（例句次数、历史上限）更新。
  3. 重放相同回调，验证状态未被重复写入且接口返回 200 幂等响应。
  4. 发送 `SUBSCRIPTION_EXPIRED` 回调，确认降级和限制同步；同时检查自动重放队列中失败任务是否补偿。
- **期望**
  - 支付成功后 3 秒内 `tier` 字段变为 Plus，配额/模块配置同步；UI 提示“升级成功”。
  - 重放相同事务 ID 时系统检测幂等并返回 `status=ignored`。
  - 到期事件触发降级、缓存失效、历史留存上限回退；异常回调会进入重试队列并最终成功。
- **数据**
  - API：`POST /api/v1/subscriptions/webhook`、`GET /api/v1/quota`、`GET /api/v1/subscription`。
  - 事件：`subscription.changed`（含 `oldTier`, `newTier`, `latencyMs`）。
  - 回调 payload：见第 11 章状态机定义。
- **优先级**：P0（Must）
- **关联 UC**：UC-08，UC-09
- **关联 AC**：AC-FR-041，AC-UC-08，AC-UC-09
