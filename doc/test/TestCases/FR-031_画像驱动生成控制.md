# FR-031 画像驱动的生成控制（Should）

- **前置**
  - Pro 账号 2 个画像版本：Profile A（目标=托福、水平=Intermediate），Profile B（目标=商务写作、水平=Advanced）。
  - Tracing 工具可读取 `profile_etag`、`promptProfile` 字段。
  - 缓存需可观测 `X-Cache` 命中与失效。
- **步骤**
  1. 用 Profile A 查询 `eloquent`，记录例句风格、释义用词与 trace 中的画像映射。
  2. 更新画像为 Profile B，再次查询相同词条，观察响应中的 `profile_etag` 和模块内容变化。
  3. 检查第二次查询的 `X-Cache` 是否为 MISS，并在日志中确认缓存失效事件。
  4. 清空画像（默认模板），再次查询，验证系统退回通用模板。
- **期望**
  - Profile A 与 Profile B 对应的 Prompt 控制项不同，例句/释义呈现的难度、词汇选择发生可观的变化，并在 trace 中可追溯。
  - 画像更新会使 `profile_etag` 变化并触发缓存失效，新的查询不命中旧缓存。
  - 画像为空时使用通用模板，输出回到默认难度，日志记录 `profile.source=default`。
- **数据**
  - API：`POST /api/v1/lookup`（响应 Header：`X-Profile-Etag`、`X-Cache`）。
  - Trace 字段：`prompt.profile.level`, `prompt.profile.goal`。
  - 词条：`eloquent`。
- **优先级**：P1（Should）
- **关联 UC**：UC-01，UC-02，UC-03
- **关联 AC**：AC-FR-031，AC-UC-01，AC-UC-02，AC-UC-03
