# FR-004 查词幂等与重试（Must）

- **前置**
  - 登录 Pro 用户，浏览器开启网络限速（Fast 3G）以便复现重试场景。
  - 记录 `subject_id`、`profile_etag`，并确保客户端会发送 `Idempotency-Key` Header。
  - 清空“历史”列表，确认配额余量充足。
- **步骤**
  1. 输入 `meticulous`，在请求发出后 1 秒内再次点击“查询”。
  2. 观察网络面板中两次请求的 `Idempotency-Key` 与响应体，记录返回时间。
  3. 打开历史列表，确认新增条目数量；检查“今日查词”配额是否只扣减 1 次。
  4. 手动调用 `POST /api/v1/lookup`，复用同一 `Idempotency-Key`，确认响应立即返回 cache 命中。
- **期望**
  - 后端用相同幂等键识别重复请求，第二次响应为 200 且 `X-Cache=IDEMPOTENT_REPLAY`，返回体与首次一致。
  - 历史列表只新增 1 条记录，配额面板扣减 1 次；日志中无重复写入。
  - 人工重放的请求未触发计费/落库，`X-Quota-Consumed=0`。
- **数据**
  - API：`POST /api/v1/lookup`，Header 含 `Idempotency-Key`、`X-Profile-Etag`。
  - 观测：历史 `GET /api/v1/history?limit=10`；配额 `X-Quota-*` Header。
  - 词条：`meticulous`。
- **优先级**：P0（Must）
- **关联 UC**：UC-01
- **关联 AC**：AC-FR-004，AC-UC-01
