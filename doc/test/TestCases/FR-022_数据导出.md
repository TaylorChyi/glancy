# FR-022 数据导出（Must）

- **前置**
  - Free 与 Pro 账号；历史数据≥50 条以验证分页导出。
  - 后台任务队列可通过 `GET /api/v1/exports/{exportId}` 轮询状态，并可访问审计日志 `export.task`。
  - 预配置对象存储桶，校验下载链接 TTL 10 分钟且一次性；可注入存储故障模拟 `X-Debug-Export-Fail=true`。
- **步骤**
  1. Free 账号在 UC-06 点击“导出历史”，仅选择 CSV，提交 `POST /api/v1/exports`，记录 202 响应 Header `Retry-After` 与 `exportId`、`receiptId`。
  2. 轮询 `GET /api/v1/exports/{exportId}` 直至状态从 `QUEUED→RUNNING→SUCCEEDED`，确认 `estimate.ttlSeconds=600`，并比对 `Retry-After` 与下一次轮询间隔。
  3. 下载生成的 CSV，校验编码为 UTF-8、含表头，敏感字段脱敏且行数≤请求时间窗条目数。
  4. Pro 账号以 JSON 格式并添加过滤条件（语言对=zh→en、时间范围=最近 7 天）发起导出；验证响应同样 ≤5 s 获得下载链接。
  5. 对 Pro 导出的链接进行二次访问，确认一次性失效；超过 10 分钟后访问返回过期提示。
  6. 人为触发 LLM 降级（暂停 Doubao 依赖），再次请求导出，观察 `degraded=true` 与降级原因。
  7. 注入对象存储失败（`X-Debug-Export-Fail=true`），等待任务进入 `FAILED`，验证响应体携带 `error.code=EXPORT_DELIVERY_FAILED` 并在审计中记录失败。
- **期望**
  - Free 档位仅显示 CSV 选项；Pro 页面提供 CSV/JSON 与过滤控件。
  - 导出任务响应 202 并在 Header 返回 `Retry-After`，轮询接口在 5 秒内返回下载 URL，状态流转遵循 `QUEUED→RUNNING→SUCCEEDED/FAILED`。
  - 下载产物满足脱敏要求，字段顺序固定；JSON 输出遵循 `history.exportReceipt` schema。
  - 下载链接只能使用一次，超时后返回 410 并提示重新导出。
  - 降级场景响应体包含 `degraded=true` 和 `meta.reason`，失败场景写入 `export.task` 审计并不计入导出配额。
- **数据**
  - API：`POST /api/v1/exports`、`GET /api/v1/exports/{exportId}`、对象存储临时 URL。
  - Header：`Retry-After`、`Content-Type=text/csv`|`application/json`、`Content-Disposition`。
  - 样例过滤：`{ "langPair": "zh-en", "from": "2024-05-01", "to": "2024-05-08" }`。
  - 验证字段：`receiptId`, `link.ttlSeconds`, `link.oneTime=true`, `statusHistory[*].state`。
- **优先级**：P0（Must）
- **关联 UC**：UC-06
- **关联 AC**：AC-FR-022，AC-UC-06
