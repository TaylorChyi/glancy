# FR-100 首屏渐进渲染（Should）

- **前置**
  - 浏览器或 curl 支持 SSE/WebSocket 录制，能够捕获 `first_chunk_latency`、`moduleId` 顺序，并可检查响应头 `Content-Type`。
  - 网络分析工具（如 Chrome Performance）可测首个内容模块渲染时间；可启用性能标记 `performance.mark('module_definitions_rendered')`。
  - 具备模拟模块失败与限速的开关（`X-Debug-Fail-Module=examples`、`X-Debug-Delay-Chunk=definitions:800ms`）。
- **步骤**
  1. 使用 `curl -N -H "Accept: text/event-stream"` 调用 `GET /api/v1/lookup/stream?entry=perspective`，记录握手头部与首个 `data:` 片段到达时间。
  2. 在 Web 端触发同一查询，记录从点击到收到第一条流式数据/首个模块渲染的时间，并对照埋点 `first_chunk_latency`。
  3. 监听 SSE 流，验证 `definitions` 模块先到达，其次是 `examples`、`collocations` 等；记录 chunk 顺序、`moduleId` 与分片间隔。
  4. 注入 `X-Debug-Fail-Module=examples`，再次请求，观察例句模块失败提示是否局部呈现且不阻塞其它模块。
  5. 设置 `X-Debug-Delay-Chunk=definitions:800ms`，确认前端仍在 2.5 s 内显示骨架屏，并在 chunk 到达后自动替换为实际内容。
  6. 刷新页面，确认每个模块都有独立的错误提示与重试入口，重试仅重新请求单模块。
- **期望**
  - SSE 握手返回 `HTTP 200`、`Content-Type: text/event-stream`、`Transfer-Encoding: chunked`，首个 chunk P95 ≤ 2.5 s、平均 ≤ 1.2 s。
  - 流式 chunk 顺序固定（释义优先），每个 chunk 含 `moduleId` 与递增 `sequence`，分片间隔 ≤400 ms（性能章节阈值）。
  - 指定模块失败时，其他模块照常渲染，失败模块显示“稍后重试”并提供重试按钮，错误不冒泡到全局，日志写入 `module.failure`。
  - 注入延迟时骨架屏持续展示，chunk 抵达后平滑过渡，无闪烁；延迟事件计入观测指标 `stream.chunk_delay`。
- **数据**
  - SSE 端点：`GET /api/v1/lookup/stream?entry=perspective`（或 WebSocket 等价接口）。
  - 指标：`first_chunk_latency`, `module_render_duration`, `stream_chunks_dropped`, `stream.chunk_delay`。
  - Debug Header：`X-Debug-Fail-Module`、`X-Debug-Delay-Chunk`；`Last-Event-Id` 用于断线重连测试。
- **优先级**：P1（Should）
- **关联 UC**：UC-01，UC-14
- **关联 AC**：AC-FR-100，AC-UC-01，AC-UC-14
