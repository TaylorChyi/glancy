# 缺陷跟踪报告模板（DefectReport.md）

> 面向测试、研发与运维的统一缺陷记录模板，兼容 `doc/需求说明文档/第 20 章 验收标准与测试方案（UC 对齐）.md` 中的发布门槛、回滚策略（DR-05）与缺陷分级（20.16）。

## 1. 填写模板

> 将下列段落复制到缺陷系统或 PR 描述中，按需补充 `[]` 内内容。

```markdown
# [缺陷标题]
- ID：DEF-[编号]
- 版本/环境：Prod | Staging | Dev（含构建号/时间戳）
- 模块/子系统：[BFF / LLM 适配层 / 导出 / 订阅 ...]
- 严重度：S[0-3]
- 优先级：P[0-3]
- 归属人/团队：[Owner]
- 计划修复版本：Release-[YYWW]/Hotfix-[日期]

## 重现步骤
1. [...]
2. [...]

## 期望结果
- [...] （对应契约/UC/验收条目）

## 实际结果
- [...]（含接口/告警/监控截图编号）

## 截图 / 日志 / 监控
- 图片：`/evidence/DEF-[编号].png`
- 日志：`s3://log-bucket/...`
- Trace/Metric：`trace_id=...` / `metric=...`

## 额外背景
- 发布窗口 / 变更单：[#change-id]
- 影响范围：租户 / 用户数 / 金额
- 回滚动作：已触发 | 不需要（理由）
```

## 2. 严重度与优先级刻度

### 2.1 严重度（S）刻度、告警映射与响应时限

| 严重度 | 描述 / 影响 | 告警策略 | 首响 (检测→响应) | 处置 / 回滚要求 |
| --- | --- | --- | --- | --- |
| **S0** | 生产级中断、数据错乱、契约/安全红线，等同 20.16 的 **P0** 退出条件 | PagerDuty P0、短信/电话；联动 `HK-02`、`HK-04` 等硬性监控 | ≤5 分钟 | 立即灰度隔离并执行 DR-05 自动回滚；禁止继续发布，需召开 WAR-Room |
| **S1** | 核心 UC 主路径受阻、有功能降级但可绕过；对应 20.16 **P1** | PagerDuty P1、IM 红色告警；生成变更单并更新运行手册 | ≤15 分钟 | 2 小时内出修复/降级方案；若无法缓解需评估局部回滚或 Kill Switch |
| **S2** | 非核心路径或边缘案例，存在输出错误但不阻断主流程 | IM 橙色告警或 Jira 看板提醒；每日巡检汇总 | ≤4 小时 | 纳入最近两个迭代计划；可随下次常规发布一并修复 |
| **S3** | 低影响、UI 细节或文案问题，对业务零影响 | 无自动告警，记录于缺陷库 | ≤2 个工作日 | 可合入任意版本或批量关闭 |

> 告警源需在监控面板中显式标记 `severity=S*`，以便运维脚本匹配告警抑制策略（20.15 “告警抑制”）。

### 2.2 优先级（P）刻度

| 优先级 | 修复期望 | 与发布/回滚的关系 |
| --- | --- | --- |
| **P0** | 立即热修 / 热回滚 | 阻断当前发布窗口，所有待发布变更需暂停，直到缺陷关闭；与 S0 强绑定 |
| **P1** | 本发布列车（≤24h） | 需在下一次发布列车结束前合入；若无法修复需更新已知问题并通过发布评审审批 |
| **P2** | 下一个迭代（≤2 周） | 不阻断发布；需在版本计划中标记并跟踪 |
| **P3** | 待排期 / 观察 | 可合并处理；定期回顾淘汰 |

> 当 S 与 P 不一致时，以更高等级的动作为准（例如 S1/P2 → 按 P1 执行）。

## 3. 流程与状态机（新建→确认→修复→验证→关闭→回退）

| 状态 | 责任人 | 进入条件 | 下一步 & 钩子 |
| --- | --- | --- | --- |
| **新建** | 发现人 | 缺陷记录创建，至少包含标题、环境、严重度初判 | → **确认**：测试/DEV 审核是否可复现 |
| **确认** | 模块 Owner | 复现、补充日志、更新严重度/优先级，与 `doc/需求…/20.16` 的放行标准比对 | 若命中 S0/S1：触发发布冻结，挂钩 DR-05 回滚；确认完成→ **修复** |
| **修复** | 开发 Owner | 提交补丁、关联变更单/PR、注明修复版本 | 合并后→ **验证**；若修复失败或需要紧急回滚，进入 **回退** |
| **验证** | QA / On-call | 执行重现步骤 + 回归（含契约回放 ≥500 样本、降级演练） | 通过→ **关闭**；若复现仍失败→回到 **修复** |
| **关闭** | 模块 Owner | 验证通过且在发布审计中留痕；若为 P0/P1，需在发布评审中确认 | 发布成功后 24h 内复查监控；若出现回归→ **回退** |
| **回退** | 运维 / 发布经理 | 修复引入新缺陷或灰度失败，根据 DR-05 触发自动/人工回退 | 回退完成→ 状态重置为 **新建**（跟踪回退原因）或 **确认**（若需重新评估） |

状态机示意：`新建 → 确认 → 修复 → 验证 → 关闭`，其中任何状态在出现新信息或灰度失败时可转入 `回退`，再回到 `确认/修复` 继续处理。所有 S0/S1 缺陷在 `修复` 前必须先落实降级或回滚动作，以保障与发布/回滚流程一致。

## 4. 交付要求与建议

1. 缺陷报告需链接到相关的 UC/NFR/契约锚点，便于发布评审复核（参考 20.18）。
2. 附件（截图/日志/监控）统一放置在团队共享存储并以 `DEF-[编号]` 命名，确保发布审计可追溯。
3. 发布总结或回滚演练结束后，缺陷记录应更新“复盘结论”并附带补偿动作，以便下次演练复用。
