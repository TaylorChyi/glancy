# UC-02 基础释义降级回退

> 关联 SRS：第 1 章 1.4.7；第 4 章 4.2.7 / UC-14；第 5 章 FR-070；第 6 章 NFR-017；第 7 章 7.4.5；第 8 章 8.3（`degraded` 字段）；第 13 章 13.3–13.5；第 14 章 14.2；第 16 章 16.3；第 20 章 20.3 / 20.17 / 20.21；对应 AC：AC-UC-14、AC-UC-02、AC-NFR-003、AC-NFR-012。

## 基本信息
- `UC ID`：UC-02
- `用例名称`：基础释义降级回退
- `所属模块/史诗`：可用性与熔断 / Reliability
- `优先级`：P0
- `版本 / 修订历史`：v1.0（2024-05-01，@reliability）

## 1. 目的（SRS 第 4 章）
> 当 Doubao 或其他依赖不可用（≥5% 5xx 或超时）时，在 ≤1.8 s 内自动回退“基础释义 + 模板例句”并标记退化，保证核心理解体验、记录熔断状态、触发告警与半开探测，避免用户感知完全失败。

## 2. 参与者（SRS 第 4 章 4.1）
- Primary：词典 BFF / Reliability Orchestrator
- Supporting：Web/H5 前端（展示退化提示）、可观测性平台、Runbook 执行者（SRE）、缓存服务
- External Systems：Doubao LLM、成本护栏（Quota Guardrail）、熔断控制台、告警系统

## 3. 前置条件（SRS 第 4 章）
- 监控已配置 Doubao 5xx、超时与成本护栏指标；阈值：5xx ≥5% 且持续 1 分钟或超时率≥10%（第 13.3、16.3）。
- 降级模板与基础释义素材预置于本地（短缓存）并对 L1–L4 语言对齐全，模板例句支持 `aria-live` 播报（第 15 章 A11y-C22）。
- 熔断状态机（closed/open/half-open）与半开配额（默认 3）可配置，状态持久化到 Redis + `circuit_state` 观测指标。
- 事件管道与告警接通 Runbook（`lookup-availability`、`streaming-drop`）。

## 4. 触发（SRS 第 4 章）
- UC-01/UC-03 调用 Doubao 时检查依赖 SLA，满足阈值即切换到降级路径。
- 运维在 DR-01/DR-03 演练或人工开关下发“强制降级”命令。
- 成本护栏达到 95%（第 16 章）自动降级再生成。

## 5. 主成功场景（SRS 第 4 章）
1. 监控检测 Doubao 5xx ≥5% 且持续 ≥1 分钟，或超时率 ≥10%，或手工触发；熔断状态切换为 `OPEN`，记录 `degrade.event`。
2. 新到查词/再生成请求在 BFF 命中熔断开关，跳过 Doubao 调用，改用本地基础释义模板（缓存）与最近一次成功结果的结构骨架。
3. BFF 构造 `DictResult`，填入 `degraded=true`、`degradeReason`（如 `UPSTREAM_UNAVAILABLE`、`COST_GUARDRAIL`）、`modules` 仅包含基础释义/模板例句。
4. 响应经前端渲染时，顶部展示“已降级”提示条（可键盘关闭），`aria-live` 播报一次；查词配额仍计入（若为查词请求），再生成配额不扣减（FR-070）。
5. 观测：`doubao.circuit_state=open`、`degrade.rate`、`query.success`(degraded) 上报；告警抄送 AI 值班与 SRE。
6. 经过冷却时间后，熔断进入半开，允许 3 次探测请求调用 Doubao；若连续成功，状态切换为 `CLOSED` 并恢复正常链路。
7. 恢复后生成事件 `degrade.recovered`，Runbook 记录演练或故障编号；缓存失效，触发高质量结果刷新。

## 6. 备选 / 异常流（SRS 第 4 章）
- 2a 模板缓存失效：BFF 从备份对象存储加载基础释义模板；若仍失败，则返回最小 JSON（义项+提示），并强制提示“稍后重试”。
- 3a 成本护栏触发：查词改走强缓存结果，并在响应体 `meta.costGuardrail=true`；再生成返回 403 `GUARDRAIL_ACTIVE`（第 16 章 DR-06）。
- 6a 半开探测失败：检测请求返回异常后立即回滚到 `OPEN`，重新计时 1 分钟，并记录失败次数。
- R1 降级响应写入历史失败：只落 `lookups` 状态、跳过 `results/history`，保留 `degraded` 标记；后台 `history.degraded_retry` 任务异步补齐并在成功后更新 `history`。

## 7. 后置条件（SRS 第 4 章）
- 所有降级响应均写入 `lookups.status=degraded`，`results.payload.degraded=true`，保留 `degradeReason` 以便审计。
- `quota_daily` 仅在查词场景计数；再生成降级不计配额。
- 告警与 Runbook 记录熔断开始/结束时间、半开成功率、影响请求数。
- DR-01/DR-03 演练结果归档到发布工单与 13 章灾备记录；性能基线（P95 ≤1.8 s）更新。

## 8. 业务规则（SRS 第 4 章 & 第 5 章占位）
- BR-06：降级内容 = 基础释义 + 模板例句，必须标注退化提示。
- FR-070：Doubao API 容错、熔断、半开、恢复闭环；降级请求再生成配额不扣减。
- FR-050：降级响应同样返回 `X-Quota-*` 与 `X-RateLimit-*`。
- NFR-017：熔断触发、半开探测、回滚脚本必须演练。
- 第 13 章表 13-3：降级成功率 ≥99.9%，半开 3 次成功后闭合。

## 9. 数据契约引用（SRS 第 8 章）
- API-001/002：降级响应沿用 `POST /api/v1/lookup` 与 `.../regenerate` 契约，区别在于 `degraded=true`、`degradeReason`。
- Schema：`glancy.dict.v1.DictResult`（第 8.3.1）— `degraded/degradeReason`；`lookups.status`、`results.payload`（第 9.4）。
- 事件：`degrade.event`、`degrade.recovered`（第 4.7 事件表）、`audit_events`（第 9.5.3）记录熔断切换。

## 10. 非功能约束（SRS 第 20 章 20.3–20.5）
- 性能：降级路径 P95 ≤1.8 s（第 16 章 16.3）；熔断触发到退化响应≤5 s。
- 可用性：熔断策略需保证 `lookup/regenerate` 可用性 ≥99.9%，降级失败率 <0.1%。
- 可观测性：`doubao.circuit_state`、`degrade.rate`、`half_open.success_rate` 指标进入告警规则；Runbook 5 分钟内执行（第 14 章）。
- 安全/合规：降级仍遵循 TLS、匿名/登录鉴权、配额统计一致。
- 发布演练：每次发布（REL-B0）需执行 DR-01，验证脚本与回滚路径可用（第 20.21 表）。

## 11. 验收标准 AC（SRS 第 20 章 20.3–20.17）
- AC-UC-14（第 20 章 20.3.8，REL-B0/B4/B5）：Given Doubao 5xx ≥5% 且持续 ≥1 分钟 When 调用 `POST /api/v1/lookup` 或 `/regenerate` Then 熔断切换为 `OPEN`，响应 200 且 `degraded=true`、模块回退基础释义+模板例句，UI 显示退化徽标（TC-DEGRADE-001、DR-01）。
- AC-UC-02（第 20 章 20.5.6，REL-B2/B3）：Given 再生成请求命中降级 When 成本护栏≥95% Then 查词复用强缓存结果，再生成返回 403 `GUARDRAIL_ACTIVE` 且 `meta.costGuardrail=true`，查词配额不扣减（TC-QUOTA-001、DR-06）。
- AC-NFR-003（第 20 章 20.3.9，REL-B0）：Given 熔断进入半开 When 触发 3 次探测 Then 全部成功才闭合，否则立即回滚至 `OPEN` 并在 5 分钟内告警、记录 `circuit_transition`（DR-03）。
- AC-NFR-012（第 20 章 20.5.9，REL-B2/B4）：Given 抽查 10 分钟窗口 When 监控成本护栏与降级比率 Then 成本燃率 ≤1.2x 日预算、护栏触发后 P95 恶化 <10%，并向 `obs-reliability` 看板写入度量（成本脚本、TC-OBS-001）。

## 12. 备注（SRS 第 4 章 4.7–4.8 & 第 20 章 20.14）
- 观测：Grafana `obs-reliability` Dashboard 展示 `circuit_state`、`degrade.rate`、`guardrail.triggered`。
- 日志：`trace_id` + `circuit_transition`（from/to/原因）写入结构化日志；拉高采样率至 50% during incident。
- Runbook：`lookup-availability`、`streaming-drop`、`guardrail-engage`；演练记录写入 13 章 DR 附录。
- 依赖：与 UC-01/UC-03/UC-04/UC-05 联动；降级期间导出/订阅提示需展示“部分模块受限”提醒。***
