# UC-03 导出任务创建与下载

> 关联 SRS：第 4 章 UC-06；第 5 章 FR-020/022/080；第 8 章 8.5–8.6（API-101~103、API-201/202/403）；第 9 章 9.5（`history`、`export_jobs`、`deletion_tasks`、`audit_events`）；第 13 章 DR-04；第 20 章 20.3 / 20.11 / 20.17 / 20.21（AC-UC-06）。

## 基本信息
- `UC ID`：UC-03
- `用例名称`：导出任务创建与下载
- `所属模块/史诗`：历史与数据控制 / History & Export
- `优先级`：P0
- `版本 / 修订历史`：v1.0（2024-05-01，@data-engineering）

## 1. 目的（SRS 第 4 章）
> 允许登录用户在权限范围内按语言组导出查询历史，5 秒内获得回执与一次性下载链接（CSV/JSON），并确保脱敏、UTF-8、TTL 10 分钟、T+7d 清理与审计可追溯。

## 2. 参与者（SRS 第 4 章 4.1）
- Primary：登录用户
- Supporting：Web/H5 历史页、导出编排服务（export orchestrator）、对象存储、后台任务调度、通知中心
- External Systems：历史存储（`history`/`history_index`）、`export_jobs`、`deletion_tasks`、配额/订阅域（校验导出能力）

## 3. 前置条件（SRS 第 4 章）
- 用户已登录且开启历史留存（FR-020），并拥有导出权限（Free=CSV，Plus/Pro=CSV+JSON）。
- 历史库中至少存在一条符合筛选条件的记录，或允许返回空文件。
- 导出配额（按日）未耗尽；`export` Quota header将返回剩余额度。
- 对象存储 Bucket、KMS、访问策略已配置；导出模板（表头、脱敏字段）可用。
- 若用户为无痕模式，需提示“无痕记录不可导出”并阻止提交。

## 4. 触发（SRS 第 4 章）
- 用户在历史页点击“导出”，选择语言组/时间范围/格式并确认。
- REST API 客户端调用 `POST /api/v1/exports`（API-201）。
- 后台调度/客服触发补发导出（同 API）。

## 5. 主成功场景（SRS 第 4 章）
1. 前端读取当前导出权限（订阅档位）并收集过滤参数（语言组、时间、格式）；校验格式与权限匹配。
2. BFF 校验导出配额与并发限制，生成 `exportId`、`receiptId`，写入 `export_jobs(status=processing)`，响应 202（≤5 s）并返回 `quota` 镜像与预计完成时间。
3. 导出编排服务根据 `exportId` 拉取 `history_index`，按过滤条件分页读取，应用脱敏规则（不含原文/翻译，保留 entry/语言对/时间），写入临时对象存储。
4. 生成一次性 `downloadUrl`（TTL=600 s），更新 `export_jobs.status=finished`，写 `history.export` 与 `audit_events(export.requested)` 记录；通知前端通过 `GET /api/v1/exports/{id}` 轮询获取链接。
5. 用户点击下载链接，通过带签名 URL 获取 CSV/JSON 文件；对象存储记录一次性令牌使用，`audit_events(export.downloaded)` 追踪 IP 与 UA。
6. 下载成功后（或 TTL 到期）执行清理：标记 `downloadUrl` 失效，T+7d 删除对象；写 `export.deleted` 事件。

## 6. 备选 / 异常流（SRS 第 4 章）
- 2a 导出配额耗尽：返回 429 `RATE_LIMITED`，Header 提示 `X-Quota-Type=export`、重置时间；UI 引导升级或等待。
- 3a 对象存储/任务队列异常：`export_jobs` 状态置 `failed`，`error` 字段记录原因并触发告警；系统自动重试 ≤3 次，若仍失败则通知用户重新发起。
- 4a 队列积压 > 阈值：返回 202 但 `status=delayed`，在 UI 展示“预计晚于 5 s”，并开启 Runbook `exports-backlog`。
- 5a 下载链接过期：`GET /api/v1/exports/{id}` 返回 `status=expired` 或下载链接 410 `EXPORT_LINK_EXPIRED`；用户需重新发起导出。
- R1 打包过程中部分文件已生成但最终失败：回滚对象存储（删除半成品）、将 `export_jobs` 重置为 `pending` 并退回导出配额，写入 `export.rollback` 事件供审计。

## 7. 后置条件（SRS 第 4 章）
- 成功导出后，`export_jobs` 记录包含 filters、format、size、`downloadUrl`、`expiresAt`、`receiptId`。
- `audit_events` 写入 `export.requested/export.downloaded/export.deleted`，含 `trace_id` 与脱敏元数据。
- T+7d 定时任务 `deletion_tasks` 物理删除导出产物；历史记录本身不受影响。
- 导出配额 `quota_daily.export_count` +1；响应/通知中同步剩余额度。
- 导出完成通知/邮件可选发送，内容含 `receiptId` 与 TTL 提醒。

## 8. 业务规则（SRS 第 4 章 & 第 5 章占位）
- BR-07/08：历史能力与删除语义遵循订阅矩阵；导出链接 TTL 10 分钟，一次性使用。
- FR-020：留存窗口按档位；无痕记录不可导出。
- FR-022：CSV/JSON、UTF-8、表头固定、脱敏字段；P95 ≤ 5 s 获取链接。
- FR-080：逻辑删除/物理清理与导出回执写入 `deletion_tasks`。
- 安全：链接需签名、最小权限 RBAC、KMS 加密（第 12 章）。

## 9. 数据契约引用（SRS 第 8 章）
- API-101：`GET /api/v1/history`（列表），供前端选择导出范围。
- API-103：`POST /api/v1/history:clear`（与清理回执共享 `taskId` 字段）。
- API-201：`POST /api/v1/exports`（创建任务）；API-202：`GET /api/v1/exports/{id}`（轮询状态）；API-403：`GET /api/v1/receipts/{receiptId}`（回执状态）。
- Schema：`history.record`、`export_jobs`、`deletion_tasks`、`audit_events`（第 9.4–9.5）；导出文件遵循 `glancy.export.v1` 表头定义（第 8.6）。

## 10. 非功能约束（SRS 第 20 章 20.3–20.5）
- SLA：P95 ≤ 5 s 返回可用 `downloadUrl`；整体 RTO ≤ 15 分钟（20.21 表、DR-04）。
- 可用性：导出链路月度可用性 ≥99.5%；对象存储/编排服务冗余部署。
- 安全：链接一次性+TTL 600 s；TLS1.2+，对象存储加密（AES-256）、最小权限访问。
- 可观测性：`exports.backlog`、`export.duration`、`download.success_rate` 指标纳入 14.2 告警；`trace_id` 贯穿 UI→API→任务。
- 数据治理：导出文件不包含敏感原文，严格遵循字段脱敏（9.5），并在 T+7d 内物理删除。

## 11. 验收标准 AC（SRS 第 20 章 20.3–20.17）
- AC-UC-06：Given 用户选择 CSV When 调用 `POST /api/v1/exports` Then ≤5 s 收到 202 + `exportId/receiptId`，随后 `GET /exports/{id}` 在 5 s 内提供一次性链接，TTL=10 分钟（TC-EXPORT-001）。
- AC-UC-06-TTL：Given 下载链接过期 When 再次访问 Then 返回 410 `EXPORT_LINK_EXPIRED`，Audit 记录 `export.deleted`（DR-04）。
- AC-UC-06-Backlog：Given 导出队列被切换到备用节点 When 重新启用任务编排 Then ≤5 分钟内恢复导出能力（DR-04 / 发布前检查清单第 4 条）。

## 12. 备注（SRS 第 4 章 4.7–4.8 & 第 20 章 20.14）
- 观测：`exports.backlog`、`export.duration`、`download.success_rate`、`export_errors` 指标纳入 `obs-data-control` Dashboard。
- 日志：`trace_id` + `exportId` + `receiptId` 写入结构化日志，以支持审计与补偿。
- Runbook：`exports-backlog`、`export-link-expired`；异常需在 15 分钟内确认（DR-04 要求）。
- 依赖：与 UC-01（数据来源）、UC-04（订阅权限/配额）、UC-05（账单回执）联动；导出模板更新需同步契约样本库。***
