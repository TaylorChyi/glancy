# UC-04 订阅变更与配额一致性

> 关联 SRS：第 1 章 1.4.4–1.4.5；第 4 章 UC-08/UC-09；第 5 章 FR-041/090/091/050；第 8 章 8.8（API-401~404）；第 9 章 9.4（`plans`、`subscriptions`、`quota_daily`、`entitlement_events`）；第 10 章 10.2–10.4；第 11 章 11.5–11.12；第 20 章 20.3 / 20.12 / 20.17 / 20.21（AC-UC-08 / AC-UC-09）。

## 基本信息
- `UC ID`：UC-04
- `用例名称`：订阅变更与配额一致性
- `所属模块/史诗`：订阅与权益 / Subscription & Entitlement
- `优先级`：P0
- `版本 / 修订历史`：v1.0（2024-05-01，@billing-platform）

## 1. 目的（SRS 第 4 章）
> 确保升级、续费、降级、到期、退款、撤销等订阅事件在 ≤5 s 内完成档位切换，并与配额/历史/模块能力保持一致；支持幂等回调、补偿轮询与审计追踪，防止权益不一致与超配额。

## 2. 参与者（SRS 第 4 章 4.1）
- Primary：登录用户（升级/续费/降级）、系统调度（到期自动降级）
- Supporting：Web/H5 订阅页、订阅服务（billing service）、订单/支付服务、权益/配额域、前端展示模块
- External Systems：支付渠道（微信/支付宝）、Webhook 回调、配额服务（`quota`）、历史与导出域（受档位影响）、可观测性平台

## 3. 前置条件（SRS 第 4 章）
- 用户已登录并通过 KYC；`subscriptions` 记录存在或默认为 Free。
- 计划矩阵（`plans` 表）与价格（`prices`）最新，且 entitlement JSON 对齐第 1 章表格。
- 支付渠道配置完成，Webhook 签名验证正常；幂等键策略可用（`hash(user_id + plan_id + period + request_ts_bucket)`）。
- 配额服务、缓存（L1 10 分钟 / L2 30 分钟）可接收 `entitlement_events`。
- 到期任务（轮询+Webhook 重放）按 15 分钟粒度运行。

## 4. 触发（SRS 第 4 章）
- 用户在订阅页点击升级/续费/降级确认（UC-08）。
- 支付渠道回调支付成功/失败/退款/拒付。
- 定时任务检测到期或 Grace/PAST_DUE 状态（UC-09）。
- 管理控制台触发人工调整（支持幂等）。

## 5. 主成功场景（SRS 第 4 章）
1. 用户选择目标档位（Plus/Pro）与周期；前端展示权益差异与价格（第 11.4）。
2. BFF 调用 `POST /v1/orders`（11.14.1 API-12-002）创建订单并返回支付参数；用户完成支付，渠道回调或前端轮询 `POST /v1/orders/{id}/confirm`。
3. 订阅服务验证回调签名、校验幂等键，更新 `orders/transactions` 状态，并将 `subscriptions` 状态切到 `ACTIVE`（升级即刻生效）或 `GRACE/EXPIRED`（降级/到期）。
4. 生成新 entitlement（每日查词/再生成/历史留存/导出能力/模块开关等），写入 `entitlement_events` 并调用配额服务更新 `quota_daily` 镜像；缓存 L1/L2 失效，`/subscription` 与 `/quotas` API 立即反映。
5. 前端收到成功回执后 ≤5 s 内刷新 UI 与 banner，展示新档位权益、剩余天数、可导出格式等；历史与导出功能读取最新阈值。
6. 到期时（定时任务或渠道事件）执行自动降级：`subscriptions.status → EXPIRED`、Plan→Free、entitlement 下发新限额；如果 `cancel_at_period_end=true`，在到期日生效。
7. 全流程写入 `subscription.change` / `plan.changed` 事件与 `audit_events`，记录 from/to/trace_id；图形化看板显示延迟。

## 6. 备选 / 异常流（SRS 第 4 章）
- 2a 支付回调丢失：轮询渠道接口；若 5 s 未收到回调则发起一次内部补偿并在 15 分钟内重放，期间订单保持 `pending` 且不切换权益。
- 3a 幂等冲突：检测到重复订单/回调时返回 200 并不重复更新；记录 `idem_key` 日志供审计。
- 4a 配额服务 5 s 内未确认：标记 `entitlement_events` 为 `pending`，重试并告警；前端在 UI 顶部提示“权益同步中”，同时保留旧档位能力 ≤5 s（“更宽松不超限”策略）。
- 5a 自动降级后用户立即续费：订单支付成功，流程同升级；若在 Grace 期内则直接延长当前订阅，不产生降级指示。
- R1 配额同步失败并超过补偿重试：回滚 `subscriptions` 到旧档位（或 Free），冻结相关订单，触发 `entitlement.rollback` 事件并通知运维手动修复后重新下发。

## 7. 后置条件（SRS 第 4 章）
- `subscriptions`、`orders`、`transactions`、`entitlement_events`、`quota_daily`、`audit_events` 均记录变更；`plan.changed` 指标更新。
- `GET /api/v1/subscription`（API-401）与 `/api/v1/quotas`（API-402）立即返回最新档位与配额。
- 历史/导出/画像等能力自动调整（例如历史留存天数、导出格式、styleTags 上限）。
- 到期或降级后的限制立即生效，但不会删除既有数据（仅受新留存上限约束）。
- 订阅变更事件同步到监控、告警、结算与客户成功看板。

## 8. 业务规则（SRS 第 4 章 & 第 5 章占位）
- FR-041：订阅状态与能力同步；≤5 s 完成档位切换。
- FR-050：配额按本地自然日重置；查词/再生分开计数。
- FR-090：支付成功立即下发权益；异常回调自动重试。
- FR-091：到期/撤销/退款自动降级，能力边界同步。
- BR-09：订阅到期自动降级为 Free，作为单一事实源。
- 第 11.6：升级立即生效、降级默认周期末；幂等键与补差规则。

## 9. 数据契约引用（SRS 第 8 章）
- API-401：`GET /api/v1/subscription`（当前档位/权益）。
- API-402：`GET /api/v1/quotas`（查词/再生成用量、重置时间）。
- API-403：`GET /api/v1/receipts/{receiptId}`（回执状态，供账单提示）。
- API-404：`POST /api/v1/webhooks/billing`（支付/订阅事件 Webhook）。
- Schema：`plans`、`subscriptions`、`orders`、`transactions`、`entitlement_events`、`quota_daily`（第 9.4）；`glancy.billing.v1.Subscription`（第 11.14）。

## 10. 非功能约束（SRS 第 20 章 20.3–20.5）
- 时效：支付成功→权益同步 ≤5 s（20.12、TC-BILL-001）；到期自动降级无人工介入。
- 可用性：订阅/配额 API 月度可用性 ≥99.9%；Webhook 重试直至成功。
- 一致性：写后读不一致容忍 ≤5 s，策略为“更宽松不超限”；之后必须一致。
- 安全：Webhook HMAC 签名、TLS1.2+、`entitlement_events` 与 `audit_events` 不落敏感原文；订阅数据保留 ≥5 年。
- 可观测性：`entitlement_delay`、`subscription.state_transition`、`quota_mismatch` 告警；发布前必做订阅演练（REL-B1/B2）。

## 11. 验收标准 AC（SRS 第 20 章 20.3–20.17）
- AC-UC-08：Given 用户升级 Plus→Pro When 支付成功 Then ≤5 s `/subscription` 与 `/quotas` 反映新上限，`entitlement_events` 状态为 `delivered`（TC-BILL-001、20.12）。
- AC-UC-09：Given 订阅到期或用户取消自动续费 When 到期定时任务运行 Then 自动降级为 Free，历史/配额阈值同步，幂等多次触发不重复扣费（订阅演练脚本、AC-FR-091）。
- AC-UC-08-Rollback：Given 配额域 5 s 内未反馈 When 超时 Then 触发补偿任务并在 UI 提示“权益同步中”，最多 3 次重试后进入告警（20.15 检查清单 + AC-FR-041）。

## 12. 备注（SRS 第 4 章 4.7–4.8 & 第 20 章 20.14）
- 观测：`subscription.change_latency`、`entitlement_delay`, `quota_mismatch`、`plan_distribution` 看板，与 21.10 订阅看板同步。
- 日志/审计：`audit_events`（action=`plan.changed`）记录 from→to、orderId、traceId；对账脚本定期校验。
- Runbook：`billing-webhook-replay`、`subscription-sync`；失败需 15 分钟内补偿。
- 依赖：UC-05（账单/对账）提供订单、回执与退款通知；UC-01/02/03 需读取最新 entitlement。***
