# UC-01 词汇查询（流式）

> 关联 SRS：第 4 章 4.2.2、4.5；第 5 章 FR-010/011/050/070/071；第 6 章 6.3；第 8 章 8.3–8.4；第 9 章 9.4–9.5；第 14 章 14.2；第 16 章 16.3；第 20 章 20.3 / 20.17 / 20.21；对应 AC：AC-UC-01、AC-FR-004、AC-UC-13、AC-NFR-001、AC-NFR-008。

## 基本信息
- `UC ID`：UC-01
- `用例名称`：词汇查询（流式）
- `所属模块/史诗`：词典主流程 / Dictionary Experience
- `优先级`：P0
- `版本 / 修订历史`：v1.0（2024-05-01，@dict-core）

## 1. 目的（SRS 第 4 章）
> 在 L1–L4 白名单语言对范围内，向匿名或登录用户提供端到端首屏 P95 ≤ 2.5 s 的流式查词体验，返回符合 `glancy.dict.v1` 契约的结构化模块，同时确保配额/缓存/历史/观测链路闭环。

## 2. 参与者（SRS 第 4 章 4.1）
- Primary：终端用户（匿名或登录）
- Supporting：Web/H5 前端、BFF（Dictionary API）、配额/画像服务、缓存（L1 Redis / L2 CDN）
- External Systems：Doubao LLM、可观测性平台（trace/metrics/log）、历史与导出域、订阅/配额域

## 3. 前置条件（SRS 第 4 章）
- 语言对属于白名单 L1–L4（同语模式允许 source=target，但不返回译文）。
- 输入文本通过前端句子拦截与 LID 判定（FR-002/003），为单词或词组。
- 主体具备可用查词配额（FR-050）；匿名主体使用 anon_jwt 且配额是 Free 档 1/3。
- 非无痕模式或无痕但允许仅渲染不落库（FR-020）；若开启无痕则仅渲染。
- 画像与模块配置已同步，`profile_etag` 可用于幂等与缓存键。

## 4. 触发（SRS 第 4 章）
- 用户在首页或结果页输入框点击“查询”提交。
- UC-12 切换语言对后自动重查。
- API 客户端直接调用 `POST /api/v1/lookup`。

## 5. 主成功场景（SRS 第 4 章）
1. 前端执行输入校验与 LID 判定，阻止明显句子并提示“请改为词或词组”；同时补齐 `langPair`、`moduleFlags`、`detailLevel` 等配置。
2. BFF 根据 `subjectId` 计算幂等键并校验查词配额（FR-004、FR-050）；若命中 24h 内重复请求，则直接返回缓存响应。
3. 依次检查 L1（用户级 10 分钟）、L2（共享 30 分钟）缓存；命中时返回 200 并附 `X-Cache: HIT`，同时在流式管线推送已缓存 chunk。
4. 未命中缓存时，构造 Prompt（画像/模块/风格）并调用 Doubao；BFF 将流式响应拆分为模块化 chunk，经 `aria-live="polite"` 渲染，首个内容模块 P95 ≤ 2.5 s（FR-100、章 16.3）。
5. 完整响应通过 `glancy.dict.v1` Schema 校验，填充 `quota` / `tokensIn/out` / `degraded=false` 字段。
6. 若未开启无痕，则写入 `lookups` + `results` + `history` 并广播 `query.success` 事件；`quota_daily` 记录查词消耗，同步观测指标（latency、cache_hit）。
7. 向客户端返回 200 流式完成帧，并附 `X-Quota-*`、`X-RateLimit-*`、`trace_id` 等 Header；UI 展示查询耗时、缓存徽标、导出/再生成入口。

## 6. 备选 / 异常流（SRS 第 4 章）
- 1a 句子输入：前端阻止提交；若绕过并命中后端，返回 400 `ENTRY_NOT_WORD_OR_PHRASE`，提示用户改为词或词组（TC-API-001）。
- 2a 配额已用尽：返回 429 `RATE_LIMITED`，Header 指出 `X-Quota-Type=lookup`、剩余额度与重置时间，引导进入 UC-13 升级提示。
- 3a Doubao 5xx≥5% 或超时超阈：触发熔断，进入 UC-02 基础释义降级回退路径（BR-06 / FR-070），响应 `degraded=true` 并展示退化提示。
- 4a 匿名主体试图访问受限模块（如多例句）：BFF 将 `exampleCount` 裁剪到 Free 阈值并提示“升级解锁更多”。
- R1 历史/结果落库失败：事务回滚 `history`/`results` 插入，仅保留响应体；同时写入 `history.write_retry` 任务与告警，确保后台补偿后恢复幂等状态。

## 7. 后置条件（SRS 第 4 章）
- 成功响应的词条写入 `lookups/results/history`（除无痕），并与 `trace_id`、`profile_snapshot` 关联。
- 查词配额 `quota_daily.lookup_count` +1 并在响应 Header/Body 镜像剩余额度。
- 缓存刷新：L1/L2 存入最新结果，key = `hash(subjectId, langPair, entry_norm, config_hash, profile_etag)`。
- 事件 `query.request/success/fail`、`cache.hit/miss`、`stream_chunks_total/dropped` 上报到观测平台；异常触发 Runbook。
- 导出/再生成入口解锁，历史页面可立即看到最新记录（除无痕模式）。

## 8. 业务规则（SRS 第 4 章 & 第 5 章占位）
- BR-05：L1/L2 双层缓存 TTL（10/30 分钟），再生成绕过 L2。
- BR-06：依赖异常回退“基础释义+模板例句”，标注退化徽标。
- FR-010/011/012：模块化结构、例句与搭配渲染，详略与档位对齐。
- FR-050：查词/再生成配额拆分，响应 Header 返回 `X-Quota-*`。
- FR-070/071：Doubao 熔断、半开探测与缓存命中标记。
- NFR-002（20.3 表）：`lookup/regenerate` 可用性 ≥99.9%。

## 9. 数据契约引用（SRS 第 8 章）
- API-001：`POST /api/v1/lookup`（第 8.4 节）— 查词/流式生成。
- API-003：`GET /api/v1/lookup/{lookupId}`（第 8.4）— 结果回放。
- Schema：`glancy.dict.v1.DictResult`（第 8.3.1），含 `modules/quotas/degraded` 字段；`history.record`（第 9.5.2）与 `lookups/results/quota_daily` 表结构（第 9.4）。

## 10. 非功能约束（SRS 第 20 章 20.3–20.5）
- 性能：首个内容模块 P95 ≤ 2.5 s、均值 ≤ 1.2 s（20.3 / 16.3）；流式丢段率 ≤0.5%（14.2 指标）。
- 可用性 / 降级：Doubao 5xx≥5% & 1 分钟触发 UC-02；降级响应 P95 ≤1.8 s（16.3）。
- 可观测性：≥99% 请求具备 `trace_id`，`query.*` 事件与 `stream_chunks_*` 指标齐全（14.2、20.14）。
- 安全 / 合规：TLS1.2+，匿名主体 `anon_jwt` TTL 24 h（第 8.1）；无痕查询不落正文（FR-020）。
- 限流：用户级/租户级/全局三级限流 + `retry_after_ms`（FR-051）。

## 11. 验收标准 AC（SRS 第 20 章 20.3–20.17）
- AC-UC-01（第 20 章 20.3.2，REL-B0）：Given 输入命中 L1–L4 白名单且 `detailLevel` 为默认 When 调用 `POST /api/v1/lookup` Then 响应 200，`modules` 与 `quotas` 字段完整且同语模式不返回译文，`X-Cache`、`X-Quota-*` 与 `trace_id` Header 齐全（TC-API-001、TC-API-002、TC-CACHE-001）。
- AC-FR-004（第 20 章 20.5.3，REL-B0）：Given 3 秒内重复发送相同 payload When `subjectId/langPair/entry_norm` 命中幂等键 Then 返回缓存结果且不重复写入历史或扣减配额（TC-API-003）。
- AC-UC-13（第 20 章 20.5.7，REL-B2）：Given 用户查词配额耗尽 When 再次请求 `POST /api/v1/lookup` Then 返回 429 `RATE_LIMITED`，Body/Headers 镜像 `X-Quota-Remaining` 与 `retry_after_ms` 并触发 UC-13 升级提示（TC-QUOTA-001、TC-RATE-001）。
- AC-NFR-001（第 20 章 20.3.5，REL-B0）：Given 2000 条样本 When 执行 `TC-PERF-001` 压测 Then 首个内容 chunk P95 ≤ 2.5 s、平均 ≤ 1.2 s，误差 ≤5%，并在观测看板留档。
- AC-NFR-008（第 20 章 20.13.2，REL-B0）：Given 10 分钟监控窗口 When 抽查 `stream_chunks_*` 指标 Then `dropped/total ≤0.5%`，所有请求具备 `trace_id` 且日志/指标/追踪可关联（A11y-C08、TC-OBS-001）。

## 12. 备注（SRS 第 4 章 4.7–4.8 & 第 20 章 20.14）
- 观测：`query.request|success|fail`、`stream_chunks_*`、`doubao.circuit_state`、`cache.hit_rate` 指标纳入 Grafana `obs-dict` 看板。
- 日志/追踪：`trace_id` 贯穿前端（Performance API）与后端（OpenTelemetry），异常采样率 ≥10%。
- Runbook：`lookup-availability`、`streaming-drop`；异常需在 5 分钟内由 on-call 执行。
- 依赖：UC-02（降级）、UC-03（导出）、UC-04（订阅/配额）、UC-05（账单）组成主干，任意一环异常需在用例备注中登记 Known Issues。***
