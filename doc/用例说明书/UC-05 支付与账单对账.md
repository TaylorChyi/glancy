# UC-05 支付与账单对账

> 关联 SRS：第 1 章 1.4.5；第 4 章 UC-08（支付）/UC-15（账单与收据）；第 5 章 FR-042/090/092；第 8 章 8.8（API-401~404）与 8.6（回执）；第 9 章 9.5（`orders`、`transactions`、`invoices`、`audit_events`）；第 11 章 11.4–11.14（商品、状态机、接口、对账）；第 20 章 20.3 / 20.12 / 20.17 / 20.21（TC-BILL-001、AC-FR-042/AC-FR-092）。

## 基本信息
- `UC ID`：UC-05
- `用例名称`：支付与账单对账
- `所属模块/史诗`：订阅与账单 / Billing & Reconciliation
- `优先级`：P0
- `版本 / 修订历史`：v1.0（2024-05-01，@billing-platform）

## 1. 目的（SRS 第 4 章）
> 支持 Web/H5 订阅购买与续费的支付流程，生成账单/收据、记录订单与交易、完成渠道对账与审计，确保支付成功 ≤5 s 内下发权益、账单数据可追溯，退款/拒付/异常对账可自动补偿并回滚权益。

## 2. 参与者（SRS 第 4 章 4.1）
- Primary：登录用户（购买、续费、退款查询）
- Supporting：Web/H5 订阅/账单模块、订单服务、支付通道 SDK、账单/收据服务、对账任务、客服/财务人员
- External Systems：支付渠道（微信/支付宝）、对象存储（账单/收据链接）、Webhook、审计系统

## 3. 前置条件（SRS 第 4 章）
- 商品矩阵（Plan/Price）已配置，订单服务可生成 `price_id` 对应的金额、币种、周期。
- 支付渠道（微信/支付宝）配置完成且 HMAC 签名校验可用；回调地址白名单。
- `orders`、`transactions`、`invoices`、`audit_events` 表存在且索引（`order_id`、`platform_txn_id`、`idem_key`）生效。
- 用户已完成 KYC（如需），支持币种/税务规则已同步到账单模板。
- Web/H5 已准备支付成功/失败 UI 状态与 Retry/客服引导。

## 4. 触发（SRS 第 4 章）
- 用户在订阅页点击“升级/续费”并确认支付。
- 财务/客服在后台创建补单或触发退款。
- 渠道异步回调（支付成功/失败/争议/退款）。
- 定时对账任务（15 分钟增量 + T+1 全量）发现差异。

## 5. 主成功场景（SRS 第 4 章）
1. 用户选择 Plan/周期，前端调用 `POST /v1/orders`（11.14.1 API-12-002），生成订单（`order_id`、金额、币种、应付/优惠）。
2. 前端调起支付（微信/支付宝 H5）；支付完成后渠道回调 `POST /api/v1/webhooks/billing`，或用户返回站内点击“已付款”触发 `POST /v1/orders/{orderId}/confirm`。
3. 订单服务校验签名、去重（`idem_key`），更新 `orders.status=paid`、`transactions.status=success` 并记录 `platform_txn_id`、`paid_at`。
4. 生成账单（`invoices`）与收据下载链接（TTL 10 分钟），写入 `invoice_id`、`link_ttl`、税额、优惠等字段；通过 `audit_events` 记录 `billing.paid`。
5. 推送 `entitlement_events` → 订阅/配额域（UC-04），确保权益 ≤5 s 内生效；账单页刷新显示新档位、生效/到期时间、订单号、收据下载入口。
6. T+15 分钟增量与 T+1 全量对账任务拉取渠道流水，对 `orders/transactions` 逐条比对；若一致，标记 `reconciled=true` 并归档；若不一致，进入异常流。
7. 用户可在账单页按时间/渠道过滤，查看详情并下载收据；收据下载走一次性链接（TTL 10 分钟），可重复申请。

## 6. 备选 / 异常流（SRS 第 4 章）
- 2a 支付失败或用户取消：`orders.status=cancelled`，UI 提示失败原因，可重试或更换渠道；不生成账单或权益。
- 3a 回调重复/乱序：幂等键命中，返回 200 但不重复更新，日志记录 `duplicate_callback`。
- 4a 账单生成失败：订单已支付但 `invoices` 写入失败时，事务回滚或标记 `invoice_status=pending`，后台补偿任务生成收据并通知用户。
- 5a 权益下发失败：参见 UC-04 R1，需暂停账单发放并提示“权益同步中”，直至成功；若最终失败则退款或恢复原档位。
- 6a 对账差异：渠道金额/状态与本地不一致时，记录 `reconciliation_issue`，自动重放回调并通知财务；若仍不一致，冻结相关权益并人工介入。
- 6b 退款/拒付：渠道发送退款/争议信息 → `orders.status=refunded/revoked`，`subscriptions` 立即降级（FR-091/092），账单生成红冲/负数行，`audit_events` 记录原因。
- R1 对账发现高风险（如重复计费）：回滚最新订单为 `pending_refund`，撤销已经发放的权益（触发 UC-04 回滚），并在账单详情展示“正在核对”状态，同时阻塞后续同渠道扣款，直至人工确认。

## 7. 后置条件（SRS 第 4 章）
- `orders`、`transactions`、`invoices`、`refunds`、`audit_events` 均记录完整链路；收据链接 TTL 到期后失效。
- `reconciliation` 视图更新账龄（M0/M1/M2）与差异状态，供财务报表。
- 成功订单的 `subscription` 和 `quota` 已同步（UC-04），失败/退款订单回滚权益。
- 账单页与收据下载记录操作事件（`billing.invoice.downloaded`）。
- 对账日志与回调原文加密存储，保留 ≥5 年。

## 8. 业务规则（SRS 第 4 章 & 第 5 章占位）
- FR-042：账单/收据展示档位、生效/到期、订单号、税额、优惠，下载链接 TTL 10 分钟。
- FR-090：支付成功 ≤5 s 权益生效；失败/超时不改变原状态。
- FR-092：退款/异常对账需幂等同步，回滚权益并记录账单痕迹。
- 第 11.6：升级立即生效、降级周期末；退款遵循渠道策略。
- 第 11.11：回调优先，轮询兜底；差异可配置“本地为准/渠道为准”。
- 安全：最小数据采集、遵守渠道合规，不落敏感支付数据明文。

## 9. 数据契约引用（SRS 第 8 章）
- API-401/402：订阅/配额镜像，用于支付成功后校验。
- API-403：`GET /api/v1/receipts/{receiptId}` 查询导出/账单回执状态。
- API-404：`POST /api/v1/webhooks/billing` 支付回调。
- `glancy.billing.v1`（第 11.14）接口：`GET /v1/subscriptions/current`、`POST /v1/orders`、`POST /v1/orders/{id}/confirm`、`POST /v1/subscriptions/upgrade` 等。
- 数据模型：`orders`、`transactions`、`invoices`、`refunds`、`subscriptions`、`entitlement_events`、`audit_events`（第 9.4、11.13）。

## 10. 非功能约束（SRS 第 20 章 20.3–20.5）
- 性能：支付成功→账单写入→权益发放 ≤5 s；账单列表分页响应 ≤1 s。
- 可用性：支付与账单 API 月度可用性 ≥99.9%；Webhook/对账任务具备重试与告警。
- 数据保留：订单/账单/交易 ≥5 年，回调原文加密存储（11.13）。
- 安全/合规：TLS1.2+、HMAC 签名、最小权限、敏感字段脱敏；符合渠道拒付流程与审计要求。
- 可观测性：`billing.callback_latency`、`reconciliation_diff`、`invoice.failures` 指标；对账失败自动在 15 分钟内告警。

## 11. 验收标准 AC（SRS 第 20 章 20.3–20.17）
- AC-FR-042：Given 用户查看账单 When 请求账单列表 Then 返回档位、生效/到期、订单号、税额，收据下载链接 TTL 10 分钟且一次性（第 20.18.2）。
- AC-FR-090：Given 支付成功回调 When 订单更新 Then ≤5 s 权益同步、`subscriptions` 状态正确，UI 展示“已升级”（TC-BILL-001）。
- AC-FR-092：Given 渠道触发退款/拒付 When 回调生效 Then 状态幂等，权益回滚，账单记录红冲，审计日志完整（20.12、11.10）。
- AC-UC-08/09 配套：账单/支付链路必须向 UC-04 提供一致的 `receiptId`、`orderId`，对账差异 0（20.21 表）。

## 12. 备注（SRS 第 4 章 4.7–4.8 & 第 20 章 20.14）
- 观测：`billing.callback_latency`、`order.success_rate`、`reconciliation_diff`、`invoice_generation_failures` Dashboard；重要事件写入 21.5 发布守门指标。
- 日志/审计：`audit_events` 采用 `action=payment.succeeded|payment.failed|refund.issued|invoice.downloaded`；`meta` 保留 orderId、traceId、amount（脱敏）。
- Runbook：`billing-webhook-replay`、`reconciliation-diff`、`invoice-regeneration`、`chargeback-response`。
- 依赖：UC-04（权益/配额）、UC-03（回执/导出）、UC-01/02（体验提示）；任何支付侧异常需在 UC-04/UC-03 中作出 UI 反馈。***
