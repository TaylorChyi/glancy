%% FigJam: https://www.figma.com/file/glancy-sdd-figjam?type=whiteboard&node-id=230-100#Deployment
%% 摘要：双区域部署拓扑、组件冗余、任务面与观测面。
flowchart TB
    classDef compute fill:#eef8ff,stroke:#1f78e0,color:#0b1736
    classDef data fill:#fff6e8,stroke:#f39c12,color:#6b3500
    classDef control fill:#f2f2f8,stroke:#9b59b6,color:#2c2142

    subgraph RegionA[Region A（Active-Active）]
        subgraph AZ1[AZ-1]
            EdgeA1[Edge/WAF]
            GW1[API 网关 Pod]
            BFF1[BFF Deployment]
            Adapter1[LLM 适配层]
            Feature1[Config/Flag Sidecar]
            RedisL1A[(Redis L1 Shard)]
        end
        subgraph AZ2[AZ-2]
            EdgeA2[Edge/WAF]
            GW2[API 网关 Pod]
            BFF2[BFF Deployment]
            Adapter2[LLM 适配层]
            Feature2[Config/Flag Sidecar]
            RedisL1B[(Redis L1 Shard)]
        end
        subgraph DataA[数据与任务层]
            RDBMSA[(PostgreSQL 主)]
            ReadReplica[(PostgreSQL 只读)]
            RedisL2A[(Redis L2 Cluster)]
            ObjA[(对象存储 Bucket A)]
            QueueA[(导出/任务队列)]
            WorkerA[导出/清理 Worker]
            ObservabilityA[日志/指标/Trace 集群]
        end
    end

    subgraph RegionB[Region B（Warm Standby）]
        RDBMSB[(PostgreSQL 备)]
        RedisL2B[(Redis L2 备)]
        ObjB[(对象存储 CRR)]
        QueueB[(灾备队列)]
        WorkerB[备援 Worker]
    end

    EdgeA1 --> GW1 --> BFF1 --> Adapter1 --> Doubao[(Doubao API)]
    EdgeA2 --> GW2 --> BFF2 --> Adapter2 --> Doubao
    BFF1 --> RedisL1A
    BFF2 --> RedisL1B
    BFF1 --> RedisL2A
    BFF2 --> RedisL2A
    BFF1 --> RDBMSA
    BFF2 --> RDBMSA
    BFF1 --> QueueA
    BFF2 --> QueueA
    QueueA --> WorkerA --> ObjA
    WorkerA --> RedisL2A
    WorkerA --> ObservabilityA
    BFF1 --> ObservabilityA
    BFF2 --> ObservabilityA
    ObjA --> CDN[CDN/下载链接] --> Users[终端用户]

    RDBMSA ==异步复制==> RDBMSB
    RedisL2A ==异步复制==> RedisL2B
    ObjA ==CRR==> ObjB
    QueueA ==灾备镜像==> QueueB
    WorkerB --> ObjB
    WorkerB --> ObservabilityA

    style Doubao fill:#ffeef0,stroke:#c0392b,color:#641b1d
    style CDN fill:#e8fff4,stroke:#27ae60,color:#0d4024
    style Users fill:#fff,stroke:#2c3e50,color:#2c3e50
