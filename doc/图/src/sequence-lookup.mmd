%% FigJam: https://www.figma.com/file/glancy-sdd-figjam?type=whiteboard&node-id=230-20#LookupSequence
%% 摘要：查词查询的主成功路径、缓存命中、降级与历史落库。
sequenceDiagram
    autonumber
    participant U as 用户
    participant FE as Web/H5 客户端
    participant GW as API 网关
    participant BFF as BFF/API
    participant Redis as Redis L1/L2
    participant Flag as 特性开关/配额服务
    participant Adapter as LLM 适配层
    participant Doubao as Doubao API
    participant Hist as 历史/导出服务
    participant Obs as 可观测性

    U->>FE: 输入词条/语言对
    FE->>FE: 本地校验（白名单/句子拦截）
    FE->>GW: POST /lookup (subject, langPair, config)
    GW->>BFF: 透传请求 + traceId + quota headers
    BFF->>Redis: GET cacheKey
    alt 命中缓存
        Redis-->>BFF: 查词结果快照
        BFF-->>FE: SSE 流返回结果 (X-Cache=HIT)
        BFF--)Hist: enqueue async audit/history
    else 未命中缓存
        BFF->>Flag: quotaCheck(subject, plan)
        alt 已超限
            Flag-->>BFF: overLimit reason
            BFF-->>FE: 429 RATE_LIMITED + 指引
            BFF--)Obs: record quota_exhausted
        else 尚有余量
            Flag-->>BFF: quotaReserved
            BFF->>Adapter: compose prompt + defaultStream
            Adapter->>Doubao: /defaultStream (timeout 5s)
            alt LLM 正常返回
                Doubao-->>Adapter: tokens/metadata
                Adapter-->>BFF: chunk + cost
                BFF-->>FE: SSE chunk 流式渲染
                BFF--)Redis: async set L1/L2 (TTL 10/30m)
            else 5xx/超时
                Adapter-->>BFF: error + policy
                BFF-->>FE: 降级响应（基础释义+模板例句）
                BFF--)Obs: emit degraded event
            end
            BFF--)Hist: persist lookup/result/profile snapshot
        end
    end
    BFF--)Obs: emit metrics/logs/traces
    FE-->>U: 渲染模块与配额剩余
