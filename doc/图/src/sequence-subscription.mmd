%% FigJam: https://www.figma.com/file/glancy-sdd-figjam?type=whiteboard&node-id=230-60#SubscriptionSequence
%% 摘要：订阅购买、支付回调、权益同步与审计。
sequenceDiagram
    autonumber
    participant U as 用户
    participant FE as Web/H5 客户端
    participant GW as API 网关
    participant BFF as BFF/API
    participant Billing as 订阅/账单服务
    participant Pay as 支付提供方
    participant Hook as Webhook 接收器
    participant Subs as Subscriptions 存储
    participant Plan as Plans/Quota
    participant Audit as 审计
    participant Obs as 可观测性

    U->>FE: 选择计划 (Plus/Pro) 并提交
    FE->>GW: POST /subscriptions (planId)
    GW->>BFF: 透传请求 + 会话
    BFF->>Billing: createOrder(planId, subject)
    Billing->>Plan: fetch price + entitlements
    Billing-->>BFF: paymentIntent + clientSecret + orderId
    BFF-->>FE: 返回支付凭据

    FE->>Pay: 调用支付 SDK (clientSecret)
    alt 支付成功
        Pay-->>U: 完成页
        Pay--)Hook: webhook event (orderId, status=SUCCEEDED)
        Hook->>Billing: POST /payments/webhook
        Billing->>Billing: verify signature/idempotency
        Billing->>Subs: upsert subscription (status=ACTIVE)
        Billing->>Plan: calculate quota/historical limits
        Billing-->>BFF: rightsSynced=true + planDelta
        BFF--)Audit: subscription.updated
        BFF--)Obs: emit entitlement_sync_latency
        BFF-->>FE: Webhook 推送/轮询结果 (≤5 s)
        FE-->>U: 展示新权益/配额
    else 支付失败/取消
        Pay-->>FE: error/cancel reason
        FE-->>U: 提示并引导重试
        Pay--)Hook: status=FAILED
        Hook->>Billing: update order -> Cancelled
        Billing--)Audit: subscription.failed
    end

    alt 到期/降级
        Billing->>Subs: set status=GRACE/EXPIRED
        Billing->>BFF: send event subscription.expired
        BFF--)Plan: lower entitlements + flush cache
        BFF--)Audit: plan.changed
    end
