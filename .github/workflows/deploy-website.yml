name: Deploy Website

on:
  push:
    branches:
      - main
      - 'feature-*'
    paths:
      - 'website/glancy-site/**'

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. 拉取仓库
      - uses: actions/checkout@v3

      # 2. 安装 Node.js (节点.js) v20
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # 3. 安装前端依赖
      - name: Install dependencies
        working-directory: glancy-website
        run: npm ci

      # 4. 代码规范校验
      - name: Lint code
        working-directory: glancy-website
        run: |
          npm run lint
          npm run lint:css

      # 5. 构建项目
      - name: Build project
        working-directory: glancy-website
        run: npm run build

      # 6. 清空服务器上旧的 dist 目录
      - name: Clean server directory
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: rm -rf ${{ secrets.WEBSITE_DEPLOY_PATH }}

      - name: Sync dist to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          # 只匹配 dist 目录下的所有文件和子目录
          source: 'glancy-website'
          # 直接放到远端的 dist 目录下
          target: ${{ secrets.WEBSITE_DEPLOY_PATH }}