name: quality-gate

on:
  pull_request:
    branches: ["trunk", "main"]
  workflow_dispatch: {}

permissions:
  contents: read
  pull-requests: read
  id-token: write

jobs:
  frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: website
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: website/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint & structural guards
        run: npm run lint

      - name: Stylelint
        run: npm run lint:css

      - name: Unit tests with coverage
        run: npm run test:coverage

      - name: Dependency audit
        run: npm run dep:audit

      - name: Upload frontend coverage
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: website/coverage/unit/lcov.info

  backend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: Verify backend (tests, Checkstyle, JaCoCo, CycloneDX, OWASP)
        run: ./mvnw -B clean verify

      - name: Upload JaCoCo report
        uses: actions/upload-artifact@v4
        with:
          name: backend-jacoco
          path: backend/target/site/jacoco/jacoco.xml

      - name: Upload CycloneDX SBOM
        uses: actions/upload-artifact@v4
        with:
          name: backend-sbom
          path: backend/target/bom/backend-sbom.json

  security:
    runs-on: ubuntu-latest
    needs: [frontend, backend]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download backend SBOM
        uses: actions/download-artifact@v4
        with:
          name: backend-sbom
          path: backend/target/bom

      - name: Run Gitleaks
        uses: zricethezav/gitleaks-action@v2

      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@latest
        with:
          project: glancy
          path: .
          format: "JSON"
          args: >
            --failOnCVSS 7

      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.24.0
        with:
          scan-type: fs
          scanners: vuln,secret
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: "1"

      - name: Generate website SBOM
        uses: CycloneDX/gh-node-module-generate-sbom@v2
        with:
          path: website
          output: website-sbom.json

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.5.0

      - name: Sign SBOMs via cosign keyless
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          cosign sign-blob --yes backend/target/bom/backend-sbom.json --output-signature backend/target/bom/backend-sbom.sig
          cosign sign-blob --yes website-sbom.json --output-signature website-sbom.sig

      - name: Upload signed SBOMs
        uses: actions/upload-artifact@v4
        with:
          name: sbom-artifacts
          path: |
            backend/target/bom/backend-sbom.json
            backend/target/bom/backend-sbom.sig
            website-sbom.json
            website-sbom.sig

  sonar:
    runs-on: ubuntu-latest
    needs: [frontend, backend]
    env:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
    if: ${{ env.SONAR_TOKEN != '' && env.SONAR_HOST_URL != '' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download frontend coverage
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage
          path: website/coverage/unit

      - name: Download backend JaCoCo report
        uses: actions/download-artifact@v4
        with:
          name: backend-jacoco
          path: backend/target/site/jacoco

      - name: Setup Sonar scanner
        uses: sonarsource/sonarcloud-github-action@v2
        with:
          projectBaseDir: .
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
